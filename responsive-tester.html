<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Responsive Design Tester</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0f;--surface:#12121a;--border:#1e1e2e;--accent:#00e5ff;--accent2:#ff3d71;--accent3:#a78bfa;--text:#e0e0f0;--muted:#5a5a7a;--panel:#0f0f18}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden}
header{display:flex;align-items:center;gap:14px;padding:10px 18px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap}
.logo{font-size:1.05rem;font-weight:800;letter-spacing:-.5px;color:var(--accent);white-space:nowrap}
.logo span{color:var(--accent2)}
.url-form{display:flex;flex:1;gap:6px;min-width:260px}
.url-input-wrap{flex:1;position:relative;display:flex;align-items:center}
.url-input{width:100%;background:var(--border);border:1px solid #2a2a3e;border-radius:6px;padding:7px 32px 7px 12px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.82rem;outline:none;transition:border-color .2s}
.url-input:focus{border-color:var(--accent)}
.url-input.error{border-color:var(--accent2)}
.url-clear{position:absolute;right:8px;background:none;border:none;color:var(--muted);cursor:pointer;font-size:.9rem;padding:2px 4px;border-radius:4px;display:none;transition:color .15s}
.url-clear:hover{color:var(--accent2)}
.url-clear.visible{display:block}
.btn{background:var(--accent);color:#000;border:none;border-radius:6px;padding:7px 16px;font-family:'Syne',sans-serif;font-weight:700;font-size:.82rem;cursor:pointer;transition:opacity .2s;white-space:nowrap}
.btn:hover{opacity:.85}
.mode-toggle{display:flex;background:var(--border);border-radius:7px;padding:2px;border:1px solid #2a2a3e}
.mode-btn{background:none;border:none;border-radius:5px;padding:5px 12px;font-family:'Syne',sans-serif;font-size:.78rem;font-weight:700;color:var(--muted);cursor:pointer;transition:all .15s;white-space:nowrap;display:flex;align-items:center;gap:5px}
.mode-btn.active{background:var(--accent);color:#000}
.mode-btn svg{width:13px;height:13px}
.header-right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
select{background:var(--border);border:1px solid #2a2a3e;border-radius:6px;padding:7px 10px;color:var(--text);font-family:'Syne',sans-serif;font-size:.82rem;cursor:pointer;outline:none}
.icon-btn{background:var(--border);border:1px solid #2a2a3e;border-radius:6px;color:var(--muted);cursor:pointer;padding:6px 10px;font-size:.75rem;font-family:'JetBrains Mono',monospace;display:flex;align-items:center;gap:4px;transition:all .15s;white-space:nowrap}
.icon-btn:hover{border-color:var(--accent);color:var(--accent)}
.icon-btn svg{width:12px;height:12px}
#device-bar{display:flex;gap:6px;padding:8px 14px;background:var(--panel);border-bottom:1px solid var(--border);overflow-x:auto;flex-shrink:0;scrollbar-width:thin;scrollbar-color:var(--border) transparent}
.category-label{font-size:.65rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);align-self:center;white-space:nowrap;padding:0 6px;border-left:2px solid var(--border)}
.category-label:first-child{border-left:none}
.device-chip{display:flex;align-items:center;gap:5px;background:var(--border);border:1px solid transparent;border-radius:20px;padding:4px 11px;font-size:.72rem;font-family:'JetBrains Mono',monospace;cursor:pointer;white-space:nowrap;transition:all .15s;color:var(--text);position:relative}
.device-chip:hover{border-color:var(--accent);color:var(--accent)}
.device-chip.active-single{background:var(--accent);color:#000;border-color:var(--accent);font-weight:700}
.device-chip.in-compare{background:#1a1a2e;border-color:var(--accent3);color:var(--accent3);font-weight:700}
.device-chip svg{width:12px;height:12px;flex-shrink:0}
.chip-badge{position:absolute;top:-5px;right:-5px;width:16px;height:16px;background:var(--accent3);color:#000;border-radius:50%;font-size:.6rem;font-weight:800;display:flex;align-items:center;justify-content:center}
#compare-bar{display:none;align-items:center;gap:8px;padding:6px 14px;background:#0d0d1a;border-bottom:1px solid var(--accent3);flex-shrink:0;flex-wrap:wrap}
#compare-bar.show{display:flex}
.compare-bar-label{font-size:.72rem;font-family:'JetBrains Mono',monospace;color:var(--accent3);white-space:nowrap}
.compare-tags{display:flex;gap:6px;flex-wrap:wrap;flex:1}
.compare-tag{display:flex;align-items:center;gap:5px;background:#1a1a2e;border:1px solid var(--accent3);border-radius:14px;padding:3px 10px;font-size:.7rem;font-family:'JetBrains Mono',monospace;color:var(--accent3)}
.compare-tag button{background:none;border:none;color:var(--accent3);cursor:pointer;font-size:.8rem;padding:0 0 0 4px;line-height:1;opacity:.7}
.compare-tag button:hover{opacity:1;color:var(--accent2)}
.compare-clear{margin-left:auto;background:none;border:1px solid #3a2a4a;border-radius:5px;color:var(--muted);cursor:pointer;font-size:.72rem;padding:4px 10px;font-family:'JetBrains Mono',monospace;transition:all .15s}
.compare-clear:hover{border-color:var(--accent2);color:var(--accent2)}
#stage{flex:1;display:flex;overflow:auto;padding:24px;gap:32px;background:radial-gradient(ellipse at 20% 30%,rgba(0,229,255,.04) 0%,transparent 50%),radial-gradient(ellipse at 80% 70%,rgba(255,61,113,.04) 0%,transparent 50%),var(--bg)}
#stage.single{align-items:center;justify-content:center}
#stage.multi{align-items:flex-start;justify-content:flex-start}
.device-wrapper{display:flex;flex-direction:column;align-items:center;gap:10px;animation:fadeIn .25s ease;flex-shrink:0}
@keyframes fadeIn{from{opacity:0;transform:scale(.97)}to{opacity:1;transform:scale(1)}}
.device-label-row{display:flex;gap:8px;font-family:'JetBrains Mono',monospace;font-size:.72rem;color:var(--muted);align-items:center;flex-wrap:wrap}
.device-label-row .dname{color:var(--text);font-weight:700}
.device-label-row .dpx{color:var(--accent)}
.remove-device-btn{background:none;border:1px solid #2a2a3e;border-radius:4px;color:var(--muted);cursor:pointer;font-size:.68rem;padding:2px 7px;font-family:'JetBrains Mono',monospace;transition:all .15s}
.remove-device-btn:hover{border-color:var(--accent2);color:var(--accent2)}
.phone-shell{position:relative;border-radius:36px;background:#1a1a2a;box-shadow:0 0 0 1px #2a2a3e,0 0 0 6px #12121e,0 0 0 7px #2a2a3e,0 24px 60px rgba(0,0,0,.7),inset 0 0 30px rgba(255,255,255,.02);transition:all .3s cubic-bezier(.34,1.56,.64,1)}
.phone-shell.landscape{border-radius:28px}
.notch{position:absolute;top:10px;left:50%;transform:translateX(-50%);width:90px;height:26px;background:#0a0a0f;border-radius:20px;z-index:10;box-shadow:0 0 0 1px #1e1e2e}
.notch.island{width:110px;height:30px}
.notch.none{display:none}
.notch.android{width:12px;height:12px;border-radius:50%;top:14px}
.notch.full-hole{width:14px;height:14px;border-radius:50%;top:12px}
.screen-area{border-radius:28px;overflow:hidden;position:absolute}
.phone-shell.landscape .screen-area{border-radius:22px}
.screen-area iframe{display:block;border:none;background:#fff;transform-origin:0 0}
.loading-overlay{position:absolute;inset:0;background:#0a0a0f;border-radius:inherit;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;z-index:20;transition:opacity .3s}
.loading-overlay.hidden{opacity:0;pointer-events:none}
.spinner{width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--muted)}
.error-overlay{position:absolute;inset:0;background:#0a0a0f;border-radius:inherit;display:none;flex-direction:column;align-items:center;justify-content:center;gap:8px;z-index:20;padding:16px;text-align:center}
.error-overlay.show{display:flex}
.error-overlay svg{width:28px;height:28px;color:var(--accent2);opacity:.7}
.error-overlay h3{font-size:.82rem;color:var(--text)}
.error-overlay p{font-size:.66rem;font-family:'JetBrains Mono',monospace;color:var(--muted);line-height:1.6}
.error-overlay a{color:var(--accent);text-decoration:none;font-size:.7rem}
.home-indicator{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);height:4px;background:rgba(255,255,255,.25);border-radius:3px}
.scale-note{font-size:.68rem;font-family:'JetBrains Mono',monospace;color:var(--muted);text-align:center}
.empty-state{display:flex;flex-direction:column;align-items:center;gap:12px;color:var(--muted);text-align:center;margin:auto}
.empty-state svg{width:60px;height:60px;opacity:.3}
.empty-state h2{font-size:1.1rem;color:var(--text);opacity:.5}
.empty-state p{font-size:.8rem;font-family:'JetBrains Mono',monospace}
.worker-bar{display:flex;align-items:center;gap:8px;padding:7px 18px;background:#0d0d16;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap}
.worker-bar-label{font-size:.68rem;font-family:'JetBrains Mono',monospace;color:var(--muted);white-space:nowrap;display:flex;align-items:center;gap:5px}
.worker-status{width:7px;height:7px;border-radius:50%;background:var(--muted);display:inline-block;flex-shrink:0}
.worker-status.ok{background:#00e5a0}
.worker-input{flex:1;min-width:240px;background:var(--border);border:1px solid #2a2a3e;border-radius:6px;padding:5px 10px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:.75rem;outline:none;transition:border-color .2s}
.worker-input:focus{border-color:var(--accent)}
.worker-input.ok{border-color:#00e5a0}
</style>
</head>
<body>
<header>
  <div class="logo">RESP<span>.</span>TEST</div>
  <div class="url-form">
    <div class="url-input-wrap">
      <input type="text" id="url-input" class="url-input" placeholder="https://example.com" autocomplete="off" spellcheck="false">
      <button class="url-clear" id="url-clear" onclick="clearURL()">✕</button>
    </div>
    <button class="btn" onclick="loadURL()">LOAD</button>
  </div>
  <div class="mode-toggle">
    <button class="mode-btn active" id="mode-single" onclick="setMode('single')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="3"/></svg>シングル
    </button>
    <button class="mode-btn" id="mode-multi" onclick="setMode('multi')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="9" height="14" rx="2"/><rect x="13" y="4" width="9" height="14" rx="2"/></svg>比較
    </button>
  </div>
  <div class="header-right">
    <select id="scale-select" onchange="updateScale()">
      <option value="0.3">30%</option>
      <option value="0.35">35%</option>
      <option value="0.4">40%</option>
      <option value="0.5">50%</option>
      <option value="0.6">60%</option>
      <option value="0.7" selected>70%</option>
      <option value="0.8">80%</option>
      <option value="1.0">100%</option>
    </select>
    <button class="icon-btn" onclick="reloadAll()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>再読み込み
    </button>
    <button class="icon-btn" onclick="copyURL()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>URLコピー
    </button>
    <button class="icon-btn" onclick="openInTab()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>新しいタブ
    </button>
    <button class="icon-btn" onclick="toggleLandscape()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="2" y="7" width="20" height="10" rx="2"/></svg><span id="rotate-label">縦</span>
    </button>
  </div>
</header>

<div class="worker-bar">
  <span class="worker-bar-label">
    <span class="worker-status" id="worker-status"></span>
    Workerプロキシ:
  </span>
  <input type="text" class="worker-input" id="worker-input" placeholder="https://your-worker.workers.dev" autocomplete="off" spellcheck="false">
  <button class="btn" style="font-size:.75rem;padding:5px 12px" onclick="saveWorkerURL()">SET</button>
  <a href="https://workers.cloudflare.com" target="_blank" rel="noopener noreferrer" style="font-size:.68rem;font-family:'JetBrains Mono',monospace;color:var(--muted);white-space:nowrap;text-decoration:none;margin-left:4px">設定方法 →</a>
</div>

<div id="device-bar"></div>

<div id="compare-bar">
  <span class="compare-bar-label">比較中:</span>
  <div class="compare-tags" id="compare-tags"></div>
  <button class="compare-clear" onclick="clearCompare()">すべてクリア</button>
</div>

<div id="stage" class="single"></div>
<div class="toast" id="toast"></div>

<script>
const DEVICES=[
  {cat:'iPhone',chips:[
    {w:393,h:852,name:'iPhone 15 Pro',notch:'island',label:'15 Pro'},
    {w:430,h:932,name:'iPhone 15 Pro Max',notch:'island',label:'15 Pro Max'},
    {w:390,h:844,name:'iPhone 14 / 15',notch:'island',label:'14 / 15'},
    {w:375,h:812,name:'iPhone X / XS',notch:'notch',label:'X / XS'},
    {w:414,h:896,name:'iPhone XR / 11',notch:'notch',label:'XR / 11'},
    {w:375,h:667,name:'iPhone SE 3rd',notch:'none',label:'SE 3rd'},
    {w:320,h:568,name:'iPhone SE 1st',notch:'none',label:'SE 1st'},
  ]},
  {cat:'Samsung',chips:[
    {w:393,h:873,name:'Galaxy S24',notch:'full-hole',label:'S24'},
    {w:412,h:915,name:'Galaxy S24 Ultra',notch:'full-hole',label:'S24 Ultra'},
    {w:360,h:800,name:'Galaxy S23',notch:'full-hole',label:'S23'},
    {w:360,h:740,name:'Galaxy A54',notch:'full-hole',label:'A54'},
    {w:848,h:1080,name:'Z Fold5 (内)',notch:'android',label:'Fold5 内'},
    {w:360,h:748,name:'Z Flip5 (外)',notch:'full-hole',label:'Flip5 外'},
  ]},
  {cat:'Pixel',chips:[
    {w:393,h:851,name:'Pixel 8',notch:'full-hole',label:'Pixel 8'},
    {w:412,h:915,name:'Pixel 8 Pro',notch:'full-hole',label:'Pixel 8 Pro'},
    {w:360,h:800,name:'Pixel 7a',notch:'full-hole',label:'Pixel 7a'},
  ]},
  {cat:'iPad / Tablet',chips:[
    {w:820,h:1180,name:'iPad 10th',notch:'none',label:'iPad 10'},
    {w:834,h:1194,name:'iPad Air 5',notch:'none',label:'Air 5'},
    {w:1024,h:1366,name:'iPad Pro 12.9',notch:'none',label:'Pro 12.9'},
    {w:744,h:1133,name:'iPad mini 6',notch:'none',label:'mini 6'},
    {w:800,h:1280,name:'Galaxy Tab S9',notch:'android',label:'Tab S9'},
  ]},
  {cat:'日本向け',chips:[
    {w:393,h:873,name:'AQUOS sense8',notch:'android',label:'AQUOS s8'},
    {w:360,h:800,name:'Xperia 5 V',notch:'android',label:'Xperia 5V'},
    {w:412,h:915,name:'Xperia 1 V',notch:'android',label:'Xperia 1V'},
    {w:360,h:800,name:'Xiaomi 13T',notch:'full-hole',label:'Xiaomi 13T'},
  ]},
];

const PAD={portrait:{top:52,bottom:28,side:12},landscape:{top:12,bottom:12,side:52}};
let mode='single',scale=0.7,landscape=false,currentURL='';
let singleDevice=DEVICES[0].chips[0],compareList=[];

const urlInput=document.getElementById('url-input');
const urlClear=document.getElementById('url-clear');

urlInput.addEventListener('input',()=>{
  urlClear.classList.toggle('visible',urlInput.value.length>0);
  urlInput.classList.remove('error');
});
urlInput.addEventListener('keydown',e=>{if(e.key==='Enter')loadURL();});

function clearURL(){
  urlInput.value='';urlInput.classList.remove('error');
  urlClear.classList.remove('visible');urlInput.focus();
}

function showToast(msg,d=2000){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),d);
}

function isValidURL(str){try{new URL(str);return true;}catch{return false;}}

function loadURL(){
  let v=urlInput.value.trim();
  if(!v)return;
  if(!/^https?:\/\//i.test(v))v='https://'+v;
  if(!isValidURL(v)){urlInput.classList.add('error');showToast('有効なURLを入力してください');return;}
  urlInput.value=v;urlInput.classList.remove('error');
  currentURL=v;renderStage();
}

function copyURL(){if(!currentURL)return;navigator.clipboard.writeText(currentURL).then(()=>showToast('URLをコピーしました'));}
function openInTab(){if(!currentURL)return;window.open(currentURL,'_blank','noopener,noreferrer');}
function reloadAll(){if(!currentURL)return;renderStage();showToast('リロード中...');}
function updateScale(){scale=+document.getElementById('scale-select').value;renderStage();}
function toggleLandscape(){
  landscape=!landscape;
  document.getElementById('rotate-label').textContent=landscape?'横':'縦';
  renderStage();
}

function setMode(m){
  mode=m;
  document.getElementById('mode-single').classList.toggle('active',m==='single');
  document.getElementById('mode-multi').classList.toggle('active',m==='multi');
  document.getElementById('stage').className=m==='multi'?'multi':'single';
  updateDeviceBar();updateCompareBar();renderStage();
}

function buildDeviceBar(){
  const bar=document.getElementById('device-bar');
  bar.innerHTML='';
  DEVICES.forEach(group=>{
    const lbl=document.createElement('span');
    lbl.className='category-label';lbl.textContent=group.cat;
    bar.appendChild(lbl);
    group.chips.forEach(d=>{
      const btn=document.createElement('button');
      btn.className='device-chip';btn.dataset.key=d.name;
      const isTablet=d.w>600;
      btn.innerHTML='<svg viewBox="0 0 24 24" fill="currentColor">'+(isTablet
        ?'<rect x="3" y="4" width="18" height="16" rx="2"/>'
        :'<rect x="5" y="2" width="14" height="20" rx="3"/>')+'</svg>'+d.label;
      btn.onclick=()=>chipClick(d);
      bar.appendChild(btn);
    });
  });
  updateDeviceBar();
}

function updateDeviceBar(){
  document.querySelectorAll('.device-chip').forEach(btn=>{
    const key=btn.dataset.key;
    btn.classList.remove('active-single','in-compare');
    const badge=btn.querySelector('.chip-badge');
    if(badge)badge.remove();
    if(mode==='single'){
      if(key===singleDevice.name)btn.classList.add('active-single');
    } else {
      const idx=compareList.findIndex(d=>d.name===key);
      if(idx!==-1){
        btn.classList.add('in-compare');
        const b=document.createElement('span');
        b.className='chip-badge';b.textContent=idx+1;
        btn.appendChild(b);
      }
    }
  });
}

function chipClick(d){
  if(mode==='single'){
    singleDevice=d;updateDeviceBar();renderStage();
  } else {
    const idx=compareList.findIndex(x=>x.name===d.name);
    if(idx===-1){
      if(compareList.length>=5){showToast('最大5台まで比較できます');return;}
      compareList.push(d);
    } else {
      compareList.splice(idx,1);
    }
    updateDeviceBar();updateCompareBar();renderStage();
  }
}

function updateCompareBar(){
  const bar=document.getElementById('compare-bar');
  const tags=document.getElementById('compare-tags');
  if(mode!=='multi'||compareList.length===0){bar.classList.remove('show');return;}
  bar.classList.add('show');tags.innerHTML='';
  compareList.forEach((d,i)=>{
    const tag=document.createElement('div');
    tag.className='compare-tag';
    tag.innerHTML='<span>'+(i+1)+'. '+d.name+' <span style="color:var(--muted)">'+d.w+'x'+d.h+'</span></span>'
      +'<button onclick="removeCompare('+i+')">x</button>';
    tags.appendChild(tag);
  });
}

function removeCompare(i){compareList.splice(i,1);updateDeviceBar();updateCompareBar();renderStage();}
function clearCompare(){compareList=[];updateDeviceBar();updateCompareBar();renderStage();}
function removeByName(name){const idx=compareList.findIndex(d=>d.name===name);if(idx!==-1)removeCompare(idx);}

function renderStage(){
  const stage=document.getElementById('stage');
  stage.innerHTML='';
  if(!currentURL){
    const e=document.createElement('div');e.className='empty-state';
    e.innerHTML='<svg viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="12" y="4" width="28" height="48" rx="5"/><line x1="22" y1="8" x2="30" y2="8"/><circle cx="26" cy="46" r="2"/><path d="M46 20 L56 20 M51 15 L51 25" stroke-linecap="round"/></svg>'
      +'<h2>URLを入力してください</h2><p>LOADボタンを押して表示開始</p>'
      +'<p style="margin-top:6px;font-size:.68rem;color:var(--muted)">比較モードでは複数デバイスを同時表示できます</p>';
    stage.appendChild(e);return;
  }
  if(mode==='single'){
    stage.appendChild(buildDeviceCard(singleDevice));
  } else {
    if(compareList.length===0){
      const h=document.createElement('div');h.className='empty-state';
      h.innerHTML='<svg viewBox="0 0 64 64" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="4" y="12" width="24" height="40" rx="4"/><rect x="36" y="12" width="24" height="40" rx="4"/></svg>'
        +'<h2>デバイスを選んでください</h2><p>上のバーからデバイスをクリックして<br>比較リストに追加（最大5台）</p>';
      stage.appendChild(h);
    } else {
      compareList.forEach(d=>stage.appendChild(buildDeviceCard(d)));
    }
  }
}

function buildDeviceCard(d){
  const pw=landscape?d.h:d.w;
  const ph=landscape?d.w:d.h;
  const pad=landscape?PAD.landscape:PAD.portrait;
  const shellW=pw+pad.side*2;
  const shellH=ph+pad.top+pad.bottom;
  const sW=Math.round(shellW*scale);
  const sH=Math.round(shellH*scale);
  const notchType=(landscape&&(d.notch==='notch'||d.notch==='island'))?'android':d.notch;
  const hasHomeBar=!landscape&&(d.notch==='island'||d.notch==='notch');
  let notchStyle='';
  if(landscape&&notchType==='android'){notchStyle='top:50%; left:'+Math.round(14*scale)+'px; transform:translateY(-50%);';}
  const screenLeft=Math.round(pad.side*scale);
  const screenTop=Math.round(pad.top*scale);
  const screenW=Math.round(pw*scale);
  const screenH=Math.round(ph*scale);
  const iid='i'+Math.random().toString(36).slice(2);
  const lid='l'+Math.random().toString(36).slice(2);
  const eid='e'+Math.random().toString(36).slice(2);

  const wrapper=document.createElement('div');
  wrapper.className='device-wrapper';

  const removeBtn=mode==='multi'
    ?'<button class="remove-device-btn" onclick="removeByName(\''+d.name.replace(/'/g,"\\'")+'\')\">x 外す</button>'
    :'';

  wrapper.innerHTML=
    '<div class="device-label-row">'
      +'<span class="dname">'+d.name+'</span>'
      +'<span class="dpx">'+d.w+'x'+d.h+'</span>'
      +'<span style="color:var(--muted)">→ '+pw+'x'+ph+' @ '+Math.round(scale*100)+'%</span>'
      +removeBtn
    +'</div>'
    +'<div class="phone-shell'+(landscape?' landscape':'')+'" style="width:'+sW+'px;height:'+sH+'px;">'
      +'<div class="notch '+notchType+'" style="'+notchStyle+'"></div>'
      +'<div class="screen-area" style="left:'+screenLeft+'px;top:'+screenTop+'px;width:'+screenW+'px;height:'+screenH+'px;">'
        +'<div class="loading-overlay" id="'+lid+'"><div class="spinner"></div><div class="loading-text">読み込み中...</div></div>'
        +'<div class="error-overlay" id="'+eid+'">'
          +'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>'
          +'<h3>表示不可</h3>'
          +'<p>X-Frame-Options / CSP<br>によりブロックされました</p>'
          +'<a href="'+currentURL+'" target="_blank" rel="noopener noreferrer">直接開く →</a>'
          +'<button class="icon-btn" style="margin-top:6px" onclick="(function(){const e=document.getElementById(\''+eid+'\');const l=document.getElementById(\''+lid+'\');const i=document.getElementById(\''+iid+'\');e.classList.remove(\'show\');l.classList.remove(\'hidden\');l.querySelector(\'.loading-text\').textContent=\'プロキシ再試行中…\';loadViaProxy(i,l,e);})()">'
          +'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>'
          +' 再試行</button>'
        +'</div>'
        +'<iframe id="'+iid+'" src="'+currentURL+'" width="'+pw+'" height="'+ph+'"'
          +' style="transform:scale('+scale+');transform-origin:0 0;display:block;border:none;background:#fff;"'
          +' sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox">'
        +'</iframe>'
      +'</div>'
      +(hasHomeBar?'<div class="home-indicator" style="width:'+Math.round(120*scale)+'px;bottom:'+Math.round(7*scale)+'px;"></div>':'')
    +'</div>'
    +'<div class="scale-note">viewport '+pw+'x'+ph+' px を '+Math.round(scale*100)+'% 縮小</div>';

  setTimeout(()=>setupIframe(iid,lid,eid),0);
  return wrapper;
}

let workerURL = localStorage.getItem('proxy_worker_url') || '';

function setWorkerURL(url) {
  workerURL = url.trim().replace(/\/+$/, '');
  localStorage.setItem('proxy_worker_url', workerURL);
}

function proxyFor(url) {
  return `${workerURL}?url=${encodeURIComponent(url)}`;
}

function setupIframe(iid,lid,eid){
  const iframe=document.getElementById(iid);
  const loading=document.getElementById(lid);
  const errBox=document.getElementById(eid);
  if(!iframe)return;

  const timer=setTimeout(()=>{
    let blocked=false;
    try{
      const doc=iframe.contentDocument||iframe.contentWindow.document;
      if(!doc||!doc.body||doc.body.innerHTML.trim()==='')blocked=true;
    }catch{blocked=true;}
    if(blocked) tryProxy(iframe,loading,errBox);
    else if(loading)loading.classList.add('hidden');
  },3000);

  iframe.addEventListener('load',function onLoad(){
    iframe.removeEventListener('load',onLoad);
    clearTimeout(timer);
    let blocked=false;
    try{
      const doc=iframe.contentDocument||iframe.contentWindow.document;
      if(!doc||!doc.body||doc.body.innerHTML.trim()==='')blocked=true;
    }catch{blocked=true;}
    if(blocked) tryProxy(iframe,loading,errBox);
    else if(loading)loading.classList.add('hidden');
  });
}

function tryProxy(iframe,loading,errBox){
  if(!workerURL){
    if(loading)loading.classList.add('hidden');
    if(errBox)errBox.classList.add('show');
    return;
  }
  if(loading){
    loading.classList.remove('hidden');
    loading.querySelector('.loading-text').textContent='Workerプロキシ経由で読み込み中…';
  }
  const pURL = proxyFor(currentURL);
  iframe.src = pURL;
  iframe.onload = () => {
    if(loading)loading.classList.add('hidden');
  };
  iframe.onerror = () => {
    if(loading)loading.classList.add('hidden');
    if(errBox)errBox.classList.add('show');
  };
  setTimeout(()=>{
    if(!loading.classList.contains('hidden')){
      loading.classList.add('hidden');
    }
  }, 12000);
}



function setupIframe(iid,lid,eid){
  const iframe=document.getElementById(iid);
  const loading=document.getElementById(lid);
  const errBox=document.getElementById(eid);
  if(!iframe)return;

  const timer=setTimeout(()=>{
    let blocked=false;
    try{
      const doc=iframe.contentDocument||iframe.contentWindow.document;
      if(!doc||!doc.body||doc.body.innerHTML.trim()==='')blocked=true;
    }catch{blocked=true;}
    if(blocked){
      if(loading)loading.querySelector('.loading-text').textContent='プロキシ経由で再試行…';
      loadViaProxy(iframe,loading,errBox);
    }else{
      if(loading)loading.classList.add('hidden');
    }
  },3000);

  iframe.addEventListener('load',function onLoad(){
    iframe.removeEventListener('load',onLoad);
    clearTimeout(timer);
    let blocked=false;
    try{
      const doc=iframe.contentDocument||iframe.contentWindow.document;
      if(!doc||!doc.body||doc.body.innerHTML.trim()==='')blocked=true;
    }catch{blocked=true;}
    if(blocked){
      if(loading)loading.querySelector('.loading-text').textContent='プロキシ経由で再試行…';
      loadViaProxy(iframe,loading,errBox);
    }else{
      if(loading)loading.classList.add('hidden');
    }
  });
}

buildDeviceBar();
renderStage();

const workerInput = document.getElementById('worker-input');
const workerStatus = document.getElementById('worker-status');
if(workerURL){
  workerInput.value = workerURL;
  workerInput.classList.add('ok');
  workerStatus.classList.add('ok');
}
workerInput.addEventListener('keydown', e => { if(e.key==='Enter') saveWorkerURL(); });

function saveWorkerURL(){
  const v = workerInput.value.trim().replace(/\/+$/,'');
  if(!v){ showToast('Worker URLを入力してください'); return; }
  setWorkerURL(v);
  workerInput.classList.add('ok');
  workerStatus.classList.add('ok');
  showToast('✓ Worker URLを保存しました');
  if(currentURL) renderStage();
}
</script>
</body>
</html>
