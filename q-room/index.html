<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Q-Room</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:ital,wght@0,300;0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg:       #070710;
  --surface:  #0e0e1f;
  --card:     #14142a;
  --border:   rgba(255,255,255,0.08);
  --cyan:     #00e5ff;
  --pink:     #ff2d6f;
  --green:    #00e096;
  --red:      #ff4757;
  --yellow:   #ffd32a;
  --text:     #e0e0f0;
  --muted:    #5a5a7a;
  --font-display: 'Orbitron', monospace;
  --font-body:    'Exo 2', sans-serif;
}
body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-body);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 0;
  overflow-x: hidden;
}
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse 60% 40% at 20% 0%, rgba(0,229,255,0.06) 0%, transparent 60%),
    radial-gradient(ellipse 50% 50% at 80% 100%, rgba(255,45,111,0.06) 0%, transparent 60%);
  pointer-events: none;
  z-index: 0;
}
.screen {
  display: none;
  width: 100%;
  max-width: 520px;
  padding: 28px 20px 60px;
  position: relative;
  z-index: 1;
}
.screen.active { display: block; }
.logo {
  font-family: var(--font-display);
  font-size: 3rem;
  font-weight: 900;
  letter-spacing: 0.12em;
  text-align: center;
  background: linear-gradient(135deg, var(--cyan) 0%, var(--pink) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 4px;
  filter: drop-shadow(0 0 20px rgba(0,229,255,0.4));
}
.tagline {
  text-align: center;
  color: var(--muted);
  font-size: 0.8rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  margin-bottom: 32px;
}
h2 {
  font-family: var(--font-display);
  font-size: 1.1rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  color: var(--cyan);
  margin-bottom: 16px;
}
h3 {
  font-family: var(--font-display);
  font-size: 0.85rem;
  font-weight: 700;
  letter-spacing: 0.08em;
  color: var(--muted);
  margin-bottom: 12px;
}
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  position: relative;
  overflow: hidden;
}
.card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--cyan), transparent);
  opacity: 0.5;
}
.field { margin-bottom: 16px; }
label {
  display: block;
  font-size: 0.72rem;
  font-weight: 700;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 7px;
}
input[type="text"], input[type="number"] {
  width: 100%;
  padding: 12px 16px;
  background: rgba(0,0,0,0.4);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-family: var(--font-body);
  font-size: 1rem;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}
input[type="text"]:focus, input[type="number"]:focus {
  border-color: var(--cyan);
  box-shadow: 0 0 0 3px rgba(0,229,255,0.12);
}
input::placeholder { color: var(--muted); }
.room-id-row { display: flex; gap: 10px; }
.room-id-row input { flex: 1; }
.room-id-row .gen-btn {
  padding: 12px 14px;
  background: rgba(0,229,255,0.1);
  border: 1px solid rgba(0,229,255,0.3);
  border-radius: 10px;
  color: var(--cyan);
  cursor: pointer;
  font-size: 0.75rem;
  font-weight: 700;
  letter-spacing: 0.05em;
  white-space: nowrap;
  transition: all 0.2s;
  font-family: var(--font-body);
}
.room-id-row .gen-btn:hover { background: rgba(0,229,255,0.2); }
.btn {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 12px;
  font-family: var(--font-display);
  font-size: 0.8rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  cursor: pointer;
  transition: all 0.2s;
  margin-bottom: 10px;
  position: relative;
  overflow: hidden;
}
.btn::after {
  content: '';
  position: absolute;
  inset: 0;
  background: rgba(255,255,255,0.08);
  opacity: 0;
  transition: opacity 0.15s;
}
.btn:hover::after { opacity: 1; }
.btn:active { transform: scale(0.98); }
.btn:disabled { opacity: 0.35; cursor: not-allowed; pointer-events: none; }
.btn-primary {
  background: linear-gradient(135deg, var(--cyan), #0088ff);
  color: #000;
  box-shadow: 0 4px 20px rgba(0,229,255,0.3);
}
.btn-secondary {
  background: linear-gradient(135deg, var(--pink), #cc0044);
  color: #fff;
  box-shadow: 0 4px 20px rgba(255,45,111,0.3);
}
.btn-ghost {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--muted);
}
.btn-ghost:hover { border-color: var(--cyan); color: var(--cyan); }
.btn-green-solid {
  background: linear-gradient(135deg, var(--green), #00b371);
  color: #000;
  font-family: var(--font-body);
  font-size: 1.2rem;
  font-weight: 700;
  letter-spacing: 0;
  padding: 16px;
  box-shadow: 0 4px 20px rgba(0,224,150,0.3);
}
.btn-red-solid {
  background: linear-gradient(135deg, var(--red), #cc2233);
  color: #fff;
  font-family: var(--font-body);
  font-size: 1.2rem;
  font-weight: 700;
  letter-spacing: 0;
  padding: 16px;
  box-shadow: 0 4px 20px rgba(255,71,87,0.3);
}
.btn-row { display: flex; gap: 10px; }
.btn-row .btn { margin-bottom: 0; }
.error-msg {
  color: var(--red);
  font-size: 0.82rem;
  margin-bottom: 10px;
  display: none;
  padding: 8px 12px;
  background: rgba(255,71,87,0.1);
  border-radius: 8px;
  border: 1px solid rgba(255,71,87,0.2);
}
.room-code-block {
  text-align: center;
  padding: 24px;
  background: linear-gradient(135deg, rgba(0,229,255,0.05), rgba(255,45,111,0.05));
  border-radius: 14px;
  border: 1px solid rgba(0,229,255,0.15);
  margin-bottom: 20px;
}
.room-code-label { font-size: 0.7rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
.room-code-num {
  font-family: var(--font-display);
  font-size: 3rem;
  font-weight: 900;
  letter-spacing: 0.3em;
  background: linear-gradient(135deg, var(--cyan), var(--pink));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 12px rgba(0,229,255,0.5));
}
.share-row { display: flex; gap: 8px; margin-top: 14px; }
.share-btn {
  flex: 1;
  padding: 9px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: transparent;
  color: var(--muted);
  cursor: pointer;
  font-size: 0.75rem;
  font-weight: 600;
  letter-spacing: 0.05em;
  font-family: var(--font-body);
  transition: all 0.2s;
}
.share-btn:hover { border-color: var(--cyan); color: var(--cyan); background: rgba(0,229,255,0.05); }
.player-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 4px; }
.player-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 11px 14px;
  background: rgba(0,0,0,0.3);
  border-radius: 10px;
  border: 1px solid var(--border);
  transition: border-color 0.2s;
}
.player-item.me { border-color: rgba(0,229,255,0.3); }
.player-avatar {
  width: 34px; height: 34px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--cyan), var(--pink));
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 0.9rem; color: #000;
  flex-shrink: 0;
}
.player-item-name { flex: 1; font-weight: 600; font-size: 0.95rem; }
.badge {
  font-size: 0.65rem;
  padding: 3px 9px;
  border-radius: 20px;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
}
.badge-host { background: rgba(255,45,111,0.2); color: var(--pink); border: 1px solid rgba(255,45,111,0.3); }
.badge-me   { background: rgba(0,229,255,0.15); color: var(--cyan); border: 1px solid rgba(0,229,255,0.3); }
.mode-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
.mode-tab {
  flex: 1;
  padding: 10px 8px;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: transparent;
  color: var(--muted);
  cursor: pointer;
  font-size: 0.82rem;
  font-weight: 700;
  font-family: var(--font-body);
  letter-spacing: 0.05em;
  transition: all 0.2s;
}
.mode-tab.active {
  background: rgba(0,229,255,0.1);
  border-color: var(--cyan);
  color: var(--cyan);
}
.settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.settings-grid .field { margin-bottom: 0; }
.settings-desc { font-size: 0.78rem; color: var(--muted); line-height: 1.6; margin-bottom: 14px; font-style: italic; }
.settings-panel { display: none; }
.settings-panel.active { display: block; }
.game-topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}
.game-room-id {
  font-family: var(--font-display);
  font-size: 0.75rem;
  letter-spacing: 0.15em;
  color: var(--muted);
}
.game-room-id span { color: var(--cyan); }
.mode-pill {
  padding: 5px 12px;
  background: rgba(255,45,111,0.12);
  border: 1px solid rgba(255,45,111,0.25);
  border-radius: 20px;
  font-size: 0.72rem;
  font-weight: 700;
  letter-spacing: 0.08em;
  color: var(--pink);
}
.player-cards { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
.pcard {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 14px 16px;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}
.pcard.pcard-me { border-color: rgba(0,229,255,0.25); }
.pcard.pcard-winner {
  border-color: var(--green);
  background: rgba(0,224,150,0.06);
}
.pcard.pcard-winner::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: var(--green);
}
.pcard.pcard-eliminated {
  opacity: 0.45;
  filter: grayscale(0.7);
}
.pcard-top { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.pcard-name { flex: 1; font-weight: 700; font-size: 1rem; }
.pcard-status {
  font-size: 0.68rem;
  padding: 3px 9px;
  border-radius: 20px;
  font-weight: 700;
  letter-spacing: 0.06em;
  text-transform: uppercase;
}
.s-active     { background: rgba(90,90,122,0.3); color: var(--muted); }
.s-winner     { background: rgba(0,224,150,0.2); color: var(--green); border: 1px solid rgba(0,224,150,0.3); }
.s-eliminated { background: rgba(255,71,87,0.15); color: var(--red); }
.pcard-stats { display: flex; gap: 16px; align-items: center; }
.stat-box { display: flex; align-items: center; gap: 5px; font-size: 0.85rem; }
.stat-icon { font-size: 0.9rem; }
.stat-val { font-weight: 700; font-size: 1rem; }
.stat-val.correct { color: var(--green); }
.stat-val.wrong   { color: var(--red); }
.stat-val.score   { color: var(--cyan); }
.score-large {
  margin-left: auto;
  font-family: var(--font-display);
  font-size: 1.8rem;
  font-weight: 900;
  color: var(--cyan);
  filter: drop-shadow(0 0 8px rgba(0,229,255,0.4));
}
.my-action-panel {
  background: rgba(0,229,255,0.04);
  border: 1px solid rgba(0,229,255,0.15);
  border-radius: 14px;
  padding: 16px;
  margin-top: 10px;
}
.my-action-title { font-size: 0.72rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); margin-bottom: 12px; text-align: center; }
.action-row { display: flex; gap: 12px; }
.action-row .btn { flex: 1; margin-bottom: 0; }
.podium-wrap { text-align: center; padding: 20px 0; }
.podium-emoji { font-size: 4rem; line-height: 1; margin-bottom: 12px; }
.podium-name {
  font-family: var(--font-display);
  font-size: 1.6rem;
  font-weight: 900;
  background: linear-gradient(135deg, var(--yellow), var(--pink));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 4px;
}
.podium-sub { color: var(--muted); font-size: 0.82rem; letter-spacing: 0.1em; }
.result-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 24px; }
.result-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 13px 16px;
  background: var(--card);
  border-radius: 12px;
  border: 1px solid var(--border);
}
.result-rank {
  font-family: var(--font-display);
  font-size: 1.1rem;
  font-weight: 900;
  min-width: 28px;
  color: var(--muted);
}
.result-rank.r1 { color: var(--yellow); }
.result-rank.r2 { color: #c0c0c0; }
.result-rank.r3 { color: #cd7f32; }
.result-name { flex: 1; font-weight: 600; }
.result-stats { font-size: 0.8rem; color: var(--muted); }
.result-score {
  font-family: var(--font-display);
  font-size: 1rem;
  font-weight: 700;
  color: var(--cyan);
}
.toast {
  position: fixed;
  bottom: 28px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: rgba(20,20,42,0.95);
  backdrop-filter: blur(12px);
  color: var(--text);
  padding: 12px 22px;
  border-radius: 30px;
  font-size: 0.88rem;
  border: 1px solid var(--border);
  opacity: 0;
  transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
  pointer-events: none;
  z-index: 1000;
  max-width: 300px;
  text-align: center;
}
.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
.divider {
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 4px 0 16px;
  color: var(--muted);
  font-size: 0.75rem;
}
.divider::before, .divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}
.spinner {
  display: inline-block;
  width: 18px; height: 18px;
  border: 2px solid var(--border);
  border-top-color: var(--cyan);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
  margin-right: 8px;
  vertical-align: middle;
}
@keyframes spin { to { transform: rotate(360deg); } }
.empty-state { text-align: center; color: var(--muted); font-size: 0.85rem; padding: 20px; }
.config-notice {
  background: rgba(255,211,42,0.08);
  border: 1px solid rgba(255,211,42,0.25);
  border-radius: 10px;
  padding: 12px 16px;
  margin-bottom: 20px;
  font-size: 0.78rem;
  color: var(--yellow);
  line-height: 1.6;
  display: none;
}
.config-notice.visible { display: block; }
.config-notice strong { display: block; margin-bottom: 4px; }
@media (min-width: 521px) {
  body { padding-top: 20px; }
}
</style>
</head>
<body>

<div id="screen-top" class="screen active">
  <div class="logo">Q-ROOM</div>
  <div class="tagline">Real-time Quiz Battle</div>

  <div id="config-notice" class="config-notice">
    <strong>âš ï¸ Firebase æœªè¨­å®š</strong>
    ãƒ•ã‚¡ã‚¤ãƒ«ä¸‹éƒ¨ã® <code>firebaseConfig</code> ã‚’ã”è‡ªèº«ã®Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å€¤ã«å·®ã—æ›¿ãˆã¦ãã ã•ã„ã€‚
  </div>

  <div class="card">
    <div class="field">
      <label>Your Name</label>
      <input type="text" id="input-name" placeholder="åå‰ã‚’å…¥åŠ›" maxlength="20" autocomplete="off">
    </div>
    <div class="field">
      <label>Room ID <span style="color:var(--muted);font-weight:400;">(ç©ºç™½ã§ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ)</span></label>
      <div class="room-id-row">
        <input type="text" id="input-roomid" placeholder="ä¾‹: 48291" maxlength="5" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
        <button class="gen-btn" onclick="fillRandomRoomId()">ğŸ² ç”Ÿæˆ</button>
      </div>
    </div>
    <div id="top-error" class="error-msg"></div>
    <button class="btn btn-primary" onclick="handleCreate()">â–¶ Create a Room</button>
    <div class="divider">ã¾ãŸã¯</div>
    <button class="btn btn-secondary" onclick="handleJoin()">â†’ Join the Room</button>
  </div>
</div>

<div id="screen-waiting" class="screen">
  <div class="room-code-block">
    <div class="room-code-label">Room ID</div>
    <div class="room-code-num" id="waiting-room-id">â€”</div>
    <div class="share-row">
      <button class="share-btn" onclick="copyLink()">ğŸ”— ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</button>
      <button class="share-btn" onclick="shareNative()">ğŸ“¤ ã‚·ã‚§ã‚¢</button>
      <button class="share-btn" onclick="copyRoomId()">ğŸ“‹ ID ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>

  <div id="host-settings" style="display:none;">
    <div class="card">
      <h3>ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰</h3>
      <div class="mode-tabs">
        <button class="mode-tab active" onclick="selectMode('survival', this)">mâ—¯nÃ—</button>
        <button class="mode-tab" onclick="selectMode('newyork', this)">New York</button>
      </div>

      <div id="panel-survival" class="settings-panel active">
        <div class="settings-desc">må•æ­£è§£ã§å‹ã¡æŠœã‘ãƒ»nå•èª¤ç­”ã§å¤±æ ¼ã€‚æ­£è§£ã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯è‡ªåˆ†ã§ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚</div>
        <div class="settings-grid">
          <div class="field">
            <label>mï¼ˆå‹ã¡æŠœã‘æ­£è§£æ•°ï¼‰</label>
            <input type="number" id="set-m" value="3" min="1" max="99">
          </div>
          <div class="field">
            <label>nï¼ˆå¤±æ ¼èª¤ç­”æ•°ï¼‰</label>
            <input type="number" id="set-n" value="2" min="1" max="99">
          </div>
        </div>
      </div>

      <div id="panel-newyork" class="settings-panel">
        <div class="settings-desc">1å•æ­£è§£ã§ +x ãƒã‚¤ãƒ³ãƒˆãƒ»1å•èª¤ç­”ã§ âˆ’y ãƒã‚¤ãƒ³ãƒˆã€‚ãƒ›ã‚¹ãƒˆãŒã€Œã‚²ãƒ¼ãƒ çµ‚äº†ã€ã‚’æŠ¼ã—ãŸæ™‚ç‚¹ã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</div>
        <div class="settings-grid">
          <div class="field">
            <label>xï¼ˆæ­£è§£ãƒã‚¤ãƒ³ãƒˆï¼‰</label>
            <input type="number" id="set-x" value="10" min="1" max="999">
          </div>
          <div class="field">
            <label>yï¼ˆèª¤ç­”ãƒã‚¤ãƒŠã‚¹ï¼‰</label>
            <input type="number" id="set-y" value="5" min="0" max="999">
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>å‚åŠ è€… <span id="player-count" style="color:var(--cyan)">0</span> äºº</h3>
    <div id="waiting-player-list" class="player-list">
      <div class="empty-state">å‚åŠ è€…ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
    </div>
  </div>

  <div id="host-start-area" style="display:none;">
    <button class="btn btn-primary" onclick="startGame()">â–¶ ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ / å†é–‹</button>
  </div>
  <div id="player-waiting-msg" class="empty-state" style="display:none;">
    ãƒ›ã‚¹ãƒˆãŒã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ãƒ»å†é–‹ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...
  </div>
</div>

<div id="screen-game" class="screen">
  <div class="game-topbar">
    <div class="game-room-id">ROOM <span id="game-room-id-display">â€”</span></div>
    <div id="mode-pill-display" class="mode-pill">â€”</div>
  </div>

  <div id="game-player-cards" class="player-cards"></div>

  <div id="my-action-panel" class="my-action-panel" style="display:none;">
    <div class="my-action-title">ã‚ãªãŸã®çµæœã‚’è¨˜éŒ²</div>
    <div class="action-row">
      <button class="btn btn-green-solid" id="btn-correct" onclick="recordResult(true)">â­• æ­£è§£</button>
      <button class="btn btn-red-solid"   id="btn-wrong"   onclick="recordResult(false)">âœ– èª¤ç­”</button>
    </div>
  </div>

  <div id="host-game-controls" style="display:none; margin-top: 16px;">
    <button class="btn btn-secondary" onclick="backToWaiting()">âš™ è¨­å®šç”»é¢(å¾…æ©Ÿ)ã«æˆ»ã‚‹</button>
    <button class="btn btn-ghost" onclick="endGame()">â¹ ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã™ã‚‹</button>
  </div>
</div>

<div id="screen-result" class="screen">
  <div class="logo" style="font-size:2rem; margin-bottom: 20px;">RESULT</div>
  <div id="podium-area" class="podium-wrap card"></div>
  <div class="card">
    <h3>æœ€çµ‚ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
    <div id="result-list" class="result-list"></div>
  </div>
  <button class="btn btn-primary" onclick="backToTop()">ğŸ  ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</button>
</div>

<div id="toast" class="toast"></div>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey:            "AIzaSyA3xtGLVJwij2BTiiOk7DsNeF9hIOuZCyI",
  authDomain:        "q-room-fe8a6.firebaseapp.com",
  databaseURL:       "https://q-room-fe8a6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:         "q-room-fe8a6",
  storageBucket:     "q-room-fe8a6.firebasestorage.app",
  messagingSenderId: "151049149394",
  appId:             "1:151049149394:web:7a3ea6406454f6a87d460b"
};

let db;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
} catch(e) {
  document.getElementById('config-notice').classList.add('visible');
}

let myPlayerId    = null;
let currentRoomId = null;
let roomListener  = null;
let isHost        = false;
let currentMode   = 'survival';
let gameSettings  = null;

function getOrCreatePlayerId() {
  let id = localStorage.getItem('qroom_pid');
  if (!id) {
    id = 'p_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
    localStorage.setItem('qroom_pid', id);
  }
  return id;
}

function randomRoomId() {
  return String(Math.floor(10000 + Math.random() * 90000));
}

function fillRandomRoomId() {
  document.getElementById('input-roomid').value = randomRoomId();
}

function showError(id, msg) {
  const el = document.getElementById(id);
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => { el.style.display = 'none'; }, 4000);
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id).classList.add('active');
  window.scrollTo(0, 0);
}

function avatarLetter(name) {
  return (name || '?')[0].toUpperCase();
}

(function checkUrlParams() {
  const params = new URLSearchParams(window.location.search);
  const rid = params.get('room');
  if (rid) {
    document.getElementById('input-roomid').value = rid;
  }
})();

function selectMode(mode, btn) {
  currentMode = mode;
  document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + mode).classList.add('active');
}

async function handleCreate() {
  if (!db) { showToast('Firebase æœªè¨­å®šã§ã™'); return; }
  const name = document.getElementById('input-name').value.trim();
  const ridInput = document.getElementById('input-roomid').value.trim();

  if (!name) { showError('top-error', 'åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  let roomId = ridInput || randomRoomId();
  if (roomId.length !== 5 || !/^\d+$/.test(roomId)) {
    showError('top-error', 'Room IDã¯5æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„'); return;
  }

  const snap = await db.ref('rooms/' + roomId).once('value');
  if (snap.exists()) {
    showError('top-error', 'ãã®Room IDã¯ã™ã§ã«ä½¿ç”¨ä¸­ã§ã™ã€‚åˆ¥ã®IDã‚’è©¦ã—ã¦ãã ã•ã„');
    return;
  }

  myPlayerId = getOrCreatePlayerId();
  isHost = true;
  currentRoomId = roomId;

  const roomData = {
    hostId:    myPlayerId,
    status:    'waiting',
    createdAt: Date.now(),
    settings:  { mode: 'survival', m: 3, n: 2, x: 10, y: 5 },
    players: {
      [myPlayerId]: {
        name:      name,
        correct:   0,
        wrong:     0,
        status:    'active',
        isHost:    true,
        joinedAt:  Date.now()
      }
    }
  };

  await db.ref('rooms/' + roomId).set(roomData);
  updateUrl(roomId);
  enterWaitingRoom(roomId, true);
}

async function handleJoin() {
  if (!db) { showToast('Firebase æœªè¨­å®šã§ã™'); return; }
  const name   = document.getElementById('input-name').value.trim();
  const roomId = document.getElementById('input-roomid').value.trim();

  if (!name)   { showError('top-error', 'åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!roomId) { showError('top-error', 'Room IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (roomId.length !== 5 || !/^\d+$/.test(roomId)) {
    showError('top-error', 'Room IDã¯5æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„'); return;
  }

  const snap = await db.ref('rooms/' + roomId).once('value');
  if (!snap.exists()) {
    showError('top-error', 'Room ID ' + roomId + ' ã®éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }

  const room = snap.val();
  if (room.status === 'finished') {
    showError('top-error', 'ãã®ãƒ«ãƒ¼ãƒ ã¯ã™ã§ã«çµ‚äº†ã—ã¦ã„ã¾ã™');
    return;
  }

  myPlayerId = getOrCreatePlayerId();

  const existingPlayer = room.players && room.players[myPlayerId];
  if (!existingPlayer) {
    await db.ref('rooms/' + roomId + '/players/' + myPlayerId).set({
      name:     name,
      correct:  0,
      wrong:    0,
      status:   'active',
      isHost:   false,
      joinedAt: Date.now()
    });
  }

  isHost = false;
  currentRoomId = roomId;
  updateUrl(roomId);

  if (room.status === 'playing') {
    enterGameScreen(roomId);
  } else if (room.status === 'finished') {
    enterResultScreen(room);
  } else {
    enterWaitingRoom(roomId, false);
  }
}

function updateUrl(roomId) {
  const url = window.location.origin + window.location.pathname + '?room=' + roomId;
  window.history.replaceState({}, '', url);
}

function getRoomUrl() {
  return window.location.origin + window.location.pathname + '?room=' + currentRoomId;
}

function copyLink() {
  navigator.clipboard.writeText(getRoomUrl()).then(() => showToast('ğŸ”— ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
}

function copyRoomId() {
  navigator.clipboard.writeText(currentRoomId).then(() => showToast('ğŸ“‹ Room ID ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
}

function shareNative() {
  if (navigator.share) {
    navigator.share({ title: 'Q-Room', text: 'ã‚¯ã‚¤ã‚ºãƒãƒˆãƒ«ã«å‚åŠ ã—ã‚ˆã†ï¼ Room: ' + currentRoomId, url: getRoomUrl() });
  } else {
    copyLink();
  }
}

function enterWaitingRoom(roomId, asHost) {
  showScreen('waiting');
  document.getElementById('waiting-room-id').textContent = roomId;
  document.getElementById('host-settings').style.display    = asHost ? 'block' : 'none';
  document.getElementById('host-start-area').style.display  = asHost ? 'block' : 'none';
  document.getElementById('player-waiting-msg').style.display = asHost ? 'none' : 'block';

  if (roomListener) roomListener();
  roomListener = db.ref('rooms/' + roomId).on('value', snap => {
    const data = snap.val();
    if (!data) { showToast('ãƒ«ãƒ¼ãƒ ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ'); backToTop(); return; }
    if (data.status === 'playing') { enterGameScreen(roomId); return; }
    if (data.status === 'finished') { enterResultScreen(data); return; }
    renderWaitingPlayers(data);
  });
}

function renderWaitingPlayers(data) {
  const players = data.players || {};
  const sorted  = Object.entries(players).sort((a, b) => a[1].joinedAt - b[1].joinedAt);
  const listEl  = document.getElementById('waiting-player-list');
  document.getElementById('player-count').textContent = sorted.length;

  if (sorted.length === 0) {
    listEl.innerHTML = '<div class="empty-state">å‚åŠ è€…ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>';
    return;
  }

  listEl.innerHTML = sorted.map(([pid, p]) => {
    const isMe   = pid === myPlayerId;
    const isHst  = p.isHost;
    const badges = [
      isHst ? '<span class="badge badge-host">Host</span>' : '',
      isMe  ? '<span class="badge badge-me">You</span>'   : ''
    ].join(' ');
    return `
      <div class="player-item ${isMe ? 'me' : ''}">
        <div class="player-avatar">${avatarLetter(p.name)}</div>
        <span class="player-item-name">${escHtml(p.name)}</span>
        ${badges}
      </div>`;
  }).join('');
}

async function startGame() {
  if (!isHost) return;

  const m = parseInt(document.getElementById('set-m').value) || 3;
  const n = parseInt(document.getElementById('set-n').value) || 2;
  const x = parseInt(document.getElementById('set-x').value) || 10;
  const y = parseInt(document.getElementById('set-y').value) || 5;

  const settings = { mode: currentMode, m, n, x, y };
  gameSettings = settings;

  await db.ref('rooms/' + currentRoomId + '/settings').set(settings);
  await db.ref('rooms/' + currentRoomId + '/status').set('playing');
}

function enterGameScreen(roomId) {
  showScreen('game');
  document.getElementById('game-room-id-display').textContent = roomId;

  if (roomListener) roomListener();
  roomListener = db.ref('rooms/' + roomId).on('value', snap => {
    const data = snap.val();
    if (!data) { backToTop(); return; }
    if (data.status === 'waiting') { enterWaitingRoom(roomId, isHost); return; }
    if (data.status === 'finished') { enterResultScreen(data); return; }
    gameSettings = data.settings;
    renderGameScreen(data);
  });
}

function renderGameScreen(data) {
  const settings = data.settings || {};
  const players  = data.players  || {};
  const sorted   = sortPlayers(players, settings);

  const modeLabel = settings.mode === 'survival'
    ? `mâ—¯nÃ—  (${settings.m}â—‹ / ${settings.n}Ã—)`
    : `NewYork  (+${settings.x} / -${settings.y})`;
  document.getElementById('mode-pill-display').textContent = modeLabel;

  const cardsEl = document.getElementById('game-player-cards');
  cardsEl.innerHTML = sorted.map(([pid, p]) => {
    const isMe     = pid === myPlayerId;
    const statusCls = p.status === 'winner' ? 'pcard-winner' : p.status === 'eliminated' ? 'pcard-eliminated' : '';
    const statusLabel = p.status === 'winner' ? 'WINNER ğŸ†' : p.status === 'eliminated' ? 'ELIMINATED' : 'ACTIVE';
    const statusPillCls = p.status === 'winner' ? 's-winner' : p.status === 'eliminated' ? 's-eliminated' : 's-active';

    let scoreHtml = '';
    if (settings.mode === 'survival') {
      scoreHtml = `
        <div class="pcard-stats">
          <div class="stat-box"><span class="stat-icon">â­•</span><span class="stat-val correct">${p.correct}</span></div>
          <div class="stat-box"><span class="stat-icon">âœ–</span><span class="stat-val wrong">${p.wrong}</span></div>
        </div>`;
    } else {
      const score = (p.correct * settings.x) - (p.wrong * settings.y);
      scoreHtml = `
        <div class="pcard-stats">
          <div class="stat-box"><span class="stat-icon">â­•</span><span class="stat-val correct">${p.correct}</span></div>
          <div class="stat-box"><span class="stat-icon">âœ–</span><span class="stat-val wrong">${p.wrong}</span></div>
          <div class="score-large">${score >= 0 ? '+' : ''}${score}</div>
        </div>`;
    }

    return `
      <div class="pcard ${isMe ? 'pcard-me' : ''} ${statusCls}">
        <div class="pcard-top">
          <div class="player-avatar" style="width:30px;height:30px;font-size:0.8rem;">${avatarLetter(p.name)}</div>
          <span class="pcard-name">${escHtml(p.name)}${p.isHost ? ' ğŸ‘‘' : ''}</span>
          <span class="pcard-status ${statusPillCls}">${statusLabel}</span>
        </div>
        ${scoreHtml}
      </div>`;
  }).join('');

  const myPlayer   = players[myPlayerId];
  const myActive   = myPlayer && myPlayer.status === 'active';
  const actionEl   = document.getElementById('my-action-panel');
  actionEl.style.display = myActive ? 'block' : 'none';

  const hostControlsEl = document.getElementById('host-game-controls');
  hostControlsEl.style.display = isHost ? 'block' : 'none';
}

function sortPlayers(players, settings) {
  return Object.entries(players).sort((a, b) => {
    const [, pa] = a, [, pb] = b;
    const rank = s => s === 'winner' ? 0 : s === 'active' ? 1 : 2;
    if (rank(pa.status) !== rank(pb.status)) return rank(pa.status) - rank(pb.status);
    if (settings.mode === 'newyork') {
      const sa = (pa.correct * settings.x) - (pa.wrong * settings.y);
      const sb = (pb.correct * settings.x) - (pb.wrong * settings.y);
      return sb - sa;
    }
    return pb.correct - pa.correct;
  });
}

async function recordResult(isCorrect) {
  if (!db || !currentRoomId || !myPlayerId) return;

  const playerRef = db.ref('rooms/' + currentRoomId + '/players/' + myPlayerId);
  const snap = await playerRef.once('value');
  const p = snap.val();
  if (!p || p.status !== 'active') return;

  const settings = gameSettings || {};
  const newCorrect = p.correct + (isCorrect ? 1 : 0);
  const newWrong   = p.wrong   + (isCorrect ? 0 : 1);
  let   newStatus  = 'active';

  if (settings.mode === 'survival') {
    if (newCorrect >= settings.m) { newStatus = 'winner'; showToast('ğŸ† å‹ã¡æŠœã‘ãŠã‚ã§ã¨ã†ï¼'); }
    else if (newWrong >= settings.n) { newStatus = 'eliminated'; showToast('ğŸ’€ å¤±æ ¼...'); }
  }

  await playerRef.update({ correct: newCorrect, wrong: newWrong, status: newStatus });

  if (isHost && settings.mode === 'survival') {
    const allSnap = await db.ref('rooms/' + currentRoomId + '/players').once('value');
    const allPlayers = allSnap.val() || {};
    const allDone = Object.values(allPlayers).every(pl => pl.status !== 'active');
    if (allDone) { await db.ref('rooms/' + currentRoomId + '/status').set('finished'); }
  }
}

async function backToWaiting() {
  if (!isHost) return;
  await db.ref('rooms/' + currentRoomId + '/status').set('waiting');
}

async function endGame() {
  if (!isHost) return;
  await db.ref('rooms/' + currentRoomId + '/status').set('finished');
}

function enterResultScreen(data) {
  if (roomListener) { db.ref('rooms/' + currentRoomId).off('value', roomListener); roomListener = null; }
  showScreen('result');
  const settings = data.settings || {};
  const players  = data.players  || {};
  const sorted   = buildResultRanking(players, settings);

  const winner = sorted[0];
  const podiumEl = document.getElementById('podium-area');
  if (winner) {
    podiumEl.innerHTML = `
      <div class="podium-emoji">ğŸ†</div>
      <div class="podium-name">${escHtml(winner[1].name)}</div>
      <div class="podium-sub">${settings.mode === 'survival' ? 'å‹ã¡æŠœã‘é”æˆï¼' : 'ãƒˆãƒƒãƒ—ã‚¹ã‚³ã‚¢ï¼'}</div>`;
  }

  const listEl = document.getElementById('result-list');
  listEl.innerHTML = sorted.map(([pid, p], i) => {
    const rank  = i + 1;
    const rankCls = rank <= 3 ? 'r' + rank : '';
    let scoreStr = '';
    if (settings.mode === 'newyork') {
      const sc = (p.correct * settings.x) - (p.wrong * settings.y);
      scoreStr = `<span class="result-score">${sc >= 0 ? '+' : ''}${sc}pt</span>`;
    } else {
      scoreStr = `<span class="result-score">${p.status === 'winner' ? 'âœ… WIN' : p.status === 'eliminated' ? 'âŒ OUT' : 'â€”'}</span>`;
    }
    return `
      <div class="result-item">
        <div class="result-rank ${rankCls}">${rank}</div>
        <div class="result-name">${escHtml(p.name)}${p.isHost ? ' ğŸ‘‘' : ''}${pid === myPlayerId ? ' <span style="color:var(--cyan);font-size:0.75rem;">(You)</span>' : ''}</div>
        <div class="result-stats">${p.correct}â—‹ ${p.wrong}Ã—</div>
        ${scoreStr}
      </div>`;
  }).join('');
}

function buildResultRanking(players, settings) {
  return Object.entries(players).sort((a, b) => {
    const [, pa] = a, [, pb] = b;
    if (settings.mode === 'newyork') {
      const sa = (pa.correct * settings.x) - (pa.wrong * settings.y);
      const sb = (pb.correct * settings.x) - (pb.wrong * settings.y);
      return sb - sa;
    }
    const rank = s => s === 'winner' ? 0 : s === 'active' ? 1 : 2;
    if (rank(pa.status) !== rank(pb.status)) return rank(pa.status) - rank(pb.status);
    return pb.correct - pa.correct;
  });
}

function backToTop() {
  if (roomListener && currentRoomId) {
    db.ref('rooms/' + currentRoomId).off('value', roomListener);
    roomListener = null;
  }
  currentRoomId = null;
  isHost = false;
  gameSettings = null;
  window.history.replaceState({}, '', window.location.pathname);
  showScreen('top');
}

function escHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

document.getElementById('input-roomid').addEventListener('keydown', e => {
  if (e.key === 'Enter') handleJoin();
});
document.getElementById('input-name').addEventListener('keydown', e => {
  if (e.key === 'Enter') document.getElementById('input-roomid').focus();
});
</script>
</body>
</html>
