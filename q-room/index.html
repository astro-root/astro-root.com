<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Q-ROOM</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=JetBrains+Mono:wght@400;700&family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:    #05050a;
  --s1:    #0d0d18;
  --s2:    #13131f;
  --s3:    #1a1a2a;
  --lime:  #d4ff00;
  --go:    #00ff88;
  --stop:  #ff3030;
  --amber: #ffaa00;
  --text:  #eeeeee;
  --t2:    #888899;
  --muted: #333348;
  --rule:  rgba(212,255,0,0.15);
  --fd:    'Bebas Neue', sans-serif;
  --fm:    'JetBrains Mono', monospace;
  --fb:    'Sora', sans-serif;
}

html, body { height: 100%; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--fb);
  min-height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  overflow-x: hidden;
}
body::before {
  content: '';
  position: fixed; inset: 0;
  background:
    radial-gradient(ellipse 80% 60% at -10% -10%, rgba(212,255,0,0.04) 0%, transparent 55%),
    radial-gradient(ellipse 60% 50% at 110% 110%, rgba(0,255,136,0.03) 0%, transparent 50%);
  pointer-events: none; z-index: 0;
}

/* ‚îÄ‚îÄ Screens ‚îÄ‚îÄ */
.screen {
  display: none; width: 100%; max-width: 480px;
  padding: 0 0 80px; position: relative; z-index: 1;
}
.screen.active { display: block; }

#screen-room {
  position: fixed; inset: 0; left: 50%; transform: translateX(-50%);
  max-width: 480px; width: 100%; padding: 0;
  display: none; flex-direction: column; overflow: hidden; z-index: 1;
}
#screen-room.active { display: flex; }
.room-fixed-top  { flex-shrink: 0; }
.room-scroll-area {
  flex: 1; overflow-y: auto; overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin; scrollbar-color: var(--muted) transparent;
}
.room-fixed-bottom {
  flex-shrink: 0;
  padding-bottom: max(12px, env(safe-area-inset-bottom));
}

/* ‚îÄ‚îÄ TOP PAGE ‚îÄ‚îÄ */
.top-hero {
  padding: 44px 22px 28px;
  border-bottom: 2px solid var(--rule);
  position: relative; overflow: hidden;
}
.top-hero::after {
  content: 'Q';
  position: absolute; right: -4vw; top: -6vw;
  font-family: var(--fd); font-size: min(55vw, 280px);
  color: rgba(212,255,0,0.03); line-height: 1;
  pointer-events: none; user-select: none;
}
.logo {
  font-family: var(--fd);
  font-size: clamp(4rem, 19vw, 7rem);
  color: var(--lime); letter-spacing: 0.06em; line-height: 0.9;
}
.logo-sub {
  font-family: var(--fd);
  font-size: clamp(0.95rem, 3.5vw, 1.5rem);
  color: var(--t2); letter-spacing: 0.3em; margin-top: 6px;
}

.top-form { padding: 24px 20px 0; }
.field { margin-bottom: 18px; }
label {
  display: block;
  font-family: var(--fm); font-size: 0.62rem; font-weight: 700;
  letter-spacing: 0.22em; text-transform: uppercase;
  color: var(--lime); margin-bottom: 8px;
}
input[type="text"], input[type="number"] {
  width: 100%; padding: 13px 14px;
  background: var(--s2); border: 2px solid var(--muted); border-radius: 0;
  color: var(--text); font-family: var(--fb); font-size: 1rem; font-weight: 600;
  outline: none; transition: border-color 0.15s; -webkit-appearance: none;
}
input[type="text"]:focus, input[type="number"]:focus { border-color: var(--lime); }
input::placeholder { color: var(--muted); font-weight: 300; }

.room-id-row { display: flex; }
.room-id-row input {
  flex: 1; border-right: none;
  font-family: var(--fm); font-size: 1.4rem; font-weight: 700;
  letter-spacing: 0.32em;
}
.gen-btn {
  padding: 0 18px; background: var(--s3);
  border: 2px solid var(--muted); border-left: none;
  color: var(--t2); cursor: pointer; font-size: 1.2rem; flex-shrink: 0;
  transition: all 0.15s;
}
.gen-btn:hover { background: var(--lime); color: #000; border-color: var(--lime); }

.error-msg {
  font-family: var(--fm); font-size: 0.7rem; color: var(--stop);
  margin-bottom: 12px; display: none; padding: 8px 12px;
  background: rgba(255,48,48,0.07); border-left: 3px solid var(--stop);
}

.btn {
  display: block; width: 100%; padding: 15px;
  border: none; border-radius: 0; cursor: pointer;
  font-family: var(--fd); font-size: 1.05rem; letter-spacing: 0.14em;
  transition: all 0.12s; margin-bottom: 0;
}
.btn:active { opacity: 0.85; }
.btn-primary { background: var(--lime); color: #000; }
.btn-primary:hover { background: #e8ff22; }
.btn-secondary { background: transparent; border: 2px solid var(--muted); color: var(--t2); }
.btn-secondary:hover { border-color: var(--t2); color: var(--text); }

.divider {
  display: flex; align-items: center; gap: 12px;
  margin: 14px 0;
  color: var(--muted); font-family: var(--fm); font-size: 0.62rem; letter-spacing: 0.15em;
}
.divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--muted); }

.config-notice {
  margin: 20px 20px 0; padding: 12px 14px;
  border-left: 3px solid var(--amber);
  background: rgba(255,170,0,0.05);
  font-family: var(--fm); font-size: 0.7rem; color: var(--amber);
  line-height: 1.6; display: none;
}
.config-notice.visible { display: block; }
.config-notice strong { display: block; margin-bottom: 3px; }

/* ‚îÄ‚îÄ GAME HEADER ‚îÄ‚îÄ */
.game-header {
  background: var(--s1); border-bottom: 2px solid var(--rule);
  padding: 10px 14px; display: flex; align-items: center; gap: 10px;
}
.room-badge {
  font-family: var(--fm); font-size: 0.68rem; font-weight: 700;
  letter-spacing: 0.14em; color: var(--t2);
}
.room-badge span { color: var(--lime); font-size: 0.82rem; }
.mode-tag {
  font-family: var(--fm); font-size: 0.6rem; font-weight: 700;
  letter-spacing: 0.07em; padding: 4px 10px;
  background: rgba(212,255,0,0.07); border: 1px solid rgba(212,255,0,0.2);
  color: var(--lime); text-transform: uppercase;
}
.header-actions { margin-left: auto; display: flex; gap: 6px; }
.hbtn {
  padding: 7px 12px; background: transparent;
  border: 1px solid var(--muted); color: var(--t2);
  font-family: var(--fm); font-size: 0.65rem; letter-spacing: 0.06em;
  cursor: pointer; transition: all 0.15s;
}
.hbtn:hover { border-color: var(--lime); color: var(--lime); }

/* ‚îÄ‚îÄ PLAYER CARDS ‚îÄ‚îÄ */
.player-list { padding: 10px 12px; display: flex; flex-direction: column; gap: 5px; }
.pcard {
  display: flex; align-items: center; gap: 11px;
  padding: 11px 12px;
  background: var(--s2); border: 1px solid var(--muted);
  border-left: 4px solid var(--muted);
  transition: all 0.2s;
}
.pcard-me     { border-left-color: var(--lime); background: rgba(212,255,0,0.025); }
.pcard-winner { border-left-color: var(--go);   background: rgba(0,255,136,0.03); }
.pcard-elim   { opacity: 0.38; filter: grayscale(0.7); }
.pcard-watch  { opacity: 0.5; }

.av {
  width: 30px; height: 30px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  background: var(--s3); border: 1px solid var(--muted);
  font-family: var(--fd); font-size: 0.95rem; color: var(--t2);
}
.pcard-me .av     { border-color: var(--lime); color: var(--lime); background: rgba(212,255,0,0.06); }
.pcard-winner .av { border-color: var(--go);   color: var(--go);   background: rgba(0,255,136,0.06); }

.pcard-body { flex: 1; min-width: 0; }
.pcard-name {
  font-size: 0.88rem; font-weight: 700; white-space: nowrap;
  overflow: hidden; text-overflow: ellipsis;
  display: flex; align-items: center; gap: 6px;
}
.you-chip {
  font-family: var(--fm); font-size: 0.52rem; font-weight: 700;
  letter-spacing: 0.1em; color: var(--lime);
  background: rgba(212,255,0,0.1); padding: 2px 5px; flex-shrink: 0;
}
.pcard-stats {
  display: flex; gap: 10px; align-items: baseline; margin-top: 3px;
}
.pstat { display: flex; align-items: baseline; gap: 3px; }
.pstat-l { font-family: var(--fm); font-size: 0.58rem; color: var(--t2); font-weight: 700; }
.pstat-n { font-family: var(--fm); font-size: 0.95rem; font-weight: 700; line-height: 1; }
.pstat-n.c { color: var(--go); }
.pstat-n.w { color: var(--stop); }

.score-lg {
  font-family: var(--fd); font-size: 1.9rem; line-height: 1;
  letter-spacing: 0.02em; margin-left: auto; flex-shrink: 0; padding-left: 8px;
}
.score-lg.pos { color: var(--lime); }
.score-lg.neg { color: var(--stop); }
.score-lg.zer { color: var(--t2); }

.sbadge {
  font-family: var(--fm); font-size: 0.52rem; font-weight: 700;
  letter-spacing: 0.1em; padding: 3px 7px; text-transform: uppercase; flex-shrink: 0;
}
.sb-a { color: var(--muted); }
.sb-w { color: var(--go);   background: rgba(0,255,136,0.08); }
.sb-e { color: var(--stop); background: rgba(255,48,48,0.08); }
.sb-s { color: var(--muted); }

/* ‚îÄ‚îÄ ACTION PANEL ‚îÄ‚îÄ */
.action-panel {
  padding: 8px 12px 4px;
  background: var(--bg); border-top: 2px solid var(--rule);
}
.ox-row {
  display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 7px;
}
.ox-btn {
  padding: 20px 0; border: none; border-radius: 0; cursor: pointer;
  font-family: var(--fd); font-size: 2.4rem; line-height: 1;
  transition: all 0.1s; position: relative; overflow: hidden;
}
.ox-btn:active { transform: scale(0.96); filter: brightness(0.9); }
.ox-correct { background: var(--go); color: #000; box-shadow: 0 4px 0 #007744; }
.ox-correct:active { box-shadow: none; transform: translateY(4px); }
.ox-wrong   { background: var(--stop); color: #fff; box-shadow: 0 4px 0 #881111; }
.ox-wrong:active   { box-shadow: none; transform: translateY(4px); }

.sub-row { display: flex; gap: 5px; }
.sub-btn {
  padding: 9px 12px; background: transparent;
  border: 1px solid var(--muted); color: var(--t2);
  font-family: var(--fm); font-size: 0.68rem; letter-spacing: 0.06em;
  cursor: pointer; transition: all 0.15s; white-space: nowrap;
}
.sub-btn:hover:not(:disabled) { border-color: var(--lime); color: var(--lime); }
.sub-btn:disabled { opacity: 0.3; cursor: default; }
.sub-btn.undo:hover:not(:disabled) { border-color: var(--amber); color: var(--amber); }
.sub-btn.leave:hover { border-color: var(--stop); color: var(--stop); }
.sub-btn.role { flex: 1; text-align: center; }

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.87);
  backdrop-filter: blur(4px); z-index: 200;
  display: none; align-items: flex-end; justify-content: center;
  opacity: 0; transition: opacity 0.2s;
}
.modal-overlay.active { display: flex; opacity: 1; }
.modal-sheet {
  background: var(--s1); border-top: 3px solid var(--lime);
  width: 100%; max-width: 480px;
  padding: 0 0 max(24px, env(safe-area-inset-bottom));
  max-height: 92vh; overflow-y: auto;
  transform: translateY(100%);
  transition: transform 0.28s cubic-bezier(0.4,0,0.2,1);
}
.modal-overlay.active .modal-sheet { transform: translateY(0); }
.modal-head {
  display: flex; align-items: center; justify-content: space-between;
  padding: 18px 20px 14px; border-bottom: 1px solid var(--muted);
}
.modal-title {
  font-family: var(--fd); font-size: 1.5rem;
  letter-spacing: 0.12em; color: var(--lime);
}
.modal-x {
  width: 28px; height: 28px; background: transparent;
  border: 1px solid var(--muted); color: var(--t2);
  font-size: 0.85rem; cursor: pointer; display: flex;
  align-items: center; justify-content: center; transition: all 0.15s;
}
.modal-x:hover { border-color: var(--stop); color: var(--stop); }
.modal-body { padding: 18px 20px; }

.share-row { display: flex; gap: 5px; margin-bottom: 18px; }
.share-btn {
  flex: 1; padding: 9px 4px; background: var(--s2);
  border: 1px solid var(--muted);
  color: var(--t2); cursor: pointer;
  font-family: var(--fm); font-size: 0.62rem; letter-spacing: 0.07em;
  text-transform: uppercase; transition: all 0.15s; text-align: center;
}
.share-btn:hover { border-color: var(--lime); color: var(--lime); }

.mode-tabs { display: flex; margin-bottom: 14px; }
.mode-tab {
  flex: 1; padding: 9px 4px; background: var(--s2);
  border: 1px solid var(--muted); border-right: none;
  color: var(--t2); cursor: pointer;
  font-family: var(--fm); font-size: 0.68rem; font-weight: 700;
  letter-spacing: 0.07em; transition: all 0.15s; text-align: center;
}
.mode-tab:last-child { border-right: 1px solid var(--muted); }
.mode-tab.active { background: var(--lime); color: #000; border-color: var(--lime); }

.settings-panel { display: none; }
.settings-panel.active { display: block; }
.settings-desc {
  font-size: 0.73rem; color: var(--t2); line-height: 1.7;
  margin-bottom: 12px; padding-left: 8px; border-left: 2px solid var(--muted);
}
.settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
.settings-grid .field { margin-bottom: 0; }
.settings-grid input[type="number"] {
  font-family: var(--fm); font-size: 1.1rem; font-weight: 700;
}
.modal-hr { border: none; border-top: 1px solid var(--muted); margin: 18px 0; }
.btn-reset {
  display: block; width: 100%; padding: 11px; margin-bottom: 7px;
  background: transparent; border: 1px solid var(--muted);
  color: var(--amber); font-family: var(--fm); font-size: 0.72rem;
  letter-spacing: 0.08em; cursor: pointer; text-align: center; transition: all 0.15s;
}
.btn-reset:hover { border-color: var(--amber); background: rgba(255,170,0,0.05); }
.btn-end {
  display: block; width: 100%; padding: 13px;
  background: var(--stop); border: none; color: #fff;
  font-family: var(--fd); font-size: 1.1rem; letter-spacing: 0.12em;
  cursor: pointer; text-align: center; transition: background 0.15s;
}
.btn-end:hover { background: #ff5555; }

/* ‚îÄ‚îÄ RESULT ‚îÄ‚îÄ */
.result-header {
  padding: 30px 20px 22px; border-bottom: 2px solid var(--rule);
}
.result-toprow {
  display: flex; align-items: flex-start; justify-content: space-between; gap: 12px;
}
.result-logo {
  font-family: var(--fd); font-size: clamp(3rem, 14vw, 5.5rem);
  color: var(--lime); letter-spacing: 0.1em; line-height: 1;
}
.result-nav { display: flex; flex-direction: column; gap: 5px; align-items: flex-end; margin-top: 6px; }
.rnav-btn {
  padding: 8px 12px; background: transparent;
  border: 1px solid var(--muted); color: var(--t2);
  font-family: var(--fm); font-size: 0.65rem; letter-spacing: 0.07em;
  cursor: pointer; white-space: nowrap; transition: all 0.15s;
}
.rnav-btn:hover { border-color: var(--lime); color: var(--lime); }

.winner-block {
  margin-top: 18px; padding: 14px 16px;
  background: rgba(0,255,136,0.03); border: 1px solid rgba(0,255,136,0.15);
  border-left: 4px solid var(--go);
}
.winner-label {
  font-family: var(--fm); font-size: 0.58rem; letter-spacing: 0.22em;
  color: var(--go); margin-bottom: 4px; text-transform: uppercase;
}
.winner-name {
  font-family: var(--fd); font-size: clamp(2rem, 9vw, 3.5rem);
  color: var(--text); letter-spacing: 0.06em; line-height: 1;
}

.result-list-wrap { padding: 0 12px 20px; }
.ri {
  display: flex; align-items: center; gap: 11px;
  padding: 11px 12px; border-bottom: 1px solid var(--muted);
  transition: background 0.15s;
}
.ri:first-child { border-top: 1px solid var(--muted); margin-top: 12px; }
.ri:hover { background: var(--s2); }
.ri.ri-1 { background: rgba(0,255,136,0.03); }
.ri-rank {
  font-family: var(--fm); font-size: 0.78rem; font-weight: 700;
  min-width: 22px; color: var(--t2);
}
.ri-rank.r1 { color: var(--lime); font-size: 1rem; }
.ri-rank.r2 { color: #b0b0b0; }
.ri-rank.r3 { color: #b07040; }
.ri-name { flex: 1; font-weight: 700; font-size: 0.88rem; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.ri-stats { font-family: var(--fm); font-size: 0.68rem; color: var(--t2); flex-shrink: 0; }
.ri-score { font-family: var(--fm); font-size: 0.88rem; font-weight: 700; color: var(--lime); min-width: 52px; text-align: right; flex-shrink: 0; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast {
  position: fixed; bottom: 28px; left: 50%;
  transform: translateX(-50%) translateY(60px);
  background: var(--s3); border: 1px solid var(--lime);
  border-left: 3px solid var(--lime);
  color: var(--text); padding: 9px 20px;
  font-family: var(--fm); font-size: 0.75rem; letter-spacing: 0.05em;
  opacity: 0; transition: all 0.25s cubic-bezier(0.34,1.56,0.64,1);
  pointer-events: none; z-index: 9999; white-space: nowrap;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

@media (min-width: 481px) {
  body { padding-top: 20px; }
  .modal-overlay { align-items: center; }
  .modal-sheet {
    border: 2px solid var(--lime); border-top: 3px solid var(--lime);
    max-width: 420px;
    transform: scale(0.95) translateY(16px);
    transition: transform 0.25s cubic-bezier(0.4,0,0.2,1);
  }
  .modal-overlay.active .modal-sheet { transform: scale(1) translateY(0); }
}
</style>
</head>
<body>

<!-- TOP -->
<div id="screen-top" class="screen active">
  <div class="top-hero">
    <div class="logo">Q-ROOM</div>
    <div class="logo-sub">REAL-TIME QUIZ BATTLE</div>
  </div>

  <div id="config-notice" class="config-notice">
    <strong>‚ö† FIREBASE Êú™Ë®≠ÂÆö</strong>
    „Éï„Ç°„Ç§„É´‰∏ãÈÉ®„ÅÆ firebaseConfig „ÇíÊõ∏„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
  </div>

  <div class="top-form">
    <div class="field">
      <label>Your Name</label>
      <input type="text" id="input-name" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ" maxlength="20" autocomplete="off">
    </div>
    <div class="field">
      <label>Room ID &nbsp;<span style="color:var(--muted);font-weight:300;font-family:var(--fb);text-transform:none;letter-spacing:0">(Á©∫ÁôΩ„Åß„É©„É≥„ÉÄ„É†ÁîüÊàê)</span></label>
      <div class="room-id-row">
        <input type="text" id="input-roomid" placeholder="_ _ _ _ _" maxlength="5" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
        <button class="gen-btn" onclick="fillRandomRoomId()">üé≤</button>
      </div>
    </div>
    <div id="top-error" class="error-msg"></div>
    <button class="btn btn-primary" onclick="handleCreate()">CREATE ROOM</button>
    <div class="divider">OR</div>
    <button class="btn btn-secondary" onclick="handleJoin()">JOIN ROOM</button>
  </div>
</div>

<!-- ROOM -->
<div id="screen-room" class="screen">
  <div class="room-fixed-top">
    <div class="game-header">
      <div class="room-badge">ROOM <span id="game-room-id-display">‚Äî</span></div>
      <div id="mode-tag-display" class="mode-tag">‚Äî</div>
      <div class="header-actions">
        <button class="hbtn" onclick="openSettings()">‚öô Ë®≠ÂÆö</button>
      </div>
    </div>
  </div>

  <div class="room-scroll-area">
    <div id="game-player-list" class="player-list"></div>
  </div>

  <div class="room-fixed-bottom">
    <div class="action-panel">
      <div class="ox-row" id="ox-row" style="display:none;">
        <button class="ox-btn ox-correct" onclick="recordResult(true)">‚óã</button>
        <button class="ox-btn ox-wrong"   onclick="recordResult(false)">‚úï</button>
      </div>
      <div class="sub-row">
        <button class="sub-btn undo" id="btn-undo" onclick="undoResult()" disabled>‚Ü© UNDO</button>
        <button class="sub-btn role" id="btn-role" onclick="toggleMyRole()">üëÄ Ë¶≥Êà¶</button>
        <button class="sub-btn leave" onclick="leaveRoom()">‚Üê ÈÄÄÂÆ§</button>
      </div>
    </div>
  </div>
</div>

<!-- RESULT -->
<div id="screen-result" class="screen">
  <div class="result-header">
    <div class="result-toprow">
      <div class="result-logo">RESULT</div>
      <div class="result-nav">
        <button class="rnav-btn" onclick="returnToRoom()">‚Üê ÈÉ®Â±ã„Å´Êàª„Çã</button>
        <button class="rnav-btn" onclick="leaveRoom()">üè† TOP</button>
      </div>
    </div>
    <div id="winner-block"></div>
  </div>
  <div id="result-list-wrap" class="result-list-wrap"></div>
</div>

<!-- SETTINGS MODAL -->
<div id="settings-modal" class="modal-overlay" onclick="handleModalBg(event)">
  <div class="modal-sheet">
    <div class="modal-head">
      <div class="modal-title">SETTINGS</div>
      <button class="modal-x" onclick="closeSettings()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="share-row">
        <button class="share-btn" onclick="copyLink()">üîó URL</button>
        <button class="share-btn" onclick="copyRoomId()">üìã ID</button>
        <button class="share-btn" onclick="shareNative()">üì§ „Ç∑„Çß„Ç¢</button>
      </div>

      <div class="mode-tabs">
        <button class="mode-tab active" id="tab-survival"  onclick="updateMode('survival')">m‚óØn√ó</button>
        <button class="mode-tab"        id="tab-newyork"   onclick="updateMode('newyork')">NY</button>
        <button class="mode-tab"        id="tab-freecount" onclick="updateMode('freecount')">FREE</button>
      </div>

      <div id="panel-survival" class="settings-panel active">
        <div class="settings-desc">mÂïèÊ≠£Ëß£„ÅßÂãù„Å°Êäú„Åë„ÉªnÂïèË™§Á≠î„ÅßÂ§±Ê†º„ÄÇ</div>
        <div class="settings-grid">
          <div class="field"><label>m (Âãù„Å°Êäú„Åë)</label><input type="number" id="set-m" value="3" min="1" max="99" onchange="updateSettings()"></div>
          <div class="field"><label>n (Â§±Ê†º)</label><input type="number" id="set-n" value="2" min="1" max="99" onchange="updateSettings()"></div>
        </div>
      </div>
      <div id="panel-newyork" class="settings-panel">
        <div class="settings-desc">Ê≠£Ëß£+x pt / Ë™§Á≠î‚àíy pt„ÄÇ„Éõ„Çπ„Éà„ÅåÁµÇ‰∫Ü„Åô„Çã„Åæ„ÅßÁ∂ôÁ∂ö„ÄÇ</div>
        <div class="settings-grid">
          <div class="field"><label>x (Ê≠£Ëß£pt)</label><input type="number" id="set-x" value="10" min="1" max="999" onchange="updateSettings()"></div>
          <div class="field"><label>y (Ë™§Á≠î‚àí)</label><input type="number" id="set-y" value="5" min="0" max="999" onchange="updateSettings()"></div>
        </div>
      </div>
      <div id="panel-freecount" class="settings-panel">
        <div class="settings-desc">Âãù„Å°Êäú„Åë„ÉªÂ§±Ê†º„Å™„Åó„ÄÇÊ≠£Ëß£Êï∞„Å®Ë™§Á≠îÊï∞„Çí„Ç´„Ç¶„É≥„Éà„Åô„Çã„Å†„Åë„ÄÇ„Éï„É™„Éê„ÉªÁ∑¥ÁøíÁî®„ÄÇÁµÇ‰∫ÜÊôÇ„Å´Ê≠£Ëß£Êï∞È†Ü„Åß„É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫„ÄÇ</div>
      </div>

      <div class="modal-hr"></div>
      <button class="btn-reset" onclick="resetPoints()">üîÑ ÂÖ®Âì°„ÅÆ„Éù„Ç§„É≥„Éà„Çí„É™„Çª„ÉÉ„Éà</button>
      <button class="btn-end"   onclick="endGame()">FINISH GAME</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey:            "AIzaSyA3xtGLVJwij2BTiiOk7DsNeF9hIOuZCyI",
  authDomain:        "q-room-fe8a6.firebaseapp.com",
  databaseURL:       "https://q-room-fe8a6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:         "q-room-fe8a6",
  storageBucket:     "q-room-fe8a6.firebasestorage.app",
  messagingSenderId: "151049149394",
  appId:             "1:151049149394:web:7a3ea6406454f6a87d460b"
};

// Firebase „ÅØ Create/Join „Éú„Çø„É≥„ÇíÊäº„Åô„Åæ„ÅßÂàùÊúüÂåñ„Åó„Å™„ÅÑ
// .once()/.on() ÂàùÂõûÂëºÂá∫„ÅßWebSocketÊé•Á∂ö„ÅåÁ¢∫Á´ã„Åï„Çå„Çã„Åü„ÇÅ
// „Éà„ÉÉ„Éó„Éö„Éº„Ç∏„ÇíÈñã„ÅÑ„Åü„Å†„Åë„Åß„ÅØ‰∏ÄÂàáÊé•Á∂ö„Åó„Å™„ÅÑ
let db = null;
function ensureFirebase() {
  if (db) return true;
  try {
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    return true;
  } catch(e) {
    document.getElementById('config-notice').classList.add('visible');
    return false;
  }
}

let myPlayerId = null, currentRoomId = null;
let roomRef = null, roomCallback = null;
let currentMode = 'survival', gameSettings = null, lastAction = null;

window.addEventListener('DOMContentLoaded', () => checkUrlParams());

function getOrCreatePlayerId() {
  let id = localStorage.getItem('qroom_pid');
  if (!id) { id = 'p_' + Date.now().toString(36) + Math.random().toString(36).slice(2,7); localStorage.setItem('qroom_pid', id); }
  return id;
}
function randomRoomId() { return String(Math.floor(10000 + Math.random() * 90000)); }
function fillRandomRoomId() { document.getElementById('input-roomid').value = randomRoomId(); }

function showError(id, msg) {
  const el = document.getElementById(id); el.textContent = msg; el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 4000);
}
function showToast(msg) {
  const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id).classList.add('active');
  window.scrollTo(0, 0);
}
function avatarLetter(n) { return (n || '?')[0].toUpperCase(); }

function checkUrlParams() {
  const pr = window.location.pathname.replace(/\//g, '');
  const rid = pr || new URLSearchParams(window.location.search).get('room');
  if (rid && /^\d{5}$/.test(rid)) document.getElementById('input-roomid').value = rid;
}

function selectModeUI(mode) {
  currentMode = mode;
  document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
  const tab = document.getElementById('tab-' + mode); if (tab) tab.classList.add('active');
  document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
  const panel = document.getElementById('panel-' + mode); if (panel) panel.classList.add('active');
}
async function updateMode(mode) {
  selectModeUI(mode);
  if (db && currentRoomId) await db.ref(`rooms/${currentRoomId}/settings/mode`).set(mode);
}
async function updateSettings() {
  if (!db || !currentRoomId) return;
  await db.ref(`rooms/${currentRoomId}/settings`).update({
    m: parseInt(document.getElementById('set-m').value) || 3,
    n: parseInt(document.getElementById('set-n').value) || 2,
    x: parseInt(document.getElementById('set-x').value) || 10,
    y: parseInt(document.getElementById('set-y').value) || 5,
  });
}

function setupPresence() {
  if (!db || !currentRoomId || !myPlayerId) return;
  const ref = db.ref(`rooms/${currentRoomId}/players/${myPlayerId}`);
  ref.child('online').set(true);
  ref.child('lastActive').set(firebase.database.ServerValue.TIMESTAMP);
  ref.child('online').onDisconnect().set(false);
  ref.child('lastActive').onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
}

async function cleanupOldRooms() {
  if (!db) return;
  try {
    const snap = await db.ref('rooms').once('value');
    const rooms = snap.val() || {}, now = Date.now();
    for (const [rid, room] of Object.entries(rooms)) {
      const pl = room.players || {};
      if (Object.values(pl).some(p => p.online)) continue;
      let last = room.createdAt || 0;
      for (const p of Object.values(pl)) if ((p.lastActive || 0) > last) last = p.lastActive;
      if (now - last > 5 * 60 * 1000) await db.ref('rooms/' + rid).remove();
    }
  } catch(e) { console.warn('cleanup', e); }
}

function detachListener() {
  if (roomRef && roomCallback) { roomRef.off('value', roomCallback); roomRef = null; roomCallback = null; }
}

async function handleCreate() {
  if (!ensureFirebase()) return;
  const name = document.getElementById('input-name').value.trim();
  const rid  = document.getElementById('input-roomid').value.trim();
  if (!name) { showError('top-error', 'ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
  let roomId = rid || randomRoomId();
  if (roomId.length !== 5 || !/^\d+$/.test(roomId)) { showError('top-error', 'Room ID„ÅØ5Ê°Å„ÅÆÊï∞Â≠ó„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
  await cleanupOldRooms();
  if ((await db.ref('rooms/' + roomId).once('value')).exists()) { showError('top-error', '„Åù„ÅÆRoom ID„ÅØ„Åô„Åß„Å´‰ΩøÁî®‰∏≠„Åß„Åô'); return; }
  myPlayerId = getOrCreatePlayerId(); currentRoomId = roomId;
  await db.ref('rooms/' + roomId).set({
    hostId: myPlayerId, status: 'playing',
    createdAt: firebase.database.ServerValue.TIMESTAMP,
    settings: { mode: 'survival', m: 3, n: 2, x: 10, y: 5 },
    players: { [myPlayerId]: { name, correct: 0, wrong: 0, status: 'active',
      joinedAt: firebase.database.ServerValue.TIMESTAMP, online: true,
      lastActive: firebase.database.ServerValue.TIMESTAMP } }
  });
  setupPresence(); updateUrl(roomId); enterRoom(roomId);
}

async function handleJoin() {
  if (!ensureFirebase()) return;
  const name   = document.getElementById('input-name').value.trim();
  const roomId = document.getElementById('input-roomid').value.trim();
  if (!name)   { showError('top-error', 'ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
  if (!roomId) { showError('top-error', 'Room ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
  if (roomId.length !== 5 || !/^\d+$/.test(roomId)) { showError('top-error', 'Room ID„ÅØ5Ê°Å„ÅÆÊï∞Â≠ó„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
  const snap = await db.ref('rooms/' + roomId).once('value');
  if (!snap.exists()) { showError('top-error', 'Room ' + roomId + ' „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'); return; }
  const room = snap.val();
  myPlayerId = getOrCreatePlayerId();
  if (!(room.players && room.players[myPlayerId])) {
    await db.ref('rooms/' + roomId + '/players/' + myPlayerId).set({ name, correct: 0, wrong: 0, status: 'active',
      joinedAt: firebase.database.ServerValue.TIMESTAMP, online: true, lastActive: firebase.database.ServerValue.TIMESTAMP });
  } else {
    await db.ref(`rooms/${roomId}/players/${myPlayerId}`).update({ online: true, lastActive: firebase.database.ServerValue.TIMESTAMP });
  }
  currentRoomId = roomId; setupPresence(); updateUrl(roomId);
  if (room.status === 'finished') enterResultScreen(room); else enterRoom(roomId);
}

function updateUrl(r) { window.history.replaceState({}, '', window.location.origin + '/' + r); }
function getRoomUrl() { return window.location.origin + '/' + currentRoomId; }
function copyLink()   { navigator.clipboard.writeText(getRoomUrl()).then(() => showToast('üîó URL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü')); }
function copyRoomId() { navigator.clipboard.writeText(currentRoomId).then(() => showToast('üìã Room ID„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü')); }
function shareNative() {
  if (navigator.share) navigator.share({ title: 'Q-Room', text: 'Room: ' + currentRoomId, url: getRoomUrl() });
  else copyLink();
}

function leaveRoom() {
  if (db && currentRoomId && myPlayerId) db.ref(`rooms/${currentRoomId}/players/${myPlayerId}`).remove();
  backToTop();
}
function backToTop() {
  detachListener();
  if (db && currentRoomId && myPlayerId) {
    const r = db.ref(`rooms/${currentRoomId}/players/${myPlayerId}`);
    r.child('online').onDisconnect().cancel(); r.child('lastActive').onDisconnect().cancel();
  }
  if (db) { db.goOffline(); db = null; }
  currentRoomId = null; gameSettings = null; lastAction = null;
  window.history.replaceState({}, '', '/');
  showScreen('top');
}

function openSettings()  { document.getElementById('settings-modal').classList.add('active'); }
function closeSettings() { document.getElementById('settings-modal').classList.remove('active'); }
function handleModalBg(e) { if (e.target === document.getElementById('settings-modal')) closeSettings(); }

function enterRoom(roomId) {
  showScreen('room');
  document.getElementById('game-room-id-display').textContent = roomId;
  detachListener();
  roomRef = db.ref('rooms/' + roomId);
  roomCallback = roomRef.on('value', snap => {
    const data = snap.val();
    if (!data) { showToast('„É´„Éº„É†„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü'); backToTop(); return; }
    if (data.status === 'finished') { enterResultScreen(data); return; }
    gameSettings = data.settings;
    if (data.settings) {
      const s = data.settings;
      if (document.activeElement !== document.getElementById('set-m')) document.getElementById('set-m').value = s.m;
      if (document.activeElement !== document.getElementById('set-n')) document.getElementById('set-n').value = s.n;
      if (document.activeElement !== document.getElementById('set-x')) document.getElementById('set-x').value = s.x;
      if (document.activeElement !== document.getElementById('set-y')) document.getElementById('set-y').value = s.y;
      if (currentMode !== s.mode) selectModeUI(s.mode);
    }
    renderGameScreen(data);
  });
}

function renderGameScreen(data) {
  const s  = data.settings || {}, pl = data.players || {};
  const sorted = sortPlayers(pl, s);
  document.getElementById('mode-tag-display').textContent =
    s.mode === 'survival' ? `m‚óØn√ó  ${s.m}‚óã ${s.n}√ó`
    : s.mode === 'newyork' ? `NY +${s.x}/-${s.y}` : 'FREE';

  document.getElementById('game-player-list').innerHTML = sorted.map(([pid, p]) => {
    const isMe = pid === myPlayerId, isSp = p.status === 'spectator';
    const cls  = p.status === 'winner' ? 'pcard-winner' : p.status === 'eliminated' ? 'pcard-elim'
      : isSp ? 'pcard-watch' : isMe ? 'pcard-me' : '';
    const sbc  = p.status === 'winner' ? 'sb-w' : p.status === 'eliminated' ? 'sb-e' : isSp ? 'sb-s' : 'sb-a';
    const sbl  = p.status === 'winner' ? 'WIN' : p.status === 'eliminated' ? 'OUT' : isSp ? 'WATCH' : 'ACTIVE';

    let body = '';
    if (!isSp) {
      if (s.mode === 'newyork') {
        const sc = (p.correct * s.x) - (p.wrong * s.y);
        body = `<div class="pcard-stats">
          <div class="pstat"><span class="pstat-l">‚óã</span><span class="pstat-n c">${p.correct}</span></div>
          <div class="pstat"><span class="pstat-l">‚úï</span><span class="pstat-n w">${p.wrong}</span></div>
        </div><div class="score-lg ${sc>0?'pos':sc<0?'neg':'zer'}">${sc>0?'+':''}${sc}</div>`;
      } else {
        body = `<div class="pcard-stats">
          <div class="pstat"><span class="pstat-l">‚óã</span><span class="pstat-n c">${p.correct}</span></div>
          <div class="pstat"><span class="pstat-l">‚úï</span><span class="pstat-n w">${p.wrong}</span></div>
        </div>`;
      }
    }

    return `<div class="pcard ${cls}">
      <div class="av"${isSp?' style="opacity:0.35"':''}>${avatarLetter(p.name)}</div>
      <div class="pcard-body">
        <div class="pcard-name">${escHtml(p.name)}${isMe?'<span class="you-chip">YOU</span>':''}</div>
        ${body}
      </div>
      <span class="sbadge ${sbc}">${sbl}</span>
    </div>`;
  }).join('');

  const me = pl[myPlayerId];
  if (me) {
    const isSp = me.status === 'spectator';
    document.getElementById('ox-row').style.display   = isSp ? 'none' : 'grid';
    document.getElementById('btn-undo').disabled       = (lastAction === null);
    document.getElementById('btn-role').textContent    = isSp ? 'üéÆ ÂèÇÂä†' : 'üëÄ Ë¶≥Êà¶';
  }
}

function sortPlayers(pl, s) {
  return Object.entries(pl).sort((a, b) => {
    const [, pa] = a, [, pb] = b;
    const r = v => v==='winner'?0:v==='active'?1:v==='eliminated'?2:3;
    if (r(pa.status) !== r(pb.status)) return r(pa.status) - r(pb.status);
    if (s.mode === 'newyork') return ((pb.correct*s.x)-(pb.wrong*s.y)) - ((pa.correct*s.x)-(pa.wrong*s.y));
    return pb.correct - pa.correct;
  });
}

async function recordResult(isCorrect) {
  if (!db || !currentRoomId || !myPlayerId) return;
  const ref = db.ref('rooms/' + currentRoomId + '/players/' + myPlayerId);
  const p   = (await ref.once('value')).val();
  if (!p || p.status === 'spectator') return;
  const s = gameSettings || {}, nc = p.correct+(isCorrect?1:0), nw = p.wrong+(isCorrect?0:1);
  let ns = p.status;
  if (s.mode === 'survival' && p.status === 'active') {
    if (nc >= s.m)      { ns = 'winner';     showToast('üèÜ Âãù„Å°Êäú„Åë„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ'); }
    else if (nw >= s.n) { ns = 'eliminated'; showToast('üíÄ Â§±Ê†º...'); }
  }
  lastAction = { prevCorrect: p.correct, prevWrong: p.wrong, prevStatus: p.status };
  document.getElementById('btn-undo').disabled = false;
  await ref.update({ correct: nc, wrong: nw, status: ns });
}

async function undoResult() {
  if (!db || !currentRoomId || !myPlayerId || !lastAction) return;
  await db.ref('rooms/' + currentRoomId + '/players/' + myPlayerId).update({
    correct: lastAction.prevCorrect, wrong: lastAction.prevWrong, status: lastAction.prevStatus
  });
  lastAction = null; document.getElementById('btn-undo').disabled = true;
  showToast('‚Ü© Âèñ„ÇäÊ∂à„Åó„Åæ„Åó„Åü');
}

async function toggleMyRole() {
  if (!db || !currentRoomId || !myPlayerId) return;
  const ref = db.ref(`rooms/${currentRoomId}/players/${myPlayerId}/status`);
  await ref.set((await ref.once('value')).val() === 'spectator' ? 'active' : 'spectator');
}

async function resetPoints() {
  if (!confirm('ÂÖ®Âì°„ÅÆ„Çπ„Ç≥„Ç¢„Çí0„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) return;
  const pl = (await db.ref(`rooms/${currentRoomId}/players`).once('value')).val() || {};
  const upd = {};
  for (const pid in pl) {
    upd[`${pid}/correct`] = 0; upd[`${pid}/wrong`] = 0;
    if (pl[pid].status !== 'spectator') upd[`${pid}/status`] = 'active';
  }
  await db.ref(`rooms/${currentRoomId}/players`).update(upd);
  lastAction = null; document.getElementById('btn-undo').disabled = true;
  showToast('„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü'); closeSettings();
}

async function endGame() {
  if (confirm('„Ç≤„Éº„É†„ÇíÁµÇ‰∫Ü„Åó„Å¶ÁµêÊûú„ÇíË°®Á§∫„Åó„Åæ„Åô„ÅãÔºü')) {
    await db.ref('rooms/' + currentRoomId + '/status').set('finished'); closeSettings();
  }
}

function returnToRoom() {
  if (!currentRoomId) { backToTop(); return; }
  db.ref('rooms/' + currentRoomId + '/status').set('playing');
  enterRoom(currentRoomId);
}

function enterResultScreen(data) {
  detachListener(); showScreen('result');
  const s = data.settings || {}, pl = data.players || {};
  const sorted = buildResultRanking(pl, s).filter(([, p]) => p.status !== 'spectator');
  const win = sorted[0];
  document.getElementById('winner-block').innerHTML = win ? `
    <div class="winner-block">
      <div class="winner-label">‚ñ∏ WINNER</div>
      <div class="winner-name">${escHtml(win[1].name)}</div>
    </div>` : '';

  const medals = ['ü•á','ü•à','ü•â'];
  document.getElementById('result-list-wrap').innerHTML = sorted.map(([pid, p], i) => {
    const rk = i+1, rkc = rk<=3?'r'+rk:'', ric = rk===1?'ri-1':'';
    let sc = s.mode === 'newyork' ? `${((p.correct*s.x)-(p.wrong*s.y))>=0?'+':''}${(p.correct*s.x)-(p.wrong*s.y)}pt`
      : s.mode === 'freecount' ? `${p.correct}‚óã`
      : p.status === 'winner' ? 'WIN' : p.status === 'eliminated' ? 'OUT' : '‚Äî';
    return `<div class="ri ${ric}">
      <div class="ri-rank ${rkc}">${rk<=3?medals[rk-1]:rk}</div>
      <div class="ri-name">${escHtml(p.name)}${pid===myPlayerId?' <span style="font-size:0.65rem;color:var(--lime)">(You)</span>':''}</div>
      <div class="ri-stats">${p.correct}‚óã ${p.wrong}‚úï</div>
      <div class="ri-score">${sc}</div>
    </div>`;
  }).join('');
}

function buildResultRanking(pl, s) {
  return Object.entries(pl).sort((a, b) => {
    const [, pa] = a, [, pb] = b;
    if (s.mode === 'newyork') return ((pb.correct*s.x)-(pb.wrong*s.y)) - ((pa.correct*s.x)-(pa.wrong*s.y));
    if (s.mode === 'freecount') return pb.correct !== pa.correct ? pb.correct - pa.correct : pa.wrong - pb.wrong;
    const r = v => v==='winner'?0:v==='active'?1:v==='eliminated'?2:3;
    return r(pa.status) !== r(pb.status) ? r(pa.status)-r(pb.status) : pb.correct - pa.correct;
  });
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

document.getElementById('input-roomid').addEventListener('keydown', e => { if(e.key==='Enter') handleJoin(); });
document.getElementById('input-name').addEventListener('keydown',   e => { if(e.key==='Enter') document.getElementById('input-roomid').focus(); });
</script>
</body>
</html>
