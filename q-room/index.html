<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Q-Room | „Ç™„É≥„É©„Ç§„É≥„ÇØ„Ç§„Ç∫„É´„Éº„É†</title>
<meta name="description" content="Q-Room„ÅØ„ÄÅ„É™„Ç¢„É´„Çø„Ç§„É†„ÅßÈÄ≤Ë°å„Åô„ÇãÂ§öÊ©üËÉΩ„Å™„Ç™„É≥„É©„Ç§„É≥„ÇØ„Ç§„Ç∫„Ç∑„Çπ„ÉÜ„É†„Åß„Åô„ÄÇËá™Ë∫´„ÅßÈÉ®Â±ã„Çí‰ΩúÊàê„Åó„ÄÅNewYork„ÇÑ„Ç¢„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Å™„Å©Êßò„ÄÖ„Å™„É´„Éº„É´„Çí„Ç™„É≥„É©„Ç§„É≥„Åß„Åø„Çì„Å™„Å®„ÇØ„Ç§„Ç∫ÂØæÊà¶„ÇíÊ•Ω„Åó„ÇÅ„Åæ„Åô„ÄÇ">
<link rel="canonical" href="https://astro-root.com/q-room/">
<meta property="og:title" content="Q-Room | Online Quiz Room">
<meta property="og:description" content="„É™„Ç¢„É´„Çø„Ç§„É†„ÅßÈÄ≤Ë°å„Åô„ÇãÂ§öÊ©üËÉΩ„Å™„Ç™„É≥„É©„Ç§„É≥„ÇØ„Ç§„Ç∫„Ç∑„Çπ„ÉÜ„É†„ÄÇÊßò„ÄÖ„Å™„É´„Éº„É´„ÅÆ„ÇØ„Ç§„Ç∫ÈÉ®Â±ã„Çí‰ΩúÊàê„ÉªÂèÇÂä†„Åß„Åç„Åæ„Åô„ÄÇ">
<meta property="og:url" content="https://astro-root.com/q-room/">
<meta property="og:type" content="website">
<meta property="og:site_name" content="Q-Room">
<meta name="twitter:card" content="summary">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+JP:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg-color: #09090b;
  --surface-color: rgba(24, 24, 27, 0.75);
  --surface-highlight: rgba(255, 255, 255, 0.12);
  --border-color: rgba(255, 255, 255, 0.1);
  --cyan: #06b6d4;
  --magenta: #e11d48;
  --green: #10b981;
  --red: #ef4444;
  --yellow: #f59e0b;
  --text-main: #f4f4f5;
  --text-muted: #a1a1aa;
  --font-en: 'Inter', sans-serif;
  --font-ja: 'Noto Sans JP', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
  --glass-blur: blur(24px);
}
html, body { min-height: 100vh; }
body {
  background-color: var(--bg-color);
  background-image: 
    radial-gradient(circle at 10% 10%, rgba(6, 182, 212, 0.08) 0%, transparent 50%),
    radial-gradient(circle at 90% 90%, rgba(225, 29, 72, 0.08) 0%, transparent 50%);
  background-attachment: fixed;
  color: var(--text-main);
  font-family: var(--font-ja);
  display: flex;
  justify-content: center;
  align-items: flex-start;
  overflow-x: hidden;
}
.screen {
  display: none; 
  flex-direction: column;
  width: 100%; 
  max-width: 540px;
  min-height: 100vh;
  position: relative; 
  z-index: 1; 
  background: var(--bg-color);
  box-shadow: 0 0 60px rgba(0,0,0,0.9), 0 0 2px rgba(255,255,255,0.05);
  animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
.screen.active { display: flex; }
#screen-top, #screen-result { padding: 0 0 80px; }
#screen-room { height: 100vh; padding: 0; overflow: hidden; }
@media (max-width: 540px) {
  .screen { box-shadow: none; }
}
.scroll-area {
  flex: 1; overflow-y: auto; overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  padding-bottom: 24px;
}
.hero { padding: 100px 20px 60px; text-align: center; }
.logo {
  font-family: var(--font-en); font-size: 4rem; font-weight: 900;
  background: linear-gradient(135deg, #ffffff, var(--cyan));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  letter-spacing: 0.08em; margin-bottom: 16px;
  filter: drop-shadow(0 8px 24px rgba(6,182,212,0.4));
}
.logo-sub { font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-muted); letter-spacing: 0.25em; }
.form-wrap { padding: 0 32px; }
.field { margin-bottom: 28px; }
label {
  display: block; font-family: var(--font-en); font-size: 0.85rem; color: var(--cyan); font-weight: 700;
  margin-bottom: 12px; letter-spacing: 0.15em; text-transform: uppercase;
}
input[type="text"], input[type="number"], select, textarea {
  width: 100%; padding: 20px;
  background: var(--surface-color); backdrop-filter: var(--glass-blur);
  border: 1px solid var(--border-color); border-radius: 16px;
  color: var(--text-main); font-family: var(--font-ja); font-size: 1.05rem;
  outline: none; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); appearance: none;
}
textarea { resize: vertical; min-height: 140px; line-height: 1.6; }
input:focus, select:focus, textarea:focus {
  border-color: var(--cyan);
  background: rgba(6, 182, 212, 0.08);
  box-shadow: 0 0 0 4px rgba(6,182,212,0.15);
  transform: translateY(-2px);
}
select { cursor: pointer; }
select option { background-color: var(--bg-color); color: var(--text-main); }
.row { display: flex; gap: 16px; }
.btn-gen {
  padding: 0 24px; background: var(--surface-color); border: 1px solid var(--border-color);
  border-radius: 16px; cursor: pointer; color: var(--text-main); font-size: 1.4rem; transition: 0.3s;
  backdrop-filter: var(--glass-blur);
}
.btn-gen:hover { border-color: var(--cyan); background: rgba(6,182,212,0.1); transform: translateY(-2px); }
.btn {
  width: 100%; padding: 20px; border: none; border-radius: 16px; cursor: pointer;
  font-family: var(--font-en); font-weight: 700; font-size: 1.05rem; letter-spacing: 0.15em;
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); position: relative; overflow: hidden;
}
.btn:active { transform: scale(0.97); }
.btn-pri {
  background: linear-gradient(135deg, var(--cyan), #0284c7); color: #fff;
  box-shadow: 0 10px 30px rgba(6,182,212,0.3); border: 1px solid rgba(255,255,255,0.15);
}
.btn-pri:hover { box-shadow: 0 16px 40px rgba(6,182,212,0.45); transform: translateY(-3px); }
.btn-sec { background: var(--surface-color); border: 1px solid var(--border-color); color: var(--text-main); backdrop-filter: var(--glass-blur); }
.btn-sec:hover { border-color: rgba(255,255,255,0.3); background: var(--surface-highlight); transform: translateY(-3px); }
.btn-warn { background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.4); color: var(--red); }
.btn-warn:hover { background: rgba(239,68,68,0.25); border-color: var(--red); transform: translateY(-2px); }
.btn-ghost { background: transparent; color: var(--text-muted); font-size: 0.9rem; font-weight: 400; text-decoration: underline; margin-top: 20px; border: none; transition: 0.3s; }
.btn-ghost:hover { color: var(--cyan); }
.err {
  color: #fca5a5; font-size: 0.9rem; padding: 16px; background: rgba(239,68,68,0.2);
  border: 1px solid rgba(239,68,68,0.4); border-radius: 14px; margin-bottom: 28px; display: none; text-align: center;
  backdrop-filter: blur(10px);
}
.header {
  background: rgba(9, 9, 11, 0.85); backdrop-filter: blur(24px);
  padding: 24px 28px; display: flex; align-items: center; justify-content: space-between;
  border-bottom: 1px solid var(--border-color); flex-shrink: 0; z-index: 10; gap: 12px;
}
.room-info { font-family: var(--font-mono); font-size: 0.9rem; color: var(--text-muted); flex: 1; display: flex; align-items: center; }
.room-info span { color: var(--cyan); font-size: 1.3rem; font-weight: 700; margin-left: 10px; letter-spacing: 0.1em; }
.rule-badge {
  font-size: 0.8rem; padding: 8px 14px; background: rgba(225,29,72,0.15);
  border: 1px solid rgba(225,29,72,0.4); border-radius: 10px; color: #fb7185; font-weight: 700;
  margin-right: auto; letter-spacing: 0.05em;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 90px;
}
@media (max-width: 380px) {
  .rule-badge { display: none; }
  .room-info span { font-size: 1.1rem; }
  .h-btn-icon { width: 36px; height: 36px; }
  .h-btn-icon svg { width: 17px; height: 17px; }
}
.h-btn {
  background: var(--surface-color); border: 1px solid var(--border-color); color: var(--text-main);
  padding: 10px 16px; border-radius: 12px; font-size: 0.8rem; cursor: pointer; transition: 0.3s;
  font-family: var(--font-en); font-weight: 700; letter-spacing: 0.05em; white-space: nowrap;
}
.h-btn:hover { border-color: var(--cyan); color: var(--cyan); background: rgba(6,182,212,0.1); transform: translateY(-2px); }
.h-btn-icon {
  background: var(--surface-color); border: 1px solid var(--border-color); color: var(--text-muted);
  width: 42px; height: 42px; border-radius: 12px; cursor: pointer; transition: 0.3s;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.h-btn-icon svg { width: 20px; height: 20px; stroke: currentColor; fill: none; stroke-width: 1.8; stroke-linecap: round; stroke-linejoin: round; }
.h-btn-icon:hover { border-color: var(--cyan); color: var(--cyan); background: rgba(6,182,212,0.1); transform: translateY(-2px); }
.room-share-modal .share-row {
  display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.04);
  border: 1px solid var(--border-color); border-radius: 14px; padding: 16px 20px; margin-bottom: 16px;
}
.share-label { font-family: var(--font-en); font-size: 0.75rem; color: var(--text-muted); letter-spacing: 0.15em; text-transform: uppercase; flex-shrink: 0; }
.share-val { font-family: var(--font-mono); font-size: 1rem; color: var(--text-main); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.share-copy-btn {
  background: var(--surface-color); border: 1px solid var(--border-color); color: var(--text-muted);
  padding: 8px 14px; border-radius: 10px; cursor: pointer; font-size: 0.8rem; font-family: var(--font-en);
  font-weight: 700; transition: 0.3s; white-space: nowrap; flex-shrink: 0;
}
.share-copy-btn:hover { border-color: var(--cyan); color: var(--cyan); background: rgba(6,182,212,0.1); }
.share-copy-btn.copied { border-color: var(--green); color: var(--green); background: rgba(16,185,129,0.1); }
.share-native-btn {
  width: 100%; padding: 18px; border: 1px solid rgba(6,182,212,0.5); border-radius: 14px;
  background: rgba(6,182,212,0.1); color: var(--cyan); font-family: var(--font-en); font-weight: 700;
  font-size: 0.95rem; letter-spacing: 0.1em; cursor: pointer; transition: 0.3s; margin-top: 8px;
  display: flex; align-items: center; justify-content: center; gap: 10px;
}
.share-native-btn:hover { background: rgba(6,182,212,0.2); border-color: var(--cyan); transform: translateY(-2px); }
.share-native-btn svg { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
.room-info-dismiss {
  width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 14px;
  background: transparent; color: var(--text-muted); font-family: var(--font-en); font-weight: 700;
  font-size: 0.85rem; letter-spacing: 0.1em; cursor: pointer; transition: 0.3s; margin-top: 12px;
}
.room-info-dismiss:hover { border-color: rgba(255,255,255,0.3); color: var(--text-main); }
.plist { padding: 28px; display: flex; flex-direction: column; gap: 18px; }
.pcard {
  background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 20px;
  padding: 24px; display: flex; align-items: center; gap: 20px; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  position: relative; overflow: hidden; backdrop-filter: var(--glass-blur);
}
.pcard::before {
  content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.06), transparent);
  transform: translateX(-100%); transition: 0.6s; pointer-events: none;
}
.pcard:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,0.4); border-color: rgba(255,255,255,0.2); }
.pcard:hover::before { transform: translateX(100%); }
.pcard.me { border-color: rgba(6,182,212,0.6); background: rgba(6, 182, 212, 0.08); box-shadow: 0 8px 30px rgba(6,182,212,0.15); }
.pcard.win { border-color: rgba(16,185,129,0.6); background: rgba(16, 185, 129, 0.08); box-shadow: 0 8px 30px rgba(16,185,129,0.15); }
.pcard.lose { opacity: 0.5; filter: grayscale(100%); background: rgba(24,24,27,0.5); border-color: rgba(255,255,255,0.05); }
.pcard.spec { opacity: 0.4; border-style: dashed; }
.rank-num {
  font-family: var(--font-en); font-size: 1.8rem; font-weight: 900; color: var(--text-muted);
  width: 40px; text-align: center; opacity: 0.6; letter-spacing: -0.05em;
}
.pcard.win .rank-num { color: var(--green); opacity: 1; text-shadow: 0 0 16px rgba(16,185,129,0.5); }
.pcard.me .rank-num { color: var(--cyan); opacity: 1; text-shadow: 0 0 16px rgba(6,182,212,0.5); }
.p-main { flex: 1; min-width: 0; }
.p-name { font-weight: 700; font-size: 1.2rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 12px; letter-spacing: 0.02em; }
.badge { font-size: 0.7rem; padding: 6px 10px; border-radius: 8px; font-family: var(--font-en); font-weight: 700; letter-spacing: 0.1em; }
.b-you { background: var(--cyan); color: #fff; box-shadow: 0 0 16px rgba(6,182,212,0.5); }
.p-stats { display: flex; gap: 20px; margin-top: 12px; font-family: var(--font-mono); font-size: 0.95rem; color: var(--text-muted); }
.p-stats span.c { color: var(--green); font-weight: 700; }
.p-stats span.w { color: var(--red); font-weight: 700; }
.score-box { text-align: right; display: flex; flex-direction: column; justify-content: center; align-items: flex-end; }
.score-val { font-family: var(--font-en); font-size: 2.6rem; font-weight: 900; line-height: 1; letter-spacing: -0.03em; }
.pcard.me .score-val { color: var(--cyan); text-shadow: 0 0 20px rgba(6,182,212,0.4); }
.score-sub { font-size: 0.8rem; color: var(--text-muted); margin-top: 10px; font-weight: 700; font-family: var(--font-en); }
.st-win { color: var(--green); font-size: 0.9rem; letter-spacing: 0.15em; text-shadow: 0 0 12px rgba(16,185,129,0.5); }
.st-lose { color: var(--red); font-size: 0.9rem; letter-spacing: 0.15em; }
.action-panel {
  background: var(--bg-color); border-top: 1px solid var(--border-color); padding: 28px;
  flex-shrink: 0; padding-bottom: max(28px, env(safe-area-inset-bottom)); z-index: 10;
  box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
  position: relative;
}
.ox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
.ox-btn {
  padding: 36px 0; border: none; border-radius: 24px; font-family: var(--font-ja);
  font-size: 3.2rem; font-weight: 700; cursor: pointer; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  box-shadow: 0 12px 32px rgba(0,0,0,0.5); line-height: 1;
}
.ox-btn:active { transform: scale(0.95) translateY(4px); box-shadow: 0 4px 16px rgba(0,0,0,0.6); }
.btn-o { background: linear-gradient(145deg, rgba(16,185,129,0.2), rgba(16,185,129,0.05)); border: 1px solid rgba(16,185,129,0.6); color: var(--green); text-shadow: 0 0 20px rgba(16,185,129,0.6); }
.btn-o:hover { background: linear-gradient(145deg, rgba(16,185,129,0.3), rgba(16,185,129,0.1)); box-shadow: 0 16px 40px rgba(16,185,129,0.3); transform: translateY(-4px); }
.btn-x { background: linear-gradient(145deg, rgba(239,68,68,0.2), rgba(239,68,68,0.05)); border: 1px solid rgba(239,68,68,0.6); color: var(--red); text-shadow: 0 0 20px rgba(239,68,68,0.6); }
.btn-x:hover { background: linear-gradient(145deg, rgba(239,68,68,0.3), rgba(239,68,68,0.1)); box-shadow: 0 16px 40px rgba(239,68,68,0.3); transform: translateY(-4px); }
.btn-rest { grid-column: 1 / -1; background: rgba(245,158,11,0.15); color: var(--yellow); border: 1px solid rgba(245,158,11,0.6); font-size: 1.6rem; letter-spacing: 0.1em; text-shadow: 0 0 16px rgba(245,158,11,0.5); }
.btn-rest:hover { background: rgba(245,158,11,0.25); transform: translateY(-4px); box-shadow: 0 16px 40px rgba(245,158,11,0.2); }
.sub-actions { display: flex; gap: 16px; }
.sub-btn {
  flex: 1; padding: 18px; background: var(--surface-color); border: 1px solid var(--border-color);
  border-radius: 14px; color: var(--text-muted); font-size: 0.95rem; cursor: pointer; text-align: center;
  font-weight: 700; transition: 0.3s; backdrop-filter: var(--glass-blur); letter-spacing: 0.05em;
}
.sub-btn:hover:not(:disabled) { border-color: var(--cyan); color: var(--cyan); background: rgba(6,182,212,0.1); transform: translateY(-2px); }
.sub-btn:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(1); }
.modal {
  position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(16px);
  z-index: 100; display: none; align-items: center; justify-content: center; padding: 24px;
}
.modal.active { display: flex; animation: fadeInModal 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
@keyframes fadeInModal { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
.m-content {
  background: rgba(24, 24, 27, 0.98); border: 1px solid rgba(255,255,255,0.15); border-radius: 28px;
  width: 100%; max-width: 480px; max-height: 85vh; overflow-y: auto; padding: 40px; position: relative;
  box-shadow: 0 32px 80px rgba(0,0,0,0.8);
}
.m-content::-webkit-scrollbar { width: 8px; }
.m-content::-webkit-scrollbar-track { background: transparent; }
.m-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
.m-close {
  position: absolute; top: 28px; right: 28px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-color);
  color: var(--text-muted); font-size: 1.5rem; cursor: pointer; transition: 0.3s; line-height: 1; width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
}
.m-close:hover { color: var(--cyan); border-color: var(--cyan); transform: rotate(90deg); background: rgba(6,182,212,0.1); }
.s-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 28px; }
.m-title { font-family: var(--font-en); font-size: 1.4rem; color: var(--cyan); margin-bottom: 32px; font-weight: 900; letter-spacing: 0.15em; }
.kick-btn {
  position: absolute; top: 10px; right: 10px;
  background: rgba(239,68,68,0.12); border: 1px solid rgba(239,68,68,0.35);
  color: rgba(239,68,68,0.6); border-radius: 8px;
  width: 26px; height: 26px; font-size: 0.75rem; line-height: 1;
  cursor: pointer; transition: 0.2s;
  display: flex; align-items: center; justify-content: center;
}
.kick-btn:hover { background: rgba(239,68,68,0.3); border-color: var(--red); color: var(--red); transform: scale(1.1); }
hr { border: none; border-top: 1px solid var(--border-color); margin: 32px 0; }
.toast {
  position: fixed; bottom: 140px; left: 50%; transform: translateX(-50%) translateY(20px);
  background: rgba(24, 24, 27, 0.98); border: 1px solid var(--cyan); color: var(--text-main);
  padding: 16px 32px; border-radius: 40px; font-size: 1.05rem; pointer-events: none;
  opacity: 0; transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1); z-index: 999;
  box-shadow: 0 16px 40px rgba(6,182,212,0.3); backdrop-filter: blur(16px); font-weight: 700; letter-spacing: 0.05em;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.r-header { padding: 80px 24px 50px; text-align: center; border-bottom: 1px solid var(--border-color); }
.r-title { font-family: var(--font-en); font-size: 3.8rem; color: var(--yellow); font-weight: 900; text-shadow: 0 0 32px rgba(245,158,11,0.4); letter-spacing: 0.08em; margin-bottom: 28px;}

.h-btn-icon.chat-btn { position: relative; }
.chat-badge {
  position: absolute; top: -5px; right: -5px; background: var(--magenta);
  color: #fff; font-size: 0.6rem; font-weight: 700; font-family: var(--font-en);
  min-width: 18px; height: 18px; border-radius: 9px; display: none;
  align-items: center; justify-content: center; padding: 0 4px;
  box-shadow: 0 0 8px rgba(225,29,72,0.6);
}
.chat-badge.show { display: flex; }
.chat-drawer {
  position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(100%);
  width: 100%; max-width: 540px; height: 70vh; max-height: 600px;
  background: rgba(14,14,16,0.98); backdrop-filter: blur(24px);
  border-top: 1px solid var(--border-color); border-radius: 24px 24px 0 0;
  z-index: 200; display: flex; flex-direction: column;
  transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  box-shadow: 0 -20px 60px rgba(0,0,0,0.6);
}
.chat-drawer.open { transform: translateX(-50%) translateY(0); }
.chat-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 199;
  opacity: 0; pointer-events: none; transition: opacity 0.3s;
}
.chat-overlay.show { opacity: 1; pointer-events: auto; }
.chat-handle {
  width: 40px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px;
  margin: 14px auto 0;
}
.chat-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 20px 14px; border-bottom: 1px solid var(--border-color); flex-shrink: 0;
}
.chat-title { font-family: var(--font-en); font-weight: 900; font-size: 0.9rem; letter-spacing: 0.15em; color: var(--cyan); }
.chat-close {
  background: none; border: none; color: var(--text-muted); cursor: pointer;
  font-size: 1.2rem; line-height: 1; padding: 4px; transition: 0.2s;
}
.chat-close:hover { color: var(--text-main); }
.chat-messages {
  flex: 1; overflow-y: auto; padding: 16px 16px 8px;
  display: flex; flex-direction: column; gap: 10px;
  -webkit-overflow-scrolling: touch;
}
.chat-messages::-webkit-scrollbar { width: 4px; }
.chat-messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 2px; }
.chat-msg { display: flex; flex-direction: column; gap: 3px; max-width: 80%; }
.chat-msg.me { align-self: flex-end; align-items: flex-end; }
.chat-msg.other { align-self: flex-start; align-items: flex-start; }
.chat-msg-name {
  font-size: 0.72rem; font-weight: 700; font-family: var(--font-en);
  letter-spacing: 0.08em; padding: 0 4px;
}
.chat-msg.me .chat-msg-name { color: var(--cyan); }
.chat-msg.other .chat-msg-name { color: var(--text-muted); }
.chat-msg-bubble {
  padding: 10px 14px; border-radius: 16px; font-size: 0.95rem; line-height: 1.5;
  word-break: break-word; max-width: 100%;
}
.chat-msg.me .chat-msg-bubble {
  background: linear-gradient(135deg, var(--cyan), #0284c7); color: #fff;
  border-bottom-right-radius: 4px;
}
.chat-msg.other .chat-msg-bubble {
  background: rgba(255,255,255,0.08); color: var(--text-main); border: 1px solid var(--border-color);
  border-bottom-left-radius: 4px;
}
.chat-msg-stamp { font-size: 2rem; line-height: 1; background: none; border: none; padding: 0; }
.chat-sys {
  align-self: center; font-size: 0.75rem; color: var(--text-muted);
  font-family: var(--font-en); letter-spacing: 0.08em;
  background: rgba(255,255,255,0.05); padding: 5px 12px; border-radius: 20px;
}
.chat-stamps {
  display: flex; gap: 6px; padding: 10px 16px; flex-shrink: 0;
  border-top: 1px solid var(--border-color); overflow-x: auto;
  -webkit-overflow-scrolling: touch; scrollbar-width: none;
}
.chat-stamps::-webkit-scrollbar { display: none; }
.stamp-btn {
  background: rgba(255,255,255,0.06); border: 1px solid var(--border-color);
  border-radius: 10px; padding: 6px 10px; font-size: 1.3rem; cursor: pointer;
  transition: 0.2s; flex-shrink: 0; line-height: 1;
}
.stamp-btn:hover { background: rgba(255,255,255,0.14); transform: scale(1.15); border-color: rgba(255,255,255,0.3); }
.stamp-btn:active { transform: scale(0.95); }
.chat-input-row {
  display: flex; gap: 10px; padding: 10px 16px 16px; flex-shrink: 0;
  padding-bottom: max(16px, env(safe-area-inset-bottom));
}
.chat-input {
  flex: 1; background: rgba(255,255,255,0.07); border: 1px solid var(--border-color);
  border-radius: 14px; padding: 12px 16px; color: var(--text-main);
  font-family: var(--font-ja); font-size: 0.95rem; outline: none; transition: 0.3s;
}
.chat-input:focus { border-color: var(--cyan); background: rgba(6,182,212,0.08); }
.chat-send {
  background: linear-gradient(135deg, var(--cyan), #0284c7); border: none;
  border-radius: 14px; width: 48px; height: 48px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  transition: 0.3s; box-shadow: 0 4px 16px rgba(6,182,212,0.3);
}
.chat-send:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(6,182,212,0.4); }
.chat-send:active { transform: scale(0.95); }
.chat-send svg { width: 20px; height: 20px; stroke: #fff; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

.timer-panel {
  display: none;
  background: rgba(9,9,11,0.97);
  border-bottom: 1px solid var(--border-color);
  padding: 14px 28px 16px;
  flex-shrink: 0;
  z-index: 9;
  flex-direction: column;
  gap: 12px;
}
.timer-panel.visible { display: flex; }
.timer-display {
  font-family: var(--font-mono);
  font-size: 3.8rem;
  font-weight: 700;
  text-align: center;
  letter-spacing: 0.06em;
  color: var(--text-main);
  text-shadow: 0 0 24px rgba(6,182,212,0.3);
  transition: color 0.3s, text-shadow 0.3s;
  line-height: 1;
}
.timer-display.warning { color: var(--yellow); text-shadow: 0 0 24px rgba(245,158,11,0.5); }
.timer-display.danger { color: var(--red); text-shadow: 0 0 24px rgba(239,68,68,0.6); animation: timerPulse 0.6s infinite alternate; }
@keyframes timerPulse { from { opacity: 1; } to { opacity: 0.6; } }
.timer-controls { display: flex; gap: 10px; }
.timer-btn {
  flex: 1; padding: 12px 8px; border-radius: 12px;
  font-family: var(--font-en); font-size: 0.8rem; font-weight: 700;
  letter-spacing: 0.08em; cursor: pointer; transition: all 0.25s; border: 1px solid;
}
.timer-btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none !important; }
.timer-btn-start { background: rgba(16,185,129,0.12); border-color: rgba(16,185,129,0.5); color: var(--green); }
.timer-btn-start:not(:disabled):hover { background: rgba(16,185,129,0.25); border-color: var(--green); transform: translateY(-2px); }
.timer-btn-stop { background: rgba(245,158,11,0.12); border-color: rgba(245,158,11,0.5); color: var(--yellow); }
.timer-btn-stop:not(:disabled):hover { background: rgba(245,158,11,0.25); border-color: var(--yellow); transform: translateY(-2px); }
.timer-btn-reset { background: rgba(239,68,68,0.12); border-color: rgba(239,68,68,0.4); color: var(--red); }
.timer-btn-reset:not(:disabled):hover { background: rgba(239,68,68,0.25); border-color: var(--red); transform: translateY(-2px); }

.countdown-overlay {
  position: fixed; inset: 0; z-index: 500;
  background: rgba(0,0,0,0.88); backdrop-filter: blur(20px);
  display: none; align-items: center; justify-content: center; flex-direction: column; gap: 20px;
}
.countdown-overlay.show { display: flex; }
.countdown-num {
  font-family: var(--font-en); font-size: 9rem; font-weight: 900; line-height: 1;
  background: linear-gradient(135deg, #ffffff, var(--cyan));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  filter: drop-shadow(0 0 40px rgba(6,182,212,0.6));
  animation: cdPop 0.35s cubic-bezier(0.16, 1, 0.3, 1);
}
@keyframes cdPop { from { transform: scale(1.6); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.countdown-label { font-family: var(--font-en); font-size: 0.95rem; color: var(--text-muted); letter-spacing: 0.35em; font-weight: 700; }
</style>
</head>
<body>

<div id="screen-top" class="screen active">
  <div class="hero">
    <div class="logo">Q-Room</div>
    <div class="logo-sub">Online QUIZ Room</div>
  </div>
  <div class="form-wrap">
    <div class="field">
      <label>PLAYER NAME</label>
      <input type="text" id="in-name" placeholder="Enter your name" maxlength="20" autocomplete="off">
    </div>
    <div class="field">
      <label>ROOM ID</label>
      <div class="row">
        <input type="text" id="in-room" placeholder="5 digits" maxlength="5" pattern="[0-9]*" inputmode="numeric">
        <button class="btn-gen" onclick="document.getElementById('in-room').value = String(Math.floor(10000+Math.random()*90000))">üé≤</button>
      </div>
    </div>
    <div id="top-err" class="err"></div>
    <button class="btn btn-pri" onclick="handleCreate()" style="margin-bottom:20px;">CREATE ROOM</button>
    <button class="btn btn-sec" onclick="handleJoin()">JOIN ROOM</button>
    <div style="display:flex; justify-content:center; align-items:center; gap:8px; margin-top:28px; padding-bottom:8px; flex-wrap:wrap;">
      <button onclick="openFeedback()" style="background:none; border:none; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:8px; color:var(--text-muted); transition:0.3s; padding:8px 16px; border-radius:12px;" onmouseover="this.style.color='var(--cyan)'" onmouseout="this.style.color='var(--text-muted)'">
        <svg viewBox="0 0 24 24" style="width:22px;height:22px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
        <span style="font-family:var(--font-en);font-size:0.75rem;letter-spacing:0.12em;font-weight:700;">FEEDBACK</span>
      </button>
      <a href="https://twitter.com/astro_root" target="_blank" rel="noopener" style="display:flex; flex-direction:column; align-items:center; gap:8px; color:var(--text-muted); text-decoration:none; transition:0.3s; padding:8px 16px; border-radius:12px;" onmouseover="this.style.color='#1d9bf0'" onmouseout="this.style.color='var(--text-muted)'">
        <svg viewBox="0 0 24 24" style="width:22px;height:22px;fill:currentColor;"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.744l7.73-8.835L1.254 2.25H8.08l4.253 5.622zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
        <span style="font-family:var(--font-en);font-size:0.75rem;letter-spacing:0.12em;font-weight:700;">TWITTER</span>
      </a>
      <a href="https://astro-root.com/" target="_blank" rel="noopener" style="display:flex; flex-direction:column; align-items:center; gap:8px; color:var(--text-muted); text-decoration:none; transition:0.3s; padding:8px 16px; border-radius:12px;" onmouseover="this.style.color='var(--cyan)'" onmouseout="this.style.color='var(--text-muted)'">
        <svg viewBox="0 0 24 24" style="width:22px;height:22px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
        <span style="font-family:var(--font-en);font-size:0.75rem;letter-spacing:0.12em;font-weight:700;">WEBSITE</span>
      </a>
      <a href="https://astro-root.com/q-room/manual.html" target="_blank" rel="noopener" style="display:flex; flex-direction:column; align-items:center; gap:8px; color:var(--text-muted); text-decoration:none; transition:0.3s; padding:8px 16px; border-radius:12px;" onmouseover="this.style.color='var(--cyan)'" onmouseout="this.style.color='var(--text-muted)'">
        <svg viewBox="0 0 24 24" style="width:22px;height:22px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
        <span style="font-family:var(--font-en);font-size:0.75rem;letter-spacing:0.12em;font-weight:700;">MANUAL</span>
      </a>
    </div>
  </div>
</div>

<div id="screen-room" class="screen">
  <div class="header">
    <div class="room-info">ROOM<span id="game-rid">‚Äî</span></div>
    <div class="rule-badge" id="game-rule">‚Äî</div>
    <div style="display:flex; gap:10px; flex-shrink:0;">
      <button class="h-btn-icon chat-btn" onclick="toggleChat()" title="Chat" id="chat-header-btn">
        <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        <span class="chat-badge" id="chat-badge"></span>
      </button>
      <button class="h-btn-icon" onclick="openFeedback()" title="Feedback">
        <svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
      </button>
      <button class="h-btn-icon" onclick="openModal()" title="Settings">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
      </button>
    </div>
  </div>
  <div class="timer-panel" id="timer-panel">
    <div class="timer-display" id="timer-display">05:00</div>
    <div class="timer-controls">
      <button class="timer-btn timer-btn-start" id="timer-btn-start" onclick="timerAction('start')">‚ñ∂ START</button>
      <button class="timer-btn timer-btn-stop" id="timer-btn-stop" onclick="timerAction('stop')" disabled>‚è∏ STOP</button>
      <button class="timer-btn timer-btn-reset" onclick="timerAction('reset')">‚Ü∫ RESET</button>
    </div>
  </div>
  <div class="scroll-area"><div id="plist" class="plist"></div></div>
  <div class="action-panel" id="mypanel">
    <div class="ox-grid" id="ox-grid">
      <button class="ox-btn btn-o" onclick="sendAction('correct')">‚óØ</button>
      <button class="ox-btn btn-x" onclick="sendAction('wrong')">‚úï</button>
    </div>
    <div class="sub-actions">
      <button class="sub-btn" id="btn-undo" onclick="reqUndo()" disabled>‚Ü© UNDO</button>
      <button class="sub-btn" onclick="toggleRole()" id="btn-role">üëÄ WATCH</button>
      <button class="sub-btn" onclick="leaveRoom()">üö™ LEAVE</button>
    </div>
  </div>
</div>

<div id="screen-result" class="screen">
  <div class="r-header">
    <div class="r-title">RESULT</div>
    <button class="sub-btn" onclick="backToRoom()" style="max-width: 240px; margin: 0 auto;">Back to ROOM</button>
  </div>
  <div class="scroll-area"><div id="rlist" class="plist"></div></div>
</div>

<div id="modal" class="modal" onclick="if(event.target===this)closeModal()">
  <div class="m-content">
    <button class="m-close" onclick="closeModal()">‚úï</button>
    <div class="m-title">ROOM SETTINGS</div>
    
    <div class="field">
      <label>RULE</label>
      <select id="sel-rule" onchange="changeRuleUI()">
        <option value="survival">m‚óØn√ó</option>
        <option value="free">Free</option>
        <option value="newyork">NewYork</option>
        <option value="rentou">ÈÄ£Á≠î‰ªò„Åç</option>
        <option value="updown">up-down</option>
        <option value="by">by</option>
        <option value="freeze">Freeze</option>
        <option value="m_n_rest">m‚óØn‰ºë</option>
        <option value="swedish">Swedish</option>
        <option value="ren_wrong">ÈÄ£Ë™§Á≠î‰ªò„Åç</option>
        <option value="divide">divide</option>
        <option value="combo">m hits Combo</option>
        <option value="attack_surv">„Ç¢„Çø„ÉÉ„ÇØÈ¢®„Çµ„Éê„Ç§„Éê„É´</option>
        <option value="lucky">LuckyShot</option>
        <option value="spiral">Ëû∫ÊóãÈöéÊÆµ</option>
        <option value="time_race">Time Race</option>
      </select>
    </div>

    <div id="config-area"></div>

    <hr>
    <div class="s-grid">
      <button class="sub-btn" onclick="copyUrl()">üîó Copy URL</button>
      <button class="sub-btn" onclick="copyId()">üìã Copy ID</button>
    </div>
    <button class="btn btn-sec" onclick="resetPoints()" style="margin-bottom:16px;">üîÑ RESET SCORES</button>
    <button class="btn btn-warn" onclick="endGame()">üèÅ FINISH GAME</button>
  </div>
</div>

<div id="modal-room-info" class="modal room-share-modal" onclick="if(event.target===this)closeRoomInfo()">
  <div class="m-content">
    <button class="m-close" onclick="closeRoomInfo()">‚úï</button>
    <div class="m-title" id="room-info-title">ROOM CREATED</div>

    <div class="share-row">
      <span class="share-label">ID</span>
      <span class="share-val" id="share-room-id">‚Äî</span>
      <button class="share-copy-btn" id="btn-copy-id" onclick="copyShareId()">COPY</button>
    </div>
    <div class="share-row">
      <span class="share-label">URL</span>
      <span class="share-val" id="share-room-url">‚Äî</span>
      <button class="share-copy-btn" id="btn-copy-url" onclick="copyShareUrl()">COPY</button>
    </div>

    <button class="share-native-btn" id="btn-native-share" onclick="nativeShare()">
      <svg viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
      INVITE FRIENDS
    </button>
    <button class="room-info-dismiss" onclick="closeRoomInfo()">START PLAYING ‚Üí</button>
  </div>
</div>

<div id="modal-feedback" class="modal" onclick="if(event.target===this)closeFeedback()">
  <div class="m-content">
    <button class="m-close" onclick="closeFeedback()">‚úï</button>
    <div class="m-title">FEEDBACK</div>
    <div style="display:flex; flex-direction:column; gap:12px; margin-bottom:28px;">
      <a href="https://twitter.com/astro_root" target="_blank" rel="noopener" style="display:flex; align-items:center; gap:14px; padding:14px 18px; background:rgba(255,255,255,0.04); border:1px solid var(--border-color); border-radius:14px; color:var(--text-main); text-decoration:none; transition:0.3s; font-family:var(--font-en); font-size:0.9rem; font-weight:700;" onmouseover="this.style.borderColor='#1d9bf0';this.style.background='rgba(29,155,240,0.08)'" onmouseout="this.style.borderColor='var(--border-color)';this.style.background='rgba(255,255,255,0.04)'">
        <svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:#1d9bf0;flex-shrink:0;"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.744l7.73-8.835L1.254 2.25H8.08l4.253 5.622zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
        <div>
          <div style="color:var(--text-muted);font-size:0.7rem;letter-spacing:0.12em;margin-bottom:2px;">TWITTER</div>
          @astro_root
        </div>
      </a>
      <a href="https://astro-root.com/" target="_blank" rel="noopener" style="display:flex; align-items:center; gap:14px; padding:14px 18px; background:rgba(255,255,255,0.04); border:1px solid var(--border-color); border-radius:14px; color:var(--text-main); text-decoration:none; transition:0.3s; font-family:var(--font-en); font-size:0.9rem; font-weight:700;" onmouseover="this.style.borderColor='var(--cyan)';this.style.background='rgba(6,182,212,0.08)'" onmouseout="this.style.borderColor='var(--border-color)';this.style.background='rgba(255,255,255,0.04)'">
        <svg viewBox="0 0 24 24" style="width:20px;height:20px;stroke:var(--cyan);fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
        <div>
          <div style="color:var(--text-muted);font-size:0.7rem;letter-spacing:0.12em;margin-bottom:2px;">WEBSITE</div>
          astro-root.com
        </div>
      </a>
    </div>
    <hr>
    <form action="https://public.herotofu.com/v1/73ca08d0-1004-11f1-9506-dbd2adae6f0e" method="post" target="_blank" onsubmit="setTimeout(closeFeedback, 500)" style="margin-top:28px;">
      <div class="field">
        <label>NAME</label>
        <input type="text" name="name" placeholder="Your Name" required>
      </div>
      <div class="field">
        <label>MESSAGE</label>
        <textarea name="message" placeholder="Your Message" required></textarea>
      </div>
      <button type="submit" class="btn btn-pri">SEND FEEDBACK</button>
    </form>
  </div>
</div>

<div class="chat-overlay" id="chat-overlay" onclick="toggleChat()"></div>
<div class="chat-drawer" id="chat-drawer">
  <div class="chat-handle"></div>
  <div class="chat-header">
    <span class="chat-title">CHAT</span>
    <button class="chat-close" onclick="toggleChat()">‚úï</button>
  </div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-stamps" id="chat-stamps"></div>
  <div class="chat-input-row">
    <input class="chat-input" id="chat-input" type="text" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ‚Ä¶" maxlength="200" autocomplete="off" onkeydown="if(event.key==='Enter')sendChatMsg()">
    <button class="chat-send" onclick="sendChatMsg()">
      <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
    </button>
  </div>
</div>

<div class="countdown-overlay" id="countdown-overlay">
  <div class="countdown-num" id="countdown-num">5</div>
  <div class="countdown-label">GET READY</div>
</div>

<div id="toast" class="toast"></div>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyA3xtGLVJwij2BTiiOk7DsNeF9hIOuZCyI",
  authDomain: "q-room-fe8a6.firebaseapp.com",
  databaseURL: "https://q-room-fe8a6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "q-room-fe8a6",
  storageBucket: "q-room-fe8a6.firebasestorage.app",
  messagingSenderId: "151049149394",
  appId: "1:151049149394:web:7a3ea6406454f6a87d460b"
};

let db = null, myId = null, rId = null, rRef = null, rCb = null;
let roomData = null;
let chatRef = null, chatCb = null, chatOpen = false, chatUnread = 0, lastSeenMsgTs = 0;
let serverTimeOffset = 0;

const STAMPS = ['üëç','üéâ','üòÇ','üî•','üòÆ','üí™','ü§î','üëè','‚ù§Ô∏è','üò≠','‚ú®','üôè'];

const DEF_CONF = {
  survival: {m:5, n:2}, free: {}, newyork: {m:1, n:1, win:10, lose:-10}, rentou: {m:5, n:2, mode:'fast'}, updown: {m:5, n:2},
  by: {m:5, n:3}, freeze: {m:5, n:0}, m_n_rest: {m:5, n:3},
  swedish: {m:10, n:10}, ren_wrong: {m:5, n:3},
  divide: {init:10, add:10, win:100}, combo: {win:10, lose:3},
  attack_surv: {life:20, dmg_to_oth:1, heal:0, dmg_to_me:2, surv:1},
  lucky: {win:50, lose:-20, max:10}, spiral: {up:1, down:1, top_req:3, btm_req:3},
  time_race: {limit:5, correct_pt:1, wrong_pt:1}
};

window.onload = () => {
  const params = new URLSearchParams(window.location.search);
  const qRoom = params.get('r');
  const pathRoom = window.location.pathname.match(/\/q-room\/(\d{5})/);
  const roomId = qRoom || (pathRoom && pathRoom[1]);
  if(roomId) document.getElementById('in-room').value = roomId;
  const savedName = localStorage.getItem('qr_name');
  if(savedName) document.getElementById('in-name').value = savedName;
};

function initFB() {
  if(!db){ 
    try {
      firebase.initializeApp(firebaseConfig); 
      db = firebase.database(); 
      db.ref('.info/serverTimeOffset').on('value', snap => {
        serverTimeOffset = snap.val() || 0;
      });
    } catch(e) {
      console.error(e);
      throw new Error("„Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
    }
  }
}

function getServerTime() {
  return Date.now() + serverTimeOffset;
}

function getMyId() {
  let id = localStorage.getItem('qr_id');
  if(!id){ id = 'p_'+Date.now().toString(36); localStorage.setItem('qr_id',id); }
  return id;
}

function err(m){ const e=document.getElementById('top-err'); e.innerText=m; e.style.display='block'; setTimeout(()=>e.style.display='none',3000); }
function toast(m){ const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
function show(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById('screen-'+id).classList.add('active'); }

async function handleCreate() {
  try {
    initFB();
    const n = document.getElementById('in-name').value.trim();
    const r = document.getElementById('in-room').value.trim() || String(Math.floor(10000+Math.random()*90000));
    if(!n) return err('ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    if(!/^\d{5}$/.test(r)) return err('ID„ÅØ5Ê°Å„ÅÆÊï∞Â≠ó„Åß„Åô');

    const s = await db.ref('rooms/'+r).once('value');
    if(s.exists()) {
      const d = s.val();
      const players = d.players || {};
      const hasPlayers = Object.keys(players).length > 0;
      if(hasPlayers) return err('„Åù„ÅÆID„ÅØ‰ΩøÁî®‰∏≠„Åß„Åô');
      const lastActive = d.lastActiveAt || d.createdAt || 0;
      if(Date.now() - lastActive < 5*60*1000) return err('„Åù„ÅÆID„ÅØ‰ΩøÁî®‰∏≠„Åß„Åô');
      await db.ref('rooms/'+r).remove();
    }

    localStorage.setItem('qr_name', n);
    myId = getMyId(); rId = r;
    await db.ref('rooms/'+r).set({
      status: 'playing', rule: 'survival', conf: DEF_CONF.survival,
      createdAt: firebase.database.ServerValue.TIMESTAMP,
      lastActiveAt: firebase.database.ServerValue.TIMESTAMP,
      players: { [myId]: newPlayer(n) }
    });
    enterRoom(true, n);
  } catch(e) {
    console.error(e);
    err('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÈÄö‰ø°Áä∂ÊÖã„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
  }
}

async function handleJoin() {
  try {
    initFB();
    const n = document.getElementById('in-name').value.trim();
    const r = document.getElementById('in-room').value.trim();
    if(!n) return err('ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    if(!/^\d{5}$/.test(r)) return err('ID„ÅØ5Ê°Å„ÅÆÊï∞Â≠ó„Åß„Åô');

    const s = await db.ref('rooms/'+r).once('value');
    if(!s.exists()) return err('ÈÉ®Â±ã„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');

    const d = s.val();
    const players = d.players || {};
    const hasPlayers = Object.keys(players).length > 0;
    if(!hasPlayers) {
      const lastActive = d.lastActiveAt || d.createdAt || 0;
      if(Date.now() - lastActive >= 5*60*1000) return err('„Åì„ÅÆID„ÅØÊúüÈôêÂàá„Çå„Åß„ÅôÔºà5ÂàÜ‰ª•‰∏äË™∞„ÇÇ„ÅÑ„Åæ„Åõ„Çì„Åß„Åó„ÅüÔºâ');
    }

    localStorage.setItem('qr_name', n);
    myId = getMyId(); rId = r;
    if(!players[myId]) await db.ref(`rooms/${r}/players/${myId}`).set(newPlayer(n));
    enterRoom(false, n);
  } catch(e) {
    console.error(e);
    err('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÈÄö‰ø°Áä∂ÊÖã„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
  }
}

function newPlayer(name) {
  return { name, st: 'active', c:0, w:0, sc:0, rst:0, str:0, adv:0, joined: Date.now(), statsAt: Date.now(), winAt: 0, hist: [] };
}

function enterRoom(isCreate=false, playerName='') {
  try {
    if (window.location.protocol !== 'file:') {
      const base = window.location.pathname.replace(/\/q-room\/.*/, '/q-room/').replace(/([^/])$/, '$1/');
      window.history.replaceState({}, '', `${base}?r=${rId}`);
    }
  } catch(e) {
    console.warn("History API replaced failed.");
  }

  db.ref(`rooms/${rId}/lastActiveAt`).set(firebase.database.ServerValue.TIMESTAMP);

  const playerRef = db.ref(`rooms/${rId}/players/${myId}`);
  db.ref(`rooms/${rId}/lastActiveAt`).onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);

  document.getElementById('game-rid').innerText = rId;
  show('room');
  showRoomInfo(isCreate);
  initChat(playerName);
  initTimerListener();

  if(rRef) rRef.off('value', rCb);
  rRef = db.ref('rooms/'+rId);
  rCb = rRef.on('value', snap => {
    roomData = snap.val();
    if(!roomData) return leaveRoom();
    if(roomData.status === 'finished') return renderResult();
    
    show('room');
    
    const r = roomData.rule;
    document.getElementById('sel-rule').value = r;
    document.getElementById('game-rule').innerText = document.getElementById('sel-rule').options[document.getElementById('sel-rule').selectedIndex].text;
    changeRuleUI(true);
    renderPlayers();
    
    const me = roomData.players && roomData.players[myId];
    document.getElementById('btn-undo').disabled = !(me && me.hist && me.hist.length > 0);
  });
}

async function leaveRoom() {
  if(rRef) { rRef.off('value', rCb); rRef = null; }
  if(chatRef) { chatRef.off('child_added', chatCb); chatRef = null; }
  if(db && rId && myId) {
    const myName = getMyName();
    await pushSysMsg(`${myName} „ÅåÈÄÄÂÆ§„Åó„Åæ„Åó„Åü`);
    const playerRef = db.ref(`rooms/${rId}/players/${myId}`);
    await playerRef.remove();
    await db.ref(`rooms/${rId}/lastActiveAt`).set(firebase.database.ServerValue.TIMESTAMP);
  }
  window.location.href = 'https://astro-root.com/q-room/';
}

async function backToRoom() {
  await db.ref(`rooms/${rId}/status`).set('playing');
}

function openModal(){ document.getElementById('modal').classList.add('active'); }
function closeModal(){ document.getElementById('modal').classList.remove('active'); updateConf(); }

function openFeedback(){ document.getElementById('modal-feedback').classList.add('active'); }
function closeFeedback(){ document.getElementById('modal-feedback').classList.remove('active'); }

function getRoomUrl() {
  if(window.location.protocol === 'file:') return `https://astro-root.com/q-room/?r=${rId}`;
  const base = window.location.origin + window.location.pathname.replace(/\/q-room\/.*/, '/q-room/').replace(/([^/])$/, '$1/');
  return `${base}?r=${rId}`;
}

function showRoomInfo(isCreate) {
  document.getElementById('room-info-title').innerText = isCreate ? 'ROOM CREATED' : 'ROOM JOINED';
  document.getElementById('share-room-id').innerText = rId;
  const url = getRoomUrl();
  document.getElementById('share-room-url').innerText = url;
  document.getElementById('btn-native-share').style.display = (navigator.share ? 'flex' : 'none');
  document.getElementById('modal-room-info').classList.add('active');
}

function closeRoomInfo() { document.getElementById('modal-room-info').classList.remove('active'); }

function copyShareId() {
  navigator.clipboard.writeText(rId);
  const btn = document.getElementById('btn-copy-id');
  btn.innerText = 'COPIED!'; btn.classList.add('copied');
  setTimeout(() => { btn.innerText = 'COPY'; btn.classList.remove('copied'); }, 2000);
}

function copyShareUrl() {
  navigator.clipboard.writeText(getRoomUrl());
  const btn = document.getElementById('btn-copy-url');
  btn.innerText = 'COPIED!'; btn.classList.add('copied');
  setTimeout(() => { btn.innerText = 'COPY'; btn.classList.remove('copied'); }, 2000);
}

function nativeShare() {
  if(!navigator.share) return;
  navigator.share({
    title: 'Q-Room „ÇØ„Ç§„Ç∫ÂØæÊà¶„Åó„Çà„ÅÜÔºÅ',
    text: `üéÆ Q-Room„Åß„ÇØ„Ç§„Ç∫ÂØæÊà¶„Åó„Çà„ÅÜÔºÅ\nRoom ID: ${rId}\nÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶ÂèÇÂä†„Åó„Å¶„Å≠üëá`,
    url: getRoomUrl()
  }).catch(() => {});
}

function changeRuleUI(skipRender=false) {
  const r = document.getElementById('sel-rule').value;
  const c = (roomData && roomData.rule === r && roomData.conf) ? roomData.conf : DEF_CONF[r];
  let h = '';
  const mkn = (id,lbl,v) => `<div class="field"><label>${lbl}</label><input type="number" id="c_${id}" value="${v !== undefined ? v : ''}"></div>`;
  const mks = (id,lbl,v,opts) => `<div class="field"><label>${lbl}</label><select id="c_${id}">${opts.map(o=>`<option value="${o.v}" ${v===o.v?'selected':''}>${o.l}</option>`).join('')}</select></div>`;
  
  if(r==='survival'||r==='updown'||r==='ren_wrong') h = `<div class="s-grid">${mkn('m','Âãù„Å°Êäú„Åë',c.m)}${mkn('n','Â§±Ê†º',c.n)}</div>`;
  else if(r==='rentou') h = `<div class="s-grid">${mkn('m','Âãù„Å°Êäú„Åë',c.m)}${mkn('n','Â§±Ê†º',c.n)}</div>${mks('mode','ÈÄ£Á≠î„É¢„Éº„Éâ',c.mode||'fast',[{v:'fast',l:'Âä†ÈÄü'},{v:'const',l:'Á≠âÈÄü'}])}`;
  else if(r==='free') h = '';
  else if(r==='newyork') h = `<div class="s-grid">${mkn('m','Ê≠£Ëß£Âä†ÁÇπ',c.m)}${mkn('n','Ë™§Á≠îÊ∏õÁÇπ',c.n)}</div><div class="s-grid">${mkn('win','Âãù„Å°Êäú„Åë',c.win)}${mkn('lose','Â§±Ê†º',c.lose)}</div>`;
  else if(r==='by') h = `<div class="s-grid">${mkn('m','ÂàùÊúüË™§Á≠îpt/ÂÆöÊï∞',c.m)}${mkn('n','Â§±Ê†ºÂõûÊï∞',c.n)}</div>`;
  else if(r==='freeze'||r==='m_n_rest') h = `<div class="s-grid">${mkn('m','Âãù„Å°Êäú„Åë',c.m)}${mkn('n',r==='freeze'?'Â§±Ê†º':'‰ºë„ÅøÊï∞',c.n)}</div>`;
  else if(r==='swedish') h = `<div class="s-grid">${mkn('m','Âãù„Å°Êäú„Åë',c.m)}${mkn('n','Â§±Ê†º√óÊï∞',c.n)}</div>`;
  else if(r==='divide') h = `<div class="s-grid">${mkn('init','ÂàùÊúüÂÄ§',c.init)}${mkn('add','Ê≠£Ëß£Âä†ÁÇπ',c.add)}</div><div class="field">${mkn('win','Âãù„Å°Êäú„Åë',c.win)}</div>`;
  else if(r==='combo') h = `<div class="s-grid">${mkn('win','Âãù„Å°Êäú„Åë',c.win)}${mkn('lose','Â§±Ê†º',c.lose)}</div>`;
  else if(r==='attack_surv') h = `<div class="s-grid">${mkn('life','ÂàùÊúü„É©„Ç§„Éï',c.life)}${mkn('dmg_to_oth','Ëá™Ê≠£Ëß£ÊôÇ‰ªñÊ∏õ',c.dmg_to_oth)}${mkn('heal','Ëá™Ê≠£Ëß£ÊôÇËá™Âä†',c.heal)}${mkn('dmg_to_me','Ëá™Ë™§ÊôÇËá™Ê∏õ',c.dmg_to_me)}</div><div class="field">${mkn('surv','ÁµÇ‰∫Ü‰∫∫Êï∞',c.surv)}</div>`;
  else if(r==='lucky') h = `<div class="s-grid">${mkn('win','Âãù„Å°Êäú„Åë',c.win)}${mkn('lose','Â§±Ê†º',c.lose)}</div><div class="field">${mkn('max','‰π±Êï∞ÊúÄÂ§ß',c.max)}</div>`;
  else if(r==='spiral') h = `<div class="s-grid">${mkn('up','Ê≠£Ëß£‰∏äÊòá',c.up)}${mkn('down','Ë™§Á≠î‰∏ãÈôç',c.down)}${mkn('top_req','ÊúÄ‰∏ä‰ΩçË¶ÅÊ≠£Ëß£',c.top_req)}${mkn('btm_req','ÊúÄ‰∏ã‰ΩçË¶ÅË™§Á≠î',c.btm_req)}</div>`;
  else if(r==='time_race') h = `<div class="s-grid">${mkn('limit','Âà∂ÈôêÊôÇÈñì(ÂàÜ)',c.limit)}${mkn('correct_pt','Ê≠£Ëß£ +pt',c.correct_pt)}${mkn('wrong_pt','Ë™§Á≠î -pt',c.wrong_pt)}</div>`;
  
  document.getElementById('config-area').innerHTML = h;
  if(!skipRender && roomData && r !== roomData.rule) {
    db.ref('rooms/'+rId).update({rule: r, conf: DEF_CONF[r]});
    if(r === 'time_race') {
      const lm = (DEF_CONF.time_race.limit) * 60 * 1000;
      db.ref(`rooms/${rId}/timer`).set({state:'idle', limitMs:lm, remaining:lm, startAt:null, cdStartAt:null});
    }
  }
}

function updateConf() {
  if(!roomData) return;
  let nc = {};
  document.querySelectorAll('#config-area input').forEach(el => nc[el.id.replace('c_','')] = parseInt(el.value)||0);
  document.querySelectorAll('#config-area select').forEach(el => nc[el.id.replace('c_','')] = el.value);
  if(Object.keys(nc).length > 0) {
    db.ref(`rooms/${rId}/conf`).update(nc);
    if(roomData.rule === 'time_race' && nc.limit !== undefined) {
      const limitMs = nc.limit * 60 * 1000;
      db.ref(`rooms/${rId}/timer`).transaction(cur => {
        if(!cur) return cur;
        if(cur.limitMs !== limitMs) {
          const oldLimit = cur.limitMs || limitMs;
          cur.limitMs = limitMs;
          if(cur.state === 'idle') {
            cur.remaining = limitMs;
          } else if(cur.state === 'paused') {
            const elapsed = oldLimit - (cur.remaining || oldLimit);
            cur.remaining = Math.max(0, limitMs - Math.max(0, elapsed));
          }
        }
        return cur;
      });
    }
  }
}

function sortPlayers(pl, rule) {
  return Object.entries(pl).sort((a,b) => {
    const p1=a[1], p2=b[1];
    const rs = v=>v==='win'?0:v==='active'?1:v==='lose'?2:3;
    if(rs(p1.st) !== rs(p2.st)) return rs(p1.st) - rs(p2.st);
    if(p1.st === 'win' && p2.st === 'win') return (p1.winAt||0) - (p2.winAt||0);
    let m1=p1.sc||0, m2=p2.sc||0;
    if(['survival','free','freeze','m_n_rest','swedish','ren_wrong'].includes(rule)){ m1=p1.c; m2=p2.c; }
    else if(rule==='by') { m1=p1.sc; m2=p2.sc; }
    if(m1 !== m2) return m2 - m1;
    if(p1.w !== p2.w) return p1.w - p2.w;
    return (p1.statsAt||p1.joined||0) - (p2.statsAt||p2.joined||0);
  });
}

function calcRanks(sorted) {
  const ranks = [];
  for (let i = 0; i < sorted.length; i++) {
    if (i === 0) {
      ranks.push(1);
    } else {
      const prev = sorted[i-1][1];
      const cur  = sorted[i][1];
      if (prev.st === cur.st && prev.c === cur.c && prev.w === cur.w) {
        ranks.push(ranks[i-1]);
      } else {
        ranks.push(i + 1);
      }
    }
  }
  return ranks;
}

function renderPlayers() {
  const pl = roomData.players || {};
  const r = roomData.rule;
  const sorted = sortPlayers(pl, r);
  
  document.getElementById('timer-panel').classList.toggle('visible', r === 'time_race');
  
  let h = '';
  const ranks = calcRanks(sorted);
  sorted.forEach(([id, p], idx) => {
    const isMe = id===myId;
    let cls = p.st==='win'?'win':p.st==='lose'?'lose':p.st==='spec'?'spec':'';
    if(isMe && !cls) cls = 'me';
    let sv = p.sc||0;
    if(['survival','free','freeze','m_n_rest','swedish','ren_wrong'].includes(r)) sv = p.c;
    else if(r==='by') sv = p.sc||0;
    else if(r==='time_race') sv = p.sc||0;
    
    let wtxt = p.w;
    if(r==='swedish'||r==='ren_wrong') wtxt = p.w + '√ó';
    
    let sub = '';
    if(p.rst > 0) sub += `<span style="color:var(--yellow)">‰ºë:${p.rst}</span> `;
    if(p.str > 0) sub += `<span style="color:var(--cyan)">ÈÄ£:${p.str}</span> `;
    if(p.adv > 0) sub += `<span style="color:var(--red)">DAdv!</span> `;
    
    h += `
    <div class="pcard ${cls}">
      <div class="rank-num">${ranks[idx]}</div>
      <div class="p-main">
        <div class="p-name">${esc(p.name)} ${isMe?'<span class="badge b-you">YOU</span>':''}</div>
        <div class="p-stats">
          <span class="c">‚óØ ${p.c}</span>
          <span class="w">‚úï ${wtxt}</span>
        </div>
      </div>
      <div class="score-box">
        <div class="score-val">${sv}</div>
        <div class="score-sub">${p.st==='win'?'<span class="st-win">WIN</span>':p.st==='lose'?'<span class="st-lose">LOSE</span>':sub}</div>
      </div>
      ${!isMe ? `<button class="kick-btn" onclick="kickPlayer('${id}','${esc(p.name)}')" title="ÈÄÄÂá∫„Åï„Åõ„Çã">‚úï</button>` : ''}
    </div>`;
  });
  document.getElementById('plist').innerHTML = h;
  
  const me = pl[myId];
  if(me) {
    document.getElementById('btn-role').innerText = me.st==='spec'?'üéÆ JOIN':'üëÄ WATCH';
    const ox = document.getElementById('ox-grid');
    if(me.st==='spec' || me.st==='win' || me.st==='lose') ox.style.display = 'none';
    else {
      ox.style.display = 'grid';
      if(me.rst > 0) ox.innerHTML = `<button class="ox-btn btn-rest" onclick="sendAction('rest')">‰ºë„ÅøÊ∂àÂåñ (${me.rst})</button>`;
      else ox.innerHTML = `<button class="ox-btn btn-o" onclick="sendAction('correct')">‚óØ</button><button class="ox-btn btn-x" onclick="sendAction('wrong')">‚úï</button>`;
    }
  }
}

async function kickPlayer(targetId, targetName) {
  if(!confirm(`„Äå${targetName}„Äç„ÇíÈÄÄÂá∫„Åï„Åõ„Åæ„Åô„ÅãÔºü`)) return;
  await db.ref(`rooms/${rId}/players/${targetId}`).remove();
  await pushSysMsg(`${targetName} „ÅåÈÄÄÂá∫„Åï„Åõ„Çâ„Çå„Åæ„Åó„Åü`);
  toast(`${targetName} „ÇíÈÄÄÂá∫„Åï„Åõ„Åæ„Åó„Åü`);
}

async function sendAction(type) {
  if(!roomData || !roomData.players || !roomData.players[myId]) return;
  const pData = JSON.parse(JSON.stringify(roomData.players));
  const me = pData[myId];
  if(me.st !== 'active') return;

  const r = roomData.rule;
  
  if(r === 'time_race') {
    if(!timerData || timerData.state !== 'running') {
      toast('„Çø„Ç§„Éû„Éº„ÅåÂãï„ÅÑ„Å¶„ÅÑ„ÇãÈñì„ÅÆ„ÅøÂõûÁ≠î„Åß„Åç„Åæ„Åô');
      return;
    }
  }
  
  const mePrev = JSON.stringify({c:me.c, w:me.w, sc:me.sc, rst:me.rst, str:me.str, adv:me.adv, st:me.st});
  
  const c = roomData.conf || DEF_CONF[r];
  
  if(type === 'rest') {
    me.rst--;
  } else if(type === 'correct') {
    me.c++;
    if(r==='survival') { if(me.c >= c.m) me.st='win'; }
    else if(r==='newyork') { me.sc = (me.sc||0) + c.m; if(me.sc >= c.win) me.st='win'; }
    else if(r==='rentou') {
      if (c.mode === 'const') {
        me.sc = (me.sc||0) + (me.str>0?2:1);
        const pStr = me.str;
        me.str = pStr > 0 ? 0 : 1;
        Object.keys(pData).forEach(id => {
          if(id !== myId) pData[id].str = 0;
        });
      } else {
        me.sc = (me.sc||0) + (me.str>0?2:1);
        me.str++;
      }
      if(me.sc>=c.m) me.st='win';
    }
    else if(r==='updown') { me.sc = (me.sc||0) + 1; if(me.sc>=c.m) me.st='win'; }
    else if(r==='by') { me.sc = me.c * (c.m - me.w); if(me.sc >= c.m*c.m) me.st='win'; }
    else if(r==='freeze') { if(me.c >= c.m) me.st='win'; }
    else if(r==='m_n_rest') { if(me.c >= c.m) me.st='win'; }
    else if(r==='swedish') { if(me.c >= c.m) me.st='win'; }
    else if(r==='ren_wrong') { me.adv = 0; if(me.c >= c.m) me.st='win'; }
    else if(r==='divide') { me.sc = (me.sc||c.init)+c.add; if(me.sc>=c.win) me.st='win'; }
    else if(r==='combo') { me.str++; me.sc = (me.sc||0) + me.str; if(me.sc>=c.win) me.st='win'; }
    else if(r==='attack_surv') {
      me.sc = (me.sc||c.life)+c.heal;
      Object.keys(pData).forEach(id => {
        if(id!==myId && pData[id].st==='active') {
          pData[id].sc = (pData[id].sc||c.life)-c.dmg_to_oth;
          if(pData[id].sc<=0) pData[id].st='lose';
        }
      });
    }
    else if(r==='lucky') { me.sc = (me.sc||0) + Math.floor(Math.random()*c.max)+1; if(me.sc>=c.win) me.st='win'; }
    else if(r==='spiral') {
      let maxStep = Math.max(...Object.values(pData).filter(p=>p.st==='active').map(p=>p.sc||0));
      if((me.sc||0) >= maxStep) me.str++; else me.str=0;
      me.sc = (me.sc||0)+c.up;
      if(me.str >= c.top_req) me.st='win';
    }
    else if(r==='time_race') { me.sc = (me.sc||0) + (c.correct_pt||1); }
  } else if(type === 'wrong') {
    me.w++;
    if(r==='survival') { if(c.n > 0 && me.w >= c.n) me.st='lose'; }
    else if(r==='newyork') { me.sc = (me.sc||0) - c.n; if(me.sc <= c.lose) me.st='lose'; }
    else if(r==='rentou') { me.str=0; if(c.n > 0 && me.w >= c.n) me.st='lose'; }
    else if(r==='updown') { me.sc=0; if(c.n > 0 && me.w >= c.n) me.st='lose'; }
    else if(r==='by') { me.sc = me.c * (c.m - me.w); if(c.n > 0 && me.w >= c.n) me.st='lose'; }
    else if(r==='freeze') { me.rst += me.w; if(c.n > 0 && me.w >= c.n) me.st='lose'; }
    else if(r==='m_n_rest') { me.rst += c.n; }
    else if(r==='swedish') {
      const batsu = Math.floor((Math.sqrt(8*me.c+1)-1)/2)+1;
      me.w = (me.w-1)+batsu; 
      if(c.n > 0 && me.w >= c.n) me.st='lose';
    }
    else if(r==='ren_wrong') {
      me.w = (me.w-1) + (me.adv>0?2:1); me.adv=1;
      if(c.n > 0 && me.w >= c.n) me.st='lose';
    }
    else if(r==='divide') {
      me.sc = Math.floor((me.sc||c.init)/me.w);
      if(me.sc < 1) me.st='lose';
    }
    else if(r==='combo') { me.str=0; if(c.lose > 0 && me.w >= c.lose) me.st='lose'; }
    else if(r==='attack_surv') {
      me.sc = (me.sc||c.life)-c.dmg_to_me;
      if(me.sc<=0) me.st='lose';
    }
    else if(r==='lucky') { me.sc = (me.sc||0) - Math.floor(Math.random()*c.max)-1; if(me.sc<=c.lose) me.st='lose'; }
    else if(r==='spiral') {
      let minStep = Math.min(...Object.values(pData).filter(p=>p.st==='active').map(p=>p.sc||0));
      if((me.sc||0) <= minStep) me.adv++; else me.adv=0;
      me.sc = (me.sc||0)-c.down;
      if(me.adv >= c.btm_req) me.st='lose';
    }
    else if(r==='time_race') { me.sc = (me.sc||0) - (c.wrong_pt||1); }
  }

  me.hist = me.hist || [];
  me.hist.unshift(mePrev);
  if(me.hist.length > 5) me.hist.length = 5;

  const prevParsed = JSON.parse(mePrev);
  if (me.c !== prevParsed.c || me.w !== prevParsed.w) {
    me.statsAt = Date.now();
  }
  if (me.st === 'win' && prevParsed.st !== 'win') {
    me.winAt = Date.now();
  }

  await db.ref(`rooms/${rId}/players`).update(pData);
  
  if(r==='attack_surv') {
    const act = Object.values(pData).filter(p=>p.st==='active').length;
    if(act <= c.surv) await db.ref(`rooms/${rId}/status`).set('finished');
  }
}

async function reqUndo() {
  if(!roomData || !roomData.players || !roomData.players[myId]) return;
  const me = roomData.players[myId];
  if(!me.hist || me.hist.length === 0) return;
  
  const hist = [...me.hist];
  const prevState = JSON.parse(hist.shift());
  prevState.hist = hist;
  
  await db.ref(`rooms/${rId}/players/${myId}`).update(prevState);
  toast('‚Ü© UNDO done!');
}

async function toggleRole() {
  const me = roomData.players[myId];
  await db.ref(`rooms/${rId}/players/${myId}/st`).set(me.st==='spec'?'active':'spec');
}

async function resetPoints() {
  if(!confirm('ÂÖ®Âì°„ÅÆ„Çπ„Ç≥„Ç¢„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) return;
  const pData = JSON.parse(JSON.stringify(roomData.players));
  
  const c = roomData.conf || {};
  const sc = roomData.rule==='divide' ? (c.init || 10) : roomData.rule==='attack_surv' ? (c.life || 20) : 0;
  
  Object.keys(pData).forEach(k => {
    pData[k] = { ...pData[k], c:0, w:0, sc:sc, rst:0, str:0, adv:0, hist:[], winAt:0, statsAt:Date.now() };
    if(pData[k].st !== 'spec') pData[k].st = 'active';
  });
  await db.ref(`rooms/${rId}/players`).set(pData);
  if(roomData.rule === 'time_race') {
    const c = roomData.conf || DEF_CONF.time_race;
    const lm = (c.limit||5) * 60 * 1000;
    await db.ref(`rooms/${rId}/timer`).set({state:'idle', limitMs:lm, remaining:lm, startAt:null, cdStartAt:null});
  }
  closeModal(); toast('„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü');
}

async function endGame() {
  if(confirm('„Ç≤„Éº„É†„ÇíÁµÇ‰∫Ü„Åó„Åæ„Åô„ÅãÔºü')) {
    await db.ref(`rooms/${rId}/status`).set('finished');
    closeModal();
  }
}

function renderResult() {
  show('result');
  const pl = roomData.players || {};
  const r = roomData.rule;
  const sorted = sortPlayers(pl, r).filter(x => x[1].st !== 'spec');
  const ranks = calcRanks(sorted);
  let h = '';
  sorted.forEach(([id, p], idx) => {
    let sv = p.sc||0;
    if(['survival','free','freeze','m_n_rest','swedish','ren_wrong'].includes(r)) sv = p.c;
    else if(r==='by') sv = p.sc||0;
    else if(r==='time_race') sv = p.sc||0;
    let mst = p.st==='win'?'WIN':p.st==='lose'?'LOSE':'-';
    h += `
    <div class="pcard ${p.st==='win'?'win':p.st==='lose'?'lose':''}">
      <div class="rank-num">${ranks[idx]}</div>
      <div class="p-main">
        <div class="p-name">${esc(p.name)}</div>
        <div class="p-stats"><span class="c">‚óØ ${p.c}</span><span class="w">‚úï ${p.w}</span></div>
      </div>
      <div class="score-box">
        <div class="score-val">${sv}</div>
        <div class="score-sub" style="color:${p.st==='win'?'var(--green)':p.st==='lose'?'var(--red)':''}">${mst}</div>
      </div>
    </div>`;
  });
  document.getElementById('rlist').innerHTML = h;
}

function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function copyUrl(){ 
  navigator.clipboard.writeText(getRoomUrl()); 
  toast('URL copied'); 
}
function copyId(){ navigator.clipboard.writeText(rId); toast('ID copied'); }

function getMyName(fallback='') {
  if(roomData && roomData.players && roomData.players[myId] && roomData.players[myId].name)
    return roomData.players[myId].name;
  return fallback || localStorage.getItem('qr_name') || 'Player';
}

function initChat(playerName='') {
  const stampsEl = document.getElementById('chat-stamps');
  stampsEl.innerHTML = STAMPS.map(s =>
    `<button class="stamp-btn" onclick="sendStamp('${s}')">${s}</button>`
  ).join('');

  if(chatRef) chatRef.off('child_added', chatCb);
  lastSeenMsgTs = Date.now();
  chatRef = db.ref(`rooms/${rId}/chat`).limitToLast(100);
  chatCb = chatRef.on('child_added', snap => {
    const msg = snap.val();
    renderChatMsg(msg);
    if(!chatOpen && msg.ts > lastSeenMsgTs && msg.playerId !== myId) {
      chatUnread++;
      updateChatBadge();
    }
  });

  const name = playerName || getMyName();
  pushSysMsg(`${name} „ÅåÂÖ•ÂÆ§„Åó„Åæ„Åó„Åü`);
}

function toggleChat() {
  chatOpen = !chatOpen;
  document.getElementById('chat-drawer').classList.toggle('open', chatOpen);
  document.getElementById('chat-overlay').classList.toggle('show', chatOpen);
  if(chatOpen) {
    chatUnread = 0;
    lastSeenMsgTs = Date.now();
    updateChatBadge();
    setTimeout(() => {
      const el = document.getElementById('chat-messages');
      el.scrollTop = el.scrollHeight;
      document.getElementById('chat-input').focus();
    }, 50);
  }
}

function updateChatBadge() {
  const badge = document.getElementById('chat-badge');
  if(chatUnread > 0) {
    badge.textContent = chatUnread > 99 ? '99+' : chatUnread;
    badge.classList.add('show');
  } else {
    badge.classList.remove('show');
  }
}

function renderChatMsg(msg) {
  const el = document.getElementById('chat-messages');
  const div = document.createElement('div');
  if(msg.type === 'system') {
    div.className = 'chat-sys';
    div.textContent = msg.text;
  } else {
    const isMe = msg.playerId === myId;
    const isStamp = msg.stamp;
    div.className = `chat-msg ${isMe ? 'me' : 'other'}`;
    div.innerHTML = `
      <div class="chat-msg-name">${esc(msg.playerName)}</div>
      <div class="${isStamp ? 'chat-msg-stamp' : 'chat-msg-bubble'}">${esc(msg.text)}</div>
    `;
  }
  el.appendChild(div);
  if(chatOpen || msg.playerId === myId) el.scrollTop = el.scrollHeight;
}

async function sendChatMsg() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if(!text || !rId) return;
  input.value = '';
  await db.ref(`rooms/${rId}/chat`).push({
    type: 'msg', playerId: myId, playerName: getMyName(),
    text, stamp: false, ts: firebase.database.ServerValue.TIMESTAMP
  });
}

async function sendStamp(emoji) {
  if(!rId) return;
  await db.ref(`rooms/${rId}/chat`).push({
    type: 'msg', playerId: myId, playerName: getMyName(),
    text: emoji, stamp: true, ts: firebase.database.ServerValue.TIMESTAMP
  });
}

async function pushSysMsg(text) {
  if(!rId || !db) return;
  await db.ref(`rooms/${rId}/chat`).push({
    type: 'system', text, ts: firebase.database.ServerValue.TIMESTAMP
  });
}

let timerInterval = null;
let timerData = null;
let timerRef = null;
let timerCb = null;
let cdInterval = null;
let cdStartTimeout = null;

function initTimerListener() {
  if(timerRef) { timerRef.off('value', timerCb); timerRef = null; }
  timerRef = db.ref(`rooms/${rId}/timer`);
  timerCb = timerRef.on('value', snap => {
    timerData = snap.val();
    updateTimerDisplay();
  });
}

function formatMs(ms) {
  const totalSec = Math.max(0, Math.ceil(ms / 1000));
  const m = Math.floor(totalSec / 60);
  const s = totalSec % 60;
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function updateTimerDisplay() {
  if(!timerData) return;
  const disp = document.getElementById('timer-display');
  const btnStart = document.getElementById('timer-btn-start');
  const btnStop = document.getElementById('timer-btn-stop');
  const co = document.getElementById('countdown-overlay');
  if(!disp) return;

  const { state, startAt, remaining, limitMs, cdStartAt } = timerData;

  clearInterval(timerInterval); timerInterval = null;
  clearInterval(cdInterval); cdInterval = null;

  if(state === 'countdown') {
    co.classList.add('show');
    btnStart.disabled = true;
    btnStop.disabled = false;
    disp.textContent = formatMs(remaining !== undefined ? remaining : limitMs);
    disp.className = 'timer-display';
    const tick = () => {
      if(!cdStartAt) return;
      const elapsed = getServerTime() - cdStartAt;
      let left = Math.ceil((5000 - elapsed) / 1000);
      if(left > 5) left = 5;
      if(left <= 0) {
        document.getElementById('countdown-num').textContent = 'GO!';
        document.getElementById('countdown-num').style.animation = 'none';
        void document.getElementById('countdown-num').offsetWidth;
        document.getElementById('countdown-num').style.animation = 'cdPop 0.35s cubic-bezier(0.16, 1, 0.3, 1)';
        setTimeout(() => { co.classList.remove('show'); }, 700);
        clearInterval(cdInterval);
        return;
      }
      const numEl = document.getElementById('countdown-num');
      if(numEl.textContent !== String(left)) {
        numEl.textContent = left;
        numEl.style.animation = 'none';
        void numEl.offsetWidth;
        numEl.style.animation = 'cdPop 0.35s cubic-bezier(0.16, 1, 0.3, 1)';
      }
    };
    tick();
    cdInterval = setInterval(tick, 100);

  } else if(state === 'running') {
    if (document.getElementById('countdown-num').textContent !== 'GO!') {
      co.classList.remove('show');
    }
    btnStart.disabled = true;
    btnStop.disabled = false;
    const tick = () => {
      if(!startAt || remaining === undefined) return;
      const elapsed = getServerTime() - startAt;
      const left = Math.max(0, remaining - elapsed);
      disp.textContent = formatMs(left);
      if(left <= 30000) disp.className = 'timer-display danger';
      else if(left <= 60000) disp.className = 'timer-display warning';
      else disp.className = 'timer-display';
      if(left <= 0) {
        clearInterval(timerInterval);
        timerInterval = null;
        db.ref(`rooms/${rId}/timer/state`).transaction(cur => {
          if(cur === 'running') return 'finished';
          return undefined;
        }).then(res => {
          if(res && res.committed) finishTimeRace();
        });
      }
    };
    tick();
    timerInterval = setInterval(tick, 100);

  } else if(state === 'paused' || state === 'idle') {
    co.classList.remove('show');
    btnStart.disabled = false;
    btnStop.disabled = true;
    const rem = (state === 'paused') ? (remaining !== undefined ? remaining : 0) : (limitMs || 300000);
    disp.textContent = formatMs(rem);
    if(rem <= 30000) disp.className = 'timer-display danger';
    else if(rem <= 60000) disp.className = 'timer-display warning';
    else disp.className = 'timer-display';

  } else if(state === 'finished') {
    co.classList.remove('show');
    disp.textContent = '00:00';
    disp.className = 'timer-display danger';
    btnStart.disabled = true;
    btnStop.disabled = true;
  }
}

async function timerAction(action) {
  if(!rId || !db) return;
  
  let confirmMsg = '';
  if(action === 'start') confirmMsg = '„Çø„Ç§„Éû„Éº„Çí„Çπ„Çø„Éº„ÉàÔºàÂÜçÈñãÔºâ„Åó„Åæ„Åô„ÅãÔºü';
  else if(action === 'stop') confirmMsg = '„Çø„Ç§„Éû„Éº„Çí„Çπ„Éà„ÉÉ„ÉóÔºà‰∏ÄÊôÇÂÅúÊ≠¢Ôºâ„Åó„Åæ„Åô„ÅãÔºü';
  else if(action === 'reset') confirmMsg = '„Çø„Ç§„Éû„Éº„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü';
  
  if(!confirm(confirmMsg)) return;

  const conf = (roomData && roomData.conf) ? roomData.conf : DEF_CONF.time_race;
  const limitMs = (conf.limit || 5) * 60 * 1000;
  const td = timerData || {};

  if(action === 'start') {
    if(td.state === 'running' || td.state === 'countdown') return;
    const currentRemaining = (td.state === 'paused') ? (td.remaining !== undefined ? td.remaining : limitMs) : limitMs;
    await db.ref(`rooms/${rId}/timer`).set({
      state: 'countdown',
      cdStartAt: firebase.database.ServerValue.TIMESTAMP,
      remaining: currentRemaining,
      limitMs: td.limitMs || limitMs,
      startAt: null
    });
    clearTimeout(cdStartTimeout);
    cdStartTimeout = setTimeout(async () => {
      const snap = await db.ref(`rooms/${rId}/timer/state`).once('value');
      if(snap.val() === 'countdown') {
        const remSnap = await db.ref(`rooms/${rId}/timer/remaining`).once('value');
        await db.ref(`rooms/${rId}/timer`).update({
          state: 'running',
          startAt: firebase.database.ServerValue.TIMESTAMP,
          remaining: remSnap.val() !== null ? remSnap.val() : currentRemaining
        });
      }
    }, 5000);

  } else if(action === 'stop') {
    clearTimeout(cdStartTimeout);
    if(td.state === 'countdown') {
      await db.ref(`rooms/${rId}/timer`).update({ state: 'paused' });
      return;
    }
    if(td.state !== 'running') return;
    const elapsed = td.startAt ? getServerTime() - td.startAt : 0;
    const currentRemaining = Math.max(0, (td.remaining !== undefined ? td.remaining : limitMs) - elapsed);
    await db.ref(`rooms/${rId}/timer`).update({ state: 'paused', remaining: currentRemaining });

  } else if(action === 'reset') {
    clearTimeout(cdStartTimeout);
    clearInterval(timerInterval); timerInterval = null;
    clearInterval(cdInterval); cdInterval = null;
    const conf2 = (roomData && roomData.conf) ? roomData.conf : DEF_CONF.time_race;
    const lm = (conf2.limit || 5) * 60 * 1000;
    await db.ref(`rooms/${rId}/timer`).set({
      state: 'idle', limitMs: lm, remaining: lm, startAt: null, cdStartAt: null
    });
  }
}

async function finishTimeRace() {
  if(!roomData || !roomData.players) return;
  const pData = JSON.parse(JSON.stringify(roomData.players));
  const actives = Object.values(pData).filter(p => p.st === 'active');
  if(actives.length === 0) return;
  const maxSc = Math.max(...actives.map(p => p.sc || 0));
  Object.keys(pData).forEach(k => {
    if(pData[k].st === 'active') {
      pData[k].st = (pData[k].sc || 0) >= maxSc ? 'win' : 'lose';
    }
  });
  await db.ref(`rooms/${rId}/players`).update(pData);
  await db.ref(`rooms/${rId}/status`).set('finished');
}
</script>
</body>
</html>
