<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Q-Room</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:ital,wght@0,300;0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg:       #05050f;
  --surface:  #0b0b1e;
  --card:     #10102a;
  --card2:    #13132f;
  --border:   rgba(255,255,255,0.07);
  --border2:  rgba(255,255,255,0.12);
  --cyan:     #00e5ff;
  --cyan2:    #0099cc;
  --pink:     #ff2d6f;
  --green:    #00e096;
  --red:      #ff4757;
  --yellow:   #ffd32a;
  --text:     #e8e8f8;
  --text2:    #a0a0c0;
  --muted:    #4a4a6a;
  --font-display: 'Orbitron', monospace;
  --font-body:    'Exo 2', sans-serif;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-body);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 0;
  overflow-x: hidden;
}

/* Animated background grid */
body::before {
  content: '';
  position: fixed; inset: 0;
  background-image:
    linear-gradient(rgba(0,229,255,0.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,229,255,0.025) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none; z-index: 0;
}
body::after {
  content: '';
  position: fixed; inset: 0;
  background:
    radial-gradient(ellipse 70% 50% at 15% 0%, rgba(0,229,255,0.07) 0%, transparent 55%),
    radial-gradient(ellipse 60% 60% at 85% 100%, rgba(255,45,111,0.07) 0%, transparent 55%);
  pointer-events: none; z-index: 0;
}

.screen {
  display: none;
  width: 100%;
  max-width: 520px;
  padding: 28px 18px 80px;
  position: relative;
  z-index: 1;
  animation: fadeUp 0.3s ease;
}
.screen.active { display: block; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes pulse-border {
  0%, 100% { box-shadow: 0 0 0 0 rgba(0,229,255,0.15); }
  50%       { box-shadow: 0 0 0 6px rgba(0,229,255,0); }
}
@keyframes winner-glow {
  0%, 100% { box-shadow: 0 0 12px rgba(0,224,150,0.2); }
  50%       { box-shadow: 0 0 24px rgba(0,224,150,0.5); }
}
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes bar-fill { from { width: 0; } }

/* â”€â”€ LOGO â”€â”€ */
.logo {
  font-family: var(--font-display);
  font-size: 3.2rem;
  font-weight: 900;
  letter-spacing: 0.14em;
  text-align: center;
  background: linear-gradient(135deg, var(--cyan) 0%, #7b61ff 50%, var(--pink) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 6px;
  filter: drop-shadow(0 0 24px rgba(0,229,255,0.35));
}
.tagline {
  text-align: center;
  color: var(--muted);
  font-size: 0.78rem;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  margin-bottom: 36px;
}
h2 {
  font-family: var(--font-display);
  font-size: 1rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  color: var(--cyan);
  margin-bottom: 16px;
}
h3 {
  font-family: var(--font-display);
  font-size: 0.78rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  color: var(--muted);
  text-transform: uppercase;
  margin-bottom: 12px;
}

/* â”€â”€ CARD â”€â”€ */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 18px;
  padding: 20px;
  margin-bottom: 14px;
  position: relative;
  overflow: hidden;
}
.card::before {
  content: '';
  position: absolute;
  top: 0; left: 20%; right: 20%; height: 1px;
  background: linear-gradient(90deg, transparent, rgba(0,229,255,0.5), transparent);
}

/* â”€â”€ TOP NAV â”€â”€ */
.top-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 14px;
}
.btn-small {
  padding: 8px 14px !important;
  font-size: 0.72rem !important;
  width: auto !important;
  margin-bottom: 0 !important;
  border-radius: 8px !important;
}

/* â”€â”€ FORM â”€â”€ */
.field { margin-bottom: 16px; }
label {
  display: block;
  font-size: 0.68rem;
  font-weight: 700;
  letter-spacing: 0.14em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 8px;
}
input[type="text"], input[type="number"] {
  width: 100%;
  padding: 13px 16px;
  background: rgba(0,0,0,0.45);
  border: 1px solid var(--border2);
  border-radius: 12px;
  color: var(--text);
  font-family: var(--font-body);
  font-size: 1rem;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
}
input[type="text"]:focus, input[type="number"]:focus {
  border-color: var(--cyan);
  background: rgba(0,229,255,0.04);
  box-shadow: 0 0 0 3px rgba(0,229,255,0.1);
}
input::placeholder { color: var(--muted); }
.room-id-row { display: flex; gap: 10px; }
.room-id-row input { flex: 1; font-family: var(--font-display); letter-spacing: 0.2em; font-size: 1.1rem; }
.room-id-row .gen-btn {
  padding: 13px 14px;
  background: rgba(0,229,255,0.08);
  border: 1px solid rgba(0,229,255,0.25);
  border-radius: 12px;
  color: var(--cyan);
  cursor: pointer;
  font-size: 1rem;
  transition: all 0.2s;
  font-family: var(--font-body);
}
.room-id-row .gen-btn:hover { background: rgba(0,229,255,0.18); }

/* â”€â”€ BUTTONS â”€â”€ */
.btn {
  width: 100%;
  padding: 15px;
  border: none;
  border-radius: 13px;
  font-family: var(--font-display);
  font-size: 0.78rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  cursor: pointer;
  transition: all 0.18s;
  margin-bottom: 10px;
  position: relative;
  overflow: hidden;
}
.btn::after {
  content: '';
  position: absolute; inset: 0;
  background: rgba(255,255,255,0.07);
  opacity: 0;
  transition: opacity 0.15s;
}
.btn:hover::after { opacity: 1; }
.btn:active { transform: scale(0.972); }
.btn-primary {
  background: linear-gradient(135deg, var(--cyan) 0%, #007acc 100%);
  color: #000;
  font-weight: 800;
  box-shadow: 0 4px 24px rgba(0,229,255,0.25), inset 0 1px 0 rgba(255,255,255,0.2);
}
.btn-primary:hover { box-shadow: 0 6px 32px rgba(0,229,255,0.4); }
.btn-secondary {
  background: linear-gradient(135deg, var(--pink) 0%, #aa0033 100%);
  color: #fff;
  font-weight: 800;
  box-shadow: 0 4px 24px rgba(255,45,111,0.25), inset 0 1px 0 rgba(255,255,255,0.1);
}
.btn-ghost {
  background: transparent;
  border: 1px solid var(--border2);
  color: var(--text2);
}
.btn-ghost:hover { border-color: var(--cyan); color: var(--cyan); background: rgba(0,229,255,0.04); }

/* â”€â”€ ACTION BUTTONS (O/X) â”€â”€ */
.btn-correct {
  background: linear-gradient(135deg, #00e096 0%, #007a50 100%);
  color: #000;
  font-family: var(--font-body);
  font-size: 1.6rem;
  font-weight: 900;
  letter-spacing: 0;
  padding: 22px 16px;
  border-radius: 16px;
  box-shadow: 0 6px 28px rgba(0,224,150,0.35), inset 0 1px 0 rgba(255,255,255,0.2);
  border: none;
  cursor: pointer;
  transition: all 0.18s;
  width: 100%;
}
.btn-correct:active { transform: scale(0.95); box-shadow: 0 2px 12px rgba(0,224,150,0.3); }
.btn-wrong {
  background: linear-gradient(135deg, #ff4757 0%, #8b0000 100%);
  color: #fff;
  font-family: var(--font-body);
  font-size: 1.6rem;
  font-weight: 900;
  letter-spacing: 0;
  padding: 22px 16px;
  border-radius: 16px;
  box-shadow: 0 6px 28px rgba(255,71,87,0.35), inset 0 1px 0 rgba(255,255,255,0.1);
  border: none;
  cursor: pointer;
  transition: all 0.18s;
  width: 100%;
}
.btn-wrong:active { transform: scale(0.95); box-shadow: 0 2px 12px rgba(255,71,87,0.3); }

/* â”€â”€ ERROR â”€â”€ */
.error-msg {
  color: var(--red);
  font-size: 0.82rem;
  margin-bottom: 12px;
  display: none;
  padding: 10px 14px;
  background: rgba(255,71,87,0.08);
  border-radius: 10px;
  border: 1px solid rgba(255,71,87,0.2);
}

/* â”€â”€ SHARE â”€â”€ */
.share-row { display: flex; gap: 8px; margin-top: 16px; }
.share-btn {
  flex: 1;
  padding: 10px 6px;
  border: 1px solid var(--border2);
  border-radius: 10px;
  background: rgba(255,255,255,0.02);
  color: var(--text2);
  cursor: pointer;
  font-size: 0.72rem;
  font-weight: 600;
  letter-spacing: 0.04em;
  font-family: var(--font-body);
  transition: all 0.2s;
}
.share-btn:hover { border-color: var(--cyan); color: var(--cyan); background: rgba(0,229,255,0.06); }

/* â”€â”€ PLAYER AVATAR â”€â”€ */
.player-avatar {
  width: 36px; height: 36px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--cyan), #7b61ff);
  display: flex; align-items: center; justify-content: center;
  font-weight: 800; font-size: 0.9rem; color: #000;
  flex-shrink: 0;
  box-shadow: 0 0 0 2px rgba(0,229,255,0.2);
}

/* â”€â”€ MODE TABS â”€â”€ */
.mode-tabs { display: flex; gap: 6px; margin-bottom: 16px; }
.mode-tab {
  flex: 1;
  padding: 10px 6px;
  border: 1px solid var(--border2);
  border-radius: 10px;
  background: transparent;
  color: var(--muted);
  cursor: pointer;
  font-size: 0.76rem;
  font-weight: 700;
  font-family: var(--font-body);
  letter-spacing: 0.04em;
  transition: all 0.2s;
}
.mode-tab.active {
  background: rgba(0,229,255,0.1);
  border-color: var(--cyan);
  color: var(--cyan);
}
.settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.settings-grid .field { margin-bottom: 0; }
.settings-desc { font-size: 0.77rem; color: var(--text2); line-height: 1.7; margin-bottom: 14px; }
.settings-panel { display: none; }
.settings-panel.active { display: block; }

/* â”€â”€ GAME TOPBAR â”€â”€ */
.game-topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding: 10px 14px;
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 12px;
}
.game-room-id {
  font-family: var(--font-display);
  font-size: 0.7rem;
  letter-spacing: 0.2em;
  color: var(--muted);
}
.game-room-id span { color: var(--cyan); letter-spacing: 0.25em; }
.mode-pill {
  padding: 5px 12px;
  background: rgba(255,45,111,0.1);
  border: 1px solid rgba(255,45,111,0.2);
  border-radius: 20px;
  font-size: 0.7rem;
  font-weight: 700;
  letter-spacing: 0.06em;
  color: var(--pink);
}

/* â”€â”€ PLAYER CARDS â”€â”€ */
.player-cards { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
.pcard {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 13px 15px;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}
.pcard.pcard-me {
  border-color: rgba(0,229,255,0.35);
  background: rgba(0,229,255,0.03);
  animation: pulse-border 3s ease-in-out infinite;
}
.pcard.pcard-winner {
  border-color: var(--green);
  background: rgba(0,224,150,0.05);
  animation: winner-glow 2s ease-in-out infinite;
}
.pcard.pcard-winner::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--green), transparent);
}
.pcard.pcard-eliminated { opacity: 0.35; filter: grayscale(0.8); }
.pcard.pcard-spectator { opacity: 0.5; }

.pcard-top { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.pcard-name { flex: 1; font-weight: 700; font-size: 0.97rem; }
.pcard-status {
  font-size: 0.65rem; padding: 3px 9px; border-radius: 20px;
  font-weight: 700; letter-spacing: 0.07em; text-transform: uppercase;
}
.s-active    { background: rgba(74,74,106,0.35); color: var(--text2); }
.s-winner    { background: rgba(0,224,150,0.18); color: var(--green); border: 1px solid rgba(0,224,150,0.3); }
.s-eliminated{ background: rgba(255,71,87,0.12); color: var(--red); }
.s-spectator { background: rgba(100,100,100,0.15); color: var(--muted); }

/* â”€â”€ STAT DISPLAY â”€â”€ */
.pcard-stats { display: flex; gap: 12px; align-items: center; margin-bottom: 10px; }
.stat-box { display: flex; align-items: center; gap: 6px; }
.stat-icon { font-size: 0.85rem; }
.stat-val { font-weight: 800; font-size: 1.05rem; font-family: var(--font-display); }
.stat-val.correct { color: var(--green); }
.stat-val.wrong   { color: var(--red); }
.score-large {
  margin-left: auto;
  font-family: var(--font-display);
  font-size: 1.7rem;
  font-weight: 900;
  color: var(--cyan);
  filter: drop-shadow(0 0 10px rgba(0,229,255,0.5));
  letter-spacing: -0.02em;
}

/* â”€â”€ PROGRESS BAR â”€â”€ */
.pcard-progress { display: flex; flex-direction: column; gap: 5px; }
.prog-row { display: flex; align-items: center; gap: 8px; }
.prog-label { font-size: 0.65rem; color: var(--muted); width: 16px; text-align: right; flex-shrink: 0; }
.prog-track {
  flex: 1; height: 6px; border-radius: 3px; background: rgba(255,255,255,0.06); overflow: hidden;
}
.prog-fill {
  height: 100%; border-radius: 3px;
  transition: width 0.4s cubic-bezier(0.34,1.56,0.64,1);
  animation: bar-fill 0.4s ease;
}
.prog-fill.correct { background: linear-gradient(90deg, var(--green), #00ffaa); }
.prog-fill.wrong   { background: linear-gradient(90deg, var(--red), #ff8888); }
.prog-count { font-size: 0.68rem; color: var(--text2); min-width: 28px; }

/* â”€â”€ ACTION PANEL (sticky) â”€â”€ */
.my-action-panel {
  position: sticky;
  bottom: 16px;
  background: rgba(10,10,28,0.9);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid rgba(0,229,255,0.2);
  border-radius: 18px;
  padding: 14px;
  margin-top: 12px;
  box-shadow: 0 8px 40px rgba(0,0,0,0.7), 0 0 0 1px rgba(0,229,255,0.05);
}
.action-row { display: flex; gap: 12px; margin-bottom: 10px; }
.action-row button { flex: 1; margin-bottom: 0; }

.undo-row { margin-bottom: 10px; }
.btn-undo {
  width: 100%;
  padding: 11px;
  background: rgba(255,211,42,0.07);
  border: 1px solid rgba(255,211,42,0.25);
  border-radius: 10px;
  color: var(--yellow);
  cursor: pointer;
  font-size: 0.82rem;
  font-weight: 700;
  font-family: var(--font-body);
  transition: all 0.2s;
}
.btn-undo:hover { background: rgba(255,211,42,0.14); }
.btn-undo:active { transform: scale(0.97); }

/* â”€â”€ RESULT SCREEN â”€â”€ */
.podium-wrap { text-align: center; padding: 24px 20px; }
.podium-emoji { font-size: 4.5rem; line-height: 1; margin-bottom: 12px; }
.podium-name {
  font-family: var(--font-display);
  font-size: 1.5rem;
  font-weight: 900;
  background: linear-gradient(135deg, var(--yellow), #ff9500, var(--pink));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  margin-bottom: 6px;
  filter: drop-shadow(0 0 16px rgba(255,211,42,0.3));
}
.podium-sub { color: var(--text2); font-size: 0.82rem; letter-spacing: 0.12em; text-transform: uppercase; }

.result-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
.result-item {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 16px;
  background: var(--card);
  border-radius: 13px;
  border: 1px solid var(--border);
  transition: transform 0.2s;
}
.result-item:hover { transform: translateX(3px); }
.result-item.ri-1 { border-color: rgba(255,211,42,0.3); background: rgba(255,211,42,0.04); }
.result-item.ri-2 { border-color: rgba(192,192,192,0.2); }
.result-item.ri-3 { border-color: rgba(205,127,50,0.2); }
.result-rank { font-family: var(--font-display); font-size: 1rem; font-weight: 900; min-width: 26px; color: var(--muted); }
.result-rank.r1 { color: var(--yellow); filter: drop-shadow(0 0 6px rgba(255,211,42,0.6)); }
.result-rank.r2 { color: #c0c0c0; }
.result-rank.r3 { color: #cd7f32; }
.result-name { flex: 1; font-weight: 700; font-size: 0.95rem; }
.result-stats { font-size: 0.78rem; color: var(--muted); }
.result-score { font-family: var(--font-display); font-size: 0.95rem; font-weight: 700; color: var(--cyan); }

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position: fixed; bottom: 30px; left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: rgba(15,15,35,0.96);
  backdrop-filter: blur(14px);
  color: var(--text); padding: 12px 24px; border-radius: 30px;
  font-size: 0.88rem; border: 1px solid var(--border2);
  opacity: 0; transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
  pointer-events: none; z-index: 1000; max-width: 320px; text-align: center;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* â”€â”€ MISC â”€â”€ */
.divider {
  display: flex; align-items: center; gap: 12px;
  margin: 6px 0 16px; color: var(--muted); font-size: 0.72rem; letter-spacing: 0.1em;
}
.divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }

.config-notice {
  background: rgba(255,211,42,0.06); border: 1px solid rgba(255,211,42,0.22);
  border-radius: 12px; padding: 12px 16px; margin-bottom: 20px;
  font-size: 0.78rem; color: var(--yellow); line-height: 1.7; display: none;
}
.config-notice.visible { display: block; }
.config-notice strong { display: block; margin-bottom: 4px; font-family: var(--font-display); font-size: 0.75rem; letter-spacing: 0.08em; }

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.85); backdrop-filter: blur(6px);
  z-index: 100; display: none; align-items: flex-end; justify-content: center;
  opacity: 0; transition: opacity 0.25s;
}
.modal-overlay.active { display: flex; opacity: 1; }
.modal-content {
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 22px 22px 0 0;
  width: 100%; max-width: 520px; padding: 28px 22px 40px;
  position: relative;
  transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.34,1.2,0.64,1);
  box-shadow: 0 -10px 60px rgba(0,0,0,0.6);
  max-height: 90vh; overflow-y: auto;
}
.modal-overlay.active .modal-content { transform: translateY(0); }
.modal-handle {
  width: 40px; height: 4px; border-radius: 2px;
  background: var(--border2); margin: 0 auto 20px;
}
.modal-close {
  position: absolute; top: 20px; right: 20px;
  background: rgba(255,255,255,0.05); border: 1px solid var(--border);
  color: var(--muted); font-size: 1.1rem; cursor: pointer;
  width: 32px; height: 32px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.2s;
}
.modal-close:hover { color: var(--cyan); border-color: var(--cyan); }

@media (min-width: 521px) {
  body { padding-top: 24px; }
  .modal-overlay { align-items: center; }
  .modal-content { border-radius: 22px; max-width: 420px; transform: translateY(20px) scale(0.96); }
  .modal-overlay.active .modal-content { transform: translateY(0) scale(1); }
  .modal-handle { display: none; }
}
</style>
</head>
<body>

<!-- TOP -->
<div id="screen-top" class="screen active">
  <div class="logo">Q-ROOM</div>
  <div class="tagline">Real-time Quiz Battle</div>

  <div id="config-notice" class="config-notice">
    <strong>âš ï¸ Firebase æœªè¨­å®š</strong>
    ãƒ•ã‚¡ã‚¤ãƒ«ä¸‹éƒ¨ã® <code>firebaseConfig</code> ã‚’ã”è‡ªèº«ã®Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å€¤ã«å·®ã—æ›¿ãˆã¦ãã ã•ã„ã€‚
  </div>

  <div class="card">
    <div class="field">
      <label>Your Name</label>
      <input type="text" id="input-name" placeholder="åå‰ã‚’å…¥åŠ›" maxlength="20" autocomplete="off">
    </div>
    <div class="field">
      <label>Room ID <span style="color:var(--muted);font-weight:400;">(ç©ºç™½ã§ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ)</span></label>
      <div class="room-id-row">
        <input type="text" id="input-roomid" placeholder="4 8 2 9 1" maxlength="5" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
        <button class="gen-btn" onclick="fillRandomRoomId()">ğŸ²</button>
      </div>
    </div>
    <div id="top-error" class="error-msg"></div>
    <button class="btn btn-primary" onclick="handleCreate()">â–¶ Create a Room</button>
    <div class="divider">ã¾ãŸã¯</div>
    <button class="btn btn-secondary" onclick="handleJoin()">â†’ Join the Room</button>
  </div>
</div>

<!-- ROOM (GAME) -->
<div id="screen-room" class="screen">
  <div class="top-nav">
    <button class="btn btn-ghost btn-small" onclick="leaveRoom()">â† é€€å®¤</button>
    <button class="btn btn-ghost btn-small" onclick="openSettings()">âš™ è¨­å®š</button>
  </div>

  <div class="game-topbar">
    <div class="game-room-id">ROOM <span id="game-room-id-display">â€”</span></div>
    <div id="mode-pill-display" class="mode-pill">â€”</div>
  </div>

  <div id="game-player-cards" class="player-cards"></div>

  <div id="my-action-panel" class="my-action-panel">
    <div class="action-row" id="score-buttons" style="display:none;">
      <button class="btn-correct" onclick="recordResult(true)">â­•</button>
      <button class="btn-wrong"   onclick="recordResult(false)">âœ–</button>
    </div>
    <div class="undo-row" id="undo-row" style="display:none;">
      <button class="btn-undo" onclick="undoResult()">â†© ç›´å‰ã®å…¥åŠ›ã‚’å–ã‚Šæ¶ˆã™</button>
    </div>
    <button class="btn btn-ghost" id="btn-toggle-role" onclick="toggleMyRole()" style="margin-bottom:0;">
      ğŸ‘€ è¦³æˆ¦è€…ï¼ˆãƒ›ã‚¹ãƒˆï¼‰ã«ãªã‚‹
    </button>
  </div>
</div>

<!-- RESULT -->
<div id="screen-result" class="screen">
  <div class="top-nav">
    <button class="btn btn-ghost btn-small" onclick="returnToRoom()">â† éƒ¨å±‹ã«æˆ»ã‚‹</button>
    <button class="btn btn-ghost btn-small" onclick="leaveRoom()">ğŸ  ãƒˆãƒƒãƒ—ã¸</button>
  </div>
  <div class="logo" style="font-size:2rem; margin-bottom: 20px;">RESULT</div>
  <div id="podium-area" class="podium-wrap card"></div>
  <div class="card">
    <h3>æœ€çµ‚ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
    <div id="result-list" class="result-list"></div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div id="settings-modal" class="modal-overlay" onclick="handleModalOutsideClick(event)">
  <div class="modal-content">
    <div class="modal-handle"></div>
    <button class="modal-close" onclick="closeSettings()">âœ•</button>
    <h2 style="margin-bottom: 18px;">ãƒ«ãƒ¼ãƒ è¨­å®š</h2>

    <div class="share-row" style="margin-top:0; margin-bottom: 20px;">
      <button class="share-btn" onclick="copyLink()">ğŸ”— URLã‚³ãƒ”ãƒ¼</button>
      <button class="share-btn" onclick="copyRoomId()">ğŸ“‹ IDã‚³ãƒ”ãƒ¼</button>
      <button class="share-btn" onclick="shareNative()">ğŸ“¤ ã‚·ã‚§ã‚¢</button>
    </div>

    <div class="mode-tabs">
      <button class="mode-tab active" id="tab-survival"  onclick="updateMode('survival')">mâ—¯nÃ—</button>
      <button class="mode-tab"        id="tab-newyork"   onclick="updateMode('newyork')">New York</button>
      <button class="mode-tab"        id="tab-freecount" onclick="updateMode('freecount')">ãƒ•ãƒªãƒ</button>
    </div>

    <div id="panel-survival" class="settings-panel active">
      <div class="settings-desc">må•æ­£è§£ã§å‹ã¡æŠœã‘ãƒ»nå•èª¤ç­”ã§å¤±æ ¼ã€‚</div>
      <div class="settings-grid">
        <div class="field">
          <label>mï¼ˆå‹ã¡æŠœã‘ï¼‰</label>
          <input type="number" id="set-m" value="3" min="1" max="99" onchange="updateSettings()">
        </div>
        <div class="field">
          <label>nï¼ˆå¤±æ ¼ï¼‰</label>
          <input type="number" id="set-n" value="2" min="1" max="99" onchange="updateSettings()">
        </div>
      </div>
    </div>

    <div id="panel-newyork" class="settings-panel">
      <div class="settings-desc">1å•æ­£è§£ã§ +x ãƒã‚¤ãƒ³ãƒˆãƒ»1å•èª¤ç­”ã§ âˆ’y ãƒã‚¤ãƒ³ãƒˆã€‚ãƒ›ã‚¹ãƒˆãŒã€Œçµ‚äº†ã€ã‚’æŠ¼ã—ãŸæ™‚ç‚¹ã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</div>
      <div class="settings-grid">
        <div class="field">
          <label>xï¼ˆæ­£è§£ptï¼‰</label>
          <input type="number" id="set-x" value="10" min="1" max="999" onchange="updateSettings()">
        </div>
        <div class="field">
          <label>yï¼ˆèª¤ç­”ãƒã‚¤ãƒŠã‚¹ï¼‰</label>
          <input type="number" id="set-y" value="5" min="0" max="999" onchange="updateSettings()">
        </div>
      </div>
    </div>

    <div id="panel-freecount" class="settings-panel">
      <div class="settings-desc">å‹ã¡æŠœã‘ãƒ»å¤±æ ¼ãªã—ã€‚æ­£è§£æ•°ãƒ»èª¤ç­”æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹ã ã‘ã€‚ãƒ•ãƒªãƒã‚„ç·´ç¿’ã«ã€‚ãƒ›ã‚¹ãƒˆãŒã€Œçµ‚äº†ã€ã‚’æŠ¼ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æ­£è§£æ•°é †ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</div>
    </div>

    <hr style="border:0; border-top:1px solid var(--border); margin: 20px 0;">
    <button class="btn btn-ghost" onclick="resetPoints()" style="color:var(--yellow); border-color:rgba(255,211,42,0.3);">ğŸ”„ å…¨å“¡ã®ãƒã‚¤ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    <button class="btn btn-secondary" onclick="endGame()" style="margin-bottom:0;">â¹ ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¦çµæœã‚’è¦‹ã‚‹</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey:            "AIzaSyA3xtGLVJwij2BTiiOk7DsNeF9hIOuZCyI",
  authDomain:        "q-room-fe8a6.firebaseapp.com",
  databaseURL:       "https://q-room-fe8a6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:         "q-room-fe8a6",
  storageBucket:     "q-room-fe8a6.firebasestorage.app",
  messagingSenderId: "151049149394",
  appId:             "1:151049149394:web:7a3ea6406454f6a87d460b"
};

let db;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
} catch(e) {
  document.getElementById('config-notice').classList.add('visible');
}

let myPlayerId    = null;
let currentRoomId = null;
let roomListener  = null;
let currentMode   = 'survival';
let gameSettings  = null;
let lastAction    = null;

window.addEventListener('DOMContentLoaded', async () => {
  await cleanupOldRooms();
  checkUrlParams();
});

function getOrCreatePlayerId() {
  let id = localStorage.getItem('qroom_pid');
  if (!id) {
    id = 'p_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
    localStorage.setItem('qroom_pid', id);
  }
  return id;
}

function randomRoomId() {
  return String(Math.floor(10000 + Math.random() * 90000));
}
function fillRandomRoomId() {
  document.getElementById('input-roomid').value = randomRoomId();
}

function showError(id, msg) {
  const el = document.getElementById(id);
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => { el.style.display = 'none'; }, 4000);
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = document.getElementById('screen-' + id);
  el.classList.add('active');
  // re-trigger animation
  el.style.animation = 'none';
  el.offsetHeight;
  el.style.animation = '';
  window.scrollTo(0, 0);
}

function avatarLetter(name) {
  return (name || '?')[0].toUpperCase();
}

function checkUrlParams() {
  const pathRoom = window.location.pathname.replace(/\//g, '');
  const params   = new URLSearchParams(window.location.search);
  const rid      = pathRoom || params.get('room');
  if (rid && /^\d{5}$/.test(rid)) {
    document.getElementById('input-roomid').value = rid;
  }
}

function selectModeUI(mode) {
  currentMode = mode;
  document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
  const tabEl = document.getElementById('tab-' + mode);
  if (tabEl) tabEl.classList.add('active');
  document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
  const panelEl = document.getElementById('panel-' + mode);
  if (panelEl) panelEl.classList.add('active');
}

async function updateMode(mode) {
  selectModeUI(mode);
  if (db && currentRoomId) {
    await db.ref(`rooms/${currentRoomId}/settings/mode`).set(mode);
  }
}

async function updateSettings() {
  if (!db || !currentRoomId) return;
  const m = parseInt(document.getElementById('set-m').value) || 3;
  const n = parseInt(document.getElementById('set-n').value) || 2;
  const x = parseInt(document.getElementById('set-x').value) || 10;
  const y = parseInt(document.getElementById('set-y').value) || 5;
  await db.ref(`rooms/${currentRoomId}/settings`).update({ m, n, x, y });
}

async function resetPoints() {
  if (!confirm("å…¨å“¡ã®ã‚¹ã‚³ã‚¢ã‚’0ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
  const playersSnap = await db.ref(`rooms/${currentRoomId}/players`).once('value');
  const players = playersSnap.val() || {};
  const updates = {};
  for (const pid in players) {
    updates[`${pid}/correct`] = 0;
    updates[`${pid}/wrong`]   = 0;
    if (players[pid].status !== 'spectator') updates[`${pid}/status`] = 'active';
  }
  await db.ref(`rooms/${currentRoomId}/players`).update(updates);
  lastAction = null;
  showToast('ãƒã‚¤ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
  closeSettings();
}

async function toggleMyRole() {
  if (!db || !currentRoomId || !myPlayerId) return;
  const myRef = db.ref(`rooms/${currentRoomId}/players/${myPlayerId}/status`);
  const snap  = await myRef.once('value');
  const next  = snap.val() === 'spectator' ? 'active' : 'spectator';
  await myRef.set(next);
}

function setupPresence() {
  if (!db || !currentRoomId || !myPlayerId) return;
  const myRef = db.ref(`rooms/${currentRoomId}/players/${myPlayerId}`);
  myRef.child('online').set(true);
  myRef.child('lastActive').set(firebase.database.ServerValue.TIMESTAMP);
  myRef.child('online').onDisconnect().set(false);
  myRef.child('lastActive').onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
}

async function cleanupOldRooms() {
  if (!db) return;
  try {
    const snap  = await db.ref('rooms').once('value');
    const rooms = snap.val() || {};
    const now   = Date.now();
    for (const [rid, room] of Object.entries(rooms)) {
      const players   = room.players || {};
      const hasOnline = Object.values(players).some(p => p.online);
      if (!hasOnline) {
        let lastActive = room.createdAt || 0;
        for (const p of Object.values(players)) {
          if (p.lastActive > lastActive) lastActive = p.lastActive;
        }
        if (now - lastActive > 5 * 60 * 1000) {
          await db.ref('rooms/' + rid).remove();
        }
      }
    }
  } catch(e) { console.warn("Cleanup error", e); }
}

async function handleCreate() {
  if (!db) { showToast('Firebase æœªè¨­å®šã§ã™'); return; }
  await cleanupOldRooms();
  const name     = document.getElementById('input-name').value.trim();
  const ridInput = document.getElementById('input-roomid').value.trim();
  if (!name) { showError('top-error', 'åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  let roomId = ridInput || randomRoomId();
  if (roomId.length !== 5 || !/^\d+$/.test(roomId)) {
    showError('top-error', 'Room IDã¯5æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„'); return;
  }
  const snap = await db.ref('rooms/' + roomId).once('value');
  if (snap.exists()) {
    showError('top-error', 'ãã®Room IDã¯ã™ã§ã«ä½¿ç”¨ä¸­ã§ã™'); return;
  }

  myPlayerId    = getOrCreatePlayerId();
  currentRoomId = roomId;

  await db.ref('rooms/' + roomId).set({
    hostId:    myPlayerId,
    status:    'playing',
    createdAt: firebase.database.ServerValue.TIMESTAMP,
    settings:  { mode: 'survival', m: 3, n: 2, x: 10, y: 5 },
    players: {
      [myPlayerId]: {
        name: name, correct: 0, wrong: 0, status: 'active',
        joinedAt: firebase.database.ServerValue.TIMESTAMP,
        online: true, lastActive: firebase.database.ServerValue.TIMESTAMP
      }
    }
  });
  setupPresence();
  updateUrl(roomId);
  enterRoom(roomId);
}

async function handleJoin() {
  if (!db) { showToast('Firebase æœªè¨­å®šã§ã™'); return; }
  await cleanupOldRooms();
  const name   = document.getElementById('input-name').value.trim();
  const roomId = document.getElementById('input-roomid').value.trim();
  if (!name)   { showError('top-error', 'åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!roomId) { showError('top-error', 'Room IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (roomId.length !== 5 || !/^\d+$/.test(roomId)) {
    showError('top-error', 'Room IDã¯5æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„'); return;
  }
  const snap = await db.ref('rooms/' + roomId).once('value');
  if (!snap.exists()) {
    showError('top-error', 'Room ID ' + roomId + ' ã®éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return;
  }
  const room = snap.val();
  myPlayerId  = getOrCreatePlayerId();

  const existing = room.players && room.players[myPlayerId];
  if (!existing) {
    await db.ref('rooms/' + roomId + '/players/' + myPlayerId).set({
      name: name, correct: 0, wrong: 0, status: 'active',
      joinedAt: firebase.database.ServerValue.TIMESTAMP,
      online: true, lastActive: firebase.database.ServerValue.TIMESTAMP
    });
  } else {
    await db.ref(`rooms/${roomId}/players/${myPlayerId}`).update({
      online: true, lastActive: firebase.database.ServerValue.TIMESTAMP
    });
  }
  currentRoomId = roomId;
  setupPresence();
  updateUrl(roomId);
  if (room.status === 'finished') { enterResultScreen(room); }
  else { enterRoom(roomId); }
}

function updateUrl(roomId) {
  window.history.replaceState({}, '', window.location.origin + '/' + roomId);
}
function getRoomUrl() {
  return window.location.origin + '/' + currentRoomId;
}
function copyLink() {
  navigator.clipboard.writeText(getRoomUrl()).then(() => showToast('ğŸ”— ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
}
function copyRoomId() {
  navigator.clipboard.writeText(currentRoomId).then(() => showToast('ğŸ“‹ Room ID ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
}
function shareNative() {
  if (navigator.share) {
    navigator.share({ title: 'Q-Room', text: 'ã‚¯ã‚¤ã‚ºãƒãƒˆãƒ«ã«å‚åŠ ã—ã‚ˆã†ï¼ Room: ' + currentRoomId, url: getRoomUrl() });
  } else { copyLink(); }
}

function leaveRoom() {
  if (db && currentRoomId && myPlayerId) {
    db.ref(`rooms/${currentRoomId}/players/${myPlayerId}`).remove();
  }
  backToTop();
}

function openSettings()  { document.getElementById('settings-modal').classList.add('active'); }
function closeSettings() { document.getElementById('settings-modal').classList.remove('active'); }
function handleModalOutsideClick(e) {
  if (e.target === document.getElementById('settings-modal')) closeSettings();
}

function enterRoom(roomId) {
  showScreen('room');
  document.getElementById('game-room-id-display').textContent = roomId;

  if (roomListener) roomListener();
  roomListener = db.ref('rooms/' + roomId).on('value', snap => {
    const data = snap.val();
    if (!data) { showToast('ãƒ«ãƒ¼ãƒ ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ'); backToTop(); return; }
    if (data.status === 'finished') { enterResultScreen(data); return; }

    gameSettings = data.settings;
    if (data.settings) {
      if (document.activeElement !== document.getElementById('set-m')) document.getElementById('set-m').value = data.settings.m;
      if (document.activeElement !== document.getElementById('set-n')) document.getElementById('set-n').value = data.settings.n;
      if (document.activeElement !== document.getElementById('set-x')) document.getElementById('set-x').value = data.settings.x;
      if (document.activeElement !== document.getElementById('set-y')) document.getElementById('set-y').value = data.settings.y;
      if (currentMode !== data.settings.mode) selectModeUI(data.settings.mode);
    }
    renderGameScreen(data);
  });
}

function renderGameScreen(data) {
  const settings = data.settings || {};
  const players  = data.players  || {};
  const sorted   = sortPlayers(players, settings);

  const modeLabel = settings.mode === 'survival'
    ? `mâ—¯nÃ—  ${settings.m}â—‹ ${settings.n}Ã—`
    : settings.mode === 'newyork'
    ? `NY  +${settings.x} / -${settings.y}`
    : 'ãƒ•ãƒªãƒ';
  document.getElementById('mode-pill-display').textContent = modeLabel;

  const cardsEl = document.getElementById('game-player-cards');
  cardsEl.innerHTML = sorted.map(([pid, p]) => {
    const isMe = pid === myPlayerId;
    const isSpec = p.status === 'spectator';
    const statusCls = p.status === 'winner' ? 'pcard-winner'
      : p.status === 'eliminated' ? 'pcard-eliminated'
      : isSpec ? 'pcard-spectator' : '';
    const statusLabel = p.status === 'winner' ? 'WIN ğŸ†'
      : p.status === 'eliminated' ? 'OUT' : isSpec ? 'WATCH' : 'ACTIVE';
    const statusPillCls = p.status === 'winner' ? 's-winner'
      : p.status === 'eliminated' ? 's-eliminated'
      : isSpec ? 's-spectator' : 's-active';

    let bodyHtml = '';
    if (!isSpec) {
      if (settings.mode === 'survival') {
        const m = settings.m || 3, n = settings.n || 2;
        const cpct = Math.min(100, (p.correct / m) * 100);
        const wpct = Math.min(100, (p.wrong   / n) * 100);
        bodyHtml = `
          <div class="pcard-stats">
            <div class="stat-box"><span class="stat-icon">â­•</span><span class="stat-val correct">${p.correct}</span></div>
            <div class="stat-box"><span class="stat-icon">âœ–</span><span class="stat-val wrong">${p.wrong}</span></div>
          </div>
          <div class="pcard-progress">
            <div class="prog-row">
              <span class="prog-label" style="color:var(--green)">â—‹</span>
              <div class="prog-track"><div class="prog-fill correct" style="width:${cpct}%"></div></div>
              <span class="prog-count">${p.correct}/${m}</span>
            </div>
            <div class="prog-row">
              <span class="prog-label" style="color:var(--red)">âœ–</span>
              <div class="prog-track"><div class="prog-fill wrong" style="width:${wpct}%"></div></div>
              <span class="prog-count">${p.wrong}/${n}</span>
            </div>
          </div>`;
      } else if (settings.mode === 'newyork') {
        const score = (p.correct * settings.x) - (p.wrong * settings.y);
        bodyHtml = `
          <div class="pcard-stats">
            <div class="stat-box"><span class="stat-icon">â­•</span><span class="stat-val correct">${p.correct}</span></div>
            <div class="stat-box"><span class="stat-icon">âœ–</span><span class="stat-val wrong">${p.wrong}</span></div>
            <div class="score-large">${score >= 0 ? '+' : ''}${score}</div>
          </div>`;
      } else {
        bodyHtml = `
          <div class="pcard-stats">
            <div class="stat-box"><span class="stat-icon">â­•</span><span class="stat-val correct">${p.correct}</span></div>
            <div class="stat-box"><span class="stat-icon">âœ–</span><span class="stat-val wrong">${p.wrong}</span></div>
          </div>`;
      }
    }

    return `
      <div class="pcard ${isMe ? 'pcard-me' : ''} ${statusCls}">
        <div class="pcard-top">
          <div class="player-avatar" style="width:30px;height:30px;font-size:0.8rem;${isSpec?'filter:grayscale(1);opacity:0.4;':''}">${avatarLetter(p.name)}</div>
          <span class="pcard-name">${escHtml(p.name)}${isMe ? ' <span style="color:var(--cyan);font-size:0.7rem;font-weight:600;">(You)</span>' : ''}</span>
          <span class="pcard-status ${statusPillCls}">${statusLabel}</span>
        </div>
        ${bodyHtml}
      </div>`;
  }).join('');

  const myPlayer = players[myPlayerId];
  if (myPlayer) {
    const isSpec = myPlayer.status === 'spectator';
    document.getElementById('score-buttons').style.display  = isSpec ? 'none' : 'flex';
    document.getElementById('undo-row').style.display       = (!isSpec && lastAction !== null) ? 'block' : 'none';
    document.getElementById('btn-toggle-role').innerHTML    = isSpec ? 'ğŸ® ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå›ç­”è€…ï¼‰ã«ãªã‚‹' : 'ğŸ‘€ è¦³æˆ¦è€…ï¼ˆãƒ›ã‚¹ãƒˆï¼‰ã«ãªã‚‹';
  }
}

function sortPlayers(players, settings) {
  return Object.entries(players).sort((a, b) => {
    const [, pa] = a, [, pb] = b;
    const rank = s => s === 'winner' ? 0 : s === 'active' ? 1 : s === 'eliminated' ? 2 : 3;
    if (settings.mode === 'freecount') {
      if (rank(pa.status) !== rank(pb.status)) return rank(pa.status) - rank(pb.status);
      return pb.correct - pa.correct;
    }
    if (rank(pa.status) !== rank(pb.status)) return rank(pa.status) - rank(pb.status);
    if (settings.mode === 'newyork') {
      const sa = (pa.correct * settings.x) - (pa.wrong * settings.y);
      const sb = (pb.correct * settings.x) - (pb.wrong * settings.y);
      return sb - sa;
    }
    return pb.correct - pa.correct;
  });
}

async function recordResult(isCorrect) {
  if (!db || !currentRoomId || !myPlayerId) return;
  const playerRef = db.ref('rooms/' + currentRoomId + '/players/' + myPlayerId);
  const snap = await playerRef.once('value');
  const p = snap.val();
  if (!p || p.status === 'spectator') return;

  const settings   = gameSettings || {};
  const newCorrect = p.correct + (isCorrect ? 1 : 0);
  const newWrong   = p.wrong   + (isCorrect ? 0 : 1);
  let   newStatus  = p.status;

  if (settings.mode === 'survival' && p.status === 'active') {
    if (newCorrect >= settings.m)      { newStatus = 'winner';    showToast('ğŸ† å‹ã¡æŠœã‘ãŠã‚ã§ã¨ã†ï¼'); }
    else if (newWrong >= settings.n)   { newStatus = 'eliminated'; showToast('ğŸ’€ å¤±æ ¼...'); }
  }

  lastAction = { wasCorrect: isCorrect, prevCorrect: p.correct, prevWrong: p.wrong, prevStatus: p.status };
  document.getElementById('undo-row').style.display = 'block';
  await playerRef.update({ correct: newCorrect, wrong: newWrong, status: newStatus });
}

async function undoResult() {
  if (!db || !currentRoomId || !myPlayerId || !lastAction) return;
  const playerRef = db.ref('rooms/' + currentRoomId + '/players/' + myPlayerId);
  await playerRef.update({
    correct: lastAction.prevCorrect,
    wrong:   lastAction.prevWrong,
    status:  lastAction.prevStatus
  });
  lastAction = null;
  document.getElementById('undo-row').style.display = 'none';
  showToast('â†© å–ã‚Šæ¶ˆã—ã¾ã—ãŸ');
}

async function endGame() {
  if (confirm("ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¦çµæœã‚’è¡¨ç¤ºã—ã¾ã™ã‹ï¼Ÿ")) {
    await db.ref('rooms/' + currentRoomId + '/status').set('finished');
    closeSettings();
  }
}

function returnToRoom() {
  if (!currentRoomId) { backToTop(); return; }
  db.ref('rooms/' + currentRoomId + '/status').set('playing');
  showScreen('room');
}

function enterResultScreen(data) {
  if (roomListener) { db.ref('rooms/' + currentRoomId).off('value', roomListener); roomListener = null; }
  showScreen('result');
  const settings = data.settings || {};
  const players  = data.players  || {};
  const sorted   = buildResultRanking(players, settings).filter(([, p]) => p.status !== 'spectator');

  const winner = sorted[0];
  document.getElementById('podium-area').innerHTML = winner ? `
    <div class="podium-emoji">ğŸ†</div>
    <div class="podium-name">${escHtml(winner[1].name)}</div>
    <div class="podium-sub">${settings.mode === 'survival' ? 'å‹ã¡æŠœã‘é”æˆï¼' : settings.mode === 'freecount' ? 'æœ€å¤šæ­£è§£ï¼' : 'ãƒˆãƒƒãƒ—ã‚¹ã‚³ã‚¢ï¼'}</div>` : '';

  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  document.getElementById('result-list').innerHTML = sorted.map(([pid, p], i) => {
    const rank = i + 1;
    const rankCls = rank <= 3 ? 'r' + rank : '';
    const riCls   = rank <= 3 ? 'ri-' + rank : '';
    const rankDisplay = rank <= 3 ? medals[rank-1] : rank;
    let scoreStr = '';
    if (settings.mode === 'newyork') {
      const sc = (p.correct * settings.x) - (p.wrong * settings.y);
      scoreStr = `<span class="result-score">${sc >= 0 ? '+' : ''}${sc}pt</span>`;
    } else if (settings.mode === 'freecount') {
      scoreStr = `<span class="result-score">${p.correct}â—‹</span>`;
    } else {
      scoreStr = `<span class="result-score">${p.status === 'winner' ? 'âœ… WIN' : p.status === 'eliminated' ? 'âŒ OUT' : 'â€”'}</span>`;
    }
    return `
      <div class="result-item ${riCls}">
        <div class="result-rank ${rankCls}">${rankDisplay}</div>
        <div class="result-name">${escHtml(p.name)}${pid === myPlayerId ? ' <span style="color:var(--cyan);font-size:0.72rem;">(You)</span>' : ''}</div>
        <div class="result-stats">${p.correct}â—‹ ${p.wrong}Ã—</div>
        ${scoreStr}
      </div>`;
  }).join('');
}

function buildResultRanking(players, settings) {
  return Object.entries(players).sort((a, b) => {
    const [, pa] = a, [, pb] = b;
    if (settings.mode === 'newyork') {
      const sa = (pa.correct * settings.x) - (pa.wrong * settings.y);
      const sb = (pb.correct * settings.x) - (pb.wrong * settings.y);
      return sb - sa;
    }
    if (settings.mode === 'freecount') {
      if (pb.correct !== pa.correct) return pb.correct - pa.correct;
      return pa.wrong - pb.wrong;
    }
    const rank = s => s === 'winner' ? 0 : s === 'active' ? 1 : s === 'eliminated' ? 2 : 3;
    if (rank(pa.status) !== rank(pb.status)) return rank(pa.status) - rank(pb.status);
    return pb.correct - pa.correct;
  });
}

function backToTop() {
  if (roomListener && currentRoomId) {
    db.ref('rooms/' + currentRoomId).off('value', roomListener);
    roomListener = null;
  }
  if (db && currentRoomId && myPlayerId) {
    const myRef = db.ref(`rooms/${currentRoomId}/players/${myPlayerId}`);
    myRef.child('online').onDisconnect().cancel();
    myRef.child('lastActive').onDisconnect().cancel();
  }
  currentRoomId = null;
  gameSettings  = null;
  lastAction    = null;
  window.history.replaceState({}, '', '/');
  showScreen('top');
}

function escHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;').replace(/</g, '&lt;')
    .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

document.getElementById('input-roomid').addEventListener('keydown', e => { if (e.key === 'Enter') handleJoin(); });
document.getElementById('input-name').addEventListener('keydown',   e => { if (e.key === 'Enter') document.getElementById('input-roomid').focus(); });
</script>
</body>
</html>
