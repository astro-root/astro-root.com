<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Q-ROOM</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Noto+Sans+JP:wght@300;400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg-color: #050508;
  --surface-color: rgba(20, 20, 30, 0.6);
  --surface-highlight: rgba(255, 255, 255, 0.05);
  --border-color: rgba(255, 255, 255, 0.1);
  --cyan: #00f0ff;
  --magenta: #ff0055;
  --green: #00ff66;
  --red: #ff3333;
  --yellow: #ffcc00;
  --text-main: #f8f8f8;
  --text-muted: #9494a0;
  --font-en: 'Orbitron', sans-serif;
  --font-ja: 'Noto Sans JP', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
  --glass-blur: blur(12px);
}
html, body { height: 100%; }
body {
  background-color: var(--bg-color);
  background-image: 
    radial-gradient(circle at 0% 0%, rgba(0, 240, 255, 0.05) 0%, transparent 40%),
    radial-gradient(circle at 100% 100%, rgba(255, 0, 85, 0.05) 0%, transparent 40%);
  color: var(--text-main);
  font-family: var(--font-ja);
  display: flex;
  justify-content: center; /* ç”»é¢ä¸­å¤®ã«é…ç½® */
  align-items: flex-start;
  overflow-x: hidden;
}

/* ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠã¨ãªã‚‹ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
.screen {
  display: none; 
  flex-direction: column;
  width: 100%; 
  max-width: 540px; /* PCç”¨ã«è¦‹æ „ãˆã‚ˆãå°‘ã—åºƒã‚ */
  min-height: 100vh;
  position: relative; 
  z-index: 1; 
  background: rgba(10, 10, 15, 0.4); /* PCç’°å¢ƒã§æµ®ãå‡ºã‚‹ã‚ˆã†ãªã‚³ãƒ³ãƒ†ãƒŠæ„Ÿ */
  box-shadow: 0 0 50px rgba(0,0,0,0.5), 0 0 10px rgba(0,240,255,0.05);
  animation: fadeIn 0.4s ease forwards;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.screen.active { display: flex; } /* blockã‹ã‚‰flexã¸å¤‰æ›´ */

#screen-top, #screen-result {
  padding: 0 0 80px;
}
#screen-room {
  height: 100vh; /* ä¸­èº«ã ã‘ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹ãŸã‚é«˜ã•ã‚’å›ºå®š */
  padding: 0;
  overflow: hidden;
}

/* ã‚¹ãƒãƒ›ç­‰ã§å¹…ãŒç‹­ã„å ´åˆã¯å½±ã‚„èƒŒæ™¯ã‚’æ¶ˆã—ã¦å…¨ç”»é¢åŒ– */
@media (max-width: 540px) {
  .screen {
    box-shadow: none;
    background: transparent;
  }
}

.scroll-area {
  flex: 1; overflow-y: auto; overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  padding-bottom: 20px;
}
.hero { padding: 60px 20px 40px; text-align: center; }
.logo {
  font-family: var(--font-en); font-size: 3.8rem; font-weight: 900;
  background: linear-gradient(135deg, var(--cyan), #0066ff);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  letter-spacing: 0.08em; margin-bottom: 8px;
  filter: drop-shadow(0 0 15px rgba(0,240,255,0.4));
}
.logo-sub { font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-muted); letter-spacing: 0.25em; }
.form-wrap { padding: 0 24px; }
.field { margin-bottom: 24px; }
label {
  display: block; font-family: var(--font-mono); font-size: 0.75rem; color: var(--cyan);
  margin-bottom: 10px; letter-spacing: 0.15em; text-transform: uppercase;
}
input[type="text"], input[type="number"], select {
  width: 100%; padding: 16px;
  background: var(--surface-color); backdrop-filter: var(--glass-blur);
  border: 1px solid var(--border-color); border-radius: 12px;
  color: var(--text-main); font-family: var(--font-mono); font-size: 1rem;
  outline: none; transition: all 0.3s ease; appearance: none;
}
input:focus, select:focus {
  border-color: var(--cyan);
  background: rgba(0, 240, 255, 0.03);
  box-shadow: 0 0 0 4px rgba(0,240,255,0.1);
}
/* PCã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é¸æŠæ™‚ã®ç™½é£›ã³å•é¡Œè§£æ¶ˆ */
select { cursor: pointer; }
select option {
  background-color: #14141e;
  color: #f8f8f8;
}

.row { display: flex; gap: 12px; }
.btn-gen {
  padding: 0 20px; background: var(--surface-color); border: 1px solid var(--border-color);
  border-radius: 12px; cursor: pointer; color: var(--text-main); font-size: 1.2rem; transition: 0.3s;
  backdrop-filter: var(--glass-blur);
}
.btn-gen:hover { border-color: var(--cyan); color: var(--cyan); background: rgba(0,240,255,0.05); }
.btn {
  width: 100%; padding: 18px; border: none; border-radius: 12px; cursor: pointer;
  font-family: var(--font-en); font-weight: 700; font-size: 1.1rem; letter-spacing: 0.15em;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden;
}
.btn:active { transform: scale(0.97); }
.btn-pri {
  background: linear-gradient(135deg, var(--cyan), #0077ff); color: #000;
  box-shadow: 0 6px 20px rgba(0,240,255,0.25); border: 1px solid rgba(255,255,255,0.2);
}
.btn-pri:hover { box-shadow: 0 8px 25px rgba(0,240,255,0.4); transform: translateY(-1px); }
.btn-sec { background: var(--surface-color); border: 1px solid var(--border-color); color: var(--text-main); backdrop-filter: var(--glass-blur); }
.btn-sec:hover { border-color: var(--text-main); background: var(--surface-highlight); }
.btn-warn { background: rgba(255,51,51,0.1); border: 1px solid var(--red); color: var(--red); }
.btn-warn:hover { background: rgba(255,51,51,0.2); }
.err {
  color: var(--red); font-size: 0.85rem; padding: 12px; background: rgba(255,51,51,0.1);
  border: 1px solid rgba(255,51,51,0.2); border-radius: 8px; margin-bottom: 20px; display: none; text-align: center;
}
.header {
  background: rgba(10, 10, 15, 0.85); backdrop-filter: blur(16px);
  padding: 16px 20px; display: flex; align-items: center; justify-content: space-between;
  border-bottom: 1px solid var(--border-color); flex-shrink: 0; z-index: 10;
}
.room-info { font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-muted); }
.room-info span { color: var(--cyan); font-size: 1.1rem; font-weight: 700; margin-left: 8px; letter-spacing: 0.1em; }
.rule-badge {
  font-size: 0.75rem; padding: 6px 10px; background: rgba(255,0,85,0.1);
  border: 1px solid rgba(255,0,85,0.3); border-radius: 6px; color: var(--magenta); font-weight: 700;
}
.h-btn {
  background: transparent; border: 1px solid var(--border-color); color: var(--text-main);
  padding: 8px 14px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; transition: 0.2s;
  font-family: var(--font-en); letter-spacing: 0.05em;
}
.h-btn:hover { border-color: var(--cyan); color: var(--cyan); }
.plist { padding: 20px; display: flex; flex-direction: column; gap: 12px; }
.pcard {
  background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 16px;
  padding: 18px; display: flex; align-items: center; gap: 16px; transition: all 0.3s ease;
  position: relative; overflow: hidden; backdrop-filter: var(--glass-blur);
}
.pcard::before {
  content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
  transform: translateX(-100%); transition: 0.5s; pointer-events: none;
}
.pcard:hover::before { transform: translateX(100%); }
.pcard.me { border-color: var(--cyan); background: rgba(0, 240, 255, 0.03); box-shadow: 0 4px 15px rgba(0,240,255,0.08); }
.pcard.win { border-color: var(--green); background: rgba(0, 255, 102, 0.05); box-shadow: 0 4px 15px rgba(0,255,102,0.1); }
.pcard.lose { opacity: 0.5; filter: grayscale(0.8); background: rgba(20,20,30,0.3); }
.pcard.spec { opacity: 0.4; border-style: dashed; }
.rank-num {
  font-family: var(--font-en); font-size: 1.6rem; font-weight: 900; color: var(--text-muted);
  width: 36px; text-align: center; opacity: 0.7;
}
.pcard.win .rank-num { color: var(--green); opacity: 1; text-shadow: 0 0 10px rgba(0,255,102,0.4); }
.pcard.me .rank-num { color: var(--cyan); opacity: 1; }
.p-main { flex: 1; min-width: 0; }
.p-name { font-weight: 700; font-size: 1.05rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 10px; }
.badge { font-size: 0.65rem; padding: 4px 8px; border-radius: 6px; font-family: var(--font-en); font-weight: 700; letter-spacing: 0.05em; }
.b-you { background: var(--cyan); color: #000; box-shadow: 0 0 8px rgba(0,240,255,0.4); }
.p-stats { display: flex; gap: 16px; margin-top: 8px; font-family: var(--font-mono); font-size: 0.85rem; color: var(--text-muted); }
.p-stats span.c { color: var(--green); font-weight: 700; }
.p-stats span.w { color: var(--red); font-weight: 700; }
.score-box { text-align: right; display: flex; flex-direction: column; justify-content: center; align-items: flex-end; }
.score-val { font-family: var(--font-en); font-size: 2rem; font-weight: 900; line-height: 1; letter-spacing: 0.02em; }
.pcard.me .score-val { color: var(--cyan); text-shadow: 0 0 10px rgba(0,240,255,0.3); }
.score-sub { font-size: 0.75rem; color: var(--text-muted); margin-top: 6px; font-weight: 700; }
.st-win { color: var(--green); font-size: 0.85rem; letter-spacing: 0.1em; text-shadow: 0 0 8px rgba(0,255,102,0.4); }
.st-lose { color: var(--red); font-size: 0.85rem; letter-spacing: 0.1em; }
.action-panel {
  background: rgba(10, 10, 15, 0.9); border-top: 1px solid var(--border-color); padding: 20px 24px;
  flex-shrink: 0; padding-bottom: max(20px, env(safe-area-inset-bottom)); backdrop-filter: blur(20px); z-index: 10;
}
.ox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
.ox-btn {
  padding: 28px 0; border: none; border-radius: 16px; font-family: var(--font-en);
  font-size: 2.8rem; font-weight: 900; cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}
.ox-btn:active { transform: scale(0.96) translateY(2px); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
.btn-o { background: linear-gradient(145deg, rgba(0,255,102,0.15), rgba(0,255,102,0.05)); border: 2px solid var(--green); color: var(--green); text-shadow: 0 0 15px rgba(0,255,102,0.5); }
.btn-x { background: linear-gradient(145deg, rgba(255,51,51,0.15), rgba(255,51,51,0.05)); border: 2px solid var(--red); color: var(--red); text-shadow: 0 0 15px rgba(255,51,51,0.5); }
.btn-rest { grid-column: 1 / -1; background: rgba(255,204,0,0.1); color: var(--yellow); border: 2px solid var(--yellow); font-size: 1.5rem; letter-spacing: 0.1em; text-shadow: 0 0 10px rgba(255,204,0,0.4); }
.sub-actions { display: flex; gap: 12px; }
.sub-btn {
  flex: 1; padding: 14px; background: var(--surface-color); border: 1px solid var(--border-color);
  border-radius: 10px; color: var(--text-muted); font-size: 0.85rem; cursor: pointer; text-align: center;
  font-weight: 700; transition: 0.2s; backdrop-filter: var(--glass-blur);
}
.sub-btn:hover:not(:disabled) { border-color: var(--cyan); color: var(--cyan); background: rgba(0,240,255,0.05); }
.sub-btn:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
.modal {
  position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
  z-index: 100; display: none; align-items: center; justify-content: center; padding: 20px;
}
.modal.active { display: flex; }
.m-content {
  background: rgba(20, 20, 30, 0.95); border: 1px solid rgba(0,240,255,0.2); border-radius: 20px;
  width: 100%; max-width: 420px; max-height: 85vh; overflow-y: auto; padding: 28px; position: relative;
  box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}
.m-content::-webkit-scrollbar { width: 6px; }
.m-content::-webkit-scrollbar-track { background: transparent; }
.m-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
.m-close {
  position: absolute; top: 20px; right: 20px; background: transparent; border: none;
  color: var(--text-muted); font-size: 1.8rem; cursor: pointer; transition: 0.2s; line-height: 1;
}
.m-close:hover { color: var(--cyan); transform: rotate(90deg); }
.s-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
.m-title { font-family: var(--font-en); font-size: 1.3rem; color: var(--cyan); margin-bottom: 24px; font-weight: 900; letter-spacing: 0.1em; }
hr { border: none; border-top: 1px solid var(--border-color); margin: 24px 0; }
.toast {
  position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%) translateY(20px);
  background: rgba(20, 20, 30, 0.95); border: 1px solid var(--cyan); color: var(--text-main);
  padding: 12px 24px; border-radius: 30px; font-size: 0.95rem; pointer-events: none;
  opacity: 0; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 999;
  box-shadow: 0 10px 30px rgba(0,240,255,0.15); backdrop-filter: blur(10px); font-weight: 700;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.r-header { padding: 50px 20px 30px; text-align: center; border-bottom: 1px solid var(--border-color); }
.r-title { font-family: var(--font-en); font-size: 3rem; color: var(--yellow); font-weight: 900; text-shadow: 0 0 20px rgba(255,204,0,0.4); letter-spacing: 0.05em; margin-bottom: 10px;}
</style>
</head>
<body>

<div id="screen-top" class="screen active">
  <div class="hero">
    <div class="logo">Q-ROOM</div>
    <div class="logo-sub">ADVANCED QUIZ SYSTEM</div>
  </div>
  <div class="form-wrap">
    <div class="field">
      <label>PLAYER NAME</label>
      <input type="text" id="in-name" placeholder="åå‰ã‚’å…¥åŠ›" maxlength="20" autocomplete="off">
    </div>
    <div class="field">
      <label>ROOM ID (BLANK FOR RANDOM)</label>
      <div class="row">
        <input type="text" id="in-room" placeholder="5 digits" maxlength="5" pattern="[0-9]*" inputmode="numeric">
        <button class="btn-gen" onclick="document.getElementById('in-room').value = String(Math.floor(10000+Math.random()*90000))">ğŸ²</button>
      </div>
    </div>
    <div id="top-err" class="err"></div>
    <button class="btn btn-pri" onclick="handleCreate()" style="margin-bottom:16px;">CREATE ROOM</button>
    <button class="btn btn-sec" onclick="handleJoin()">JOIN ROOM</button>
  </div>
</div>

<div id="screen-room" class="screen">
  <div class="header">
    <div class="room-info">ROOM<span id="game-rid">â€”</span></div>
    <div class="rule-badge" id="game-rule">â€”</div>
    <button class="h-btn" onclick="openModal()">SETTINGS</button>
  </div>
  <div class="scroll-area"><div id="plist" class="plist"></div></div>
  <div class="action-panel" id="mypanel">
    <div class="ox-grid" id="ox-grid">
      <button class="ox-btn btn-o" onclick="sendAction('correct')">â—¯</button>
      <button class="ox-btn btn-x" onclick="sendAction('wrong')">âœ•</button>
    </div>
    <div class="sub-actions">
      <button class="sub-btn" id="btn-undo" onclick="reqUndo()" disabled>â†© UNDO</button>
      <button class="sub-btn" onclick="toggleRole()" id="btn-role">ğŸ‘€ è¦³æˆ¦</button>
      <button class="sub-btn" onclick="leaveRoom()">ğŸšª é€€å®¤</button>
    </div>
  </div>
</div>

<div id="screen-result" class="screen">
  <div class="r-header">
    <div class="r-title">RESULT</div>
    <button class="sub-btn" onclick="leaveRoom()" style="max-width: 200px; margin: 0 auto;">TOPã¸æˆ»ã‚‹</button>
  </div>
  <div class="scroll-area"><div id="rlist" class="plist"></div></div>
</div>

<div id="modal" class="modal" onclick="if(event.target===this)closeModal()">
  <div class="m-content">
    <button class="m-close" onclick="closeModal()">âœ•</button>
    <div class="m-title">ROOM SETTINGS</div>
    
    <div class="field">
      <label>RULE</label>
      <select id="sel-rule" onchange="changeRuleUI()">
        <option value="survival">mâ—¯nÃ— (Survival)</option>
        <option value="rentou">é€£ç­”ä»˜ã (mâ—¯nÃ—)</option>
        <option value="updown">up-down</option>
        <option value="by">by</option>
        <option value="freeze">Freeze</option>
        <option value="m_n_rest">mâ—¯nä¼‘</option>
        <option value="swedish">Swedish</option>
        <option value="ren_wrong">é€£èª¤ç­”ä»˜ã</option>
        <option value="divide">divide</option>
        <option value="combo">m hits Combo</option>
        <option value="attack_surv">ã‚¢ã‚¿ãƒƒã‚¯é¢¨ã‚µãƒã‚¤ãƒãƒ«</option>
        <option value="lucky">LuckyShot</option>
        <option value="spiral">èºæ—‹éšæ®µ</option>
      </select>
    </div>

    <div id="config-area"></div>

    <hr>
    <div class="s-grid">
      <button class="sub-btn" onclick="copyUrl()">ğŸ”— URLã‚³ãƒ”ãƒ¼</button>
      <button class="sub-btn" onclick="copyId()">ğŸ“‹ IDã‚³ãƒ”ãƒ¼</button>
    </div>
    <button class="btn btn-sec" onclick="resetPoints()" style="margin-bottom:12px;">ğŸ”„ RESET SCORES</button>
    <button class="btn btn-warn" onclick="endGame()">ğŸ FINISH GAME</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyA3xtGLVJwij2BTiiOk7DsNeF9hIOuZCyI",
  authDomain: "q-room-fe8a6.firebaseapp.com",
  databaseURL: "https://q-room-fe8a6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "q-room-fe8a6",
  storageBucket: "q-room-fe8a6.firebasestorage.app",
  messagingSenderId: "151049149394",
  appId: "1:151049149394:web:7a3ea6406454f6a87d460b"
};

let db = null, myId = null, rId = null, rRef = null, rCb = null;
let roomData = null;

const DEF_CONF = {
  survival: {m:3, n:2}, rentou: {m:10, n:3}, updown: {m:10, n:3},
  by: {m:10, n:3}, freeze: {m:10, n:3}, m_n_rest: {m:10, n:2},
  swedish: {m:10, n:10}, ren_wrong: {m:10, n:3},
  divide: {init:10, add:10, win:100}, combo: {win:50},
  attack_surv: {life:20, dmg_to_oth:1, heal:0, dmg_to_me:2, surv:1},
  lucky: {win:50, lose:-20, max:10}, spiral: {up:1, down:1, top_req:3, btm_req:3}
};

window.onload = () => {
  const m = window.location.pathname.match(/\/q-room\/(\d{5})/);
  if(m) document.getElementById('in-room').value = m[1];
};

function initFB() {
  if(!db){ 
    try {
      firebase.initializeApp(firebaseConfig); 
      db = firebase.database(); 
    } catch(e) {
      console.error(e);
      throw new Error("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  }
}

function getMyId() {
  let id = localStorage.getItem('qr_id');
  if(!id){ id = 'p_'+Date.now().toString(36); localStorage.setItem('qr_id',id); }
  return id;
}

function err(m){ const e=document.getElementById('top-err'); e.innerText=m; e.style.display='block'; setTimeout(()=>e.style.display='none',3000); }
function toast(m){ const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
function show(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById('screen-'+id).classList.add('active'); }

async function handleCreate() {
  try {
    initFB();
    const n = document.getElementById('in-name').value.trim();
    const r = document.getElementById('in-room').value.trim() || String(Math.floor(10000+Math.random()*90000));
    if(!n) return err('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    if(!/^\d{5}$/.test(r)) return err('IDã¯5æ¡ã®æ•°å­—ã§ã™');
    
    const s = await db.ref('rooms/'+r).once('value');
    if(s.exists()) return err('ãã®IDã¯ä½¿ç”¨ä¸­ã§ã™');
    
    myId = getMyId(); rId = r;
    await db.ref('rooms/'+r).set({
      status: 'playing', rule: 'survival', conf: DEF_CONF.survival,
      players: { [myId]: newPlayer(n) }
    });
    enterRoom();
  } catch(e) {
    console.error(e);
    err('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚é€šä¿¡çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
  }
}

async function handleJoin() {
  try {
    initFB();
    const n = document.getElementById('in-name').value.trim();
    const r = document.getElementById('in-room').value.trim();
    if(!n) return err('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    if(!/^\d{5}$/.test(r)) return err('IDã¯5æ¡ã®æ•°å­—ã§ã™');
    
    const s = await db.ref('rooms/'+r).once('value');
    if(!s.exists()) return err('éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    
    myId = getMyId(); rId = r;
    const p = s.val().players || {};
    if(!p[myId]) await db.ref(`rooms/${r}/players/${myId}`).set(newPlayer(n));
    enterRoom();
  } catch(e) {
    console.error(e);
    err('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚é€šä¿¡çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
  }
}

function newPlayer(name) {
  return { name, st: 'active', c:0, w:0, sc:0, rst:0, str:0, adv:0, joined: Date.now(), hist: [] };
}

function enterRoom() {
  try {
    if (window.location.protocol !== 'file:') {
      window.history.replaceState({},'',`/q-room/${rId}`);
    }
  } catch(e) {
    console.warn("History API replaced failed, possibly running locally.");
  }
  
  document.getElementById('game-rid').innerText = rId;
  show('room');
  if(rRef) rRef.off('value', rCb);
  rRef = db.ref('rooms/'+rId);
  rCb = rRef.on('value', snap => {
    roomData = snap.val();
    if(!roomData) return leaveRoom();
    if(roomData.status === 'finished') return renderResult();
    
    const r = roomData.rule;
    document.getElementById('sel-rule').value = r;
    document.getElementById('game-rule').innerText = document.getElementById('sel-rule').options[document.getElementById('sel-rule').selectedIndex].text;
    changeRuleUI(true);
    renderPlayers();
    
    const me = roomData.players && roomData.players[myId];
    document.getElementById('btn-undo').disabled = !(me && me.hist && me.hist.length > 0);
  });
}

function leaveRoom() {
  if(rRef) rRef.off('value', rCb);
  window.location.href = 'https://astro-root.com/q-room/';
}

function openModal(){ document.getElementById('modal').classList.add('active'); }
function closeModal(){ document.getElementById('modal').classList.remove('active'); updateConf(); }

function changeRuleUI(skipRender=false) {
  const r = document.getElementById('sel-rule').value;
  const c = (roomData && roomData.rule === r && roomData.conf) ? roomData.conf : DEF_CONF[r];
  let h = '';
  const mkn = (id,lbl,v) => `<div class="field"><label>${lbl}</label><input type="number" id="c_${id}" value="${v !== undefined ? v : ''}"></div>`;
  
  if(r==='survival'||r==='rentou'||r==='updown'||r==='ren_wrong') h = `<div class="s-grid">${mkn('m','å‹ã¡æŠœã‘',c.m)}${mkn('n','å¤±æ ¼',c.n)}</div>`;
  else if(r==='by') h = `<div class="s-grid">${mkn('m','åˆæœŸèª¤ç­”pt/å®šæ•°',c.m)}${mkn('n','å¤±æ ¼å›æ•°',c.n)}</div>`;
  else if(r==='freeze'||r==='m_n_rest') h = `<div class="s-grid">${mkn('m','å‹ã¡æŠœã‘',c.m)}${mkn('n',r==='freeze'?'å¤±æ ¼':'ä¼‘ã¿æ•°',c.n)}</div>`;
  else if(r==='swedish') h = `<div class="s-grid">${mkn('m','å‹ã¡æŠœã‘',c.m)}${mkn('n','å¤±æ ¼Ã—æ•°',c.n)}</div>`;
  else if(r==='divide') h = `<div class="s-grid">${mkn('init','åˆæœŸå€¤',c.init)}${mkn('add','æ­£è§£åŠ ç‚¹',c.add)}</div><div class="field">${mkn('win','å‹ã¡æŠœã‘',c.win)}</div>`;
  else if(r==='combo') h = `<div class="s-grid">${mkn('win','å‹ã¡æŠœã‘',c.win)}</div>`;
  else if(r==='attack_surv') h = `<div class="s-grid">${mkn('life','åˆæœŸãƒ©ã‚¤ãƒ•',c.life)}${mkn('dmg_to_oth','è‡ªæ­£è§£æ™‚ä»–æ¸›',c.dmg_to_oth)}${mkn('heal','è‡ªæ­£è§£æ™‚è‡ªåŠ ',c.heal)}${mkn('dmg_to_me','è‡ªèª¤æ™‚è‡ªæ¸›',c.dmg_to_me)}</div><div class="field">${mkn('surv','çµ‚äº†äººæ•°',c.surv)}</div>`;
  else if(r==='lucky') h = `<div class="s-grid">${mkn('win','å‹ã¡æŠœã‘',c.win)}${mkn('lose','å¤±æ ¼',c.lose)}</div><div class="field">${mkn('max','ä¹±æ•°æœ€å¤§',c.max)}</div>`;
  else if(r==='spiral') h = `<div class="s-grid">${mkn('up','æ­£è§£ä¸Šæ˜‡',c.up)}${mkn('down','èª¤ç­”ä¸‹é™',c.down)}${mkn('top_req','æœ€ä¸Šä½è¦æ­£è§£',c.top_req)}${mkn('btm_req','æœ€ä¸‹ä½è¦èª¤ç­”',c.btm_req)}</div>`;
  
  document.getElementById('config-area').innerHTML = h;
  if(!skipRender && roomData && r !== roomData.rule) {
    db.ref('rooms/'+rId).update({rule: r, conf: DEF_CONF[r]});
  }
}

function updateConf() {
  if(!roomData) return;
  const r = document.getElementById('sel-rule').value;
  let nc = {};
  document.querySelectorAll('#config-area input').forEach(el => nc[el.id.replace('c_','')] = parseInt(el.value)||0);
  if(Object.keys(nc).length > 0) db.ref(`rooms/${rId}/conf`).update(nc);
}

function sortPlayers(pl, rule) {
  return Object.entries(pl).sort((a,b) => {
    const p1=a[1], p2=b[1];
    const rs = v=>v==='win'?0:v==='active'?1:v==='lose'?2:3;
    if(rs(p1.st) !== rs(p2.st)) return rs(p1.st) - rs(p2.st);
    let m1=p1.sc||0, m2=p2.sc||0;
    if(['survival','freeze','m_n_rest','swedish','ren_wrong'].includes(rule)){ m1=p1.c; m2=p2.c; }
    else if(rule==='by') { m1=p1.sc; m2=p2.sc; }
    if(m1 !== m2) return m2 - m1;
    if(p1.w !== p2.w) return p1.w - p2.w;
    return p2.joined - p1.joined;
  });
}

function renderPlayers() {
  const pl = roomData.players || {};
  const r = roomData.rule;
  const sorted = sortPlayers(pl, r);
  let h = '';
  
  sorted.forEach(([id, p], idx) => {
    const isMe = id===myId;
    let cls = p.st==='win'?'win':p.st==='lose'?'lose':p.st==='spec'?'spec':'';
    if(isMe && !cls) cls = 'me';
    let sv = p.sc||0;
    if(['survival','freeze','m_n_rest','swedish','ren_wrong'].includes(r)) sv = p.c;
    else if(r==='by') sv = `${p.c} Ã— ${(roomData.conf && roomData.conf.m !== undefined ? roomData.conf.m : 10) - (p.w||0)}`;
    
    let wtxt = p.w;
    if(r==='swedish'||r==='ren_wrong') wtxt = p.w + 'Ã—';
    
    let sub = '';
    if(p.rst > 0) sub += `<span style="color:var(--yellow)">ä¼‘:${p.rst}</span> `;
    if(p.str > 0) sub += `<span style="color:var(--cyan)">é€£:${p.str}</span> `;
    if(p.adv > 0) sub += `<span style="color:var(--red)">DAdv!</span> `;
    
    h += `
    <div class="pcard ${cls}">
      <div class="rank-num">${idx+1}</div>
      <div class="p-main">
        <div class="p-name">${esc(p.name)} ${isMe?'<span class="badge b-you">YOU</span>':''}</div>
        <div class="p-stats">
          <span class="c">â—¯ ${p.c}</span>
          <span class="w">âœ• ${wtxt}</span>
        </div>
      </div>
      <div class="score-box">
        <div class="score-val">${sv}</div>
        <div class="score-sub">${p.st==='win'?'<span class="st-win">WINNER</span>':p.st==='lose'?'<span class="st-lose">ELIMINATED</span>':sub}</div>
      </div>
    </div>`;
  });
  document.getElementById('plist').innerHTML = h;
  
  const me = pl[myId];
  if(me) {
    document.getElementById('btn-role').innerText = me.st==='spec'?'ğŸ® å‚åŠ ':'ğŸ‘€ è¦³æˆ¦';
    const ox = document.getElementById('ox-grid');
    if(me.st==='spec' || me.st==='win' || me.st==='lose') ox.style.display = 'none';
    else {
      ox.style.display = 'grid';
      if(me.rst > 0) ox.innerHTML = `<button class="ox-btn btn-rest" onclick="sendAction('rest')">ä¼‘ã¿æ¶ˆåŒ– (${me.rst})</button>`;
      else ox.innerHTML = `<button class="ox-btn btn-o" onclick="sendAction('correct')">â—¯</button><button class="ox-btn btn-x" onclick="sendAction('wrong')">âœ•</button>`;
    }
  }
}

async function sendAction(type) {
  if(!roomData || !roomData.players || !roomData.players[myId]) return;
  const pData = JSON.parse(JSON.stringify(roomData.players));
  const me = pData[myId];
  if(me.st !== 'active') return;
  
  const mePrev = JSON.stringify({c:me.c, w:me.w, sc:me.sc, rst:me.rst, str:me.str, adv:me.adv, st:me.st});
  
  const r = roomData.rule;
  const c = roomData.conf || DEF_CONF[r];
  
  if(type === 'rest') {
    me.rst--;
  } else if(type === 'correct') {
    me.c++;
    if(r==='survival') { if(me.c >= c.m) me.st='win'; }
    else if(r==='rentou') { me.sc = (me.sc||0) + (me.str>0?2:1); me.str++; if(me.sc>=c.m) me.st='win'; }
    else if(r==='updown') { me.sc = (me.sc||0) + 1; if(me.sc>=c.m) me.st='win'; }
    else if(r==='by') { me.sc = me.c * (c.m - me.w); if(me.sc >= c.m*c.m) me.st='win'; }
    else if(r==='freeze') { if(me.c >= c.m) me.st='win'; }
    else if(r==='m_n_rest') { if(me.c >= c.m) me.st='win'; }
    else if(r==='swedish') { if(me.c >= c.m) me.st='win'; }
    else if(r==='ren_wrong') { if(me.c >= c.m) me.st='win'; }
    else if(r==='divide') { me.sc = (me.sc||c.init)+c.add; if(me.sc>=c.win) me.st='win'; }
    else if(r==='combo') { me.str++; me.sc = (me.sc||0) + me.str; if(me.sc>=c.win) me.st='win'; }
    else if(r==='attack_surv') {
      me.sc = (me.sc||c.life)+c.heal;
      Object.keys(pData).forEach(id => {
        if(id!==myId && pData[id].st==='active') {
          pData[id].sc = (pData[id].sc||c.life)-c.dmg_to_oth;
          if(pData[id].sc<=0) pData[id].st='lose';
        }
      });
    }
    else if(r==='lucky') { me.sc = (me.sc||0) + Math.floor(Math.random()*c.max)+1; if(me.sc>=c.win) me.st='win'; }
    else if(r==='spiral') {
      let maxStep = Math.max(...Object.values(pData).filter(p=>p.st==='active').map(p=>p.sc||0));
      if((me.sc||0) >= maxStep) me.str++; else me.str=0;
      me.sc = (me.sc||0)+c.up;
      if(me.str >= c.top_req) me.st='win';
    }
  } else if(type === 'wrong') {
    me.w++;
    if(r==='survival') { if(me.w >= c.n) me.st='lose'; }
    else if(r==='rentou') { me.str=0; if(me.w >= c.n) me.st='lose'; }
    else if(r==='updown') { me.sc=0; if(me.w >= c.n) me.st='lose'; }
    else if(r==='by') { me.sc = me.c * (c.m - me.w); if(me.w >= c.n) me.st='lose'; }
    else if(r==='freeze') { me.rst += me.w; if(me.w >= c.n) me.st='lose'; }
    else if(r==='m_n_rest') { me.rst += c.n; }
    else if(r==='swedish') {
      const batsu = Math.floor((Math.sqrt(8*me.c+1)-1)/2)+1;
      me.w = (me.w-1)+batsu; 
      if(me.w >= c.n) me.st='lose';
    }
    else if(r==='ren_wrong') {
      me.w = (me.w-1) + (me.adv>0?2:1); me.adv=1;
      if(me.w >= c.n) me.st='lose';
    }
    else if(r==='divide') {
      me.sc = Math.floor((me.sc||c.init)/me.w);
      if(me.sc < 1) me.st='lose';
    }
    else if(r==='combo') { me.str=0; }
    else if(r==='attack_surv') {
      me.sc = (me.sc||c.life)-c.dmg_to_me;
      if(me.sc<=0) me.st='lose';
    }
    else if(r==='lucky') { me.sc = (me.sc||0) - Math.floor(Math.random()*c.max)-1; if(me.sc<=c.lose) me.st='lose'; }
    else if(r==='spiral') {
      let minStep = Math.min(...Object.values(pData).filter(p=>p.st==='active').map(p=>p.sc||0));
      if((me.sc||0) <= minStep) me.adv++; else me.adv=0;
      me.sc = (me.sc||0)-c.down;
      if(me.adv >= c.btm_req) me.st='lose';
    }
  }

  me.hist = me.hist || [];
  me.hist.unshift(mePrev);
  if(me.hist.length > 5) me.hist.length = 5;

  await db.ref(`rooms/${rId}/players`).update(pData);
  
  if(r==='attack_surv') {
    const act = Object.values(pData).filter(p=>p.st==='active').length;
    if(act <= c.surv) await db.ref(`rooms/${rId}/status`).set('finished');
  }
}

async function reqUndo() {
  if(!roomData || !roomData.players || !roomData.players[myId]) return;
  const me = roomData.players[myId];
  if(!me.hist || me.hist.length === 0) return;
  
  const hist = [...me.hist];
  const prevState = JSON.parse(hist.shift());
  prevState.hist = hist;
  
  await db.ref(`rooms/${rId}/players/${myId}`).update(prevState);
  toast('â†© è‡ªåˆ†ã®ç›´å‰ã®çŠ¶æ…‹ã«æˆ»ã—ã¾ã—ãŸ');
}

async function toggleRole() {
  const me = roomData.players[myId];
  await db.ref(`rooms/${rId}/players/${myId}/st`).set(me.st==='spec'?'active':'spec');
}

async function resetPoints() {
  if(!confirm('å…¨å“¡ã®ã‚¹ã‚³ã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  const pData = JSON.parse(JSON.stringify(roomData.players));
  
  const c = roomData.conf || {};
  const sc = roomData.rule==='divide' ? (c.init || 10) : roomData.rule==='attack_surv' ? (c.life || 20) : 0;
  
  Object.keys(pData).forEach(k => {
    pData[k] = { ...pData[k], c:0, w:0, sc:sc, rst:0, str:0, adv:0, hist:[] };
    if(pData[k].st !== 'spec') pData[k].st = 'active';
  });
  await db.ref(`rooms/${rId}/players`).set(pData);
  closeModal(); toast('ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
}

async function endGame() {
  if(confirm('ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ')) {
    await db.ref(`rooms/${rId}/status`).set('finished');
    closeModal();
  }
}

function renderResult() {
  show('result');
  const pl = roomData.players || {};
  const r = roomData.rule;
  const sorted = sortPlayers(pl, r).filter(x => x[1].st !== 'spec');
  let h = '';
  sorted.forEach(([id, p], idx) => {
    let sv = p.sc||0;
    if(['survival','freeze','m_n_rest','swedish','ren_wrong'].includes(r)) sv = p.c;
    else if(r==='by') sv = `${p.c} Ã— ${(roomData.conf && roomData.conf.m !== undefined ? roomData.conf.m : 10) - (p.w||0)}`;
    let mst = p.st==='win'?'WINNER':p.st==='lose'?'ELIMINATED':'-';
    h += `
    <div class="pcard ${p.st==='win'?'win':p.st==='lose'?'lose':''}">
      <div class="rank-num">${idx+1}</div>
      <div class="p-main">
        <div class="p-name">${esc(p.name)}</div>
        <div class="p-stats"><span class="c">â—¯ ${p.c}</span><span class="w">âœ• ${p.w}</span></div>
      </div>
      <div class="score-box">
        <div class="score-val">${sv}</div>
        <div class="score-sub" style="color:${p.st==='win'?'var(--green)':p.st==='lose'?'var(--red)':''}">${mst}</div>
      </div>
    </div>`;
  });
  document.getElementById('rlist').innerHTML = h;
}

function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function copyUrl(){ 
  const url = window.location.protocol === 'file:' ? 'https://astro-root.com/q-room/'+rId : window.location.href;
  navigator.clipboard.writeText(url); 
  toast('URL copied'); 
}
function copyId(){ navigator.clipboard.writeText(rId); toast('ID copied'); }
</script>
</body>
</html>
