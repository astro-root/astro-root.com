<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Q-Room | ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚¯ã‚¤ã‚ºãƒ«ãƒ¼ãƒ </title>
<meta name="description" content="Q-Roomã¯ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§é€²è¡Œã™ã‚‹å¤šæ©Ÿèƒ½ãªã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚¯ã‚¤ã‚ºã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚è‡ªèº«ã§éƒ¨å±‹ã‚’ä½œæˆã—ã€NewYorkã‚„ã‚¢ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãªã©æ§˜ã€…ãªãƒ«ãƒ¼ãƒ«ã‚’ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ã¿ã‚“ãªã¨ã‚¯ã‚¤ã‚ºå¯¾æˆ¦ã‚’æ¥½ã—ã‚ã¾ã™ã€‚">
<link rel="canonical" href="https://astro-root.com/q-room/">
<meta property="og:title" content="Q-Room | Online Quiz Room">
<meta property="og:description" content="ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§é€²è¡Œã™ã‚‹å¤šæ©Ÿèƒ½ãªã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚¯ã‚¤ã‚ºã‚·ã‚¹ãƒ†ãƒ ã€‚æ§˜ã€…ãªãƒ«ãƒ¼ãƒ«ã®ã‚¯ã‚¤ã‚ºéƒ¨å±‹ã‚’ä½œæˆãƒ»å‚åŠ ã§ãã¾ã™ã€‚">
<meta property="og:url" content="https://astro-root.com/q-room/">
<meta property="og:type" content="website">
<meta property="og:site_name" content="Q-Room">
<meta name="twitter:card" content="summary">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+JP:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/q-room.css">
</head>
<body>


<div id="screen-top" class="screen active">
  <div id="dev-notice-banner" class="dev-notice-banner">
    <span class="dev-notice-icon">ğŸ“¢</span>
    <span class="dev-notice-text" id="dev-notice-text"></span>
    <button class="dev-notice-close" onclick="dismissDevNotice()">âœ•</button>
  </div>

  <div class="hero">
    <button class="hero-theme-btn" id="theme-toggle-btn" onclick="toggleTheme()" title="ãƒ€ãƒ¼ã‚¯/ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">
      <span id="theme-icon">â˜€ï¸</span>
    </button>
    <button class="hero-account-btn" id="hero-account-btn" onclick="handleHeroAccountBtn()" title="é€šçŸ¥ãƒ»ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ">
      <span id="hero-account-icon">
        <svg viewBox="0 0 24 24" width="22" height="22" stroke="currentColor" fill="none" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      </span>
      <span class="hero-account-badge" id="hero-account-badge" style="display:none;"></span>
    </button>
    <div class="logo">Q-Room</div>
    <div class="logo-sub">Online QUIZ Room</div>
  </div>

  <div class="form-wrap">
    <div class="field">
      <label>PLAYER NAME</label>
      <input type="text" id="in-name" placeholder="Enter your name" maxlength="20" autocomplete="off">
    </div>
    <div class="field">
      <label>ROOM ID</label>
      <div class="row">
        <input type="text" id="in-room" placeholder="5 numbers" maxlength="5" pattern="[0-9]*" inputmode="numeric">
        <button class="btn-gen" onclick="document.getElementById('in-room').value = String(Math.floor(10000+Math.random()*90000))">ğŸ²</button>
      </div>
    </div>
    <div id="top-err" class="err"></div>
    <button class="btn btn-pri" onclick="handleCreate()" style="margin-bottom:20px;">CREATE ROOM</button>
    <button class="btn btn-sec" onclick="handleJoin()">JOIN ROOM</button>
    <div style="display:flex; justify-content:center; align-items:center; gap:8px; margin-top:28px; padding-bottom:8px; flex-wrap:wrap;">
      <button onclick="openFeedback()" style="background:none; border:none; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:8px; color:var(--text-muted); transition:0.3s; padding:8px 16px; border-radius:12px;" onmouseover="this.style.color='var(--cyan)'" onmouseout="this.style.color='var(--text-muted)'">
        <svg viewBox="0 0 24 24" style="width:22px;height:22px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
        <span style="font-family:var(--font-en);font-size:0.75rem;letter-spacing:0.12em;font-weight:700;">FEEDBACK</span>
      </button>
      <a href="https://twitter.com/astro_root" target="_blank" rel="noopener" style="display:flex; flex-direction:column; align-items:center; gap:8px; color:var(--text-muted); text-decoration:none; transition:0.3s; padding:8px 16px; border-radius:12px;" onmouseover="this.style.color='#1d9bf0'" onmouseout="this.style.color='var(--text-muted)'">
        <svg viewBox="0 0 24 24" style="width:22px;height:22px;fill:currentColor;"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.744l7.73-8.835L1.254 2.25H8.08l4.253 5.622zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
        <span style="font-family:var(--font-en);font-size:0.75rem;letter-spacing:0.12em;font-weight:700;">TWITTER</span>
      </a>
      <a href="https://astro-root.com/" target="_blank" rel="noopener" style="display:flex; flex-direction:column; align-items:center; gap:8px; color:var(--text-muted); text-decoration:none; transition:0.3s; padding:8px 16px; border-radius:12px;" onmouseover="this.style.color='var(--cyan)'" onmouseout="this.style.color='var(--text-muted)'">
        <svg viewBox="0 0 24 24" style="width:22px;height:22px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
        <span style="font-family:var(--font-en);font-size:0.75rem;letter-spacing:0.12em;font-weight:700;">WEBSITE</span>
      </a>
      <a href="https://astro-root.com/q-room/manual.html" target="_blank" rel="noopener" style="display:flex; flex-direction:column; align-items:center; gap:8px; color:var(--text-muted); text-decoration:none; transition:0.3s; padding:8px 16px; border-radius:12px;" onmouseover="this.style.color='var(--cyan)'" onmouseout="this.style.color='var(--text-muted)'">
        <svg viewBox="0 0 24 24" style="width:22px;height:22px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
        <span style="font-family:var(--font-en);font-size:0.75rem;letter-spacing:0.12em;font-weight:700;">MANUAL</span>
      </a>
      <a href="https://astro-root.com/q-room/monitor" target="_blank" rel="noopener" style="display:flex; flex-direction:column; align-items:center; gap:8px; color:var(--text-muted); text-decoration:none; transition:0.3s; padding:8px 16px; border-radius:12px;" onmouseover="this.style.color='var(--cyan)'" onmouseout="this.style.color='var(--text-muted)'">
        <svg viewBox="0 0 24 24" style="width:22px;height:22px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
        <span style="font-family:var(--font-en);font-size:0.75rem;letter-spacing:0.12em;font-weight:700;">MONITOR</span>
      </a>
      <button onclick="tweetApp()" style="background:none; border:none; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:8px; color:var(--text-muted); transition:0.3s; padding:8px 16px; border-radius:12px;" onmouseover="this.style.color='#1d9bf0'" onmouseout="this.style.color='var(--text-muted)'">
        <svg viewBox="0 0 24 24" style="width:22px;height:22px;fill:currentColor;"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.744l7.73-8.835L1.254 2.25H8.08l4.253 5.622zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
        <span style="font-family:var(--font-en);font-size:0.75rem;letter-spacing:0.12em;font-weight:700;">TWEET</span>
      </button>
    </div>
  </div>
</div>


<div id="screen-room" class="screen">
  <div class="header">
    <div class="header-row1">
      <button class="h-btn-icon h-btn-icon-theme-room" onclick="toggleTheme()" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿" id="theme-toggle-btn-room">
        <span id="theme-icon-room">â˜€ï¸</span>
      </button>
      <div class="header-row1-spacer"></div>
      <button class="h-btn-icon h-btn-icon-tweet" onclick="tweetInvite()" title="Xã«æŠ•ç¨¿">
        <svg viewBox="0 0 24 24" style="width:17px;height:17px;fill:currentColor;"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.744l7.73-8.835L1.254 2.25H8.08l4.253 5.622zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
      </button>
      <button class="h-btn-icon notif-bell-btn" onclick="toggleNotifPanel()" title="é€šçŸ¥" id="notif-bell-btn" style="display:none;">
        <svg viewBox="0 0 24 24" style="width:17px;height:17px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
        <span class="notif-badge" id="notif-badge" style="display:none;"></span>
      </button>
      <button class="h-btn-icon chat-btn" onclick="toggleChat()" title="Chat" id="chat-header-btn">
        <svg viewBox="0 0 24 24" style="width:17px;height:17px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        <span class="chat-badge" id="chat-badge"></span>
      </button>
      <button class="h-btn-icon h-btn-icon-feedback" onclick="openFeedback()" title="Feedback">
        <svg viewBox="0 0 24 24" style="width:17px;height:17px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
      </button>
      <button class="h-btn-icon" onclick="openModal()" title="Settings">
        <svg viewBox="0 0 24 24" style="width:17px;height:17px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
      </button>
    </div>
    <div class="header-row2">
      <div class="room-info">ROOM<span id="game-rid">â€”</span></div>
      <div class="rule-badge" id="game-rule">â€”</div>
    </div>
  </div>
  <div class="timer-panel" id="timer-panel">
    <div class="timer-display" id="timer-display">05:00</div>
    <div class="timer-controls">
      <button class="timer-btn timer-btn-start" id="timer-btn-startstop" onclick="timerAction('toggle')">â–¶ START</button>
      <button class="timer-btn timer-btn-reset" onclick="timerAction('reset')">â†º RESET</button>
    </div>
  </div>
  <div class="scroll-area"><div id="plist" class="plist"></div></div>
  <div class="action-panel" id="mypanel">
    <div class="ox-grid" id="ox-grid">
      <button class="ox-btn btn-o" onclick="sendAction('correct')">â—¯</button>
      <button class="ox-btn btn-x" onclick="sendAction('wrong')">âœ•</button>
    </div>
    <div class="sub-actions">
      <button class="sub-btn" id="btn-undo" onclick="reqUndo()" disabled>â†© UNDO</button>
      <button class="sub-btn" onclick="toggleRole()" id="btn-role">ğŸ‘€ WATCH</button>
      <button class="sub-btn" id="btn-board-host" onclick="boardSetHost()" style="display:none;">ğŸ™ HOST</button>
      <button class="sub-btn" onclick="leaveRoom()">ğŸšª LEAVE</button>
    </div>
  </div>
</div>


<div id="screen-result" class="screen">
  <div class="r-header">
    <div class="r-title">RESULT</div>
    <div style="display:flex; gap:12px; max-width:240px; margin:0 auto;">
      <button class="sub-btn" onclick="backToRoom()" style="flex:1;">Back to ROOM</button>
      <button class="sub-btn" onclick="tweetResult()" style="flex:0 0 auto; padding:12px 16px; color:#1d9bf0; border-color:rgba(29,155,240,0.4);" title="çµæœã‚’ãƒ„ã‚¤ãƒ¼ãƒˆ">
        <svg viewBox="0 0 24 24" style="width:16px;height:16px;fill:currentColor;display:block;"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.744l7.73-8.835L1.254 2.25H8.08l4.253 5.622zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
      </button>
    </div>
  </div>
  <div class="scroll-area"><div id="rlist" class="plist"></div></div>
</div>


<div id="screen-account" class="screen">
  <div class="acct-header">
    <button class="acct-back-btn" onclick="show('top')">
      <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" fill="none" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
    </button>
    <div class="acct-header-title">ACCOUNT</div>
    <button class="hero-theme-btn acct-theme-btn" onclick="toggleTheme()" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">
      <span id="theme-icon-acct">â˜€ï¸</span>
    </button>
  </div>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³å‰ -->
  <div id="acct-guest-section">
    <div class="acct-guest-icon">
      <svg viewBox="0 0 24 24" width="56" height="56" stroke="currentColor" fill="none" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
    </div>
    <div class="acct-guest-label">ãƒ­ã‚°ã‚¤ãƒ³ / ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²</div>
    <div class="acct-tabs">
      <button class="acct-tab active" id="acct-tab-login" onclick="switchAcctTab('login')">LOGIN</button>
      <button class="acct-tab" id="acct-tab-register" onclick="switchAcctTab('register')">REGISTER</button>
    </div>
    <div class="acct-form-wrap" id="acct-login-form">
      <div class="field"><label>EMAIL or USER ID</label><input type="text" id="auth-email-login" placeholder="your@email.com or user_id" autocomplete="username"></div>
      <div class="field"><label>PASSWORD</label><input type="password" id="auth-pw-login" placeholder="Password" autocomplete="current-password" onkeydown="if(event.key==='Enter')loginAccount()"></div>
      <div id="auth-err-login" class="err"></div>
      <button class="btn btn-pri" onclick="loginAccount()" style="margin-bottom:12px;">LOGIN</button>
      <button class="btn btn-ghost" onclick="forgotPassword()">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãŠå¿˜ã‚Œã®å ´åˆ</button>
    </div>
    <div class="acct-form-wrap" id="acct-register-form" style="display:none;">
      <div class="field"><label>EMAIL</label><input type="email" id="auth-email-reg" placeholder="your@email.com" autocomplete="email"></div>
      <div class="field">
        <label>USER ID <span style="font-size:0.75rem;color:var(--text-muted);font-weight:400;">ï¼ˆåŠè§’è‹±æ•°å­—ãƒ»_ 3ã€œ20æ–‡å­—ï¼‰</span></label>
        <input type="text" id="auth-uid-reg" placeholder="quiz_master" maxlength="20" autocomplete="off" oninput="this.value=this.value.replace(/[^a-zA-Z0-9_]/g,'')">
      </div>
      <div class="field">
        <label>PASSWORD <span style="font-size:0.75rem;color:var(--text-muted);font-weight:400;">ï¼ˆè‹±å­—+æ•°å­—+è¨˜å· 8æ–‡å­—ä»¥ä¸Šï¼‰</span></label>
        <input type="password" id="auth-pw-reg" placeholder="Passw0rd!" autocomplete="new-password" onkeydown="if(event.key==='Enter')registerAccount()">
      </div>
      <div id="auth-err-reg" class="err"></div>
      <button class="btn btn-pri" onclick="registerAccount()">CREATE ACCOUNT</button>
    </div>
  </div>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³å¾Œ -->
  <div id="acct-user-section" style="display:none;">

    <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ˜ãƒƒãƒ€ -->
    <div class="acct-profile-hero">
      <div class="acct-profile-icon-wrap">
        <div class="profile-icon-display" id="profile-icon-display">ğŸ®</div>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:10px;align-items:center;">
          <button class="profile-icon-change-btn" onclick="toggleIconPicker()">çµµæ–‡å­—ã‚¢ã‚¤ã‚³ãƒ³</button>
          <button class="profile-icon-change-btn" onclick="triggerImageUpload()">ğŸ“· ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
          <button class="profile-icon-change-btn" id="btn-reset-icon" onclick="resetIconToDefault()" style="display:none;color:var(--red);border-color:rgba(239,68,68,0.4);">ğŸ—‘ ç”»åƒã‚’å‰Šé™¤</button>
          <input type="file" id="icon-image-file" accept="image/*" style="display:none;" onchange="onIconImageSelected(event)">
        </div>
      </div>
      <div class="acct-profile-meta">
        <div class="acct-profile-uid" id="profile-uid-display">â€”</div>
        <div class="acct-profile-email" id="profile-email-display">â€”</div>
      </div>
    </div>

    <!-- ã‚¢ã‚¤ã‚³ãƒ³é¸æŠ -->
    <div class="icon-picker" id="icon-picker" style="display:none;"></div>

    <!-- ã‚¯ãƒ­ãƒƒãƒ—UI -->
    <div id="icon-crop-wrap" style="display:none;margin:0 20px 16px;">
      <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:8px;text-align:center;">ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ”ãƒ³ãƒã§ä½ç½®ãƒ»æ‹¡å¤§ã‚’èª¿æ•´</div>
      <div id="icon-crop-stage" style="width:200px;height:200px;border-radius:50%;overflow:hidden;position:relative;background:#111;margin:0 auto 12px;border:2px solid var(--cyan);touch-action:none;cursor:grab;">
        <img id="icon-crop-img" style="position:absolute;transform-origin:0 0;user-select:none;-webkit-user-drag:none;" draggable="false">
      </div>
      <div style="display:flex;gap:8px;justify-content:center;">
        <button class="profile-icon-change-btn" onclick="cropIconAndSave()" style="color:var(--cyan);border-color:rgba(6,182,212,0.5);">âœ… ã“ã®ä½ç½®ã§ä¿å­˜</button>
        <button class="profile-icon-change-btn" onclick="cancelCrop()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>

    <!-- åå‰ãƒ»ç§°å· -->
    <div class="acct-section">
      <div class="field">
        <label>NAME <span style="font-size:0.75rem;color:var(--text-muted);font-weight:400;">ï¼ˆ20æ–‡å­—ä»¥å†…ï¼‰</span></label>
        <input type="text" id="profile-name-input" maxlength="20" placeholder="ã‚ãªãŸã®åå‰">
      </div>
      <div class="field">
        <label>ç§°å· <span style="font-size:0.75rem;color:var(--text-muted);font-weight:400;">ï¼ˆ20æ–‡å­—ä»¥å†…ï¼‰</span></label>
        <input type="text" id="profile-title-input" maxlength="20" placeholder="ã‚¯ã‚¤ã‚ºç‹">
      </div>
      <button class="btn btn-pri" onclick="saveProfile()" style="margin-bottom:0;">SAVE</button>
    </div>

    <!-- é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼ -->
    <div class="acct-section">
      <div class="acct-section-header">
        <div class="acct-section-title">ğŸ”” NOTIFICATIONS</div>
        <button class="acct-readall-btn" onclick="topNotifReadAll()">ã™ã¹ã¦æ—¢èª­</button>
      </div>
      <div class="top-notif-list acct-notif-list" id="top-notif-list" style="max-height:360px;overflow-y:auto;"></div>
    </div>

    <!-- ã‚¹ã‚¿ãƒƒãƒ„ -->
    <div class="acct-section">
      <div class="acct-section-title">ğŸ“Š STATS</div>
      <div class="stats-grid" id="stats-grid"></div>
    </div>

    <!-- ãƒ•ãƒ¬ãƒ³ãƒ‰ -->
    <div class="acct-section">
      <button class="btn" onclick="openFriendModal()" style="background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.35);color:var(--cyan);margin-bottom:0;">ğŸ‘¥ ãƒ•ãƒ¬ãƒ³ãƒ‰ç®¡ç†</button>
    </div>

    <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š -->
    <div class="acct-section">
      <button onclick="toggleAccountSettings()" style="background:none;border:none;cursor:pointer;display:flex;align-items:center;gap:8px;color:var(--text-muted);font-family:var(--font-en);font-size:0.82rem;font-weight:700;letter-spacing:0.1em;padding:0;margin-bottom:12px;" id="account-settings-toggle">
        âš™ï¸ ACCOUNT SETTINGS <span id="account-settings-arrow" style="margin-left:4px;">â–¼</span>
      </button>
      <div id="account-settings-body" style="display:none;">
        <div style="background:rgba(255,255,255,0.03);border:1px solid var(--border-color);border-radius:14px;padding:16px;margin-bottom:12px;">
          <div style="font-family:var(--font-en);font-size:0.72rem;font-weight:700;letter-spacing:0.12em;color:var(--text-muted);margin-bottom:12px;">USER ID</div>
          <input type="text" id="new-uid-input" placeholder="æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆ3ã€œ20æ–‡å­—ï¼‰" maxlength="20" autocomplete="off" oninput="this.value=this.value.replace(/[^a-zA-Z0-9_]/g,'')" style="margin-bottom:8px;">
          <button class="btn btn-sec" onclick="updateUserId()" style="padding:10px;">USER ID ã‚’å¤‰æ›´</button>
          <div id="uid-change-err" class="err" style="margin-bottom:0;margin-top:8px;"></div>
        </div>
        <div style="background:rgba(255,255,255,0.03);border:1px solid var(--border-color);border-radius:14px;padding:16px;margin-bottom:12px;">
          <div style="font-family:var(--font-en);font-size:0.72rem;font-weight:700;letter-spacing:0.12em;color:var(--text-muted);margin-bottom:12px;">EMAIL</div>
          <input type="email" id="new-email-input" placeholder="æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" autocomplete="email" style="margin-bottom:8px;">
          <input type="password" id="reauth-pw-email" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªç”¨ï¼‰" autocomplete="current-password" style="margin-bottom:8px;">
          <button class="btn btn-sec" onclick="updateEmail()" style="padding:10px;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¤‰æ›´</button>
          <div id="email-change-err" class="err" style="margin-bottom:0;margin-top:8px;"></div>
        </div>
        <div style="background:rgba(255,255,255,0.03);border:1px solid var(--border-color);border-radius:14px;padding:16px;">
          <div style="font-family:var(--font-en);font-size:0.72rem;font-weight:700;letter-spacing:0.12em;color:var(--text-muted);margin-bottom:12px;">PASSWORD</div>
          <input type="password" id="reauth-pw-current" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="current-password" style="margin-bottom:8px;">
          <input type="password" id="new-pw-input" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆè‹±å­—+æ•°å­—+è¨˜å· 8æ–‡å­—ä»¥ä¸Šï¼‰" autocomplete="new-password" style="margin-bottom:8px;">
          <input type="password" id="new-pw-confirm" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰" autocomplete="new-password" style="margin-bottom:8px;">
          <button class="btn btn-sec" onclick="updatePassword()" style="padding:10px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</button>
          <div id="pw-change-err" class="err" style="margin-bottom:0;margin-top:8px;"></div>
        </div>
      </div>
    </div>

    <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ»é€€ä¼š -->
    <div class="acct-section" style="padding-bottom:40px;display:flex;flex-direction:column;gap:12px;">
      <button class="btn btn-warn" onclick="logoutAccount()">LOGOUT</button>
      <button onclick="deleteAccount()" style="background:none;border:none;cursor:pointer;color:rgba(239,68,68,0.5);font-size:0.78rem;text-decoration:underline;padding:4px;align-self:center;">é€€ä¼šã™ã‚‹</button>
    </div>

  </div>
</div>


<div id="modal" class="modal" onclick="if(event.target===this)closeModal()">
  <div class="m-content">
    <button class="m-close" onclick="closeModal()">âœ•</button>
    <div class="m-title">ROOM SETTINGS</div>

    <div id="admin-gate"></div>

    <div id="admin-section">
      <div class="field">
        <label>RULE</label>
        <select id="sel-rule" onchange="changeRuleUI()">
          <option value="survival">mâ—¯nÃ—</option>
          <option value="free">Free</option>
          <option value="newyork">NewYork</option>
          <option value="rentou">é€£ç­”ä»˜ã</option>
          <option value="updown">up-down</option>
          <option value="by">by</option>
          <option value="freeze">Freeze</option>
          <option value="m_n_rest">mâ—¯nä¼‘</option>
          <option value="swedish">Swedish</option>
          <option value="ren_wrong">é€£èª¤ç­”ä»˜ã</option>
          <option value="divide">divide</option>
          <option value="combo">m hits Combo</option>
          <option value="attack_surv">ã‚¢ã‚¿ãƒƒã‚¯é¢¨ã‚µãƒã‚¤ãƒãƒ«</option>
          <option value="lucky">LuckyShot</option>
          <option value="spiral">èºæ—‹éšæ®µ</option>
          <option value="time_race">Time Race</option>
          <option value="board_quiz">Board Quiz</option>
        </select>
      </div>
      <div id="config-area"></div>
    </div>

    <hr>
    <div class="s-grid">
      <button class="sub-btn" onclick="copyUrl()">ğŸ”— Copy URL</button>
      <button class="sub-btn" onclick="copyId()">ğŸ“‹ Copy ID</button>
    </div>
    <div id="admin-section-btns">
      <button class="btn btn-sec" onclick="resetPoints()" style="margin-bottom:16px;">ğŸ”„ RESET SCORES</button>
      <button class="btn btn-warn" onclick="endGame()">ğŸ FINISH GAME</button>
      <div id="invite-friend-section" style="display:none; margin-top:20px;">
        <hr style="margin-bottom:20px;">
        <button class="btn btn-sec" onclick="openInviteFriendModal()" style="border-color:rgba(6,182,212,0.4);color:var(--cyan);">ğŸ‘¥ ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚’æ‹›å¾…</button>
      </div>
    </div>
  </div>
</div>


<div id="modal-room-info" class="modal room-share-modal" onclick="if(event.target===this)closeRoomInfo()">
  <div class="m-content">
    <button class="m-close" onclick="closeRoomInfo()">âœ•</button>
    <div class="m-title" id="room-info-title">ROOM CREATED</div>

    <div class="share-row">
      <span class="share-label">ID</span>
      <span class="share-val" id="share-room-id">â€”</span>
      <button class="share-copy-btn" id="btn-copy-id" onclick="copyShareId()">COPY</button>
    </div>
    <div class="share-row">
      <span class="share-label">URL</span>
      <span class="share-val" id="share-room-url">â€”</span>
      <button class="share-copy-btn" id="btn-copy-url" onclick="copyShareUrl()">COPY</button>
    </div>

    <button class="share-native-btn" id="btn-native-share" onclick="nativeShare()">
      <svg viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
      INVITE FRIENDS
    </button>
    <button class="room-info-dismiss" onclick="closeRoomInfo()">START PLAYING â†’</button>
  </div>
</div>


<div id="modal-feedback" class="modal" onclick="if(event.target===this)closeFeedback()">
  <div class="m-content">
    <button class="m-close" onclick="closeFeedback()">âœ•</button>
    <div class="m-title">FEEDBACK</div>
    <div style="display:flex; flex-direction:column; gap:12px; margin-bottom:16px;">
      <a href="https://twitter.com/astro_root" target="_blank" rel="noopener" style="display:flex; align-items:center; gap:14px; padding:14px 18px; background:rgba(255,255,255,0.04); border:1px solid var(--border-color); border-radius:14px; color:var(--text-main); text-decoration:none; transition:0.3s; font-family:var(--font-en); font-size:0.9rem; font-weight:700;" onmouseover="this.style.borderColor='#1d9bf0';this.style.background='rgba(29,155,240,0.08)'" onmouseout="this.style.borderColor='var(--border-color)';this.style.background='rgba(255,255,255,0.04)'">
        <svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:#1d9bf0;flex-shrink:0;"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.744l7.73-8.835L1.254 2.25H8.08l4.253 5.622zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
        <div>
          <div style="color:var(--text-muted);font-size:0.7rem;letter-spacing:0.12em;margin-bottom:2px;">TWITTER</div>
          @astro_root
        </div>
      </a>
      <a href="https://astro-root.com/" target="_blank" rel="noopener" style="display:flex; align-items:center; gap:14px; padding:14px 18px; background:rgba(255,255,255,0.04); border:1px solid var(--border-color); border-radius:14px; color:var(--text-main); text-decoration:none; transition:0.3s; font-family:var(--font-en); font-size:0.9rem; font-weight:700;" onmouseover="this.style.borderColor='var(--cyan)';this.style.background='rgba(6,182,212,0.08)'" onmouseout="this.style.borderColor='var(--border-color)';this.style.background='rgba(255,255,255,0.04)'">
        <svg viewBox="0 0 24 24" style="width:20px;height:20px;stroke:var(--cyan);fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
        <div>
          <div style="color:var(--text-muted);font-size:0.7rem;letter-spacing:0.12em;margin-bottom:2px;">WEBSITE</div>
          astro-root.com
        </div>
      </a>
    </div>
    <hr>
    <form action="https://public.herotofu.com/v1/73ca08d0-1004-11f1-9506-dbd2adae6f0e" method="post" target="_blank" onsubmit="setTimeout(closeFeedback, 500)" style="margin-top:28px;">
      <div class="field">
        <label>NAME</label>
        <input type="text" name="name" placeholder="Your Name" required>
      </div>
      <div class="field">
        <label>MESSAGE</label>
        <textarea name="message" placeholder="Your Message" required></textarea>
      </div>
      <button type="submit" class="btn btn-pri">SEND FEEDBACK</button>
    </form>
  </div>
</div>


<!-- ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ç”¨é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼ãƒ‰ãƒ­ãƒ¯ãƒ¼ -->
<div class="notif-overlay" id="top-notif-overlay" onclick="toggleTopNotifDrawer()"></div>
<div class="notif-drawer" id="top-notif-drawer">
  <div class="chat-handle"></div>
  <div class="notif-drawer-header">
    <div class="notif-drawer-title">ğŸ”” NOTIFICATIONS</div>
    <button class="notif-readall-btn" onclick="topNotifReadAll()">ã™ã¹ã¦æ—¢èª­</button>
    <button class="notif-readall-btn" onclick="toggleTopNotifDrawer();showAccountPage();" style="border-color:rgba(6,182,212,0.4);color:var(--cyan);">âš™ï¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</button>
    <button class="chat-close" onclick="toggleTopNotifDrawer()" style="margin-left:8px;">âœ•</button>
  </div>
  <div class="notif-list" id="top-notif-drawer-list"></div>
</div>

<!-- é€šçŸ¥ãƒ‰ãƒ­ãƒ¯ãƒ¼ï¼ˆãƒ«ãƒ¼ãƒ å†…ï¼‰ -->
<div class="notif-overlay" id="notif-overlay" onclick="toggleNotifPanel()"></div>
<div class="notif-drawer" id="notif-drawer">
  <div class="chat-handle"></div>
  <div class="notif-drawer-header">
    <div class="notif-drawer-title">ğŸ”” NOTIFICATIONS</div>
    <button class="notif-readall-btn" onclick="markAllNotifRead()">ã™ã¹ã¦æ—¢èª­</button>
    <button class="chat-close" onclick="toggleNotifPanel()" style="margin-left:8px;">âœ•</button>
  </div>
  <div class="notif-list" id="notif-list"></div>
</div>

<div class="chat-overlay" id="chat-overlay" onclick="toggleChat()"></div>
<div class="chat-drawer" id="chat-drawer">
  <div class="chat-handle"></div>
  <div class="chat-header">
    <span class="chat-title">CHAT</span>
    <button class="chat-close" onclick="toggleChat()">âœ•</button>
  </div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-stamps" id="chat-stamps"></div>
  <div class="chat-input-row">
    <input class="chat-input" id="chat-input" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›â€¦" maxlength="200" autocomplete="off" onkeydown="if(event.key==='Enter')sendChatMsg()">
    <button class="chat-send" onclick="sendChatMsg()">
      <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
    </button>
  </div>
</div>


<div class="countdown-overlay" id="countdown-overlay">
  <div class="countdown-num" id="countdown-num">5</div>
  <div class="countdown-label">GET READY</div>
</div>

<div id="toast" class="toast"></div>






<div id="modal-delete-account" class="modal" onclick="if(event.target===this)closeDeleteAccountModal()">
  <div class="m-content" style="max-width:400px;">
    <button class="m-close" onclick="closeDeleteAccountModal()">âœ•</button>
    <div class="m-title" style="color:#f87171;">âš ï¸ é€€ä¼šç¢ºèª</div>
    <p style="color:var(--text-muted);font-size:0.88rem;margin-bottom:20px;line-height:1.6;">é€€ä¼šã™ã‚‹ã¨å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ»ã‚¹ã‚¿ãƒƒãƒ„ãƒ»ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒ»é€šçŸ¥ï¼‰ãŒå‰Šé™¤ã•ã‚Œã€å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</p>
    <div class="field">
      <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦æœ¬äººç¢ºèª</label>
      <input type="password" id="delete-account-pw" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="current-password">
    </div>
    <div id="delete-account-err" class="err" style="display:none;margin-bottom:12px;"></div>
    <button id="delete-account-btn" class="btn btn-warn" onclick="confirmDeleteAccount()" style="width:100%;background:rgba(239,68,68,0.15);border-color:rgba(239,68,68,0.4);color:#f87171;">é€€ä¼šã‚’å®Ÿè¡Œã™ã‚‹</button>
    <button class="btn btn-sec" onclick="closeDeleteAccountModal()" style="width:100%;margin-top:8px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<div id="modal-friend" class="modal" onclick="if(event.target===this)closeFriendModal()">
  <div class="m-content">
    <button class="m-close" onclick="closeFriendModal()">âœ•</button>
    <div class="m-title">ğŸ‘¥ FRIENDS</div>
    <div class="friend-search-row">
      <input type="text" id="friend-search-input" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§æ¤œç´¢â€¦" maxlength="20" autocomplete="off" oninput="this.value=this.value.replace(/[^a-zA-Z0-9_]/g,'')" onkeydown="if(event.key==='Enter')sendFriendRequest()">
      <button class="friend-search-btn" onclick="sendFriendRequest()">ç”³è«‹</button>
    </div>
    <div id="friend-req-section" style="display:none;">
      <div class="friend-section-label">ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹</div>
      <div id="friend-req-list"></div>
    </div>
    <div class="friend-section-label">ãƒ•ãƒ¬ãƒ³ãƒ‰ä¸€è¦§</div>
    <div id="friend-list"></div>
  </div>
</div>


<div id="modal-invite-friend" class="modal" onclick="if(event.target===this)closeInviteFriendModal()">
  <div class="m-content">
    <button class="m-close" onclick="closeInviteFriendModal()">âœ•</button>
    <div class="m-title">ğŸ‘¥ ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚’æ‹›å¾…</div>
    <div style="font-size:0.82rem;color:var(--text-muted);margin-bottom:12px;">ãƒ•ãƒ¬ãƒ³ãƒ‰ã«éƒ¨å±‹ã®æ‹›å¾…é€šçŸ¥ã‚’é€ã‚Šã¾ã™</div>
    <div id="invite-friend-list"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="js/q-room.js"></script>
<script>
// ============================================================
// é€šçŸ¥ã‚»ãƒ³ã‚¿ãƒ¼ä¿®æ­£ãƒ‘ãƒƒãƒ
// ============================================================

// Fix1: orderByChild('ts') ã‚’ä½¿ã‚ãšã‚·ãƒ³ãƒ—ãƒ«ãªãƒªã‚¹ãƒŠãƒ¼ã«å·®ã—æ›¿ãˆ
//       â†’ ".indexOn" æœªè¨­å®šã§ã‚‚ç¢ºå®Ÿã«å‹•ä½œã™ã‚‹
const _origInitTopNotifCenter = initTopNotifCenter;
function initTopNotifCenter(user) {
  if(window._patchNotifRef) {
    window._patchNotifRef.off('value', window._patchNotifCb);
    window._patchNotifRef = null;
  }
  if(!user || !user.uid) return;
  const fbdb = db || firebase.database();
  // orderByChild/limitToLast ã‚’å¤–ã—ã¦ã‚·ãƒ³ãƒ—ãƒ«ãªãƒªã‚¹ãƒŠãƒ¼ã«
  window._patchNotifRef = fbdb.ref('notifications/' + user.uid);
  window._patchNotifCb = snap => {
    const items = [];
    snap.forEach(c => items.push({ id: c.key, ...c.val() }));
    // tsã§é™é †ã‚½ãƒ¼ãƒˆ
    items.sort((a, b) => (b.ts||0) - (a.ts||0));
    const limited = items.slice(0, 50);
    unreadNotifCount = limited.filter(n => !n.read).length;
    updateNotifBadge();
    renderAccountNotifList(limited);
    if(window._topNotifDrawerOpen) renderTopNotifDrawer(limited);
    if(window._notifOpen) renderNotifList(limited);
  };
  window._patchNotifRef.on('value', window._patchNotifCb, err => {
    console.error('[notif-patch] listener error:', err.code, err.message);
  });
  // å…ƒã®é–¢æ•°ã¯å‘¼ã°ãªã„ï¼ˆä¸Šæ›¸ãï¼‰
}

// Fix2: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒœã‚¿ãƒ³ â†’ ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰é€šçŸ¥ãƒ‰ãƒ­ãƒ¯ãƒ¼ã‚’é–‹ã
function handleHeroAccountBtn() {
  if(currentUser) { toggleTopNotifDrawer(); } else { showAccountPage(); }
}

// Fix3: notifyFriendsRoomCreated â†’ currentUserProfile ã‚’ç¢ºèªã—ã¦ã‹ã‚‰é€ä¿¡
const _origNotifyFriendsRoomCreated = notifyFriendsRoomCreated;
async function notifyFriendsRoomCreated(roomId) {
  if(!currentUser) return;
  if(!currentUserProfile) {
    // profileãŒã¾ã å–ã‚Œã¦ã„ãªã„å ´åˆ1.5ç§’å¾…ã£ã¦å†è©¦è¡Œ
    await new Promise(r => setTimeout(r, 1500));
    if(!currentUserProfile) { console.warn('[notif-patch] currentUserProfile still null, skip'); return; }
  }
  try {
    const snap = await db.ref('friends/' + currentUser.uid).once('value');
    let count = 0;
    const promises = [];
    snap.forEach(child => {
      count++;
      promises.push(
        db.ref('notifications/' + child.key).push({
          type: 'friendRoom',
          title: currentUserProfile.displayId + ' ã•ã‚“ãŒéƒ¨å±‹ã‚’ä½œã‚Šã¾ã—ãŸ',
          body: 'Room ID: ' + roomId + ' ã«æ‹›å¾…ã•ã‚Œã¾ã—ãŸ',
          roomId: roomId,
          fromUid: currentUser.uid,
          read: false,
          ts: firebase.database.ServerValue.TIMESTAMP
        }).catch(e => console.error('[notif-patch] write failed uid=' + child.key, e))
      );
    });
    console.log('[notif-patch] notifyFriendsRoomCreated â†’ ' + count + ' friends, roomId=' + roomId);
    await Promise.allSettled(promises);
  } catch(e) { console.error('[notif-patch] notifyFriendsRoomCreated error', e); }
}

// Fix4: loadFriendData â†’ try/catch + iconUrlå¯¾å¿œ
async function loadFriendData() {
  const friendList = document.getElementById('friend-list');
  const reqSec = document.getElementById('friend-req-section');
  const reqList = document.getElementById('friend-req-list');
  if(friendList) friendList.innerHTML = '<div class="friend-empty">èª­ã¿è¾¼ã¿ä¸­â€¦</div>';

  let friendsSnap, reqSnap;
  try {
    [friendsSnap, reqSnap] = await Promise.all([
      db.ref('friends/' + currentUser.uid).once('value'),
      db.ref('friendRequests/' + currentUser.uid).once('value')
    ]);
  } catch(e) {
    console.error('[notif-patch] loadFriendData failed:', e);
    if(friendList) friendList.innerHTML = '<div class="friend-empty">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
    if(reqSec) reqSec.style.display = 'none';
    return;
  }

  const reqs = [];
  reqSnap.forEach(child => reqs.push({ uid: child.key, ...child.val() }));
  if(reqs.length > 0) {
    if(reqSec) reqSec.style.display = '';
    if(reqList) reqList.innerHTML = reqs.map(r => {
      const ic = r.iconUrl ? '<img src="' + r.iconUrl + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">' : (r.icon||'ğŸ‘¤');
      return '<div class="friend-req-item">' +
        '<div class="friend-icon">' + ic + '</div>' +
        '<div class="friend-info"><div class="friend-displayid">' + esc(r.displayId||'?') + '</div><div class="friend-title">' + (r.title ? esc(r.title) : '') + '</div></div>' +
        '<div class="friend-actions">' +
        '<button class="friend-btn friend-btn-accept" onclick="acceptFriendDirect(\'' + r.uid + '\',\'' + (r.displayId||'') + '\')">æ‰¿èª</button>' +
        '<button class="friend-btn friend-btn-decline" onclick="declineFriendDirect(\'' + r.uid + '\')">æ‹’å¦</button>' +
        '</div></div>';
    }).join('');
  } else {
    if(reqSec) reqSec.style.display = 'none';
  }

  const friendUids = [];
  friendsSnap.forEach(child => friendUids.push(child.key));
  if(friendUids.length === 0) {
    if(friendList) friendList.innerHTML = '<div class="friend-empty">ãƒ•ãƒ¬ãƒ³ãƒ‰ãŒã„ã¾ã›ã‚“</div>';
    return;
  }

  const profiles = await Promise.all(
    friendUids.map(uid =>
      db.ref('users/' + uid).once('value')
        .then(s => ({ uid, data: s.val() || {} }))
        .catch(() => ({ uid, data: {} }))
    )
  );

  if(friendList) friendList.innerHTML = profiles.map(({ uid, data: p }) => {
    accountProfileCache[uid] = p;
    const ic = p.iconUrl ? '<img src="' + p.iconUrl + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">' : (p.icon||'ğŸ‘¤');
    return '<div class="friend-item">' +
      '<div class="friend-icon">' + ic + '</div>' +
      '<div class="friend-info"><div class="friend-displayid">' + esc(p.displayId||'?') + '</div><div class="friend-title">' + (p.title ? esc(p.title) : 'ç§°å·ãªã—') + '</div></div>' +
      '<div class="friend-actions"><button class="friend-btn friend-btn-remove" onclick="removeFriend(\'' + uid + '\',\'' + (p.displayId||'') + '\')">å‰Šé™¤</button></div>' +
      '</div>';
  }).join('');
}

console.log('[notif-patch] loaded âœ…');
</script>
</body>
</html>
