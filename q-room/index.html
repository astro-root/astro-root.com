<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Q-Room</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:ital,wght@0,300;0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg:       #070710;
  --surface:  #0e0e1f;
  --card:     #14142a;
  --border:   rgba(255,255,255,0.08);
  --cyan:     #00e5ff;
  --pink:     #ff2d6f;
  --green:    #00e096;
  --red:      #ff4757;
  --yellow:   #ffd32a;
  --text:     #e0e0f0;
  --muted:    #5a5a7a;
  --font-display: 'Orbitron', monospace;
  --font-body:    'Exo 2', sans-serif;
}
body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-body);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 0;
  overflow-x: hidden;
}
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse 60% 40% at 20% 0%, rgba(0,229,255,0.06) 0%, transparent 60%),
    radial-gradient(ellipse 50% 50% at 80% 100%, rgba(255,45,111,0.06) 0%, transparent 60%);
  pointer-events: none;
  z-index: 0;
}
.screen {
  display: none;
  width: 100%;
  max-width: 520px;
  padding: 28px 20px 60px;
  position: relative;
  z-index: 1;
}
.screen.active { display: block; }
.logo {
  font-family: var(--font-display);
  font-size: 3rem;
  font-weight: 900;
  letter-spacing: 0.12em;
  text-align: center;
  background: linear-gradient(135deg, var(--cyan) 0%, var(--pink) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 4px;
  filter: drop-shadow(0 0 20px rgba(0,229,255,0.4));
}
.tagline {
  text-align: center;
  color: var(--muted);
  font-size: 0.8rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  margin-bottom: 32px;
}
h2 {
  font-family: var(--font-display);
  font-size: 1.1rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  color: var(--cyan);
  margin-bottom: 16px;
}
h3 {
  font-family: var(--font-display);
  font-size: 0.85rem;
  font-weight: 700;
  letter-spacing: 0.08em;
  color: var(--muted);
  margin-bottom: 12px;
}
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  position: relative;
  overflow: hidden;
}
.card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--cyan), transparent);
  opacity: 0.5;
}
.top-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.btn-small {
  padding: 8px 12px !important;
  font-size: 0.75rem !important;
  width: auto !important;
  margin-bottom: 0 !important;
}
.field { margin-bottom: 16px; }
label {
  display: block;
  font-size: 0.72rem;
  font-weight: 700;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 7px;
}
input[type="text"], input[type="number"] {
  width: 100%;
  padding: 12px 16px;
  background: rgba(0,0,0,0.4);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-family: var(--font-body);
  font-size: 1rem;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
}
input[type="text"]:focus, input[type="number"]:focus {
  border-color: var(--cyan);
  box-shadow: 0 0 0 3px rgba(0,229,255,0.12);
}
input::placeholder { color: var(--muted); }
.room-id-row { display: flex; gap: 10px; }
.room-id-row input { flex: 1; }
.room-id-row .gen-btn {
  padding: 12px 14px;
  background: rgba(0,229,255,0.1);
  border: 1px solid rgba(0,229,255,0.3);
  border-radius: 10px;
  color: var(--cyan);
  cursor: pointer;
  font-size: 0.75rem;
  font-weight: 700;
  letter-spacing: 0.05em;
  white-space: nowrap;
  transition: all 0.2s;
  font-family: var(--font-body);
}
.room-id-row .gen-btn:hover { background: rgba(0,229,255,0.2); }
.btn {
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 12px;
  font-family: var(--font-display);
  font-size: 0.8rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  cursor: pointer;
  transition: all 0.2s;
  margin-bottom: 10px;
  position: relative;
  overflow: hidden;
}
.btn::after {
  content: '';
  position: absolute;
  inset: 0;
  background: rgba(255,255,255,0.08);
  opacity: 0;
  transition: opacity 0.15s;
}
.btn:hover::after { opacity: 1; }
.btn:active { transform: scale(0.98); }
.btn-primary {
  background: linear-gradient(135deg, var(--cyan), #0088ff);
  color: #000;
  box-shadow: 0 4px 20px rgba(0,229,255,0.3);
}
.btn-secondary {
  background: linear-gradient(135deg, var(--pink), #cc0044);
  color: #fff;
  box-shadow: 0 4px 20px rgba(255,45,111,0.3);
}
.btn-ghost {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text);
}
.btn-ghost:hover { border-color: var(--cyan); color: var(--cyan); }
.btn-green-solid {
  background: linear-gradient(135deg, var(--green), #00b371);
  color: #000;
  font-family: var(--font-body);
  font-size: 1.2rem;
  font-weight: 700;
  letter-spacing: 0;
  padding: 16px;
  box-shadow: 0 4px 20px rgba(0,224,150,0.3);
}
.btn-red-solid {
  background: linear-gradient(135deg, var(--red), #cc2233);
  color: #fff;
  font-family: var(--font-body);
  font-size: 1.2rem;
  font-weight: 700;
  letter-spacing: 0;
  padding: 16px;
  box-shadow: 0 4px 20px rgba(255,71,87,0.3);
}
.error-msg {
  color: var(--red);
  font-size: 0.82rem;
  margin-bottom: 10px;
  display: none;
  padding: 8px 12px;
  background: rgba(255,71,87,0.1);
  border-radius: 8px;
  border: 1px solid rgba(255,71,87,0.2);
}
.share-row { display: flex; gap: 8px; margin-top: 14px; }
.share-btn {
  flex: 1;
  padding: 9px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: transparent;
  color: var(--muted);
  cursor: pointer;
  font-size: 0.75rem;
  font-weight: 600;
  letter-spacing: 0.05em;
  font-family: var(--font-body);
  transition: all 0.2s;
}
.share-btn:hover { border-color: var(--cyan); color: var(--cyan); background: rgba(0,229,255,0.05); }
.player-avatar {
  width: 34px; height: 34px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--cyan), var(--pink));
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 0.9rem; color: #000;
  flex-shrink: 0;
}
.mode-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
.mode-tab {
  flex: 1;
  padding: 10px 8px;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: transparent;
  color: var(--muted);
  cursor: pointer;
  font-size: 0.82rem;
  font-weight: 700;
  font-family: var(--font-body);
  letter-spacing: 0.05em;
  transition: all 0.2s;
}
.mode-tab.active {
  background: rgba(0,229,255,0.1);
  border-color: var(--cyan);
  color: var(--cyan);
}
.settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.settings-grid .field { margin-bottom: 0; }
.settings-desc { font-size: 0.78rem; color: var(--muted); line-height: 1.6; margin-bottom: 14px; font-style: italic; }
.settings-panel { display: none; }
.settings-panel.active { display: block; }
.game-topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}
.game-room-id {
  font-family: var(--font-display);
  font-size: 0.75rem;
  letter-spacing: 0.15em;
  color: var(--muted);
}
.game-room-id span { color: var(--cyan); }
.mode-pill {
  padding: 5px 12px;
  background: rgba(255,45,111,0.12);
  border: 1px solid rgba(255,45,111,0.25);
  border-radius: 20px;
  font-size: 0.72rem;
  font-weight: 700;
  letter-spacing: 0.08em;
  color: var(--pink);
}
.player-cards { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
.pcard {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 14px 16px;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}
.pcard.pcard-me { border-color: rgba(0,229,255,0.4); box-shadow: 0 0 15px rgba(0,229,255,0.1); }
.pcard.pcard-winner { border-color: var(--green); background: rgba(0,224,150,0.06); }
.pcard.pcard-winner::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: var(--green);
}
.pcard.pcard-eliminated { opacity: 0.45; filter: grayscale(0.7); }
.pcard.pcard-spectator { opacity: 0.6; }
.pcard-top { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
.pcard-name { flex: 1; font-weight: 700; font-size: 1rem; }
.pcard-status {
  font-size: 0.68rem; padding: 3px 9px; border-radius: 20px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase;
}
.s-active { background: rgba(90,90,122,0.3); color: var(--muted); }
.s-winner { background: rgba(0,224,150,0.2); color: var(--green); border: 1px solid rgba(0,224,150,0.3); }
.s-eliminated { background: rgba(255,71,87,0.15); color: var(--red); }
.s-spectator { background: rgba(100,100,100,0.2); color: #ccc; }
.pcard-stats { display: flex; gap: 16px; align-items: center; }
.stat-box { display: flex; align-items: center; gap: 5px; font-size: 0.85rem; }
.stat-icon { font-size: 0.9rem; }
.stat-val { font-weight: 700; font-size: 1rem; }
.stat-val.correct { color: var(--green); }
.stat-val.wrong { color: var(--red); }
.score-large {
  margin-left: auto; font-family: var(--font-display); font-size: 1.8rem; font-weight: 900; color: var(--cyan); filter: drop-shadow(0 0 8px rgba(0,229,255,0.4));
}
.my-action-panel {
  background: var(--card);
  border: 1px solid rgba(0,229,255,0.3);
  border-radius: 14px;
  padding: 16px;
  margin-top: 20px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.action-row { display: flex; gap: 12px; margin-bottom: 12px; }
.action-row .btn { flex: 1; margin-bottom: 0; }
.podium-wrap { text-align: center; padding: 20px 0; }
.podium-emoji { font-size: 4rem; line-height: 1; margin-bottom: 12px; }
.podium-name {
  font-family: var(--font-display); font-size: 1.6rem; font-weight: 900;
  background: linear-gradient(135deg, var(--yellow), var(--pink));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 4px;
}
.podium-sub { color: var(--muted); font-size: 0.82rem; letter-spacing: 0.1em; }
.result-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 24px; }
.result-item {
  display: flex; align-items: center; gap: 12px; padding: 13px 16px; background: var(--card); border-radius: 12px; border: 1px solid var(--border);
}
.result-rank { font-family: var(--font-display); font-size: 1.1rem; font-weight: 900; min-width: 28px; color: var(--muted); }
.result-rank.r1 { color: var(--yellow); }
.result-rank.r2 { color: #c0c0c0; }
.result-rank.r3 { color: #cd7f32; }
.result-name { flex: 1; font-weight: 600; }
.result-stats { font-size: 0.8rem; color: var(--muted); }
.result-score { font-family: var(--font-display); font-size: 1rem; font-weight: 700; color: var(--cyan); }
.toast {
  position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%) translateY(80px);
  background: rgba(20,20,42,0.95); backdrop-filter: blur(12px); color: var(--text); padding: 12px 22px; border-radius: 30px;
  font-size: 0.88rem; border: 1px solid var(--border); opacity: 0; transition: all 0.3s cubic-bezier(0.34,1.56,0.64,1);
  pointer-events: none; z-index: 1000; max-width: 300px; text-align: center;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.divider { display: flex; align-items: center; gap: 12px; margin: 4px 0 16px; color: var(--muted); font-size: 0.75rem; }
.divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.config-notice {
  background: rgba(255,211,42,0.08); border: 1px solid rgba(255,211,42,0.25); border-radius: 10px; padding: 12px 16px;
  margin-bottom: 20px; font-size: 0.78rem; color: var(--yellow); line-height: 1.6; display: none;
}
.config-notice.visible { display: block; }

.modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
  z-index: 100; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s;
}
.modal-overlay.active { display: flex; opacity: 1; }
.modal-content {
  background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
  width: 90%; max-width: 400px; padding: 24px; position: relative;
  transform: translateY(20px); transition: transform 0.2s; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
}
.modal-overlay.active .modal-content { transform: translateY(0); }
.modal-close {
  position: absolute; top: 16px; right: 16px; background: transparent; border: none;
  color: var(--muted); font-size: 1.5rem; cursor: pointer; transition: color 0.2s;
}
.modal-close:hover { color: var(--cyan); }

@media (min-width: 521px) { body { padding-top: 20px; } }
</style>
</head>
<body>

<div id="screen-top" class="screen active">
  <div class="logo">Q-ROOM</div>
  <div class="tagline">Real-time Quiz Battle</div>

  <div id="config-notice" class="config-notice">
    <strong>âš ï¸ Firebase æœªè¨­å®š</strong>
    ãƒ•ã‚¡ã‚¤ãƒ«ä¸‹éƒ¨ã® <code>firebaseConfig</code> ã‚’ã”è‡ªèº«ã®Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å€¤ã«å·®ã—æ›¿ãˆã¦ãã ã•ã„ã€‚
  </div>

  <div class="card">
    <div class="field">
      <label>Your Name</label>
      <input type="text" id="input-name" placeholder="åå‰ã‚’å…¥åŠ›" maxlength="20" autocomplete="off">
    </div>
    <div class="field">
      <label>Room ID <span style="color:var(--muted);font-weight:400;">(ç©ºç™½ã§ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ)</span></label>
      <div class="room-id-row">
        <input type="text" id="input-roomid" placeholder="ä¾‹: 48291" maxlength="5" pattern="[0-9]*" inputmode="numeric" autocomplete="off">
        <button class="gen-btn" onclick="fillRandomRoomId()">ğŸ² ç”Ÿæˆ</button>
      </div>
    </div>
    <div id="top-error" class="error-msg"></div>
    <button class="btn btn-primary" onclick="handleCreate()">â–¶ Create a Room</button>
    <div class="divider">ã¾ãŸã¯</div>
    <button class="btn btn-secondary" onclick="handleJoin()">â†’ Join the Room</button>
  </div>
</div>

<div id="screen-room" class="screen">
  <div class="top-nav">
    <button class="btn btn-ghost btn-small" onclick="leaveRoom()">ğŸ”™ é€€å®¤</button>
    <button class="btn btn-ghost btn-small" onclick="openSettings()">âš™ è¨­å®š</button>
  </div>
  
  <div class="game-topbar">
    <div class="game-room-id">ROOM <span id="game-room-id-display">â€”</span></div>
    <div id="mode-pill-display" class="mode-pill">â€”</div>
  </div>

  <div id="game-player-cards" class="player-cards"></div>

  <div id="my-action-panel" class="my-action-panel">
    <div class="action-row" id="score-buttons" style="display:none;">
      <button class="btn btn-green-solid" onclick="recordResult(true)">â­• æ­£è§£</button>
      <button class="btn btn-red-solid" onclick="recordResult(false)">âœ– èª¤ç­”</button>
    </div>
    <div id="undo-row" style="display:none; margin-bottom: 12px;">
      <button class="btn btn-ghost" id="btn-undo" onclick="undoResult()" style="color:var(--yellow); border-color:rgba(255,211,42,0.3); margin-bottom:0;">â†© ç›´å‰ã®å…¥åŠ›ã‚’å–ã‚Šæ¶ˆã™</button>
    </div>
    <button class="btn btn-ghost" id="btn-toggle-role" onclick="toggleMyRole()" style="margin-bottom:0;">
      ğŸ”„ è¦³æˆ¦è€…ï¼ˆãƒ›ã‚¹ãƒˆï¼‰ã«ãªã‚‹
    </button>
  </div>
</div>

<div id="screen-result" class="screen">
  <div class="top-nav">
    <button class="btn btn-ghost btn-small" onclick="leaveRoom()">ğŸ”™ ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</button>
  </div>
  <div class="logo" style="font-size:2rem; margin-bottom: 20px;">RESULT</div>
  <div id="podium-area" class="podium-wrap card"></div>
  <div class="card">
    <h3>æœ€çµ‚ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
    <div id="result-list" class="result-list"></div>
  </div>
</div>

<div id="settings-modal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close" onclick="closeSettings()">Ã—</button>
    <h2 style="margin-bottom: 20px;">ãƒ«ãƒ¼ãƒ è¨­å®š</h2>
    
    <div class="share-row" style="margin-top:0; margin-bottom: 20px;">
      <button class="share-btn" onclick="copyLink()">ğŸ”— URLã‚³ãƒ”ãƒ¼</button>
      <button class="share-btn" onclick="copyRoomId()">ğŸ“‹ IDã‚³ãƒ”ãƒ¼</button>
    </div>

    <div class="mode-tabs">
      <button class="mode-tab active" id="tab-survival" onclick="updateMode('survival')">mâ—¯nÃ—</button>
      <button class="mode-tab" id="tab-newyork" onclick="updateMode('newyork')">New York</button>
      <button class="mode-tab" id="tab-freecount" onclick="updateMode('freecount')">ãƒ•ãƒªãƒ</button>
    </div>

    <div id="panel-survival" class="settings-panel active">
      <div class="settings-desc">må•æ­£è§£ã§å‹ã¡æŠœã‘ãƒ»nå•èª¤ç­”ã§å¤±æ ¼ã€‚æ­£è§£ã—ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯è‡ªåˆ†ã§ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚</div>
      <div class="settings-grid">
        <div class="field">
          <label>mï¼ˆå‹ã¡æŠœã‘ï¼‰</label>
          <input type="number" id="set-m" value="3" min="1" max="99" onchange="updateSettings()">
        </div>
        <div class="field">
          <label>nï¼ˆå¤±æ ¼ï¼‰</label>
          <input type="number" id="set-n" value="2" min="1" max="99" onchange="updateSettings()">
        </div>
      </div>
    </div>

    <div id="panel-newyork" class="settings-panel">
      <div class="settings-desc">1å•æ­£è§£ã§ +x ãƒã‚¤ãƒ³ãƒˆãƒ»1å•èª¤ç­”ã§ âˆ’y ãƒã‚¤ãƒ³ãƒˆã€‚ãƒ›ã‚¹ãƒˆãŒã€Œçµ‚äº†ã€ã‚’æŠ¼ã—ãŸæ™‚ç‚¹ã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</div>
      <div class="settings-grid">
        <div class="field">
          <label>xï¼ˆæ­£è§£ptï¼‰</label>
          <input type="number" id="set-x" value="10" min="1" max="999" onchange="updateSettings()">
        </div>
        <div class="field">
          <label>yï¼ˆèª¤ç­”ãƒã‚¤ãƒŠã‚¹ï¼‰</label>
          <input type="number" id="set-y" value="5" min="0" max="999" onchange="updateSettings()">
        </div>
      </div>
    </div>

    <div id="panel-freecount" class="settings-panel">
      <div class="settings-desc">å‹ã¡æŠœã‘ãƒ»å¤±æ ¼ãªã—ã€‚æ­£è§£æ•°ã¨èª¤ç­”æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹ã ã‘ã€‚ãƒ•ãƒªãƒ¼ç·´ç¿’ã‚„æŒ¯ã‚Šè¿”ã‚Šã«ã€‚ãƒ›ã‚¹ãƒˆãŒã€Œçµ‚äº†ã€ã‚’æŠ¼ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æ­£è§£æ•°é †ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</div>
    </div>

    <hr style="border:0; border-top:1px solid var(--border); margin: 20px 0;">
    
    <button class="btn btn-ghost" onclick="resetPoints()" style="color:var(--yellow); border-color:rgba(255,211,42,0.3);">ğŸ”„ å…¨å“¡ã®ãƒã‚¤ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ</button>
    <button class="btn btn-secondary" onclick="endGame()" style="margin-bottom:0;">â¹ ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¦çµæœã‚’è¦‹ã‚‹</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey:            "AIzaSyA3xtGLVJwij2BTiiOk7DsNeF9hIOuZCyI",
  authDomain:        "q-room-fe8a6.firebaseapp.com",
  databaseURL:       "https://q-room-fe8a6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:         "q-room-fe8a6",
  storageBucket:     "q-room-fe8a6.firebasestorage.app",
  messagingSenderId: "151049149394",
  appId:             "1:151049149394:web:7a3ea6406454f6a87d460b"
};

let db;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
} catch(e) {
  document.getElementById('config-notice').classList.add('visible');
}

let myPlayerId    = null;
let currentRoomId = null;
let roomListener  = null;
let currentMode   = 'survival';
let gameSettings  = null;
let lastAction    = null;

window.addEventListener('DOMContentLoaded', async () => {
  await cleanupOldRooms();
  checkUrlParams();
});

function getOrCreatePlayerId() {
  let id = localStorage.getItem('qroom_pid');
  if (!id) {
    id = 'p_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
    localStorage.setItem('qroom_pid', id);
  }
  return id;
}

function randomRoomId() {
  return String(Math.floor(10000 + Math.random() * 90000));
}

function fillRandomRoomId() {
  document.getElementById('input-roomid').value = randomRoomId();
}

function showError(id, msg) {
  const el = document.getElementById(id);
  el.textContent = msg;
  el.style.display = 'block';
  setTimeout(() => { el.style.display = 'none'; }, 4000);
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id).classList.add('active');
  window.scrollTo(0, 0);
}

function avatarLetter(name) {
  return (name || '?')[0].toUpperCase();
}

function checkUrlParams() {
  const pathRoom = window.location.pathname.replace(/\//g, '');
  const params = new URLSearchParams(window.location.search);
  const rid = pathRoom || params.get('room');
  if (rid && /^\d{5}$/.test(rid)) {
    document.getElementById('input-roomid').value = rid;
  }
}

function selectModeUI(mode) {
  currentMode = mode;
  document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
  const tabEl = document.getElementById('tab-' + mode);
  if (tabEl) tabEl.classList.add('active');
  document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
  const panelEl = document.getElementById('panel-' + mode);
  if (panelEl) panelEl.classList.add('active');
}

async function updateMode(mode) {
  selectModeUI(mode);
  if (db && currentRoomId) {
    await db.ref(`rooms/${currentRoomId}/settings/mode`).set(mode);
  }
}

async function updateSettings() {
  if (!db || !currentRoomId) return;
  const m = parseInt(document.getElementById('set-m').value) || 3;
  const n = parseInt(document.getElementById('set-n').value) || 2;
  const x = parseInt(document.getElementById('set-x').value) || 10;
  const y = parseInt(document.getElementById('set-y').value) || 5;
  await db.ref(`rooms/${currentRoomId}/settings`).update({ m, n, x, y });
}

async function resetPoints() {
  if (!confirm("å…¨å“¡ã®ã‚¹ã‚³ã‚¢ã‚’0ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
  const playersSnap = await db.ref(`rooms/${currentRoomId}/players`).once('value');
  const players = playersSnap.val() || {};
  const updates = {};
  for(const pid in players) {
    updates[`${pid}/correct`] = 0;
    updates[`${pid}/wrong`] = 0;
    if(players[pid].status !== 'spectator') {
      updates[`${pid}/status`] = 'active';
    }
  }
  await db.ref(`rooms/${currentRoomId}/players`).update(updates);
  showToast('ãƒã‚¤ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
  closeSettings();
}

async function toggleMyRole() {
  if (!db || !currentRoomId || !myPlayerId) return;
  const myRef = db.ref(`rooms/${currentRoomId}/players/${myPlayerId}/status`);
  const snap = await myRef.once('value');
  const currentStatus = snap.val();
  const nextStatus = currentStatus === 'spectator' ? 'active' : 'spectator';
  await myRef.set(nextStatus);
}

function setupPresence() {
  if (!db || !currentRoomId || !myPlayerId) return;
  const myRef = db.ref(`rooms/${currentRoomId}/players/${myPlayerId}`);
  myRef.child('online').set(true);
  myRef.child('lastActive').set(firebase.database.ServerValue.TIMESTAMP);
  myRef.child('online').onDisconnect().set(false);
  myRef.child('lastActive').onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
}

async function cleanupOldRooms() {
  if(!db) return;
  try {
    const snap = await db.ref('rooms').once('value');
    const rooms = snap.val() || {};
    const now = Date.now();
    for (const [rid, room] of Object.entries(rooms)) {
      const players = room.players || {};
      const hasOnline = Object.values(players).some(p => p.online);
      if (!hasOnline) {
        let lastActive = room.createdAt || 0;
        for (const p of Object.values(players)) {
          if (p.lastActive > lastActive) lastActive = p.lastActive;
        }
        if (now - lastActive > 5 * 60 * 1000) {
          await db.ref('rooms/' + rid).remove();
        }
      }
    }
  } catch(e) {
    console.warn("Cleanup error", e);
  }
}

async function handleCreate() {
  if (!db) { showToast('Firebase æœªè¨­å®šã§ã™'); return; }
  await cleanupOldRooms();
  const name = document.getElementById('input-name').value.trim();
  const ridInput = document.getElementById('input-roomid').value.trim();

  if (!name) { showError('top-error', 'åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  let roomId = ridInput || randomRoomId();
  if (roomId.length !== 5 || !/^\d+$/.test(roomId)) {
    showError('top-error', 'Room IDã¯5æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„'); return;
  }

  const snap = await db.ref('rooms/' + roomId).once('value');
  if (snap.exists()) {
    showError('top-error', 'ãã®Room IDã¯ã™ã§ã«ä½¿ç”¨ä¸­ã§ã™ã€‚åˆ¥ã®IDã‚’è©¦ã—ã¦ãã ã•ã„');
    return;
  }

  myPlayerId = getOrCreatePlayerId();
  currentRoomId = roomId;

  const roomData = {
    hostId:    myPlayerId,
    status:    'playing',
    createdAt: firebase.database.ServerValue.TIMESTAMP,
    settings:  { mode: 'survival', m: 3, n: 2, x: 10, y: 5 },
    players: {
      [myPlayerId]: {
        name:      name,
        correct:   0,
        wrong:     0,
        status:    'active',
        joinedAt:  firebase.database.ServerValue.TIMESTAMP,
        online:    true,
        lastActive: firebase.database.ServerValue.TIMESTAMP
      }
    }
  };

  await db.ref('rooms/' + roomId).set(roomData);
  setupPresence();
  updateUrl(roomId);
  enterRoom(roomId);
}

async function handleJoin() {
  if (!db) { showToast('Firebase æœªè¨­å®šã§ã™'); return; }
  await cleanupOldRooms();
  const name   = document.getElementById('input-name').value.trim();
  const roomId = document.getElementById('input-roomid').value.trim();

  if (!name)   { showError('top-error', 'åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!roomId) { showError('top-error', 'Room IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (roomId.length !== 5 || !/^\d+$/.test(roomId)) {
    showError('top-error', 'Room IDã¯5æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„'); return;
  }

  const snap = await db.ref('rooms/' + roomId).once('value');
  if (!snap.exists()) {
    showError('top-error', 'Room ID ' + roomId + ' ã®éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }

  const room = snap.val();
  myPlayerId = getOrCreatePlayerId();

  const existingPlayer = room.players && room.players[myPlayerId];
  if (!existingPlayer) {
    await db.ref('rooms/' + roomId + '/players/' + myPlayerId).set({
      name:     name,
      correct:  0,
      wrong:    0,
      status:   'active',
      joinedAt: firebase.database.ServerValue.TIMESTAMP,
      online:   true,
      lastActive: firebase.database.ServerValue.TIMESTAMP
    });
  } else {
    await db.ref(`rooms/${roomId}/players/${myPlayerId}`).update({
      online: true,
      lastActive: firebase.database.ServerValue.TIMESTAMP
    });
  }

  currentRoomId = roomId;
  setupPresence();
  updateUrl(roomId);

  if (room.status === 'finished') {
    enterResultScreen(room);
  } else {
    enterRoom(roomId);
  }
}

function updateUrl(roomId) {
  const url = window.location.origin + '/' + roomId;
  window.history.replaceState({}, '', url);
}

function getRoomUrl() {
  return window.location.origin + '/' + currentRoomId;
}

function copyLink() {
  navigator.clipboard.writeText(getRoomUrl()).then(() => showToast('ğŸ”— ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
}

function copyRoomId() {
  navigator.clipboard.writeText(currentRoomId).then(() => showToast('ğŸ“‹ Room ID ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
}

async function leaveRoom() {
  if(confirm("ãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å®¤ã—ã¦ãƒˆãƒƒãƒ—ç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")) {
    if (db && currentRoomId && myPlayerId) {
      await db.ref(`rooms/${currentRoomId}/players/${myPlayerId}`).remove();
    }
    backToTop();
  }
}

function openSettings() {
  document.getElementById('settings-modal').classList.add('active');
}

function closeSettings() {
  document.getElementById('settings-modal').classList.remove('active');
}

function enterRoom(roomId) {
  showScreen('room');
  document.getElementById('game-room-id-display').textContent = roomId;

  if (roomListener) roomListener();
  roomListener = db.ref('rooms/' + roomId).on('value', snap => {
    const data = snap.val();
    if (!data) { showToast('ãƒ«ãƒ¼ãƒ ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ'); backToTop(); return; }
    if (data.status === 'finished') { enterResultScreen(data); return; }
    
    gameSettings = data.settings;
    if (data.settings) {
      if (document.activeElement !== document.getElementById('set-m')) document.getElementById('set-m').value = data.settings.m;
      if (document.activeElement !== document.getElementById('set-n')) document.getElementById('set-n').value = data.settings.n;
      if (document.activeElement !== document.getElementById('set-x')) document.getElementById('set-x').value = data.settings.x;
      if (document.activeElement !== document.getElementById('set-y')) document.getElementById('set-y').value = data.settings.y;
      if (currentMode !== data.settings.mode) selectModeUI(data.settings.mode);
    }
    
    renderGameScreen(data);
  });
}

function renderGameScreen(data) {
  const settings = data.settings || {};
  const players  = data.players  || {};
  const sorted   = sortPlayers(players, settings);

  const modeLabel = settings.mode === 'survival'
    ? `mâ—¯nÃ—  (${settings.m}â—‹ / ${settings.n}Ã—)`
    : settings.mode === 'newyork'
    ? `NewYork  (+${settings.x} / -${settings.y})`
    : 'ãƒ•ãƒªãƒ';  document.getElementById('mode-pill-display').textContent = modeLabel;

  const cardsEl = document.getElementById('game-player-cards');
  cardsEl.innerHTML = sorted.map(([pid, p]) => {
    const isMe     = pid === myPlayerId;
    const isSpec   = p.status === 'spectator';
    const statusCls = p.status === 'winner' ? 'pcard-winner' : p.status === 'eliminated' ? 'pcard-eliminated' : isSpec ? 'pcard-spectator' : '';
    const statusLabel = p.status === 'winner' ? 'WINNER ğŸ†' : p.status === 'eliminated' ? 'ELIMINATED' : isSpec ? 'SPECTATOR' : 'ACTIVE';
    const statusPillCls = p.status === 'winner' ? 's-winner' : p.status === 'eliminated' ? 's-eliminated' : isSpec ? 's-spectator' : 's-active';

    let scoreHtml = '';
    if (!isSpec) {
      if (settings.mode === 'survival') {
        scoreHtml = `
          <div class="pcard-stats">
            <div class="stat-box"><span class="stat-icon">â­•</span><span class="stat-val correct">${p.correct}</span></div>
            <div class="stat-box"><span class="stat-icon">âœ–</span><span class="stat-val wrong">${p.wrong}</span></div>
          </div>`;
      } else if (settings.mode === 'newyork') {
        const score = (p.correct * settings.x) - (p.wrong * settings.y);
        scoreHtml = `
          <div class="pcard-stats">
            <div class="stat-box"><span class="stat-icon">â­•</span><span class="stat-val correct">${p.correct}</span></div>
            <div class="stat-box"><span class="stat-icon">âœ–</span><span class="stat-val wrong">${p.wrong}</span></div>
            <div class="score-large">${score >= 0 ? '+' : ''}${score}</div>
          </div>`;
      } else {
        scoreHtml = `
          <div class="pcard-stats">
            <div class="stat-box"><span class="stat-icon">â­•</span><span class="stat-val correct">${p.correct}</span></div>
            <div class="stat-box"><span class="stat-icon">âœ–</span><span class="stat-val wrong">${p.wrong}</span></div>
          </div>`;
      }
    }

    return `
      <div class="pcard ${isMe ? 'pcard-me' : ''} ${statusCls}">
        <div class="pcard-top">
          <div class="player-avatar" style="width:30px;height:30px;font-size:0.8rem;${isSpec ? 'filter:grayscale(1); opacity:0.5;' : ''}">${avatarLetter(p.name)}</div>
          <span class="pcard-name">${escHtml(p.name)}</span>
          <span class="pcard-status ${statusPillCls}">${statusLabel}</span>
        </div>
        ${scoreHtml}
      </div>`;
  }).join('');

  const myPlayer = players[myPlayerId];
  if (myPlayer) {
    const isSpec = myPlayer.status === 'spectator';
    document.getElementById('score-buttons').style.display = isSpec ? 'none' : 'flex';
    document.getElementById('undo-row').style.display = (!isSpec && lastAction !== null) ? 'block' : 'none';
    document.getElementById('btn-toggle-role').innerHTML = isSpec ? 'ğŸ® ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå›ç­”è€…ï¼‰ã«ãªã‚‹' : 'ğŸ‘€ è¦³æˆ¦è€…ï¼ˆãƒ›ã‚¹ãƒˆï¼‰ã«ãªã‚‹';
  }
}

function sortPlayers(players, settings) {
  return Object.entries(players).sort((a, b) => {
    const [, pa] = a, [, pb] = b;
    const rank = s => s === 'winner' ? 0 : s === 'active' ? 1 : s === 'eliminated' ? 2 : 3;
    if (settings.mode === 'freecount') {
      if (rank(pa.status) !== rank(pb.status)) return rank(pa.status) - rank(pb.status);
      return pb.correct - pa.correct;
    }
    if (rank(pa.status) !== rank(pb.status)) return rank(pa.status) - rank(pb.status);
    if (settings.mode === 'newyork') {
      const sa = (pa.correct * settings.x) - (pa.wrong * settings.y);
      const sb = (pb.correct * settings.x) - (pb.wrong * settings.y);
      return sb - sa;
    }
    return pb.correct - pa.correct;
  });
}

async function recordResult(isCorrect) {
  if (!db || !currentRoomId || !myPlayerId) return;

  const playerRef = db.ref('rooms/' + currentRoomId + '/players/' + myPlayerId);
  const snap = await playerRef.once('value');
  const p = snap.val();
  if (!p || p.status === 'spectator') return;

  const settings = gameSettings || {};
  const newCorrect = p.correct + (isCorrect ? 1 : 0);
  const newWrong   = p.wrong   + (isCorrect ? 0 : 1);
  let   newStatus  = 'active';

  if (settings.mode === 'survival') {
    if (newCorrect >= settings.m) { newStatus = 'winner'; showToast('ğŸ† å‹ã¡æŠœã‘ãŠã‚ã§ã¨ã†ï¼'); }
    else if (newWrong >= settings.n) { newStatus = 'eliminated'; showToast('ğŸ’€ å¤±æ ¼...'); }
  }

  await playerRef.update({ correct: newCorrect, wrong: newWrong, status: newStatus });

  lastAction = { wasCorrect: isCorrect, prevStatus: p.status };
  document.getElementById('undo-row').style.display = 'block';
}

async function undoResult() {
  if (!db || !currentRoomId || !myPlayerId || lastAction === null) return;

  const playerRef = db.ref('rooms/' + currentRoomId + '/players/' + myPlayerId);
  const snap = await playerRef.once('value');
  const p = snap.val();
  if (!p) return;

  const newCorrect = Math.max(0, p.correct - (lastAction.wasCorrect ? 1 : 0));
  const newWrong   = Math.max(0, p.wrong   - (lastAction.wasCorrect ? 0 : 1));

  await playerRef.update({
    correct: newCorrect,
    wrong:   newWrong,
    status:  lastAction.prevStatus
  });

  lastAction = null;
  document.getElementById('undo-row').style.display = 'none';
  showToast('â†© ç›´å‰ã®å…¥åŠ›ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ');
}


  if(confirm("ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¦çµæœã‚’è¡¨ç¤ºã—ã¾ã™ã‹ï¼Ÿ")) {
    await db.ref('rooms/' + currentRoomId + '/status').set('finished');
    closeSettings();
  }
}

function enterResultScreen(data) {
  if (roomListener) { db.ref('rooms/' + currentRoomId).off('value', roomListener); roomListener = null; }
  showScreen('result');
  const settings = data.settings || {};
  const players  = data.players  || {};
  const sorted   = buildResultRanking(players, settings).filter(([, p]) => p.status !== 'spectator');

  const winner = sorted[0];
  const podiumEl = document.getElementById('podium-area');
  if (winner) {
    podiumEl.innerHTML = `
      <div class="podium-emoji">ğŸ†</div>
      <div class="podium-name">${escHtml(winner[1].name)}</div>
      <div class="podium-sub">${settings.mode === 'survival' ? 'å‹ã¡æŠœã‘é”æˆï¼' : settings.mode === 'newyork' ? 'ãƒˆãƒƒãƒ—ã‚¹ã‚³ã‚¢ï¼' : 'æœ€å¤šæ­£è§£ï¼'}</div>`;
  } else {
    podiumEl.innerHTML = '';
  }

  const listEl = document.getElementById('result-list');
  listEl.innerHTML = sorted.map(([pid, p], i) => {
    const rank  = i + 1;
    const rankCls = rank <= 3 ? 'r' + rank : '';
    let scoreStr = '';
    if (settings.mode === 'newyork') {
      const sc = (p.correct * settings.x) - (p.wrong * settings.y);
      scoreStr = `<span class="result-score">${sc >= 0 ? '+' : ''}${sc}pt</span>`;
    } else if (settings.mode === 'freecount') {
      scoreStr = `<span class="result-score">${p.correct}â—‹</span>`;
    } else {
      scoreStr = `<span class="result-score">${p.status === 'winner' ? 'âœ… WIN' : p.status === 'eliminated' ? 'âŒ OUT' : 'â€”'}</span>`;
    }
    return `
      <div class="result-item">
        <div class="result-rank ${rankCls}">${rank}</div>
        <div class="result-name">${escHtml(p.name)}${pid === myPlayerId ? ' <span style="color:var(--cyan);font-size:0.75rem;">(You)</span>' : ''}</div>
        <div class="result-stats">${p.correct}â—‹ ${p.wrong}Ã—</div>
        ${scoreStr}
      </div>`;
  }).join('');
}

function buildResultRanking(players, settings) {
  return Object.entries(players).sort((a, b) => {
    const [, pa] = a, [, pb] = b;
    if (settings.mode === 'newyork') {
      const sa = (pa.correct * settings.x) - (pa.wrong * settings.y);
      const sb = (pb.correct * settings.x) - (pb.wrong * settings.y);
      return sb - sa;
    }
    if (settings.mode === 'freecount') {
      if (pb.correct !== pa.correct) return pb.correct - pa.correct;
      return pa.wrong - pb.wrong;
    }
    const rank = s => s === 'winner' ? 0 : s === 'active' ? 1 : s === 'eliminated' ? 2 : 3;
    if (rank(pa.status) !== rank(pb.status)) return rank(pa.status) - rank(pb.status);
    return pb.correct - pa.correct;
  });
}

function backToTop() {
  if (roomListener && currentRoomId) {
    db.ref('rooms/' + currentRoomId).off('value', roomListener);
    roomListener = null;
  }
  if (db && currentRoomId && myPlayerId) {
    const myRef = db.ref(`rooms/${currentRoomId}/players/${myPlayerId}`);
    myRef.child('online').onDisconnect().cancel();
    myRef.child('lastActive').onDisconnect().cancel();
  }
  currentRoomId = null;
  gameSettings = null;
  lastAction = null;
  window.history.replaceState({}, '', '/');
  showScreen('top');
}

function escHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

document.getElementById('input-roomid').addEventListener('keydown', e => {
  if (e.key === 'Enter') handleJoin();
});
document.getElementById('input-name').addEventListener('keydown', e => {
  if (e.key === 'Enter') document.getElementById('input-roomid').focus();
});
</script>
</body>
</html>
