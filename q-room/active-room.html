<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Q-Room | Active Rooms</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #09090b;
  --surface: rgba(24,24,27,0.75);
  --border: rgba(255,255,255,0.1);
  --cyan: #06b6d4;
  --magenta: #e11d48;
  --green: #10b981;
  --red: #ef4444;
  --yellow: #f59e0b;
  --text: #f4f4f5;
  --muted: #a1a1aa;
  --en: 'Inter', sans-serif;
  --ja: 'Noto Sans JP', sans-serif;
  --mono: 'JetBrains Mono', monospace;
}
html, body {
  min-height: 100vh;
  background-color: var(--bg);
  background-image:
    radial-gradient(circle at 15% 20%, rgba(6,182,212,0.07) 0%, transparent 45%),
    radial-gradient(circle at 85% 80%, rgba(225,29,72,0.07) 0%, transparent 45%);
  color: var(--text);
  font-family: var(--ja);
}
.container {
  max-width: 860px;
  margin: 0 auto;
  padding: 40px 24px 80px;
}

/* â”€â”€ HEADER â”€â”€ */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 40px;
  gap: 16px;
  flex-wrap: wrap;
}
.logo-wrap { display: flex; align-items: baseline; gap: 12px; }
.logo {
  font-family: var(--en); font-size: 2rem; font-weight: 900;
  background: linear-gradient(135deg, #fff, var(--cyan));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  letter-spacing: 0.08em;
  filter: drop-shadow(0 4px 16px rgba(6,182,212,0.4));
}
.logo-tag {
  font-family: var(--mono); font-size: 0.75rem; color: var(--muted);
  background: rgba(255,255,255,0.06); border: 1px solid var(--border);
  border-radius: 6px; padding: 4px 10px; letter-spacing: 0.15em;
}
.status-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
.dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--green); box-shadow: 0 0 8px var(--green);
  animation: pulse 2s ease-in-out infinite; flex-shrink: 0;
}
.dot.offline { background: var(--red); box-shadow: 0 0 8px var(--red); animation: none; }
@keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }
.status-text { font-family: var(--mono); font-size: 0.8rem; color: var(--muted); letter-spacing: 0.1em; }
.countdown-text { font-family: var(--mono); font-size: 0.8rem; color: var(--muted); }

/* â”€â”€ SUMMARY BAR â”€â”€ */
.summary-bar {
  display: flex; gap: 16px; margin-bottom: 28px; flex-wrap: wrap;
}
.summary-chip {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; padding: 12px 20px;
  display: flex; flex-direction: column; gap: 4px;
  backdrop-filter: blur(16px);
  flex: 1; min-width: 120px;
}
.chip-label { font-family: var(--en); font-size: 0.68rem; font-weight: 700; color: var(--muted); letter-spacing: 0.18em; text-transform: uppercase; }
.chip-val { font-family: var(--en); font-size: 1.6rem; font-weight: 900; line-height: 1; }

/* â”€â”€ ROOM CARDS â”€â”€ */
.rooms-list { display: flex; flex-direction: column; gap: 16px; }

.room-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  backdrop-filter: blur(24px);
  overflow: hidden;
  transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
  animation: fadeUp 0.5s cubic-bezier(0.16,1,0.3,1) both;
}
@keyframes fadeUp { from { opacity:0; transform: translateY(12px); } to { opacity:1; transform: translateY(0); } }
.room-card:hover { transform: translateY(-3px); box-shadow: 0 12px 32px rgba(0,0,0,0.4); border-color: rgba(255,255,255,0.18); }
.room-card.finished { opacity: 0.5; filter: grayscale(60%); }

.room-card-header {
  display: flex; align-items: center; gap: 14px;
  padding: 20px 24px 16px;
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap; gap: 10px;
}
.room-id-wrap { display: flex; align-items: center; gap: 10px; flex: 1; }
.live-dot {
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--green); box-shadow: 0 0 6px var(--green);
  animation: pulse 2s ease-in-out infinite; flex-shrink: 0;
}
.live-dot.fin { background: var(--muted); box-shadow: none; animation: none; }
.room-id-label { font-family: var(--mono); font-size: 0.7rem; color: var(--muted); letter-spacing: 0.15em; }
.room-id-val { font-family: var(--mono); font-size: 1.4rem; font-weight: 700; color: var(--cyan); letter-spacing: 0.12em; }

.copy-btn {
  background: rgba(6,182,212,0.1); border: 1px solid rgba(6,182,212,0.3);
  border-radius: 10px; padding: 7px 14px;
  font-family: var(--mono); font-size: 0.72rem; font-weight: 700;
  color: var(--cyan); cursor: pointer; transition: 0.25s;
  letter-spacing: 0.08em; white-space: nowrap; flex-shrink: 0;
}
.copy-btn:hover { background: rgba(6,182,212,0.2); border-color: var(--cyan); transform: translateY(-1px); }
.copy-btn.copied { background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.5); color: var(--green); }

.join-btn {
  background: linear-gradient(135deg, var(--cyan), #0284c7);
  border: none; border-radius: 10px; padding: 7px 16px;
  font-family: var(--mono); font-size: 0.72rem; font-weight: 700;
  color: #fff; cursor: pointer; transition: 0.25s;
  letter-spacing: 0.08em; white-space: nowrap; flex-shrink: 0;
  box-shadow: 0 4px 12px rgba(6,182,212,0.3);
}
.join-btn:hover { box-shadow: 0 6px 18px rgba(6,182,212,0.45); transform: translateY(-1px); }

.peek-btn {
  background: rgba(225,29,72,0.1); border: 1px solid rgba(225,29,72,0.3);
  border-radius: 10px; padding: 7px 14px;
  font-family: var(--mono); font-size: 0.72rem; font-weight: 700;
  color: #fb7185; cursor: pointer; transition: 0.25s;
  letter-spacing: 0.08em; white-space: nowrap; flex-shrink: 0;
}
.peek-btn:hover { background: rgba(225,29,72,0.2); border-color: var(--magenta); transform: translateY(-1px); }

/* â”€â”€ PASSWORD MODAL â”€â”€ */
.pw-modal-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
  z-index: 2000; align-items: center; justify-content: center;
}
.pw-modal-overlay.show { display: flex; }
.pw-modal {
  background: #18181b; border: 1px solid rgba(225,29,72,0.4);
  border-radius: 20px; padding: 32px 28px; width: 100%; max-width: 360px;
  box-shadow: 0 24px 64px rgba(0,0,0,0.6);
  animation: fadeUp 0.3s cubic-bezier(0.16,1,0.3,1) both;
}
.pw-modal-title {
  font-family: var(--en); font-size: 0.78rem; font-weight: 700;
  color: #fb7185; letter-spacing: 0.2em; text-transform: uppercase;
  margin-bottom: 6px;
}
.pw-modal-sub {
  font-family: var(--mono); font-size: 0.75rem; color: var(--muted);
  margin-bottom: 20px; line-height: 1.6;
}
.pw-modal-rid {
  font-family: var(--mono); font-size: 1.1rem; font-weight: 700;
  color: var(--cyan); margin-bottom: 20px;
}
.pw-input {
  width: 100%; background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.15); border-radius: 10px;
  padding: 12px 14px; font-family: var(--mono); font-size: 0.9rem;
  color: var(--text); outline: none; transition: 0.25s;
  margin-bottom: 8px;
}
.pw-input:focus { border-color: rgba(225,29,72,0.5); box-shadow: 0 0 0 3px rgba(225,29,72,0.1); }
.pw-error {
  font-family: var(--mono); font-size: 0.75rem; color: var(--red);
  min-height: 1.2em; margin-bottom: 16px; padding-left: 2px;
}
.pw-modal-btns { display: flex; gap: 10px; }
.pw-submit-btn {
  flex: 1; background: linear-gradient(135deg, var(--magenta), #be185d);
  border: none; border-radius: 10px; padding: 10px 0;
  font-family: var(--mono); font-size: 0.8rem; font-weight: 700;
  color: #fff; cursor: pointer; transition: 0.25s; letter-spacing: 0.08em;
  box-shadow: 0 4px 12px rgba(225,29,72,0.3);
}
.pw-submit-btn:hover { box-shadow: 0 6px 18px rgba(225,29,72,0.45); transform: translateY(-1px); }
.pw-cancel-btn {
  background: rgba(255,255,255,0.05); border: 1px solid var(--border);
  border-radius: 10px; padding: 10px 18px;
  font-family: var(--mono); font-size: 0.8rem; font-weight: 700;
  color: var(--muted); cursor: pointer; transition: 0.25s;
}
.pw-cancel-btn:hover { background: rgba(255,255,255,0.1); color: var(--text); }

.rule-badge {
  font-size: 0.72rem; padding: 5px 12px; border-radius: 8px;
  background: rgba(225,29,72,0.15); border: 1px solid rgba(225,29,72,0.3);
  color: #fb7185; font-weight: 700; font-family: var(--en); letter-spacing: 0.05em;
  white-space: nowrap;
}

/* â”€â”€ ROOM META ROW â”€â”€ */
.room-meta {
  display: flex; gap: 24px; padding: 12px 24px;
  border-bottom: 1px solid var(--border);
  font-family: var(--mono); font-size: 0.75rem; color: var(--muted);
  flex-wrap: wrap; gap: 16px;
}
.meta-item { display: flex; align-items: center; gap: 6px; }
.meta-item svg { width: 13px; height: 13px; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; flex-shrink: 0; }
.meta-item span { color: var(--text); font-weight: 700; }

/* â”€â”€ PLAYER LIST â”€â”€ */
.players-wrap { padding: 14px 24px 20px; }
.players-title {
  font-family: var(--en); font-size: 0.68rem; font-weight: 700;
  color: var(--muted); letter-spacing: 0.2em; text-transform: uppercase;
  margin-bottom: 12px;
}
.players-grid {
  display: flex; flex-wrap: wrap; gap: 8px;
}
.player-chip {
  display: flex; align-items: center; gap: 7px;
  background: rgba(255,255,255,0.05); border: 1px solid var(--border);
  border-radius: 10px; padding: 7px 13px;
  font-size: 0.85rem; transition: 0.2s;
}
.player-chip:hover { border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); }
.player-chip.st-active { border-color: rgba(6,182,212,0.3); }
.player-chip.st-win { border-color: rgba(16,185,129,0.4); background: rgba(16,185,129,0.07); }
.player-chip.st-lose { opacity: 0.45; filter: grayscale(80%); }
.player-chip.st-spec { opacity: 0.5; border-style: dashed; }
.player-avatar {
  width: 22px; height: 22px; border-radius: 50%; font-size: 0.7rem; font-weight: 700;
  display: flex; align-items: center; justify-content: center;
  background: rgba(6,182,212,0.2); color: var(--cyan); flex-shrink: 0;
  font-family: var(--en);
}
.player-avatar.win { background: rgba(16,185,129,0.2); color: var(--green); }
.player-name { font-weight: 700; font-size: 0.88rem; }
.player-score { font-family: var(--mono); font-size: 0.78rem; color: var(--muted); margin-left: 2px; }
.player-sc-val { color: var(--cyan); font-weight: 700; }
.player-sc-val.win { color: var(--green); }

/* â”€â”€ EMPTY / ERROR â”€â”€ */
.empty {
  text-align: center; padding: 80px 24px;
  font-family: var(--mono); color: var(--muted);
}
.empty-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; }
.empty-text { font-size: 0.85rem; letter-spacing: 0.1em; }

.error-box {
  background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.4);
  border-radius: 14px; padding: 20px 24px; margin-bottom: 24px;
  display: none;
}
.error-title { font-family: var(--en); font-size: 0.78rem; font-weight: 700; color: var(--red); letter-spacing: 0.15em; margin-bottom: 8px; }
.error-msg { font-family: var(--mono); font-size: 0.8rem; color: #fca5a5; line-height: 1.7; }

/* â”€â”€ SECTION TITLE â”€â”€ */
.section-title {
  font-family: var(--en); font-size: 0.78rem; font-weight: 700;
  color: var(--muted); letter-spacing: 0.2em; text-transform: uppercase;
  margin-bottom: 18px; display: flex; align-items: center; gap: 10px;
}
.section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.section-count {
  font-family: var(--mono); font-size: 0.8rem; color: var(--cyan);
  background: rgba(6,182,212,0.1); border: 1px solid rgba(6,182,212,0.25);
  border-radius: 8px; padding: 3px 10px;
}

/* â”€â”€ FINISHED SECTION â”€â”€ */
.finished-toggle {
  background: none; border: 1px solid var(--border); border-radius: 12px;
  color: var(--muted); font-family: var(--mono); font-size: 0.75rem;
  padding: 9px 18px; cursor: pointer; transition: 0.25s; letter-spacing: 0.08em;
  margin-bottom: 20px;
}
.finished-toggle:hover { border-color: rgba(255,255,255,0.25); color: var(--text); }

/* â”€â”€ FOOTER â”€â”€ */
.footer {
  text-align: center; margin-top: 48px;
  font-family: var(--mono); font-size: 0.7rem;
  color: rgba(255,255,255,0.18); letter-spacing: 0.1em; line-height: 2;
}
.footer a { color: var(--cyan); text-decoration: none; }
.footer a:hover { text-decoration: underline; }

.loading-shimmer { opacity: 0.35; animation: blink 1.2s ease-in-out infinite; }
@keyframes blink { 0%,100%{opacity:0.35;} 50%{opacity:0.7;} }

@media (max-width: 540px) {
  .container { padding: 24px 14px 60px; }
  .room-card-header { flex-wrap: wrap; }
  .room-id-val { font-size: 1.2rem; }
}
</style>
</head>
<body>
<div class="container">

  <div class="header">
    <div class="logo-wrap">
      <div class="logo">Q-ROOM</div>
      <div class="logo-tag">ACTIVE ROOMS</div>
    </div>
    <div class="status-row">
      <div class="dot" id="dot"></div>
      <div class="status-text" id="status-text">CONNECTING...</div>
      <div class="countdown-text" id="countdown-text"></div>
    </div>
  </div>

  <div class="error-box" id="error-box">
    <div class="error-title">âŒ ERROR</div>
    <div class="error-msg" id="error-msg"></div>
  </div>

  <div class="summary-bar">
    <div class="summary-chip">
      <div class="chip-label">Active Rooms</div>
      <div class="chip-val loading-shimmer" id="chip-rooms" style="color:var(--cyan)">â€”</div>
    </div>
    <div class="summary-chip">
      <div class="chip-label">Players Online</div>
      <div class="chip-val loading-shimmer" id="chip-players" style="color:var(--green)">â€”</div>
    </div>
    <div class="summary-chip">
      <div class="chip-label">Last Updated</div>
      <div class="chip-val" id="chip-time" style="color:var(--muted);font-size:1rem;padding-top:4px;letter-spacing:0.05em">â€”:â€”:â€”</div>
    </div>
  </div>

  <div class="section-title">
    PLAYING
    <span class="section-count" id="playing-count">0</span>
    <span style="flex:1;height:1px;background:var(--border);display:block"></span>
  </div>
  <div class="rooms-list" id="rooms-active">
    <div class="empty"><div class="empty-icon">ğŸ®</div><div class="empty-text loading-shimmer">èª­ã¿è¾¼ã¿ä¸­...</div></div>
  </div>

  <div style="margin-top:32px;">
    <button class="finished-toggle" id="fin-toggle" onclick="toggleFinished()">â–¶ çµ‚äº†æ¸ˆã¿ãƒ«ãƒ¼ãƒ ã‚’è¡¨ç¤º</button>
    <div class="rooms-list" id="rooms-finished" style="display:none"></div>
  </div>

  <div class="footer">
    Q-Room Active Rooms &nbsp;Â·&nbsp; 60ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°<br>
    <a href="https://astro-root.com/q-room/" target="_blank">Q-Roomã§éŠã¶</a>
    &nbsp;Â·&nbsp;
    <a href="https://console.firebase.google.com/project/q-room-fe8a6/database" target="_blank">Firebase Console</a>
  </div>

</div>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyA3xtGLVJwij2BTiiOk7DsNeF9hIOuZCyI",
  authDomain: "q-room-fe8a6.firebaseapp.com",
  databaseURL: "https://q-room-fe8a6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "q-room-fe8a6",
  storageBucket: "q-room-fe8a6.firebasestorage.app",
  messagingSenderId: "151049149394",
  appId: "1:151049149394:web:7a3ea6406454f6a87d460b"
};

const ADMIN_HASH = '1f05d74edef006760f3b1f964820887e991f266be0015dcef0dd41b85eb7e8e9';

const RULE_LABELS = {
  survival:'ã‚µãƒã‚¤ãƒãƒ«', free:'ãƒ•ãƒªãƒ¼', newyork:'New York', rentou:'é€£ç­”',
  updown:'UpDown', by:'BY', freeze:'ãƒ•ãƒªãƒ¼ã‚º', m_n_rest:'MNä¼‘æ†©',
  swedish:'ã‚¹ã‚¦ã‚§ãƒ¼ãƒ‡ãƒ³', ren_wrong:'é€£ç¶šä¸æ­£è§£', divide:'åˆ†é…',
  combo:'ã‚³ãƒ³ãƒœ', attack_surv:'æ”»æ’ƒã‚µãƒã‚¤ãƒãƒ«', lucky:'ãƒ©ãƒƒã‚­ãƒ¼',
  spiral:'ã‚¹ãƒ‘ã‚¤ãƒ©ãƒ«', time_race:'ã‚¿ã‚¤ãƒ ãƒ¬ãƒ¼ã‚¹'
};

const QROOM_BASE = 'https://astro-root.com/q-room/';

let db = null;
let countdownSec = 60;
let countdownTimer = null;
let finishedVisible = false;
let isAdmin = false;
let peekListener = null;
let peekRid = null;

function initFB() {
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  db.ref('.info/connected').on('value', snap => {
    const ok = snap.val() === true;
    document.getElementById('dot').className = 'dot' + (ok ? '' : ' offline');
    document.getElementById('status-text').textContent = ok ? 'LIVE' : 'OFFLINE';
  });
}

function formatTime(ts) {
  if (!ts) return 'â€”';
  const d = new Date(ts);
  return String(d.getHours()).padStart(2,'0') + ':' +
         String(d.getMinutes()).padStart(2,'0') + ':' +
         String(d.getSeconds()).padStart(2,'0');
}

function timeAgo(ts) {
  if (!ts) return 'â€”';
  const sec = Math.floor((Date.now() - ts) / 1000);
  if (sec < 60) return sec + 'ç§’å‰';
  if (sec < 3600) return Math.floor(sec / 60) + 'åˆ†å‰';
  return Math.floor(sec / 3600) + 'æ™‚é–“å‰';
}

function copyRoomId(rid, btn) {
  navigator.clipboard.writeText(rid).then(() => {
    btn.textContent = 'âœ“ COPIED';
    btn.classList.add('copied');
    setTimeout(() => {
      btn.textContent = 'COPY ID';
      btn.classList.remove('copied');
    }, 2000);
  }).catch(() => {
    btn.textContent = 'âœ“ COPIED';
    btn.classList.add('copied');
    setTimeout(() => {
      btn.textContent = 'COPY ID';
      btn.classList.remove('copied');
    }, 2000);
  });
}

function getPlayerStatusClass(st) {
  if (st === 'win') return 'st-win';
  if (st === 'lose') return 'st-lose';
  if (st === 'spectator') return 'st-spec';
  return 'st-active';
}

function buildRoomCard(rid, room, idx) {
  const players = room.players || {};
  const playerList = Object.values(players);
  const activePlayers = playerList.filter(p => p.st === 'active');
  const isFinished = room.status === 'finished' || playerList.length === 0;
  const ruleName = RULE_LABELS[room.rule] || room.rule || '?';
  const createdAt = room.createdAt || room.lastActiveAt || null;
  const lastActive = room.lastActiveAt || room.createdAt || null;

  const avatarChar = (name) => name ? name.charAt(0).toUpperCase() : '?';

  const playersHtml = playerList.length === 0
    ? '<div style="font-family:var(--mono);font-size:0.78rem;color:var(--muted);">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãªã—</div>'
    : playerList.map(p => {
        const sc = p.sc !== undefined ? p.sc : 0;
        const stClass = getPlayerStatusClass(p.st);
        const isWin = p.st === 'win';
        return `
        <div class="player-chip ${stClass}">
          <div class="player-avatar ${isWin ? 'win' : ''}">${avatarChar(p.name)}</div>
          <span class="player-name">${escHtml(p.name || '?')}</span>
          <span class="player-score"><span class="player-sc-val ${isWin ? 'win' : ''}">${sc}</span>pt</span>
        </div>`;
      }).join('');

  return `
  <div class="room-card ${isFinished ? 'finished' : ''}" style="animation-delay:${idx * 0.06}s">
    <div class="room-card-header">
      <div class="room-id-wrap">
        <div class="live-dot ${isFinished ? 'fin' : ''}"></div>
        <div>
          <div class="room-id-label">ROOM ID</div>
          <div class="room-id-val">${rid}</div>
        </div>
      </div>
      <div class="rule-badge">${ruleName}</div>
      <button class="copy-btn" onclick="copyRoomId('${rid}', this)">COPY ID</button>
      <button class="peek-btn" onclick="openPeek('${rid}')">ğŸ‘ PEEK</button>
      <button class="join-btn" onclick="window.open('${QROOM_BASE}?r=${rid}','_blank')">â†’ å‚åŠ </button>
    </div>
    <div class="room-meta">
      <div class="meta-item">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        ä½œæˆ: <span>${formatTime(createdAt)}</span>
      </div>
      <div class="meta-item">
        <svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        æœ€çµ‚æ›´æ–°: <span>${timeAgo(lastActive)}</span>
      </div>
      <div class="meta-item">
        <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        <span>${playerList.length}</span> ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–: <span>${activePlayers.length}</span>ï¼‰
      </div>
      <div class="meta-item">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        çŠ¶æ…‹: <span style="color:${isFinished ? 'var(--muted)' : 'var(--green)'}">${isFinished ? 'çµ‚äº†' : 'ãƒ—ãƒ¬ã‚¤ä¸­'}</span>
      </div>
    </div>
    <div class="players-wrap">
      <div class="players-title">PLAYERS</div>
      <div class="players-grid">${playersHtml}</div>
    </div>
  </div>`;
}

function escHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

async function fetchRooms() {
  if (!db) return;
  try {
    const snap = await db.ref('rooms').once('value');
    const roomsData = snap.val() || {};
    const roomKeys = Object.keys(roomsData);

    const ACTIVE_THRESHOLD_MS = 30 * 60 * 1000;
    const now_ms = Date.now();

    const active = [], finished = [];
    roomKeys.forEach(rid => {
      const room = roomsData[rid];
      const lastActive = room.lastActiveAt || room.createdAt || 0;
      const isRecent = (now_ms - lastActive) < ACTIVE_THRESHOLD_MS;

      const players = room.players || {};
      const activePlayers = Object.values(players).filter(p => {
        const playerTs = p.statsAt || p.joined || 0;
        return (now_ms - playerTs) < ACTIVE_THRESHOLD_MS;
      });

      if (!isRecent || room.status === 'finished' || activePlayers.length === 0) {
        if (isRecent) finished.push({ rid, room });
      } else {
        const filteredRoom = { ...room, players: Object.fromEntries(
          Object.entries(players).filter(([, p]) => {
            const playerTs = p.statsAt || p.joined || 0;
            return (now_ms - playerTs) < ACTIVE_THRESHOLD_MS;
          })
        )};
        active.push({ rid, room: filteredRoom });
      }
    });

    active.sort((a, b) => (b.room.lastActiveAt || 0) - (a.room.lastActiveAt || 0));
    finished.sort((a, b) => (b.room.lastActiveAt || 0) - (a.room.lastActiveAt || 0));

    const totalPlayers = active.reduce((s, { room }) => s + Object.keys(room.players || {}).length, 0);

    document.getElementById('chip-rooms').textContent = active.length;
    document.getElementById('chip-rooms').classList.remove('loading-shimmer');
    document.getElementById('chip-players').textContent = totalPlayers;
    document.getElementById('chip-players').classList.remove('loading-shimmer');
    const now = new Date();
    document.getElementById('chip-time').textContent =
      String(now.getHours()).padStart(2,'0') + ':' +
      String(now.getMinutes()).padStart(2,'0') + ':' +
      String(now.getSeconds()).padStart(2,'0');

    document.getElementById('playing-count').textContent = active.length;

    const activeEl = document.getElementById('rooms-active');
    if (active.length === 0) {
      activeEl.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ®</div><div class="empty-text">ç¾åœ¨ãƒ—ãƒ¬ã‚¤ä¸­ã®ãƒ«ãƒ¼ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“</div></div>`;
    } else {
      activeEl.innerHTML = active.map(({ rid, room }, i) => buildRoomCard(rid, room, i)).join('');
    }

    const finEl = document.getElementById('rooms-finished');
    if (finished.length === 0) {
      finEl.innerHTML = `<div class="empty"><div class="empty-text">çµ‚äº†æ¸ˆã¿ãƒ«ãƒ¼ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“</div></div>`;
    } else {
      finEl.innerHTML = finished.map(({ rid, room }, i) => buildRoomCard(rid, room, i)).join('');
    }
    document.getElementById('fin-toggle').textContent =
      (finishedVisible ? 'â–¼ ' : 'â–¶ ') + `çµ‚äº†æ¸ˆã¿ãƒ«ãƒ¼ãƒ ã‚’è¡¨ç¤º (${finished.length})`;

    document.getElementById('error-box').style.display = 'none';

  } catch(e) {
    const errBox = document.getElementById('error-box');
    errBox.style.display = 'block';
    let msg = e.message || String(e);
    if (msg.includes('permission') || msg.includes('PERMISSION_DENIED')) {
      msg += '<br><br>â†’ Firebase ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã§ <code>/rooms</code> ã®èª­ã¿å–ã‚ŠãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>'
           + '<a href="https://console.firebase.google.com/project/q-room-fe8a6/database/q-room-fe8a6-default-rtdb/rules" target="_blank" style="color:var(--cyan)">ãƒ«ãƒ¼ãƒ«è¨­å®šã‚’ç¢ºèªã™ã‚‹</a>';
    }
    document.getElementById('error-msg').innerHTML = msg;
  }
}

function toggleFinished() {
  finishedVisible = !finishedVisible;
  const el = document.getElementById('rooms-finished');
  el.style.display = finishedVisible ? 'flex' : 'none';
  if (finishedVisible) el.style.flexDirection = 'column';
}

function startCountdown() {
  clearInterval(countdownTimer);
  countdownSec = 60;
  countdownTimer = setInterval(() => {
    countdownSec--;
    document.getElementById('countdown-text').textContent = `NEXT: ${countdownSec}s`;
    if (countdownSec <= 0) {
      clearInterval(countdownTimer);
      fetchRooms().then(() => startCountdown());
    }
  }, 1000);
}

function openPeek(rid) {
  if (!document.body.classList.contains('admin-mode')) { showPwModal(rid); return; }
  _doOpenPeek(rid);
}

function showPwModal(rid) {
  document.getElementById('pw-modal-rid').textContent = 'ROOM ' + rid;
  document.getElementById('pw-input').value = '';
  document.getElementById('pw-error').textContent = '';
  const overlay = document.getElementById('pw-modal-overlay');
  overlay.classList.add('show');
  overlay._pendingRid = rid;
  setTimeout(() => document.getElementById('pw-input').focus(), 80);
}

function closePwModal() {
  document.getElementById('pw-modal-overlay').classList.remove('show');
  document.getElementById('pw-input').value = '';
  document.getElementById('pw-error').textContent = '';
}

async function submitPwModal() {
  const key = document.getElementById('pw-input').value;
  if (!key) { document.getElementById('pw-error').textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(key));
  const hash = Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
  if (hash !== ADMIN_HASH) {
    document.getElementById('pw-error').textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™';
    document.getElementById('pw-input').select();
    return;
  }
  activateAdmin();
  const rid = document.getElementById('pw-modal-overlay')._pendingRid;
  closePwModal();
  _doOpenPeek(rid);
}

function _doOpenPeek(rid) {
  if (!db) { alert('Firebaseæœªæ¥ç¶šã§ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚'); return; }
  closePeek();
  peekRid = rid;
  document.getElementById('peek-rid').textContent = 'ROOM ' + rid;
  document.getElementById('peek-overlay').classList.add('show');
  document.getElementById('peek-drawer').classList.add('open');
  document.body.style.overflow = 'hidden';

  peekListener = db.ref('rooms/' + rid).on('value', snap => {
    const room = snap.val();
    if (!room) {
      document.getElementById('peek-body').innerHTML =
        '<div style="text-align:center;padding:40px;color:var(--red);font-family:var(--mono);">ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
      return;
    }
    renderPeek(rid, room);
  });
}

function closePeek() {
  if (peekListener && peekRid && db) {
    db.ref('rooms/' + peekRid).off('value', peekListener);
    peekListener = null;
  }
  peekRid = null;
  document.getElementById('peek-overlay').classList.remove('show');
  document.getElementById('peek-drawer').classList.remove('open');
  document.body.style.overflow = '';
}

function renderPeek(rid, room) {
  const RULE_LABEL_MAP = {
    survival:'ã‚µãƒã‚¤ãƒãƒ«', free:'ãƒ•ãƒªãƒ¼', newyork:'New York', rentou:'é€£ç­”',
    updown:'UpDown', by:'BY', freeze:'ãƒ•ãƒªãƒ¼ã‚º', m_n_rest:'MNä¼‘æ†©',
    swedish:'ã‚¹ã‚¦ã‚§ãƒ¼ãƒ‡ãƒ³', ren_wrong:'é€£ç¶šä¸æ­£è§£', divide:'åˆ†é…',
    combo:'ã‚³ãƒ³ãƒœ', attack_surv:'æ”»æ’ƒã‚µãƒã‚¤ãƒãƒ«', lucky:'ãƒ©ãƒƒã‚­ãƒ¼',
    spiral:'ã‚¹ãƒ‘ã‚¤ãƒ©ãƒ«', time_race:'ã‚¿ã‚¤ãƒ ãƒ¬ãƒ¼ã‚¹'
  };
  const players = room.players || {};
  const playerList = Object.entries(players).sort((a, b) => (b[1].sc || 0) - (a[1].sc || 0));
  const timer = room.timer || null;
  const ruleName = RULE_LABEL_MAP[room.rule] || room.rule || '?';
  const now_d = new Date();
  const ts = String(now_d.getHours()).padStart(2,'0') + ':' +
              String(now_d.getMinutes()).padStart(2,'0') + ':' +
              String(now_d.getSeconds()).padStart(2,'0');

  const stColor = room.status === 'playing' ? 'var(--green)' : room.status === 'finished' ? 'var(--muted)' : 'var(--yellow)';

  let timerHtml = '';
  if (timer) {
    const tState = timer.state || 'â€”';
    const tRem = timer.remaining !== undefined ? Math.max(0, Math.ceil(timer.remaining / 1000)) : 'â€”';
    const mm = typeof tRem === 'number' ? String(Math.floor(tRem/60)).padStart(2,'0') : 'â€”';
    const ss = typeof tRem === 'number' ? String(tRem%60).padStart(2,'0') : 'â€”';
    timerHtml = `
    <div class="peek-section">
      <div class="peek-section-title">TIMER</div>
      <div class="peek-kv"><span class="peek-key">STATE</span><span class="peek-val" style="color:${tState==='running'?'var(--green)':tState==='finished'?'var(--red)':'var(--muted)'}">${tState.toUpperCase()}</span></div>
      <div class="peek-kv"><span class="peek-key">REMAINING</span><span class="peek-val">${mm}:${ss}</span></div>
    </div>`;
  }

  const playersHtml = playerList.length === 0
    ? '<div style="color:var(--muted);font-family:var(--mono);font-size:0.8rem;padding:8px;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãªã—</div>'
    : playerList.map(([pid, p], i) => {
        const isWin = p.st === 'win';
        const isLose = p.st === 'lose';
        return `
        <div class="peek-player-row ${isWin?'win':isLose?'lose':''}">
          <div style="color:var(--muted);font-family:var(--mono);font-size:0.75rem;min-width:18px;">${i+1}</div>
          <div class="peek-avatar ${isWin?'win':''}">${(p.name||'?').charAt(0).toUpperCase()}</div>
          <div class="peek-pname">${escHtml(p.name||'?')}</div>
          <div class="peek-stats">
            <span>âœ“${p.c||0}</span>
            <span>âœ—${p.w||0}</span>
            <span class="sc ${isWin?'win':''}">${p.sc||0}pt</span>
          </div>
          <div style="font-family:var(--mono);font-size:0.68rem;color:${
            p.st==='active'?'var(--green)':p.st==='win'?'var(--green)':p.st==='lose'?'var(--red)':'var(--muted)'
          };min-width:40px;text-align:right;">${(p.st||'?').toUpperCase()}</div>
        </div>`;
      }).join('');

  document.getElementById('peek-body').innerHTML = `
    <div class="peek-section">
      <div class="peek-section-title">ROOM INFO <div class="peek-live-dot" style="border-radius:50%"></div></div>
      <div class="peek-kv"><span class="peek-key">RULE</span><span class="peek-val">${ruleName}</span></div>
      <div class="peek-kv"><span class="peek-key">STATUS</span><span class="peek-val" style="color:${stColor}">${(room.status||'?').toUpperCase()}</span></div>
      <div class="peek-kv"><span class="peek-key">PLAYERS</span><span class="peek-val">${playerList.length} äºº</span></div>
      <div class="peek-kv"><span class="peek-key">CREATED</span><span class="peek-val">${room.createdAt ? new Date(room.createdAt).toLocaleTimeString('ja-JP') : 'â€”'}</span></div>
      <div class="peek-kv"><span class="peek-key">LAST ACTIVE</span><span class="peek-val">${room.lastActiveAt ? new Date(room.lastActiveAt).toLocaleTimeString('ja-JP') : 'â€”'}</span></div>
    </div>
    ${timerHtml}
    <div class="peek-section">
      <div class="peek-section-title">PLAYERS (ã‚¹ã‚³ã‚¢é †)</div>
      ${playersHtml}
    </div>
    <div style="text-align:right;font-family:var(--mono);font-size:0.65rem;color:rgba(255,255,255,0.2);margin-top:8px;">æ›´æ–°: ${ts}</div>
  `;
}

function activateAdmin() {
  isAdmin = true;
  sessionStorage.setItem('qr_admin', '1');
  document.body.classList.add('admin-mode');
  const hdr = document.querySelector('.status-row');
  if (!document.querySelector('.admin-badge')) {
    const badge = document.createElement('div');
    badge.className = 'admin-badge';
    badge.textContent = 'âš¡ ADMIN';
    hdr.prepend(badge);
  }
}

window.addEventListener('load', async () => {
  const checkHash = async (k) => {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(k));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
  };

  const params = new URLSearchParams(window.location.search);
  const key = params.get('admin');

  if (key) {
    const hash = await checkHash(key);
    if (hash === ADMIN_HASH) {
      activateAdmin();
      history.replaceState({}, '', window.location.pathname);
    } else {
      alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚');
    }
  } else if (sessionStorage.getItem('qr_admin') === '1') {
    activateAdmin();
  }

  initFB();
  fetchRooms().then(() => startCountdown());
});
</script>

<!-- PASSWORD MODAL -->
<div class="pw-modal-overlay" id="pw-modal-overlay" onclick="if(event.target===this)closePwModal()">
  <div class="pw-modal">
    <div class="pw-modal-title">ğŸ‘ PEEK ACCESS</div>
    <div class="pw-modal-sub">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>å‚åŠ è€…ã«ã¯é€šçŸ¥ã•ã‚Œã¾ã›ã‚“ã€‚</div>
    <div class="pw-modal-rid" id="pw-modal-rid">â€”</div>
    <input class="pw-input" id="pw-input" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
      onkeydown="if(event.key==='Enter')submitPwModal();if(event.key==='Escape')closePwModal()">
    <div class="pw-error" id="pw-error"></div>
    <div class="pw-modal-btns">
      <button class="pw-cancel-btn" onclick="closePwModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="pw-submit-btn" onclick="submitPwModal()">ğŸ‘ PEEK</button>
    </div>
  </div>
</div>

<!-- ADMIN PEEK PANEL -->
<div class="peek-overlay" id="peek-overlay" onclick="closePeek()"></div>
<div class="peek-drawer" id="peek-drawer">
  <div class="peek-header">
    <div>
      <div class="peek-title">ğŸ‘ ADMIN PEEK</div>
      <div class="peek-rid" id="peek-rid">â€”</div>
    </div>
    <button class="peek-close" onclick="closePeek()">âœ•</button>
  </div>
  <div class="peek-body" id="peek-body">
    <div style="text-align:center;padding:40px;color:var(--muted);font-family:var(--mono);font-size:0.82rem;">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>
  <div class="peek-footer">READ-ONLY Â· Firebase ã¸ã®æ›¸ãè¾¼ã¿ãªã— Â· ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã¯è¦‹ãˆã¾ã›ã‚“</div>
</div>

</body>
</html>
