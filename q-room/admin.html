<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Q-Room Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+JP:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #09090b; --surface: rgba(24,24,27,0.95); --border: rgba(255,255,255,0.1);
  --cyan: #06b6d4; --green: #10b981; --red: #ef4444; --yellow: #f59e0b;
  --text: #f4f4f5; --muted: #a1a1aa;
  --font-en: 'Inter', sans-serif; --font-ja: 'Noto Sans JP', sans-serif; --font-mono: 'JetBrains Mono', monospace;
}
body { background: var(--bg); color: var(--text); font-family: var(--font-ja); min-height: 100vh; }

#app { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 24px; }
.login-box {
  background: var(--surface); border: 1px solid var(--border); border-radius: 24px;
  padding: 48px 40px; width: 100%; max-width: 420px; box-shadow: 0 32px 80px rgba(0,0,0,0.6);
}
.login-title { font-family: var(--font-en); font-size: 2rem; font-weight: 900; letter-spacing: 0.1em; margin-bottom: 6px; }
.login-title span { color: var(--cyan); }
.login-sub { font-size: 0.82rem; color: var(--muted); margin-bottom: 36px; line-height: 1.7; }
.field { margin-bottom: 18px; }
label { display: block; font-family: var(--font-en); font-size: 0.75rem; color: var(--cyan); font-weight: 700; margin-bottom: 10px; letter-spacing: 0.15em; text-transform: uppercase; }
input[type="email"], input[type="password"], input[type="text"] {
  width: 100%; padding: 13px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border);
  border-radius: 12px; color: var(--text); font-family: var(--font-ja); font-size: 0.95rem; outline: none; transition: all 0.3s;
}
input:focus { border-color: var(--cyan); background: rgba(6,182,212,0.08); box-shadow: 0 0 0 4px rgba(6,182,212,0.12); }
.btn-login {
  width: 100%; padding: 15px; border: none; border-radius: 12px; cursor: pointer;
  background: linear-gradient(135deg, var(--cyan), #0284c7); color: #fff;
  font-family: var(--font-en); font-weight: 700; font-size: 0.95rem; letter-spacing: 0.12em;
  transition: all 0.3s; box-shadow: 0 8px 24px rgba(6,182,212,0.3); margin-top: 4px;
}
.btn-login:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(6,182,212,0.4); }
.btn-login:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
.err-box {
  background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.4); border-radius: 12px;
  color: #fca5a5; padding: 12px 16px; font-size: 0.88rem; margin-bottom: 18px; display: none; line-height: 1.5;
}

#admin-wrap { display: none; flex-direction: column; min-height: 100vh; }
.adm-header {
  background: rgba(9,9,11,0.92); border-bottom: 1px solid var(--border); padding: 14px 28px;
  display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 20; backdrop-filter: blur(24px); gap: 10px; flex-wrap: wrap;
}
.adm-logo { font-family: var(--font-en); font-size: 1.1rem; font-weight: 900; color: var(--cyan); letter-spacing: 0.1em; flex-shrink: 0; }
.adm-logo span { color: var(--muted); font-weight: 400; font-size: 0.78rem; margin-left: 10px; }
.adm-user { font-family: var(--font-mono); font-size: 0.72rem; color: var(--muted); flex: 1; }
.btn-sm { padding: 8px 16px; border-radius: 8px; font-family: var(--font-en); font-size: 0.78rem; font-weight: 700; letter-spacing: 0.08em; cursor: pointer; transition: 0.2s; border: 1px solid; }
.btn-sm-pri { background: rgba(6,182,212,0.1); border-color: rgba(6,182,212,0.4); color: var(--cyan); }
.btn-sm-pri:hover { background: rgba(6,182,212,0.2); }
.btn-sm-danger { background: rgba(239,68,68,0.1); border-color: rgba(239,68,68,0.4); color: var(--red); }
.btn-sm-danger:hover { background: rgba(239,68,68,0.2); }

.adm-body { padding: 28px 28px 60px; max-width: 1400px; margin: 0 auto; width: 100%; }
.gs-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 14px; margin-bottom: 28px; }
.gs-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 18px; text-align: center; }
.gs-val { font-family: var(--font-en); font-size: 2rem; font-weight: 900; color: var(--cyan); line-height: 1; margin-bottom: 7px; }
.gs-lbl { font-size: 0.68rem; color: var(--muted); font-family: var(--font-en); letter-spacing: 0.12em; font-weight: 700; text-transform: uppercase; }

.sec-head { display: flex; align-items: center; gap: 16px; margin-bottom: 14px; flex-wrap: wrap; }
.sec-title { font-family: var(--font-en); font-size: 0.78rem; font-weight: 700; color: var(--muted); letter-spacing: 0.15em; text-transform: uppercase; }
.search-input {
  padding: 9px 14px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
  color: var(--text); font-family: var(--font-ja); font-size: 0.88rem; outline: none; transition: 0.3s; flex: 1; max-width: 320px;
}
.search-input:focus { border-color: var(--cyan); }

.tbl-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 900px; }
thead { background: rgba(255,255,255,0.04); }
th { padding: 12px 14px; text-align: left; font-family: var(--font-en); font-size: 0.68rem; font-weight: 700; letter-spacing: 0.12em; color: var(--muted); text-transform: uppercase; border-bottom: 1px solid var(--border); white-space: nowrap; }
td { padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,0.04); vertical-align: middle; }
tr:last-child td { border-bottom: none; }
tr:hover td { background: rgba(255,255,255,0.02); }

.icon-cell { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; }
.icon-img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
.uid-cell { font-family: var(--font-mono); font-size: 0.8rem; color: var(--cyan); }
.email-cell { font-family: var(--font-mono); font-size: 0.75rem; color: var(--muted); }
.center { text-align: center; }
.c-cyan { color: var(--cyan); font-weight: 700; }
.c-green { color: var(--green); font-weight: 700; }
.c-red { color: var(--red); font-weight: 700; }
.c-yellow { color: var(--yellow); }

.det-row td { padding: 0; }
.det-inner {
  padding: 16px 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 10px; border-left: 3px solid rgba(6,182,212,0.35); background: rgba(6,182,212,0.02);
}
.det-lbl { font-family: var(--font-en); font-size: 0.62rem; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 3px; }
.det-val { font-family: var(--font-mono); font-size: 0.8rem; color: var(--text); word-break: break-all; }
.friend-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
.ftag { font-family: var(--font-mono); font-size: 0.7rem; background: rgba(6,182,212,0.1); border: 1px solid rgba(6,182,212,0.3); color: var(--cyan); padding: 1px 7px; border-radius: 5px; }
.expand-btn { background: none; border: 1px solid var(--border); color: var(--muted); padding: 4px 10px; border-radius: 7px; cursor: pointer; font-size: 0.7rem; font-family: var(--font-en); transition: 0.2s; white-space: nowrap; }
.expand-btn:hover { border-color: var(--cyan); color: var(--cyan); }
.loading-msg { text-align: center; padding: 40px; color: var(--muted); font-family: var(--font-en); font-size: 0.88rem; letter-spacing: 0.08em; }
</style>
</head>
<body>

<div id="app">
  <div class="login-box">
    <div class="login-title">Q-ROOM <span>ADMIN</span></div>
    <div class="login-sub">
      Q-Roomã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚<br>
      ç®¡ç†è€…ã¨ã—ã¦ç™»éŒ²ã•ã‚ŒãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
    </div>
    <div class="err-box" id="login-err"></div>
    <div class="field">
      <label>Email</label>
      <input type="email" id="admin-email" placeholder="your@email.com" autocomplete="email">
    </div>
    <div class="field">
      <label>Password</label>
      <input type="password" id="admin-pw" placeholder="Password" autocomplete="current-password" onkeydown="if(event.key==='Enter')adminLogin()">
    </div>
    <button class="btn-login" id="login-btn" onclick="adminLogin()">LOGIN</button>
  </div>
</div>

<div id="admin-wrap">
  <div class="adm-header">
    <div class="adm-logo">Q-ROOM <span>ADMIN</span></div>
    <div class="adm-user" id="adm-user-label"></div>
    <button class="btn-sm btn-sm-pri" onclick="loadAllUsers()" style="margin-right:8px;">ğŸ”„ æ›´æ–°</button>
    <button class="btn-sm btn-sm-danger" onclick="adminLogout()">LOGOUT</button>
  </div>
  <div class="adm-body">
    <div class="gs-row">
      <div class="gs-card"><div class="gs-val" id="gs-users">â€”</div><div class="gs-lbl">TOTAL USERS</div></div>
      <div class="gs-card"><div class="gs-val" id="gs-games">â€”</div><div class="gs-lbl">TOTAL GAMES</div></div>
      <div class="gs-card"><div class="gs-val" id="gs-correct">â€”</div><div class="gs-lbl">TOTAL CORRECT</div></div>
      <div class="gs-card"><div class="gs-val" id="gs-wins">â€”</div><div class="gs-lbl">TOTAL WINS</div></div>
    </div>
    <div class="sec-head" style="margin-top:28px;">
      <div class="sec-title">ğŸ“¢ å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€æ–‰é€šçŸ¥</div>
    </div>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:28px;">
      <div class="field">
        <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
        <input type="text" id="broadcast-title" placeholder="é€šçŸ¥ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹ï¼šãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŠçŸ¥ã‚‰ã›ï¼‰" maxlength="80">
      </div>
      <div class="field">
        <label>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡</label>
        <textarea id="broadcast-body" placeholder="é€šçŸ¥å†…å®¹ã‚’å…¥åŠ›â€¦" rows="4" style="width:100%;padding:13px 16px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:12px;color:var(--text);font-family:var(--font-ja);font-size:0.95rem;outline:none;transition:all 0.3s;resize:vertical;"></textarea>
      </div>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <button class="btn-sm btn-sm-pri" onclick="sendBroadcastNotif()" id="broadcast-btn" style="padding:10px 24px;font-size:0.88rem;">ğŸ“¨ å…¨å“¡ã«é€ä¿¡</button>
        <button class="btn-sm" onclick="testSendNotif()" style="padding:10px 18px;font-size:0.88rem;background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.3);color:var(--cyan);">ğŸ§ª è‡ªåˆ†ã«ãƒ†ã‚¹ãƒˆé€ä¿¡</button>
        <span id="broadcast-status" style="font-size:0.82rem;color:var(--muted);display:block;margin-top:8px;width:100%;"></span>
      </div>
    </div>
    <div class="sec-head">
      <div class="sec-title">USER LIST</div>
      <input type="text" class="search-input" id="search-input" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒ»åå‰ãƒ»ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢â€¦" oninput="filterUsers(this.value)">
    </div>
    <div class="tbl-wrap">
      <table>
        <thead>
          <tr>
            <th></th>
            <th>USER ID</th>
            <th>NAME</th>
            <th>EMAIL</th>
            <th>ç§°å·</th>
            <th class="center">GAMES</th>
            <th class="center">WIN%</th>
            <th class="center">CORRECT</th>
            <th class="center">WRONG</th>
            <th class="center">FRIENDS</th>
            <th>REGISTERED</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="user-tbody">
          <tr><td colspan="12" class="loading-msg">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script>
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyA3xtGLVJwij2BTiiOk7DsNeF9hIOuZCyI",
  authDomain: "q-room-fe8a6.firebaseapp.com",
  databaseURL: "https://q-room-fe8a6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "q-room-fe8a6",
  storageBucket: "q-room-fe8a6.firebasestorage.app",
  messagingSenderId: "151049149394",
  appId: "1:151049149394:web:7a3ea6406454f6a87d460b"
};

const ADMIN_EMAILS = ["astro.root.quiz@gmail.com"];

let db, auth, adminUser;
let allUsers = [];

firebase.initializeApp(FIREBASE_CONFIG);
db = firebase.database();
auth = firebase.auth();

function showApp(view) {
  document.getElementById('app').style.display = (view === 'login') ? 'flex' : 'none';
  document.getElementById('admin-wrap').style.display = (view === 'admin') ? 'flex' : 'none';
}

showApp('login');

auth.onAuthStateChanged(async user => {
  if (!user) {
    adminUser = null;
    showApp('login');
    return;
  }
  if (!ADMIN_EMAILS.includes(user.email)) {
    await auth.signOut();
    showErr('ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¯ç®¡ç†è€…æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br><code style="font-family:var(--font-mono);font-size:0.82rem;">astro.root.quiz@gmail.com</code> ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
    return;
  }
  adminUser = user;
  document.getElementById('adm-user-label').textContent = user.email;
  showApp('admin');
  loadAllUsers();
});

function showErr(msg) {
  const el = document.getElementById('login-err');
  el.innerHTML = msg;
  el.style.display = '';
}

async function adminLogin() {
  const email = document.getElementById('admin-email').value.trim();
  const pw = document.getElementById('admin-pw').value;
  const btn = document.getElementById('login-btn');
  document.getElementById('login-err').style.display = 'none';
  if (!email || !pw) { showErr('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  btn.disabled = true; btn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­â€¦';
  try {
    await auth.signInWithEmailAndPassword(email, pw);
  } catch(e) {
    const msg = (e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password' || e.code === 'auth/invalid-credential')
      ? 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'
      : 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message;
    showErr(msg);
  } finally {
    btn.disabled = false; btn.textContent = 'LOGIN';
  }
}

async function adminLogout() {
  if (!confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  await auth.signOut();
}

async function loadAllUsers() {
  document.getElementById('user-tbody').innerHTML = '<tr><td colspan="12" class="loading-msg">èª­ã¿è¾¼ã¿ä¸­â€¦</td></tr>';
  document.getElementById('search-input').value = '';
  try {
    const [usersSnap, statsSnap, friendsSnap] = await Promise.all([
      db.ref('users').once('value'),
      db.ref('stats').once('value'),
      db.ref('friends').once('value')
    ]);
    const users = usersSnap.val() || {};
    const stats = statsSnap.val() || {};
    const friends = friendsSnap.val() || {};

    allUsers = Object.entries(users).map(([uid, u]) => ({
      uid, ...u,
      stats: stats[uid] || {},
      friendUids: friends[uid] ? Object.keys(friends[uid]) : []
    })).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

    let tg = 0, tc = 0, tw = 0;
    allUsers.forEach(u => { tg += u.stats.totalGames||0; tc += u.stats.totalCorrect||0; tw += u.stats.wins||0; });
    document.getElementById('gs-users').textContent = allUsers.length;
    document.getElementById('gs-games').textContent = tg;
    document.getElementById('gs-correct').textContent = tc;
    document.getElementById('gs-wins').textContent = tw;
    renderTable(allUsers);
  } catch(e) {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãŒå–ã‚Œãªãã¦ã‚‚ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã¯userIndexçµŒç”±ã§é€ã‚Œã‚‹æ—¨ã‚’è¡¨ç¤º
    document.getElementById('broadcast-status').style.color = 'var(--yellow)';
    document.getElementById('broadcast-status').textContent = 'âš ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€é€šçŸ¥é€ä¿¡ã¯userIndexçµŒç”±ã§å®Ÿè¡Œã§ãã¾ã™';
    let errMsg = esc(e.message);
    if (e.message && e.message.includes('permission_denied')) {
      errMsg = `
        <strong>permission_denied ã‚¨ãƒ©ãƒ¼</strong><br>
        Firebase Realtime Database ã®ãƒ«ãƒ¼ãƒ«ã§ç®¡ç†è€…ç”¨ã®èª­ã¿å–ã‚ŠãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™ã€‚<br><br>
        Firebase ã‚³ãƒ³ã‚½ãƒ¼ãƒ« â†’ Realtime Database â†’ ãƒ«ãƒ¼ãƒ« ã§ä»¥ä¸‹ã‚’è¨­å®šã—ã¦ãã ã•ã„:<br>
        <pre style="background:rgba(255,255,255,0.05);padding:10px;border-radius:8px;margin-top:8px;font-size:0.78rem;text-align:left;overflow:auto;">{
  "rules": {
    "userIndex": {
      ".read": true,
      "$displayId": {
        ".write": "auth != null"
      }
    },
    "users": {
      ".read": "auth.token.email === 'astro.root.quiz@gmail.com'",
      "$uid": {
        ".read": "auth.uid === $uid",
        ".write": "auth.uid === $uid"
      }
    },
    "stats": {
      ".read": "auth.token.email === 'astro.root.quiz@gmail.com'",
      "$uid": {
        ".read": "auth.uid === $uid",
        ".write": "auth.uid === $uid"
      }
    },
    "friends": {
      ".read": "auth.token.email === 'astro.root.quiz@gmail.com'",
      "$uid": {
        ".read": "auth.uid === $uid",
        ".write": "auth.uid === $uid"
      }
    },
    "notifications": {
      "$uid": {
        ".read": "auth.uid === $uid",
        ".write": "auth != null"
      }
    },
    "friendRequests": {
      "$uid": {
        ".read": "auth.uid === $uid",
        ".write": "auth != null"
      }
    },
    "rooms": {
      ".read": "auth != null || true",
      ".write": "auth != null || true"
    },
    "devNotice": {
      ".read": true,
      ".write": "auth.token.email === 'astro.root.quiz@gmail.com'"
    }
  }
}</pre>
        <strong>é‡è¦ï¼š</strong> <code>userIndex</code> ã¯æœªèªè¨¼ã§ã‚‚èª­ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒ­ã‚°ã‚¤ãƒ³ã®ãŸã‚ï¼‰ã€‚`;
    }
    document.getElementById('user-tbody').innerHTML = `<tr><td colspan="12" class="loading-msg" style="color:var(--red);text-align:left;padding:24px;">${errMsg}</td></tr>`;
  }
}

function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function fmtDate(ts) {
  if (!ts) return 'â€”';
  return new Date(ts).toLocaleDateString('ja-JP') + ' ' + new Date(ts).toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'});
}

function renderTable(users) {
  const tbody = document.getElementById('user-tbody');
  if (users.length === 0) {
    tbody.innerHTML = '<tr><td colspan="12" class="loading-msg">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</td></tr>';
    return;
  }
  tbody.innerHTML = users.map(u => {
    const s = u.stats;
    const wr = s.totalGames > 0 ? Math.round(s.wins / s.totalGames * 100) : 0;
    const iconHtml = u.iconUrl
      ? `<img src="${esc(u.iconUrl)}" class="icon-img">`
      : `<span style="font-size:1.3rem;">${esc(u.icon||'ğŸ‘¤')}</span>`;
    return `
    <tr id="row-${esc(u.uid)}">
      <td><div class="icon-cell">${iconHtml}</div></td>
      <td class="uid-cell">${esc(u.displayId||'?')}</td>
      <td>${esc(u.name||'â€”')}</td>
      <td class="email-cell">${esc(u.email||'â€”')}</td>
      <td class="c-yellow">${esc(u.title||'â€”')}</td>
      <td class="center">${s.totalGames||0}</td>
      <td class="center c-green">${wr}%</td>
      <td class="center c-cyan">${s.totalCorrect||0}</td>
      <td class="center c-red">${s.totalWrong||0}</td>
      <td class="center">${u.friendUids.length}</td>
      <td style="font-size:0.72rem;color:var(--muted);white-space:nowrap;">${fmtDate(u.createdAt)}</td>
      <td><button class="expand-btn" onclick="toggleDet('${esc(u.uid)}')">è©³ç´° â–¼</button></td>
    </tr>
    <tr id="det-${esc(u.uid)}" class="det-row" style="display:none;">
      <td colspan="12">
        <div class="det-inner">
          <div><div class="det-lbl">Firebase UID</div><div class="det-val">${esc(u.uid)}</div></div>
          <div><div class="det-lbl">Display ID</div><div class="det-val">${esc(u.displayId||'â€”')}</div></div>
          <div><div class="det-lbl">Name</div><div class="det-val">${esc(u.name||'â€”')}</div></div>
          <div><div class="det-lbl">Email</div><div class="det-val" style="color:var(--cyan);">${esc(u.email||'â€”')}</div></div>
          <div><div class="det-lbl">Password</div><div class="det-val" style="color:var(--muted);font-size:0.72rem;">å–å¾—ä¸å¯ï¼ˆFirebaseã¯ãƒãƒƒã‚·ãƒ¥åŒ–ä¿å­˜ï¼‰</div></div>
          <div><div class="det-lbl">ç§°å·</div><div class="det-val">${esc(u.title||'â€”')}</div></div>
          <div><div class="det-lbl">Icon</div><div class="det-val">${u.iconUrl?`<img src="${esc(u.iconUrl)}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">`:esc(u.icon||'ğŸ‘¤')}</div></div>
          <div><div class="det-lbl">Total Games</div><div class="det-val">${s.totalGames||0}</div></div>
          <div><div class="det-lbl">Wins (Win%)</div><div class="det-val" style="color:var(--green);">${s.wins||0} (${wr}%)</div></div>
          <div><div class="det-lbl">Total Correct</div><div class="det-val" style="color:var(--cyan);">${s.totalCorrect||0}</div></div>
          <div><div class="det-lbl">Total Wrong</div><div class="det-val" style="color:var(--red);">${s.totalWrong||0}</div></div>
          <div><div class="det-lbl">Registered</div><div class="det-val">${fmtDate(u.createdAt)}</div></div>
          <div style="grid-column:1/-1;">
            <div class="det-lbl">Friends (${u.friendUids.length})</div>
            <div class="friend-tags">
              ${u.friendUids.length===0
                ? '<span style="color:var(--muted);font-size:0.75rem;">ãƒ•ãƒ¬ãƒ³ãƒ‰ãªã—</span>'
                : u.friendUids.map(fid => {
                    const fu = allUsers.find(x => x.uid === fid);
                    if(fu) {
                      const nm = fu.name ? ' (' + esc(fu.name) + ')' : '';
                      return '<span class="ftag" title="Email: ' + esc(fu.email||'â€”') + '">' + esc(fu.displayId||'?') + nm + '</span>';
                    }
                    return '<span class="ftag" style="opacity:0.5;">' + fid.substring(0,10) + 'â€¦</span>';
                  }).join('')}
            </div>
          </div>
        </div>
      </td>
    </tr>`;
  }).join('');
}

function toggleDet(uid) {
  const row = document.getElementById(`det-${uid}`);
  const btn = document.querySelector(`#row-${uid} .expand-btn`);
  const open = row.style.display === 'none';
  row.style.display = open ? '' : 'none';
  if (btn) btn.textContent = open ? 'è©³ç´° â–²' : 'è©³ç´° â–¼';
}

function filterUsers(q) {
  if (!q.trim()) { renderTable(allUsers); return; }
  const ql = q.toLowerCase();
  renderTable(allUsers.filter(u =>
    (u.displayId||'').toLowerCase().includes(ql) ||
    (u.name||'').toLowerCase().includes(ql) ||
    (u.email||'').toLowerCase().includes(ql) ||
    (u.title||'').toLowerCase().includes(ql)
  ));
}

async function _getTargetUids(statusEl) {
  // allUsers ã‹ã‚‰å–å¾—ã€ãªã‘ã‚Œã° userIndex ã‹ã‚‰å–å¾—
  let uids = allUsers.map(u => u.uid);
  if (uids.length === 0) {
    if (statusEl) { statusEl.style.color = 'var(--muted)'; statusEl.textContent = 'userIndex ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—ä¸­â€¦'; }
    const idxSnap = await db.ref('userIndex').once('value');
    idxSnap.forEach(child => {
      const val = child.val();
      const uid = (val && typeof val === 'object') ? val.uid : val;
      if (uid && typeof uid === 'string' && !uids.includes(uid)) uids.push(uid);
    });
  }
  return uids;
}

async function _sendNotifToUids(uids, title, body, statusEl) {
  const ts = firebase.database.ServerValue.TIMESTAMP;
  let ok = 0, fail = 0;
  const errors = [];
  const BATCH = 10;
  for (let i = 0; i < uids.length; i += BATCH) {
    const batch = uids.slice(i, i + BATCH);
    const results = await Promise.allSettled(
      batch.map(uid => db.ref(`notifications/${uid}`).push({ type:'devAnnounce', title, body, read:false, ts }))
    );
    results.forEach((r, idx) => {
      if (r.status === 'fulfilled') { ok++; }
      else {
        fail++;
        const msg = r.reason?.message || String(r.reason);
        errors.push(`${batch[idx]}: ${msg}`);
        if (msg.toLowerCase().includes('permission_denied') && errors.length === 1) {
          console.error(`[broadcast] PERMISSION_DENIED â€” Firebase Rulesã§notificationsã®writeã‚’articAuth != nullã«å¤‰æ›´ã—ã¦ãã ã•ã„`);
        }
      }
    });
    if (statusEl) statusEl.textContent = `é€ä¿¡ä¸­â€¦ (${ok} / ${uids.length})`;
  }
  return { ok, fail, errors };
}

async function testSendNotif() {
  if (!adminUser) { alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“'); return; }
  const title = document.getElementById('broadcast-title').value.trim() || 'ãƒ†ã‚¹ãƒˆé€šçŸ¥';
  const body = document.getElementById('broadcast-body').value.trim() || 'ç®¡ç†è€…ã‹ã‚‰ã®ãƒ†ã‚¹ãƒˆé€ä¿¡ã§ã™ã€‚';
  const statusEl = document.getElementById('broadcast-status');
  statusEl.style.color = 'var(--muted)';
  statusEl.textContent = `è‡ªåˆ† (${adminUser.uid.slice(0,8)}â€¦) ã«ãƒ†ã‚¹ãƒˆé€ä¿¡ä¸­â€¦`;
  try {
    const { ok, fail, errors } = await _sendNotifToUids([adminUser.uid], title, body, null);
    if (ok > 0) {
      statusEl.style.color = 'var(--green)';
      statusEl.textContent = `âœ… ãƒ†ã‚¹ãƒˆé€ä¿¡æˆåŠŸï¼ Q-Roomã§é€šçŸ¥ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
    } else {
      statusEl.style.color = 'var(--red)';
      statusEl.textContent = `âŒ ãƒ†ã‚¹ãƒˆé€ä¿¡å¤±æ•—: ${errors[0] || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`;
    }
  } catch (e) {
    statusEl.style.color = 'var(--red)';
    statusEl.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`;
  }
}

async function sendBroadcastNotif() {
  if (!adminUser) { alert('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“'); return; }
  const title = document.getElementById('broadcast-title').value.trim();
  const body = document.getElementById('broadcast-body').value.trim();
  const statusEl = document.getElementById('broadcast-status');
  const btn = document.getElementById('broadcast-btn');

  if (!title) { statusEl.style.color = 'var(--red)'; statusEl.textContent = 'ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
  if (!body) { statusEl.style.color = 'var(--red)'; statusEl.textContent = 'æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }

  let targetUids;
  try {
    targetUids = await _getTargetUids(statusEl);
  } catch (e) {
    statusEl.style.color = 'var(--red)';
    statusEl.textContent = `âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—å¤±æ•—: ${e.message}`;
    return;
  }

  if (targetUids.length === 0) {
    statusEl.style.color = 'var(--red)';
    statusEl.textContent = 'é€ä¿¡å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆuserIndexãŒç©ºï¼‰';
    return;
  }

  if (!confirm(`${targetUids.length} äººå…¨å“¡ã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ\n\nã‚¿ã‚¤ãƒˆãƒ«: ${title}\næœ¬æ–‡: ${body}`)) return;

  btn.disabled = true;
  statusEl.style.color = 'var(--muted)';
  statusEl.textContent = `é€ä¿¡ä¸­â€¦ (0 / ${targetUids.length})`;

  try {
    const { ok, fail, errors } = await _sendNotifToUids(targetUids, title, body, statusEl);
    if (fail === 0) {
      statusEl.style.color = 'var(--green)';
      statusEl.textContent = `âœ… ${ok} äººã«é€ä¿¡å®Œäº†`;
      document.getElementById('broadcast-title').value = '';
      document.getElementById('broadcast-body').value = '';
    } else if (ok === 0) {
      statusEl.style.color = 'var(--red)';
      statusEl.textContent = `âŒ å…¨ä»¶å¤±æ•— (${fail}ä»¶): ${errors[0] || ''}`;
    } else {
      statusEl.style.color = 'var(--yellow)';
      statusEl.textContent = `âš ï¸ ${ok}äººæˆåŠŸ / ${fail}ä»¶å¤±æ•—: ${errors[0] || ''}`;
    }
  } catch (e) {
    statusEl.style.color = 'var(--red)';
    statusEl.textContent = `âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${e.message}`;
  } finally {
    btn.disabled = false;
  }
}
</script>
</body>
</html>
